<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Senaryo Timeline EditÃ¶rÃ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" crossorigin="anonymous">
<!-- Firebase Realtime Database (GerÃ§ek ZamanlÄ± Ä°ÅŸbirliÄŸi) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js" integrity="sha384-sEVIly94UBRLKWdkYoPpSG7GD/e79YHMrxVyZaOk712Ga7+EAw6w1EFi+xBzBdd+" crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js" integrity="sha384-EkqK+ezBWJuvO3hfrSx2iVqr3YQbhmnzn8kPhOpBZ+0GMVU5oGSgptwIu8D84HjE" crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js" integrity="sha384-1/m+A1jVWbD3yiK3/vtFvm1+LjK1WLpSoDY+Kaxppwn/yP9BVSgdHTNQVOjrzUO5" crossorigin="anonymous"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#08080c;--bg2:#0e0e14;--bg3:#16161f;--bg4:#1e1e2a;--bg5:#262635;--brd:#2a2a3a;--brd2:#3a3a4f;--tx:#e8e6f0;--tx2:#a8a4b8;--tx3:#706c82;--tx4:#4a475a;--red:#ef4444;--blue:#3b82f6;--green:#10b981;--yellow:#f59e0b;--purple:#a855f7;--orange:#f97316;--cyan:#06b6d4;--pink:#ec4899;--radius:6px;--shadow:0 4px 16px rgba(0,0,0,.4)}body{font-family:'Inter','DM Sans','Segoe UI',sans-serif;background:var(--bg);color:var(--tx);overflow:hidden;height:100vh;font-size:13px}.app{display:flex;flex-direction:column;height:100vh}::selection{background:var(--blue);color:#fff}.topbar{min-height:48px;background:var(--bg2);border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;padding:6px 16px;flex-shrink:0;z-index:50;flex-wrap:wrap;gap:6px}.logo{display:flex;align-items:center;gap:10px}.logo h1{font-size:15px;font-weight:700;letter-spacing:.5px;cursor:pointer}.logo h1:hover{color:var(--blue)}.logo span{font-size:10px;color:var(--tx3);letter-spacing:.5px}.tba{display:flex;gap:6px;align-items:center;flex-wrap:wrap}.btn{padding:7px 13px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx2);font-family:inherit;font-size:12px;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;line-height:1}.btn:hover{background:var(--bg4);color:var(--tx);border-color:var(--brd2)}.btn:active{transform:scale(.97)}.btn-p{background:var(--blue);border-color:var(--blue);color:#fff}.btn-p:hover{background:#2563eb;border-color:#2563eb}.btn-d{background:var(--red);border-color:var(--red);color:#fff}.btn-d:hover{background:#dc2626}.btn-s{padding:4px 8px;font-size:11px}.btn-icon{padding:6px 8px;font-size:14px}.badge{background:var(--orange);color:#fff;font-size:9px;padding:1px 6px;border-radius:8px;font-weight:700;min-width:18px;text-align:center}.view-modes{display:flex;gap:2px;background:var(--bg);border-radius:var(--radius);padding:2px;border:1px solid var(--brd)}.view-mode{padding:5px 12px;border-radius:4px;font-size:11px;cursor:pointer;color:var(--tx3);border:none;background:none;font-family:inherit;transition:all .15s}.view-mode.active{background:var(--bg4);color:var(--tx)}.view-mode:hover:not(.active){color:var(--tx2)}.toolbar{min-height:40px;background:var(--bg2);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:4px 16px;gap:10px;flex-wrap:wrap;flex-shrink:0;z-index:40}.toolbar label{font-size:10px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;font-weight:500}.toolbar select{padding:4px 8px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx2);font-size:12px;font-family:inherit;cursor:pointer;outline:none}.toolbar select:focus{border-color:var(--blue)}.sep{width:1px;height:22px;background:var(--brd);flex-shrink:0}.pill{padding:3px 10px;border-radius:12px;font-size:11px;cursor:pointer;border:1px solid;transition:all .15s;white-space:nowrap;user-select:none;font-weight:500}.pill.off{opacity:.2}.pill:hover{opacity:1}.main-wrap{display:flex;flex:1;overflow:hidden;position:relative}.sp-panel{width:0;background:var(--bg2);border-right:1px solid var(--brd);overflow:hidden;transition:width .25s ease;flex-shrink:0;display:flex;flex-direction:column;position:relative;z-index:30}.sp-panel.open{width:380px}.sp-resize{position:absolute;right:-3px;top:0;bottom:0;width:6px;cursor:col-resize;z-index:35;transition:background .15s}.sp-resize:hover,.sp-resize.active{background:var(--blue)}.sp-header{padding:10px 14px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;background:var(--bg2)}.sp-header h3{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}.sp-toolbar{padding:6px 14px;border-bottom:1px solid var(--brd);display:flex;gap:4px;flex-wrap:wrap;flex-shrink:0;background:var(--bg3)}.sp-episodes{flex:1;overflow-y:auto;padding:0}.ep-tree{border-bottom:1px solid var(--brd)}.ep-tree-hdr{padding:8px 14px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:background .12s;user-select:none}.ep-tree-hdr:hover{background:var(--bg3)}.ep-tree-hdr .arrow{font-size:10px;color:var(--tx3);transition:transform .2s;width:12px}.ep-tree-hdr .arrow.open{transform:rotate(90deg)}.ep-tree-hdr .ep-info{flex:1}.ep-tree-hdr .ep-num{font-weight:600;font-size:12px}.ep-tree-hdr .ep-title{font-size:11px;color:var(--tx2);margin-left:6px}.ep-tree-hdr .ep-meta{font-size:10px;color:var(--tx3);font-family:'Courier New',monospace}.ep-tree-body{display:none;padding-left:8px}.ep-tree-body.open{display:block}.scene-card{padding:8px 14px;border-bottom:1px solid rgba(42,42,58,.5);cursor:pointer;transition:background .12s;position:relative}.scene-card:hover{background:var(--bg3)}.scene-card.active{background:var(--bg4);border-left:3px solid var(--blue)}.scene-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.scene-card-title{font-size:12px;font-weight:500}.scene-card-badges{display:flex;gap:4px;align-items:center}.scene-card-badge{font-size:9px;padding:1px 6px;border-radius:8px;background:var(--bg4);color:var(--tx3)}.scene-card-chars{display:flex;gap:3px;margin-top:4px;flex-wrap:wrap}.scene-card-char{width:22px;height:22px;border-radius:50%;background:var(--bg5);font-size:9px;display:flex;align-items:center;justify-content:center;color:var(--tx2);border:1px solid var(--brd)}.scene-card-body{display:none;margin-top:8px;padding-top:8px;border-top:1px solid var(--brd)}.scene-card.expanded .scene-card-body{display:block}.scene-editor{padding:8px}.scene-block{margin-bottom:6px;border-radius:4px;position:relative}.scene-block-action{padding:6px 8px;background:var(--bg3);border:1px solid var(--brd);border-radius:4px;min-height:30px;font-size:12px;color:var(--tx2);line-height:1.5;outline:none}.scene-block-action:focus{border-color:var(--blue);background:var(--bg4)}.scene-block-dialogue{border:1px solid var(--brd);border-radius:4px;overflow:hidden}.scene-block-dialogue .char-line{padding:4px 8px;background:var(--bg4);font-size:11px;font-weight:600;color:var(--blue);display:flex;align-items:center;gap:6px}.scene-block-dialogue .char-line select{padding:2px 6px;font-size:11px;background:var(--bg3);border:1px solid var(--brd);color:var(--tx);border-radius:3px;font-family:inherit}.scene-block-dialogue .paren{padding:2px 8px;font-size:10px;color:var(--tx3);font-style:italic}.scene-block-dialogue .dial-text{padding:6px 8px;background:var(--bg3);min-height:28px;font-size:12px;color:var(--tx);outline:none;line-height:1.5}.scene-block-dialogue .dial-text:focus{background:var(--bg4)}.scene-block-transition{padding:4px 8px;background:var(--bg4);border:1px solid var(--brd);border-radius:4px;text-align:center;font-size:11px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px}.scene-meta-row{display:flex;gap:8px;margin-bottom:6px}.scene-meta-field{flex:1;display:flex;flex-direction:column;gap:2px}.scene-meta-field label{font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;font-weight:500}.scene-meta-field input,.scene-meta-field select{padding:4px 7px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:11px;outline:none;transition:border-color .15s}.scene-meta-field input:focus,.scene-meta-field select:focus{border-color:var(--blue)}.scene-screenplay-wrap{position:relative;margin-bottom:6px}.scene-screenplay-label{font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;font-weight:500;margin-bottom:3px}.scene-screenplay{min-height:120px;max-height:400px;overflow-y:auto;padding:8px 10px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:12px;line-height:1.7;outline:none;white-space:pre-wrap;word-wrap:break-word}.scene-screenplay:focus{border-color:var(--blue);background:var(--bg4)}.scene-screenplay:empty::before{content:attr(data-placeholder);color:var(--tx4);pointer-events:none}.scene-screenplay .mention{color:var(--cyan);font-weight:600;background:rgba(6,182,212,.1);padding:0 3px;border-radius:3px;cursor:default;user-select:all}.mention-popup{position:absolute;left:0;top:0;min-width:180px;max-height:200px;overflow-y:auto;background:var(--bg2);border:1px solid var(--brd2);border-radius:var(--radius);box-shadow:var(--shadow);z-index:100;display:none}.mention-popup.open{display:block}.mention-popup .mp-item{padding:7px 12px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .1s}.mention-popup .mp-item:hover,.mention-popup .mp-item.active{background:var(--bg4);color:var(--cyan)}.mention-popup .mp-item .mp-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.mention-popup .mp-empty{padding:8px 12px;font-size:11px;color:var(--tx4)}.scene-chars-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px}.scene-char-tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:500;border:1px solid var(--brd);background:var(--bg4);color:var(--tx2)}.scene-char-tag .remove-char{cursor:pointer;opacity:.5;font-size:12px;line-height:1}.scene-char-tag .remove-char:hover{opacity:1;color:var(--red)}.scene-block-acts{display:flex;gap:4px;margin-top:4px;padding:4px 0}.scene-block-acts .btn{font-size:10px;padding:3px 7px}.add-scene-btn{padding:8px 14px;display:flex;align-items:center;gap:6px;cursor:pointer;color:var(--tx3);font-size:12px;transition:all .15s;border:none;background:none;width:100%;text-align:left;font-family:inherit}.add-scene-btn:hover{background:var(--bg3);color:var(--blue)}.sp-editor-wrap{flex:1;overflow-y:auto;background:#fff;padding:20px 20px 20px 20px;display:block}.sp-editor-page{width:100%;background:#fff;color:#111;font-family:'Courier New','Courier',monospace;font-size:12pt;line-height:1.2;position:relative;padding:20px 16px 100px 16px}.sp-el{position:relative;margin-bottom:12pt;outline:none;min-height:1em;white-space:pre-wrap;word-wrap:break-word}.sp-el:empty::before{content:attr(data-placeholder);color:#999;pointer-events:none}.sp-el.sp-action{}.sp-el.sp-character{text-transform:uppercase;margin-left:37%;margin-bottom:0}.sp-el.sp-parenthetical{margin-left:31%;margin-right:31%;margin-bottom:0}.sp-el.sp-dialogue{margin-left:25%;margin-right:25%;margin-bottom:0}.sp-el.sp-transition{text-align:right;text-transform:uppercase}.sp-el:focus{background:#f0f7ff;border-radius:2px}.sp-el-type-badge{position:absolute;left:0;top:-14px;font:9px/1 'Inter',sans-serif;color:#888;background:#f5f5f5;padding:2px 6px;border-radius:3px;white-space:nowrap;pointer-events:none}.sp-autocomplete{position:absolute;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,.15);max-height:160px;overflow-y:auto;z-index:100;min-width:180px;display:none}.sp-autocomplete.open{display:block}.sp-autocomplete-item{padding:6px 12px;cursor:pointer;font:12px 'Inter',sans-serif;color:#333}.sp-autocomplete-item.active{background:#3b82f6;color:#fff}.sp-page-break{border-top:1px dashed #ccc;margin:20px 0;position:relative;height:0}.sp-page-break::after{content:attr(data-page);position:absolute;right:10px;top:-10px;font:10px 'Inter',sans-serif;color:#aaa;background:#fff;padding:0 6px}.sp-episode-divider{text-align:left;padding:20px 0;margin:30px 0;border-top:2px solid #333;font:bold 14pt 'Courier New',monospace;color:#333}.sp-editor-page.focus-mode .sp-el:not(:focus){opacity:0.3;transition:opacity .2s}.sp-editor-page.focus-mode .sp-el:focus{opacity:1}.sp-editor-toolbar{background:#f8f8f8;border-bottom:1px solid #ddd;padding:6px 16px;display:flex;align-items:center;gap:8px;flex-shrink:0;font-family:'Inter',sans-serif}.sp-editor-toolbar select,.sp-editor-toolbar button{padding:4px 10px;border:1px solid #ccc;border-radius:4px;background:#fff;font-size:12px;cursor:pointer;color:#333;font-family:'Inter',sans-serif}.sp-editor-toolbar button:hover{background:#e8e8e8}.sp-editor-toolbar button.active{background:#3b82f6;color:#fff;border-color:#3b82f6}.sp-editor-toolbar .sp-tb-sep{width:1px;height:22px;background:#ddd;flex-shrink:0}.sp-el.sp-flash{animation:sp-flash .6s ease}@keyframes sp-flash{0%{background:#bfdbfe}100%{background:transparent}}.sp-scene-header{display:flex;align-items:center;gap:8px;padding:10px 12px;margin-top:24pt;background:#f8f9fa;border:1px solid #e0e0e0;border-radius:6px;font-family:'Inter',sans-serif;font-size:12px;flex-wrap:wrap}.sp-scene-header .sp-scene-num{font-weight:700;font-size:14px;color:#333;min-width:60px;white-space:nowrap}.sp-scene-header select{padding:3px 8px;border:1px solid #ccc;border-radius:4px;font-size:11px;background:#fff;color:#333;font-family:'Inter',sans-serif}.sp-scene-header input{padding:3px 8px;border:1px solid #ccc;border-radius:4px;font-size:11px;background:#fff;color:#333;font-family:'Inter',sans-serif;min-width:100px;flex:1}.sp-scene-header .sp-add-scene-btn{margin-left:auto;font:11px 'Inter',sans-serif;color:#3b82f6;cursor:pointer;background:none;border:1px solid #3b82f6;border-radius:4px;padding:3px 10px;white-space:nowrap}.sp-scene-header .sp-add-scene-btn:hover{background:#3b82f6;color:#fff}.sp-block-actions{display:flex;gap:6px;padding:4px 0;margin-top:4px}.sp-block-actions button{font:11px 'Inter',sans-serif;color:#3b82f6;cursor:pointer;background:none;border:1px dashed #ccc;border-radius:4px;padding:3px 10px}.sp-block-actions button:hover{background:#f0f7ff;border-color:#3b82f6}.screenplay-editor-active #tlA{cursor:default!important;overflow:hidden!important;background:#fff}.screenplay-editor-active #tlC{transform:none!important;display:flex!important;flex-direction:column!important;position:relative!important;height:100%!important;align-items:stretch!important}.tl-area{flex:1;overflow:auto;position:relative;cursor:grab}.tl-area.panning{cursor:grabbing}.tl-container{position:relative;transform-origin:0 0;display:flex;flex-direction:row;align-items:flex-start}.ruler{position:sticky;left:0;z-index:20;width:60px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--brd)}.rtick{position:absolute;left:0;right:0;font-family:'Courier New',Consolas,monospace;font-size:9px;color:var(--tx4);padding-left:4px}.rtick.minor{border-top:1px solid var(--brd)}.rtick.major{border-top:1px solid var(--tx4);color:var(--tx3)}.snap-guide{position:absolute;left:0;right:0;height:1px;background:var(--cyan);z-index:25;pointer-events:none;opacity:0;transition:opacity .1s}.snap-guide.show{opacity:.6}.ep-row{display:flex;flex-direction:column;border-right:1px solid var(--brd);min-width:180px;position:relative}.ep-row:nth-child(even){background:rgba(255,255,255,.008)}.ep-hdr{height:60px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg2);border-bottom:1px solid var(--brd);position:sticky;top:0;z-index:10;gap:2px;width:100%}.ep-hdr .num{font-size:22px;font-weight:700}.ep-hdr .sub{font-size:9px;color:var(--tx3);font-weight:500}.ep-hdr .dur{font-family:'Courier New',monospace;font-size:9px;color:var(--tx4);margin-top:2px}.ep-body{position:relative;flex-shrink:0}.gl{position:absolute;left:0;right:0;height:1px;pointer-events:none}.gl.mi{background:rgba(255,255,255,.025)}.gl.ma{background:rgba(255,255,255,.07)}.heatmap-bar{position:absolute;right:0;width:3px;pointer-events:none;border-radius:1px;opacity:.6}.evb{position:absolute;border-radius:var(--radius);z-index:5;display:flex;flex-direction:column;align-items:flex-start;padding:6px 8px;overflow:hidden;cursor:grab;user-select:none;border:1px solid;transition:box-shadow .15s,transform .1s;font-size:12px;font-weight:500}.evb:hover{z-index:15;box-shadow:0 4px 20px rgba(0,0,0,.5);transform:scale(1.02)}.evb.selected{box-shadow:0 0 0 2px var(--cyan)!important;z-index:16}.evb.drag{opacity:.85;z-index:50;box-shadow:0 8px 32px rgba(0,0,0,.7);cursor:grabbing;transform:scale(1.04)}.evb.ghost{opacity:.3!important;pointer-events:none;z-index:4}.evb.dim{opacity:.1!important}.evb.hl{box-shadow:0 0 0 2px rgba(255,255,255,.5)!important;z-index:16}.evb.warn-hl{box-shadow:0 0 0 2px var(--orange),0 0 16px rgba(249,115,22,.5)!important;z-index:20;opacity:1!important}.evb.collision{box-shadow:0 0 0 2px var(--red)!important}.evb.impact-1{box-shadow:0 0 0 2px var(--red),0 0 12px rgba(239,68,68,.4)!important;z-index:17}.evb.impact-2{box-shadow:0 0 0 2px var(--orange),0 0 12px rgba(249,115,22,.3)!important;z-index:17}.evb.impact-3{box-shadow:0 0 0 2px var(--yellow),0 0 12px rgba(245,158,11,.2)!important;z-index:17}.evb .etxt{white-space:normal;word-break:break-word;line-height:1.3;overflow:hidden;pointer-events:none;flex:1}.evb .scene-link{font-size:10px;opacity:.5;margin-left:4px;pointer-events:none}.evb .rh{position:absolute;left:0;height:7px;width:100%;cursor:ns-resize;z-index:6}.evb .rh:hover{background:rgba(255,255,255,.15)}.evb .rh.l{top:0;border-radius:var(--radius) var(--radius) 0 0}.evb .rh.r{bottom:0;border-radius:0 0 var(--radius) var(--radius)}.ep-body.drop-target{background:rgba(59,130,246,.06)!important;outline:2px dashed var(--blue);outline-offset:-2px}.rpanel{width:0;background:var(--bg2);border-left:1px solid var(--brd);overflow:hidden;transition:width .2s ease;flex-shrink:0;display:flex;flex-direction:column}.rpanel.open{width:320px}.rpanel-hdr{padding:10px 14px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;background:var(--bg2);z-index:2}.rpanel-hdr h3{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}.rpanel-body{flex:1;overflow-y:auto}.close-btn{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:16px;padding:4px;border-radius:4px;line-height:1}.close-btn:hover{color:var(--tx);background:var(--bg4)}.rtabs{display:flex;border-bottom:1px solid var(--brd);background:var(--bg3);flex-shrink:0}.rtab{flex:1;padding:8px 6px;text-align:center;font-size:10px;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;font-family:inherit;background:none;border-top:none;border-left:none;border-right:none}.rtab:hover{color:var(--tx2)}.rtab.active{color:var(--tx);border-bottom-color:var(--blue)}.wi{padding:10px 14px;border-bottom:1px solid var(--brd);cursor:pointer;transition:background .12s}.wi:hover{background:var(--bg3)}.wi.active{background:var(--bg4);border-left:3px solid var(--orange)}.wi .wt{font-size:12px;font-weight:500;margin-bottom:3px}.wi .wd{font-size:11px;color:var(--tx3);line-height:1.4}.wi .wf{margin-top:6px;display:flex;gap:4px}.nw{padding:20px 14px;text-align:center;color:var(--tx3);font-size:12px}.fg{margin-bottom:10px}.fg label{display:block;font-size:10px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;font-weight:500}.fg input,.fg textarea,.fg select{width:100%;padding:6px 8px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:12px;outline:none;transition:border-color .15s}.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--blue)}.fg textarea{resize:vertical;min-height:50px}.chw{display:flex;flex-wrap:wrap;gap:4px}.chcb{display:flex;align-items:center;gap:3px;font-size:11px;color:var(--tx2);cursor:pointer}.chcb input{width:auto;margin:0}.epf{padding:10px 14px;border-top:1px solid var(--brd);display:flex;gap:6px;flex-shrink:0;background:var(--bg2)}.epc{margin-top:10px;padding-top:10px;border-top:1px solid var(--brd)}.eci{display:flex;align-items:center;justify-content:space-between;padding:4px 0;font-size:11px;color:var(--tx2)}.char-row{padding:8px 14px;border-bottom:1px solid var(--brd);cursor:pointer;transition:background .12s}.char-row:hover{background:var(--bg3)}.char-bar{height:6px;border-radius:3px;margin-top:4px;transition:width .3s}.tempo-row{display:flex;align-items:center;gap:8px;padding:6px 14px;border-bottom:1px solid var(--brd);font-size:11px}.tempo-bar{flex:1;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden}.tempo-fill{height:100%;border-radius:4px;transition:width .3s}.impact-info{padding:14px;background:var(--bg3);border-radius:var(--radius);margin:10px 14px;font-size:12px;line-height:1.6}.statusbar{height:28px;background:var(--bg2);border-top:1px solid var(--brd);display:flex;align-items:center;padding:0 16px;gap:16px;font-size:11px;color:var(--tx3);flex-shrink:0;z-index:40}.statusbar .st-item{display:flex;align-items:center;gap:4px}.statusbar .st-sep{width:1px;height:14px;background:var(--brd)}.statusbar .st-warn{color:var(--orange);cursor:pointer}.statusbar .st-warn:hover{color:var(--yellow)}.ttp{position:fixed;background:var(--bg4);border:1px solid var(--brd2);border-radius:var(--radius);padding:10px 14px;z-index:200;pointer-events:none;max-width:300px;box-shadow:var(--shadow);display:none;font-size:12px}.ttp.show{display:block}.ttp .tt{font-weight:600;margin-bottom:4px}.ttp .td{color:var(--tx2);font-size:11px;line-height:1.5}.ttp .tm{font-family:'Courier New',monospace;font-size:10px;color:var(--tx3);margin-top:4px}.ctx-menu{position:fixed;background:var(--bg3);border:1px solid var(--brd2);border-radius:var(--radius);z-index:250;min-width:180px;box-shadow:var(--shadow);padding:4px 0;display:none}.ctx-menu.show{display:block}.ctx-item{padding:7px 14px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--tx2);transition:all .1s}.ctx-item:hover{background:var(--bg4);color:var(--tx)}.ctx-item.danger{color:var(--red)}.ctx-item.danger:hover{background:rgba(239,68,68,.1)}.ctx-sep{height:1px;background:var(--brd);margin:4px 0}.mbg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px)}.mbg.open{display:flex}.mdl{background:var(--bg2);border:1px solid var(--brd);border-radius:8px;width:480px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.6)}.mh{padding:14px 16px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center;font-size:14px;font-weight:600}.mb{padding:16px}.mf{padding:12px 16px;border-top:1px solid var(--brd);display:flex;justify-content:flex-end;gap:6px}.tbox{position:fixed;bottom:44px;left:50%;transform:translateX(-50%);z-index:400;display:flex;flex-direction:column;gap:6px;align-items:center}.tst{padding:8px 16px;background:var(--bg4);border:1px solid var(--brd2);border-radius:var(--radius);font-size:12px;box-shadow:var(--shadow);animation:toast-in .25s ease,toast-out .25s ease 2.3s forwards;white-space:nowrap}@keyframes toast-in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes toast-out{from{opacity:1}to{opacity:0;transform:translateY(-6px)}}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--brd2)}.sync-bar{display:none;align-items:center;gap:8px;margin-right:8px}.sync-bar.active{display:flex}.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:background .3s}.sync-dot.connected{background:var(--green)}.sync-dot.connecting{background:var(--yellow);animation:syncPulse 1s infinite}.sync-dot.disconnected{background:var(--red)}@keyframes syncPulse{0%,100%{opacity:1}50%{opacity:.4}}.sync-status-text{font-size:10px;color:var(--tx3);white-space:nowrap}.presence-bar{display:flex;align-items:center;gap:4px}.presence-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;cursor:default;border:2px solid var(--bg2);position:relative;flex-shrink:0;transition:transform .15s}.presence-avatar:hover{transform:scale(1.15);z-index:1}.presence-avatar .pa-tip{display:none;position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);background:var(--bg4);color:var(--tx);font-size:10px;padding:2px 8px;border-radius:4px;white-space:nowrap;pointer-events:none;z-index:99}.presence-avatar:hover .pa-tip{display:block}.room-code{font-family:'Courier New',monospace;font-size:12px;color:var(--cyan);background:var(--bg);padding:3px 8px;border-radius:4px;border:1px solid var(--brd);cursor:pointer;letter-spacing:1px;font-weight:600;transition:all .15s}.room-code:hover{background:var(--bg3);border-color:var(--cyan)}.btn-leave{background:var(--red);border-color:var(--red);color:#fff;font-size:11px;padding:5px 10px}.btn-leave:hover{background:#dc2626;border-color:#dc2626}.sync-modal-body{display:flex;gap:16px;margin-top:12px}.sync-modal-col{flex:1;background:var(--bg);border:1px solid var(--brd);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:10px}.sync-modal-col h3{font-size:13px;color:var(--tx2);margin-bottom:4px}.sync-modal-col input{width:100%;padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:13px;outline:none}.sync-modal-col input:focus{border-color:var(--blue)}.sync-modal-col .btn{width:100%;justify-content:center;margin-top:4px}.sync-name-row{margin-bottom:8px}.sync-name-row label{font-size:11px;color:var(--tx3);display:block;margin-bottom:4px}.sync-name-row input{width:100%;padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:13px;outline:none}.sync-name-row input:focus{border-color:var(--blue)}.sync-info{font-size:11px;color:var(--tx3);line-height:1.5;margin-top:8px}.sync-room-info{background:var(--bg);border:1px solid var(--brd);border-radius:var(--radius);padding:12px;margin-top:12px;display:flex;flex-direction:column;gap:8px}.sync-room-info .room-code{font-size:16px;text-align:center;display:block;padding:8px;letter-spacing:2px}#projectsScreen{position:fixed;inset:0;background:var(--bg);z-index:500;overflow-y:auto}.ps-inner{max-width:720px;margin:0 auto;padding:48px 24px}.ps-header{text-align:center;margin-bottom:32px}.ps-header h1{font-size:24px;font-weight:700}.ps-header p{font-size:13px;color:var(--tx3);margin-top:6px}.ps-actions{display:flex;gap:8px;justify-content:center;margin-bottom:32px;flex-wrap:wrap}.ps-list{display:grid;grid-template-columns:1fr 1fr;gap:12px}.ps-card{background:var(--bg2);border:1px solid var(--brd);border-radius:8px;padding:16px;cursor:pointer;transition:all .15s}.ps-card:hover{border-color:var(--blue);background:var(--bg3)}.ps-card-title{font-size:15px;font-weight:600;margin-bottom:6px}.ps-card-stats{font-size:11px;color:var(--tx2);margin-bottom:4px}.ps-card-date{font-size:10px;color:var(--tx3)}.ps-card-actions{display:flex;gap:6px;margin-top:10px}.ps-empty{text-align:center;color:var(--tx3);padding:40px 0;font-size:13px;grid-column:1/-1}.cl-entry{padding:8px 14px;border-bottom:1px solid var(--brd)}.cl-entry:hover{background:var(--bg3)}.cl-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}.cl-user{font-size:11px;font-weight:600}.cl-time{font-size:10px;color:var(--tx3)}.cl-desc{font-size:11px;color:var(--tx2)}.notes-compose{padding:10px 14px;border-bottom:1px solid var(--brd);background:var(--bg3)}.notes-compose textarea{width:100%;min-height:60px;padding:8px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg);color:var(--tx);font-family:inherit;font-size:12px;resize:vertical;outline:none}.notes-compose textarea:focus{border-color:var(--blue)}.notes-compose .notes-compose-bar{display:flex;justify-content:flex-end;margin-top:6px}.note-item{padding:10px 14px;border-bottom:1px solid var(--brd)}.note-item:hover{background:var(--bg3)}.note-hdr{display:flex;align-items:center;gap:6px;margin-bottom:4px}.note-author{font-size:11px;font-weight:600}.note-time{font-size:10px;color:var(--tx3);flex:1}.note-actions{display:flex;gap:4px}.note-text{font-size:12px;color:var(--tx2);white-space:pre-wrap;word-break:break-word}.ai-spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--brd2);border-top-color:var(--purple);border-radius:50%;animation:aiSpin .6s linear infinite;vertical-align:middle;margin-right:6px}@keyframes aiSpin{to{transform:rotate(360deg)}}.ai-feature-btn{width:100%;text-align:left;padding:8px 12px;margin-bottom:4px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx2);font-family:inherit;font-size:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:8px}.ai-feature-btn:hover{background:var(--bg4);color:var(--tx);border-color:var(--purple)}.ai-feature-btn:disabled{opacity:.5;cursor:not-allowed}.ai-response-stream{background:var(--bg);border:1px solid var(--brd);border-radius:var(--radius);padding:12px;margin-top:8px;font-family:'Courier New',monospace;font-size:12px;color:var(--tx2);line-height:1.6;max-height:400px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}.ai-tab-bar{display:flex;gap:2px;background:var(--bg);border-radius:var(--radius);padding:2px;border:1px solid var(--brd);margin-bottom:8px}.ai-tab{flex:1;padding:6px 8px;border-radius:4px;font-size:11px;cursor:pointer;color:var(--tx3);border:none;background:none;font-family:inherit;transition:all .15s;text-align:center}.ai-tab.active{background:var(--bg4);color:var(--tx)}.ai-tab:hover:not(.active){color:var(--tx2)}.ai-config-section{padding:10px 0;border-top:1px solid var(--brd);margin-top:8px}.ai-config-section label{font-size:11px;color:var(--tx3);display:block;margin-bottom:4px}.ai-msg{padding:8px 12px;margin-bottom:6px;border-radius:var(--radius);font-size:12px;line-height:1.5}.ai-msg.user{background:var(--bg4);color:var(--tx);border:1px solid var(--brd)}.ai-msg.assistant{background:linear-gradient(135deg,rgba(168,85,247,.08),rgba(59,130,246,.08));color:var(--tx2);border:1px solid rgba(168,85,247,.2)}@media(max-width:1200px){.topbar{padding:6px 10px}.logo span{display:none}.tba .sep{display:none}.btn{padding:6px 10px;font-size:11px}.btn-icon{padding:5px 7px;font-size:13px}.view-mode{padding:4px 10px;font-size:10px}#zLvl{display:none}.toolbar{padding:4px 10px;gap:6px}.pill{padding:2px 8px;font-size:10px}}@media(max-width:768px){.ps-list{grid-template-columns:1fr}.ps-inner{padding:24px 16px}.sync-bar{gap:4px;margin-right:4px}.sync-status-text{display:none}.presence-avatar{width:22px;height:22px;font-size:9px}.room-code{font-size:10px;padding:2px 6px}.sync-modal-body{flex-direction:column}.topbar{min-height:auto;padding:8px 10px;gap:6px}.logo{width:100%;justify-content:space-between}.logo h1{font-size:14px}.logo span{display:none}.view-modes{order:1}.tba{order:2;width:100%;flex-wrap:wrap;gap:4px;justify-content:flex-start}.tba .sep{display:none}.tba .btn{padding:6px 8px;font-size:11px}.tba .btn-icon{padding:5px 7px;font-size:12px}#zLvl{display:none}.toolbar{padding:4px 10px;gap:6px;min-height:36px}.toolbar label{font-size:9px}.toolbar select{padding:3px 6px;font-size:11px}#catP{display:none!important}.main-wrap{flex-direction:column}.sp-panel{width:100%!important;max-height:50vh;border-right:none;border-bottom:1px solid var(--brd);z-index:35}.sp-panel.open{width:100%!important}.sp-resize{display:none}.tl-area{flex:1;min-height:200px;-webkit-overflow-scrolling:touch}.rpanel{position:fixed;bottom:0;left:0;right:0;width:100%!important;max-height:60vh;border-left:none;border-top:1px solid var(--brd);z-index:60;border-radius:12px 12px 0 0}.rpanel.open{width:100%!important}.evb{font-size:11px;min-height:40px}.evb .rh{height:12px}.ep-hdr{height:50px}.ep-hdr .num{font-size:18px}.ep-hdr .sub{font-size:8px}.ep-hdr .dur{font-size:8px}.ruler{width:44px}.scene-card{padding:8px 10px}.scene-meta-row{flex-direction:column;gap:4px}.scene-meta-field{flex:1 1 100%!important}.scene-screenplay{min-height:100px;font-size:13px}.mdl{width:calc(100% - 16px)!important;max-width:100%;max-height:calc(100vh - 40px);border-radius:10px;margin:8px}.mbg{align-items:center;padding:0}.statusbar{height:auto;padding:4px 10px;flex-wrap:wrap;gap:4px 10px;font-size:10px}.statusbar .st-sep{display:none}#stProj{display:none}.tbox{bottom:80px;left:10px;right:10px;transform:none}.ttp{display:none!important}.ctx-menu{position:fixed;bottom:0;left:0;right:0;top:auto;border-radius:12px 12px 0 0;min-width:100%;max-height:60vh;overflow-y:auto}.mention-popup{max-height:150px}.mention-popup .mp-item{padding:10px 14px;font-size:13px}::-webkit-scrollbar{width:3px;height:3px}}@media(max-width:400px){.topbar{padding:6px 8px}.tba .btn{padding:5px 6px;font-size:10px}.view-mode{padding:4px 8px;font-size:10px}.sp-panel.open{max-height:45vh}.ep-hdr{height:40px}.ep-hdr .num{font-size:15px}.ep-hdr .sub,.ep-hdr .dur{display:none}.ruler{width:36px}.evb{font-size:10px;padding:4px 6px}}@media print{.topbar,.toolbar,.sp-panel,.rpanel,.ttp,.mbg,.tbox,.statusbar,.ctx-menu{display:none!important}.main-wrap{overflow:visible!important}.tl-area{overflow:visible!important;cursor:default!important}.tl-container{transform:none!important}body{background:#fff;color:#111;overflow:visible;height:auto}.ep-hdr{background:#f5f5f5!important;color:#111}.ep-hdr .num,.ep-hdr .sub,.ep-hdr .dur{color:#111!important}.ep-row{border-color:#ccc!important}.evb{border-width:2px!important;font-weight:600!important;color:#111!important}.gl.ma{background:rgba(0,0,0,.12)!important}.gl.mi{background:rgba(0,0,0,.05)!important}.ruler{background:#f5f5f5!important;border-color:#ccc!important}.rtick{color:#666!important;border-color:#999!important}}.auth-tabs{display:flex;gap:2px;background:var(--bg);border-radius:var(--radius);padding:2px;border:1px solid var(--brd);margin-bottom:20px}.auth-tab{flex:1;padding:8px;border:none;background:none;color:var(--tx3);cursor:pointer;font-family:inherit;font-size:13px;border-radius:4px;transition:all .15s}.auth-tab.active{background:var(--bg4);color:var(--tx)}.auth-form{max-width:360px;margin:0 auto}.auth-form input{width:100%;padding:10px 12px;margin-bottom:10px;border:1px solid var(--brd);border-radius:var(--radius);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:13px;outline:none}.auth-form input:focus{border-color:var(--blue)}.auth-form .btn{width:100%;padding:10px;margin-top:4px}.auth-error{color:var(--red);font-size:12px;margin-bottom:8px;display:none}.user-info{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--tx2)}.user-avatar{width:28px;height:28px;border-radius:50%;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}.readonly-mode .sp-add-scene-btn,.readonly-mode .sp-block-actions,.readonly-mode .btn-p[onclick*="addEvent"],.readonly-mode .btn-p[onclick*="addScene"],.readonly-mode #tb{display:none !important}.readonly-mode .sp-scene-header select,.readonly-mode .sp-scene-header input{pointer-events:none;opacity:.7}.readonly-badge{background:var(--orange);color:#fff;font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600;display:none}.readonly-mode .readonly-badge{display:inline-block}.ps-card-role{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}.ps-card-role.owner{background:var(--blue);color:#fff}.ps-card-role.editor{background:var(--green);color:#fff}.ps-card-role.viewer{background:var(--orange);color:#fff}.member-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--brd)}.member-row:last-child{border:none}.member-email{flex:1;font-size:12px;color:var(--tx)}.member-role{font-size:11px;color:var(--tx2)}.rm-toolbar{height:40px;background:var(--bg2);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:4px 16px;gap:8px;flex-shrink:0;z-index:10;position:relative}.rm-node{transition:opacity .2s}.rm-node:hover{opacity:1}.rm-node:hover>circle:not(.rm-glow){filter:brightness(1.15)}.rm-edge path{transition:stroke-opacity .2s}.rm-edge:hover path:nth-child(2){stroke-opacity:0.8!important}.rm-edge.selected path:nth-child(2){stroke-opacity:0.95!important}.export-tab{flex:1;padding:8px;border:none;background:none;color:var(--tx3);cursor:pointer;font-family:inherit;font-size:12px;border-radius:4px;transition:all .15s;text-align:center}.export-tab.active{background:var(--bg4);color:var(--tx)}.export-tab:hover:not(.active){color:var(--tx2)}.review-mode-active #reviewToggleBtn{background:var(--green);border-color:var(--green);color:#fff}.track-add{border-bottom:2px solid var(--green);background:rgba(16,185,129,.1);border-radius:2px}.track-del{text-decoration:line-through;color:var(--red);opacity:.7}.review-comment{background:rgba(255,255,0,.15);border-bottom:2px solid var(--yellow);border-radius:2px;cursor:pointer}.review-panel-entry{transition:background .12s}.review-panel-entry:hover{background:var(--bg3)}.review-mode-active .sp-editor-toolbar::after{content:'Ä°NCELEME MODU';font-size:10px;color:var(--green);font-weight:600;letter-spacing:1px;margin-left:auto}.review-mode-active .scene-screenplay{border-color:var(--green)!important}
</style>
</head>
<body>
<noscript><div style="color:var(--red);background:var(--bg2);padding:24px;margin:20px;font-size:16px;border:2px solid var(--red);border-radius:8px;">JavaScript devre dÄ±ÅŸÄ±. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan JavaScript'i etkinleÅŸtirin.</div></noscript>
<div id="loadMsg" style="color:var(--tx2);padding:20px;font-size:14px;">YÃ¼kleniyor...</div>

<div id="authScreen" style="display:none;">
  <div class="ps-inner">
    <div class="ps-header">
      <h1>Senaryo Timeline EditÃ¶rÃ¼</h1>
      <p>GiriÅŸ yapÄ±n veya hesap oluÅŸturun</p>
    </div>
    <div class="auth-tabs" role="tablist" aria-label="Kimlik doÄŸrulama sekmeleri">
      <button class="auth-tab active" onclick="App.Auth.switchTab('login')" data-tab="login" role="tab" aria-selected="true" aria-controls="authLoginForm">GiriÅŸ Yap</button>
      <button class="auth-tab" onclick="App.Auth.switchTab('register')" data-tab="register" role="tab" aria-selected="false" aria-controls="authRegisterForm">KayÄ±t Ol</button>
    </div>
    <div class="auth-form" id="authLoginForm" role="tabpanel" aria-labelledby="authLoginForm">
      <div class="auth-error" id="loginError"></div>
      <input type="email" id="loginEmail" placeholder="E-posta adresi" onkeydown="if(event.key==='Enter')App.Auth.doLogin()" />
      <input type="password" id="loginPass" placeholder="Parola" onkeydown="if(event.key==='Enter')App.Auth.doLogin()" />
      <button class="btn btn-p" onclick="App.Auth.doLogin()">GiriÅŸ Yap</button>
    </div>
    <div class="auth-form" id="authRegisterForm" style="display:none;" role="tabpanel" aria-labelledby="authRegisterForm">
      <div class="auth-error" id="registerError"></div>
      <input type="text" id="regName" placeholder="AdÄ±nÄ±z" />
      <input type="email" id="regEmail" placeholder="E-posta adresi" />
      <input type="password" id="regPass" placeholder="Parola (min 6 karakter)" onkeydown="if(event.key==='Enter')App.Auth.doRegister()" />
      <button class="btn btn-p" onclick="App.Auth.doRegister()">KayÄ±t Ol</button>
    </div>
  </div>
</div>

<div id="projectsScreen" style="display:none;">
  <div class="ps-inner">
    <div class="ps-header">
      <h1>Senaryo Timeline EditÃ¶rÃ¼</h1>
      <p>Projelerinizi yÃ¶netin</p>
    </div>
    <div class="ps-actions">
      <button class="btn btn-p" onclick="App.Projects.create()">+ Yeni Proje</button>
      <button class="btn" onclick="App.Projects.loadDemoAsProject()">Demo Proje</button>
      <button class="btn" onclick="document.getElementById('psFIn').click()">â†‘ JSON YÃ¼kle</button>
      <input type="file" id="psFIn" accept=".json" style="display:none" onchange="App.Projects.handleImport(event)">
    </div>
    <div class="ps-list" id="psList"></div>
  </div>
</div>

<div class="app" id="appRoot" style="display:none;">
  <div class="topbar">
    <div class="logo">
      <h1 id="projTitle" onclick="App.Panels.openSettings()">Yeni Proje</h1>
      <span id="projSub">Senaryo Timeline EditÃ¶rÃ¼</span>
      <button class="btn" onclick="App.Projects.goBack()" title="Proje listesine dÃ¶n">ğŸ“‚ Projeler</button>
    </div>
    <div class="view-modes">
      <button class="view-mode" data-vm="screenplay" onclick="App.setViewMode('screenplay')">Senaryo</button>
      <button class="view-mode active" data-vm="split" onclick="App.setViewMode('split')">BÃ¶lÃ¼nmÃ¼ÅŸ</button>
      <button class="view-mode" data-vm="timeline" onclick="App.setViewMode('timeline')">Timeline</button>
      <button class="view-mode" data-vm="iliskiler" onclick="App.setViewMode('iliskiler')">Ä°liÅŸkiler</button>
    </div>
    <div class="sync-bar" id="syncBar">
      <span class="sync-dot connected" id="syncDot"></span>
      <span class="sync-status-text" id="syncStatusText" role="status"></span>
      <div class="presence-bar" id="presenceBar"></div>
    </div>
    <div class="tba">
      <span class="readonly-badge">Sadece Okuma</span>
      <div class="user-info" id="userInfo" style="display:none;cursor:pointer;" onclick="App.Auth.openProfileModal()" title="Profili dÃ¼zenle">
        <div class="user-avatar" id="userAvatar"></div>
        <span id="userDisplayName"></span>
      </div>
      <button class="btn" id="shareBtn" onclick="App.Projects.openShareModal()" style="display:none;">PaylaÅŸ</button>
      <button class="btn" id="logoutBtn" onclick="App.Auth.logout()" style="display:none;">Ã‡Ä±kÄ±ÅŸ</button>
      <button class="btn" onclick="App.Projects.save();App.UI.toast('Kaydedildi')" title="Projeyi Kaydet (Ctrl+S)">ğŸ’¾ Kaydet</button>
      <div class="sep"></div>
      <button class="btn btn-icon" onclick="App.Store.undo()" title="Geri Al (Ctrl+Z)" aria-label="Geri Al">â†©</button>
      <button class="btn btn-icon" onclick="App.Store.redo()" title="Yinele (Ctrl+Y)" aria-label="Yinele">â†ª</button>
      <div class="sep"></div>
      <button class="btn" onclick="App.Timeline.zoomOut()" aria-label="UzaklaÅŸtÄ±r">âˆ’</button>
      <span id="zLvl" style="font-size:10px;color:var(--tx3);font-family:monospace;min-width:36px;text-align:center">100%</span>
      <button class="btn" onclick="App.Timeline.zoomIn()" aria-label="YakÄ±nlaÅŸtÄ±r">+</button>
      <button class="btn" onclick="App.Timeline.zoomReset()">SÄ±ÄŸdÄ±r</button>
      <div class="sep"></div>
      <button class="btn" onclick="document.getElementById('fIn').click()">â†‘ YÃ¼kle</button>
      <button class="btn" onclick="App.Export.openExportModal()">â†“ DÄ±ÅŸa Aktar</button>
      <button class="btn" id="reviewToggleBtn" onclick="App.Review.toggleReviewMode()" title="Ä°nceleme Modu (Track Changes)">Ä°nceleme</button>
      <button class="btn" onclick="App.Panels.openSettings()" aria-label="Ayarlar">âš™</button>
      <button class="btn btn-p" onclick="App.Panels.openAddEvent()">+ Olay</button>
      <input type="file" id="fIn" accept=".json" style="display:none" onchange="App.IO.importJSON(event)">
    </div>
  </div>

  <div class="toolbar" id="tb">
    <label>BÃ¶lÃ¼m</label>
    <select id="fEp" onchange="App.Timeline.doFilter()"><option value="all">TÃ¼mÃ¼</option></select>
    <label>Karakter</label>
    <select id="fCh" onchange="App.Timeline.doFilter()"><option value="all">TÃ¼mÃ¼</option></select>
    <div class="sep"></div>
    <label>Snap</label>
    <select id="snapSel" onchange="App.Interaction.setSnap(+this.value)">
      <option value="0">KapalÄ±</option>
      <option value="5">5sn</option>
      <option value="10" selected>10sn</option>
      <option value="15">15sn</option>
      <option value="30">30sn</option>
      <option value="60">60sn</option>
    </select>
    <div class="sep"></div>
    <div id="catP" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
    <div class="sep"></div>
    <button class="btn btn-s" id="wBtn" onclick="App.Panels.togglePanel('warn')">âš  UyarÄ±lar <span class="badge" id="wBdg" style="display:none">0</span></button>
    <button class="btn btn-s" onclick="App.Panels.togglePanel('analysis')">â— Analiz</button>
    <button class="btn btn-s" onclick="App.Panels.togglePanel('changelog')">ğŸ“‹ GÃ¼nlÃ¼k</button>
    <button class="btn btn-s" onclick="App.Panels.togglePanel('notes')">ğŸ“Œ Notlar</button>
    <button class="btn btn-s" onclick="App.Panels.togglePanel('ai')" style="background:linear-gradient(135deg,#a855f7,#3b82f6);border-color:transparent;color:#fff;">âœ¦ AI Asistan</button>
    <button class="btn btn-s" onclick="App.Panels.togglePanel('review')">âœ Ä°nceleme</button>
  </div>

  <div class="main-wrap">
    <div class="sp-panel" id="spPanel">
      <div class="sp-resize" id="spResize"></div>
      <div class="sp-header">
        <h3>ğŸ“ Senaryo</h3>
        <button class="close-btn" onclick="App.setViewMode('timeline')">âœ•</button>
      </div>
      <div class="sp-toolbar">
        <button class="btn btn-s" onclick="App.Screenplay.addEpisode()">+ BÃ¶lÃ¼m</button>
        <button class="btn btn-s" onclick="document.getElementById('docxIn').click()">ğŸ“„ DOCX</button>
        <input type="file" id="docxIn" accept=".docx" style="display:none" onchange="App.IO.handleDocx(event)">
      </div>
      <div class="sp-episodes" id="spEpisodes"></div>
    </div>

    <div class="tl-area" id="tlA">
      <div class="tl-container" id="tlC"></div>
    </div>

    <div class="rpanel" id="rPanel"></div>
  </div>

  <div class="statusbar" id="statusbar" role="status">
    <div class="st-item" id="stProj">Proje: Yeni Proje</div>
    <div class="st-sep"></div>
    <div class="st-item" id="stEps">0 bÃ¶lÃ¼m</div>
    <div class="st-sep"></div>
    <div class="st-item" id="stScenes">0 sahne</div>
    <div class="st-sep"></div>
    <div class="st-item" id="stEvents">0 olay</div>
    <div class="st-sep"></div>
    <div class="st-item" id="stDur">00:00</div>
    <div style="flex:1"></div>
    <div class="st-item st-warn" id="stWarn" onclick="App.Panels.togglePanel('warn')"></div>
    <div class="st-item" id="stSel"></div>
    <div class="st-item" id="stSyncStatus" style="font-size:11px;"></div>
    <div class="st-item" id="stSync" style="display:none"></div>
  </div>
</div>

<div class="ttp" id="ttp"></div>
<div class="ctx-menu" id="ctxMenu"></div>
<div class="mbg" id="mbg" role="dialog" aria-modal="true" onclick="if(event.target===this)App.UI.closeModal()"><div class="mdl" id="mdl"></div></div>
<div class="tbox" id="tbox" aria-live="polite"></div>

<script>
// â”€â”€ bootstrap.js â”€â”€
// â”€â”€ Global Error Handlers â”€â”€
window.onerror = function(msg, src, line, col, err) {
  console.error('[Global Error]', msg, 'at', src, line + ':' + col, err);
  if(window.App && App.UI && App.UI.toast) {
    App.UI.toast('Beklenmeyen hata: ' + (msg || 'Bilinmeyen hata').toString().substring(0, 100));
  }
  return false;
};
window.addEventListener('unhandledrejection', function(e) {
  console.error('[Unhandled Promise]', e.reason);
  if(window.App && App.UI && App.UI.toast) {
    var msg = (e.reason && e.reason.message) ? e.reason.message : String(e.reason);
    App.UI.toast('Async hata: ' + msg.substring(0, 100));
  }
});
// â”€â”€ Network Connectivity Detection â”€â”€
(function(){
  var _wasOffline = false;
  window.addEventListener('offline', function() {
    _wasOffline = true;
    if(window.App && App.UI && App.UI.toast) App.UI.toast('Ä°nternet baÄŸlantÄ±sÄ± kesildi! DeÄŸiÅŸiklikler kaydedilmeyecek.');
    var bar = document.getElementById('statusbar');
    if(bar) bar.style.borderTop = '2px solid var(--red)';
  });
  window.addEventListener('online', function() {
    if(_wasOffline) {
      _wasOffline = false;
      if(window.App && App.UI && App.UI.toast) App.UI.toast('Ä°nternet baÄŸlantÄ±sÄ± yeniden kuruldu.');
      var bar = document.getElementById('statusbar');
      if(bar) bar.style.borderTop = '';
    }
  });
})();

// â”€â”€ AI localStorage cleanup (one-time migration v2) â”€â”€
(function(){
  const migrated = localStorage.getItem('ai_migrated_v2');
  if(!migrated) {
    localStorage.removeItem('ai_provider');
    localStorage.removeItem('ai_model');
    localStorage.setItem('ai_migrated_v2', '1');
  }
  const m = localStorage.getItem('ai_model');
  if(m && (m.includes('claude-sonnet-4-2025') || m.includes('claude-haiku-4-2025') || m === 'gpt-4o' || m === 'gpt-4o-mini' || m.includes('gemini-2.0-flash-lite'))) localStorage.removeItem('ai_model');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SENARYO TIMELINE EDITÃ–RÃœ â€” MODÃœLER MÄ°MARÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App = {};

// â•â•â• FIREBASE CONFIG â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyDwrB0ghEJUZRI6p5AuCGwobdsof9nhESQ",
  authDomain: "senaryo-7e7fb.firebaseapp.com",
  databaseURL: "https://senaryo-7e7fb-default-rtdb.firebaseio.com",
  projectId: "senaryo-7e7fb",
  storageBucket: "senaryo-7e7fb.firebasestorage.app",
  messagingSenderId: "1092333524437",
  appId: "1:1092333524437:web:31cec6e577c127abc5d95c"
};

/*
 * â•â•â• FIREBASE SECURITY RULES â•â•â•
 * Deploy these rules in Firebase Console â†’ Realtime Database â†’ Rules
 * NOT: Multi-path update iÃ§in newData bazlÄ± kontroller eklendi.
 * Firebase multi-path update atomiktir â€” tÃ¼m path'ler tek seferde yazÄ±lÄ±r.
 * newData.parent().child('owner') ile yazÄ±lacak owner deÄŸeri kontrol edilir.
 *
 * {
 *   "rules": {
 *     "users": {
 *       "$uid": {
 *         ".read": "auth != null && auth.uid === $uid",
 *         ".write": "auth != null && auth.uid === $uid"
 *       }
 *     },
 *     "projects": {
 *       "$projectId": {
 *         ".read": "auth != null && (data.child('members/' + auth.uid).exists() || data.child('owner').val() === auth.uid)",
 *         ".write": "auth != null && data.exists() && data.child('owner').val() === auth.uid && !newData.exists()",
 *         "data": {
 *           ".write": "auth != null && (root.child('projects/' + $projectId + '/owner').val() === auth.uid || newData.parent().child('owner').val() === auth.uid || root.child('projects/' + $projectId + '/members/' + auth.uid + '/role').val() === 'owner' || root.child('projects/' + $projectId + '/members/' + auth.uid + '/role').val() === 'editor')"
 *         },
 *         "meta": {
 *           ".write": "auth != null && (root.child('projects/' + $projectId + '/owner').val() === auth.uid || newData.parent().child('owner').val() === auth.uid || root.child('projects/' + $projectId + '/members/' + auth.uid + '/role').val() === 'owner' || root.child('projects/' + $projectId + '/members/' + auth.uid + '/role').val() === 'editor')"
 *         },
 *         "owner": {
 *           ".write": "auth != null && !data.exists()"
 *         },
 *         "members": {
 *           ".read": "auth != null && (data.parent().child('members/' + auth.uid).exists() || data.parent().child('owner').val() === auth.uid)",
 *           ".write": "auth != null && (root.child('projects/' + $projectId + '/owner').val() === auth.uid || newData.parent().child('owner').val() === auth.uid || root.child('projects/' + $projectId + '/members/' + auth.uid + '/role').val() === 'owner')"
 *         },
 *         "presence": {
 *           "$uid": {
 *             ".write": "auth != null && $uid === auth.uid && (root.child('projects/' + $projectId + '/members/' + auth.uid).exists() || root.child('projects/' + $projectId + '/owner').val() === auth.uid)"
 *           }
 *         }
 *       }
 *     },
 *     "userProjects": {
 *       "$uid": {
 *         ".read": "auth != null && auth.uid === $uid",
 *         "$projectId": {
 *           ".write": "auth != null"
 *         }
 *       }
 *     },
 *     "invitations": {
 *       "$invId": {
 *         ".read": "auth != null",
 *         ".write": "auth != null"
 *       }
 *     },
 *     "emailIndex": {
 *       "$email": {
 *         ".read": "auth != null",
 *         ".write": "auth != null"
 *       }
 *     }
 *   }
 * }
 */


// â”€â”€ utils.js â”€â”€
// â•â•â• UTILS MODULE â•â•â•
App.Utils = (function(){
  let _nid = 1;
  const s2t = s => { const m=Math.floor(s/60); return m+':'+String(Math.floor(s%60)).padStart(2,'0'); };
  const s2px = (s,pps) => s * (pps||0.5);
  const px2s = (p,pps) => p / (pps||0.5);
  const genId = (prefix) => prefix + '_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
  const setIdCounter = (n) => { _nid = n; };
  const clamp = (v,min,max) => Math.max(min,Math.min(max,v));
  const escHtml = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const _safeColorNames = new Set(['red','blue','green','yellow','orange','purple','pink','cyan','white','black','gray','grey','brown','navy','teal','lime','aqua','maroon','olive','silver','fuchsia','transparent','inherit','currentColor']);
  const sanitizeColor = c => {
    if(!c || typeof c !== 'string') return '#888';
    c = c.trim();
    if(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$/.test(c)) return c;
    if(/^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(c)) return c;
    if(/^rgba\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*[\d.]+\s*\)$/.test(c)) return c;
    if(/^hsl\(\s*\d{1,3}\s*,\s*\d{1,3}%?\s*,\s*\d{1,3}%?\s*\)$/.test(c)) return c;
    if(/^var\(--[a-zA-Z0-9_-]+\)$/.test(c)) return c;
    if(_safeColorNames.has(c.toLowerCase())) return c;
    return '#888';
  };
  const debounce = (fn,ms) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
  const snap = (val, grid) => grid > 0 ? Math.round(val/grid)*grid : val;
  const epLbl = e => e==='fb'?'FB':'B'+e;
  const deepClone = o => JSON.parse(JSON.stringify(o));
  // â”€â”€ Input Validation â”€â”€
  const LIMITS = { title:200, description:5000, screenplay:50000, characterName:50, color:20 };
  function validateText(str, field) {
    if(!str || typeof str !== 'string') return str;
    const max = LIMITS[field];
    if(!max) return str;
    if(str.length > max) {
      App.UI.toast(field + ' alanÄ± ' + max + ' karakterle sÄ±nÄ±rlÄ± â€” kÄ±rpÄ±ldÄ±');
      return str.substring(0, max);
    }
    return str;
  }
  // â”€â”€ Cached DOM Query â”€â”€
  const _domCache = {};
  function $(id) {
    let el = _domCache[id];
    if(el && el.isConnected) return el;
    el = document.getElementById(id);
    if(el) _domCache[id] = el;
    return el;
  }
  function clearDomCache() { for(const k in _domCache) delete _domCache[k]; }

  return { s2t, s2px, px2s, genId, setIdCounter, clamp, escHtml, sanitizeColor, debounce, snap, epLbl, deepClone, LIMITS, validateText, $, clearDomCache };
})();


// â”€â”€ store.js â”€â”€
// â•â•â• STORE MODULE â•â•â•
App.Store = (function(){
  const U = App.Utils;
  const MAX_UNDO = 50;
  let undoStack = [];
  let redoStack = [];
  let listeners = {};

  // Default empty project
  let project = {
    meta: { title: 'Yeni Proje', author: '', settings: { episodeDuration: 2700, pixelsPerSecond: 0.5, snapGrid: 10 } },
    categories: {
      operasyon:{label:'Operasyon',color:'#ef4444'},
      karakter:{label:'Karakter',color:'#3b82f6'},
      organizasyon:{label:'Organizasyon',color:'#10b981'},
      sistem:{label:'Sistem',color:'#f59e0b'},
      flashback:{label:'Flashback',color:'#a855f7'},
      ihanet:{label:'Ä°hanet',color:'#f97316'}
    },
    characters: [],
    episodes: [],
    scenes: [],
    events: [],
    connections: [],
    characterRelationships: [],
    reviewComments: []
  };

  // Event bus
  function on(evt, fn) { if(!listeners[evt]) listeners[evt]=[]; listeners[evt].push(fn); }
  function emit(evt, data) { (listeners[evt]||[]).forEach(fn => fn(data)); }

  // Dirty collection tracking for per-collection saves
  let _dirty = new Set();
  function markDirty(col) { if(Array.isArray(col)) col.forEach(function(c){ _dirty.add(c); }); else _dirty.add(col); }
  function getDirty() { return new Set(_dirty); }
  function clearDirty() { _dirty.clear(); }
  function markAllDirty() { ['events','scenes','episodes','connections','characters','categories','characterRelationships','reviewComments'].forEach(function(c){ _dirty.add(c); }); }

  // Snapshot for undo
  function snapshot() {
    undoStack.push(U.deepClone(project));
    if(undoStack.length > MAX_UNDO) undoStack.shift();
    redoStack = [];
  }
  function undo() {
    if(!undoStack.length) return;
    redoStack.push(U.deepClone(project));
    project = undoStack.pop();
    markAllDirty();
    emit('change', {type:'undo'});
  }
  function redo() {
    if(!redoStack.length) return;
    undoStack.push(U.deepClone(project));
    project = redoStack.pop();
    markAllDirty();
    emit('change', {type:'redo'});
  }

  function get() { return project; }
  function set(p) { project = p; emit('change', {type:'set'}); }
  function getPPS() { return project.meta.settings.pixelsPerSecond; }
  function getEPDUR() { return project.meta.settings.episodeDuration; }
  function getEPPX() { return getEPDUR() * getPPS(); }
  function getSnap() { return project.meta.settings.snapGrid; }
  function setSnap(v) { project.meta.settings.snapGrid = v; }

  // Episode helpers
  function getEpisodeIds() { return project.episodes.map(e=>e.id); }
  function getEpisode(id) { return project.episodes.find(e=>e.id===id); }
  function addEpisode(ep) { snapshot(); project.episodes.push(ep); project.episodes.sort((a,b)=>a.order-b.order); markDirty('episodes'); emit('change',{type:'addEp',targetId:ep.id,targetName:ep.title||''}); }
  function updateEpisode(id, data) { snapshot(); const ep=getEpisode(id); if(ep) Object.assign(ep,data); markDirty('episodes'); emit('change',{type:'updateEp',targetId:id,targetName:(ep&&ep.title)||''}); }
  function removeEpisode(id) { snapshot(); const _n=(getEpisode(id)||{}).title||''; project.episodes=project.episodes.filter(e=>e.id!==id); project.scenes=project.scenes.filter(s=>s.episodeId!==id); project.events=project.events.filter(e=>e.episodeId!==id); markDirty(['episodes','scenes','events']); emit('change',{type:'removeEp',targetId:id,targetName:_n}); }

  // Scene helpers
  function getScenes(epId) { return project.scenes.filter(s=>s.episodeId===epId).sort((a,b)=>a.order-b.order); }
  function getScene(id) { return project.scenes.find(s=>s.id===id); }
  function addScene(sc) { snapshot(); project.scenes.push(sc); markDirty('scenes'); emit('change',{type:'addScene',targetId:sc.id,targetName:sc.title||''}); }
  function updateScene(id, data) { snapshot(); const sc=getScene(id); if(sc) Object.assign(sc,data); markDirty('scenes'); emit('change',{type:'updateScene',targetId:id,targetName:(sc&&sc.title)||''}); }
  function removeScene(id) { snapshot(); const _n=(getScene(id)||{}).title||''; project.scenes=project.scenes.filter(s=>s.id!==id); project.events=project.events.filter(e=>e.sceneId!==id); markDirty(['scenes','events']); emit('change',{type:'removeScene',targetId:id,targetName:_n}); }

  // Event helpers
  function getEvents(epId) { return epId ? project.events.filter(e=>e.episodeId===epId) : project.events; }
  function getEvent(id) { return project.events.find(e=>e.id===id); }
  function addEvent(ev) { snapshot(); project.events.push(ev); markDirty('events'); emit('change',{type:'addEvent',targetId:ev.id,targetName:ev.title||''}); }
  function updateEvent(id, data) { snapshot(); const ev=getEvent(id); if(ev) Object.assign(ev,data); markDirty('events'); emit('change',{type:'updateEvent',targetId:id,targetName:(ev&&ev.title)||''}); }
  function removeEvent(id) { snapshot(); const _n=(getEvent(id)||{}).title||''; project.events=project.events.filter(e=>e.id!==id); project.connections=project.connections.filter(c=>c.from!==id&&c.to!==id); markDirty(['events','connections']); emit('change',{type:'removeEvent',targetId:id,targetName:_n}); }

  // Connection helpers
  function getConnections(evId) { return evId ? project.connections.filter(c=>c.from===evId||c.to===evId) : project.connections; }
  function addConnection(cn) { snapshot(); if(!project.connections.some(c=>c.from===cn.from&&c.to===cn.to&&c.type===cn.type)){project.connections.push(cn);} markDirty('connections'); emit('change',{type:'addCn'}); }
  function removeConnection(from,to,type) { snapshot(); project.connections=project.connections.filter(c=>!(c.from===from&&c.to===to&&c.type===type)); markDirty('connections'); emit('change',{type:'removeCn'}); }

  // Character helpers
  function getCharacters() { return project.characters; }
  function addCharacter(ch) { snapshot(); project.characters.push(ch); markDirty('characters'); emit('change',{type:'addChar',targetName:ch.name||''}); }
  function removeCharacter(id) { snapshot(); const _n=(project.characters.find(c=>c.id===id)||{}).name||''; project.characters=project.characters.filter(c=>c.id!==id); project.characterRelationships=project.characterRelationships.filter(r=>r.from!==id&&r.to!==id); markDirty(['characters','characterRelationships']); emit('change',{type:'removeChar',targetName:_n}); }
  function updateCharacter(id, data) { snapshot(); const ch=project.characters.find(c=>c.id===id); if(ch) Object.assign(ch,data); markDirty('characters'); emit('change',{type:'updateChar',targetId:id,targetName:(ch&&ch.name)||''}); }

  // Character Relationship helpers
  function getCharacterRelationships(charId) { return charId ? project.characterRelationships.filter(r=>r.from===charId||r.to===charId) : project.characterRelationships; }
  function addCharacterRelationship(rel) { snapshot(); project.characterRelationships.push(rel); markDirty('characterRelationships'); emit('change',{type:'addCharRel'}); }
  function updateCharacterRelationship(id, data) { snapshot(); const r=project.characterRelationships.find(x=>x.id===id); if(r) Object.assign(r,data); markDirty('characterRelationships'); emit('change',{type:'updateCharRel',targetId:id}); }
  function removeCharacterRelationship(id) { snapshot(); project.characterRelationships=project.characterRelationships.filter(r=>r.id!==id); markDirty('characterRelationships'); emit('change',{type:'removeCharRel',targetId:id}); }

  // Review Comment helpers
  function getReviewComments(sceneId) { return sceneId ? project.reviewComments.filter(r=>r.sceneId===sceneId) : project.reviewComments; }
  function addReviewComment(rc) { snapshot(); project.reviewComments.push(rc); markDirty('reviewComments'); emit('change',{type:'addReviewComment'}); }
  function updateReviewComment(id, data) { snapshot(); const r=project.reviewComments.find(x=>x.id===id); if(r) Object.assign(r,data); markDirty('reviewComments'); emit('change',{type:'updateReviewComment',targetId:id}); }
  function removeReviewComment(id) { snapshot(); project.reviewComments=project.reviewComments.filter(r=>r.id!==id); markDirty('reviewComments'); emit('change',{type:'removeReviewComment',targetId:id}); }

  // Category helpers
  function getCategories() { return project.categories; }
  function addCategory(key, data) { snapshot(); project.categories[key]=data; markDirty('categories'); emit('change',{type:'addCat',targetName:key}); }
  function removeCategory(key) { snapshot(); delete project.categories[key]; markDirty('categories'); emit('change',{type:'removeCat',targetName:key}); }

  // Batch update without multiple snapshots
  function batch(fn) { snapshot(); fn(); markAllDirty(); emit('change',{type:'batch'}); }

  return {
    on, emit, snapshot, undo, redo, get, set, getPPS, getEPDUR, getEPPX, getSnap, setSnap,
    markDirty, getDirty, clearDirty, markAllDirty,
    getEpisodeIds, getEpisode, addEpisode, updateEpisode, removeEpisode,
    getScenes, getScene, addScene, updateScene, removeScene,
    getEvents, getEvent, addEvent, updateEvent, removeEvent,
    getConnections, addConnection, removeConnection,
    getCharacters, addCharacter, removeCharacter, updateCharacter,
    getCharacterRelationships, addCharacterRelationship, updateCharacterRelationship, removeCharacterRelationship,
    getReviewComments, addReviewComment, updateReviewComment, removeReviewComment,
    getCategories, addCategory, removeCategory, batch
  };
})();


// â”€â”€ ui.js â”€â”€
// â•â•â• UI MODULE â•â•â•
App.UI = (function(){
  // --- Accessibility: focus trap state ---
  var _previouslyFocusedEl = null;
  var _focusTrapHandler = null;

  function toast(msg) {
    const t = document.createElement('div');
    t.className = 'tst'; t.textContent = msg;
    t.setAttribute('role', 'alert');
    document.getElementById('tbox').appendChild(t);
    setTimeout(() => t.remove(), 2800);
  }

  function openModal(html) {
    // Store the element that had focus before the modal opened
    _previouslyFocusedEl = document.activeElement;

    document.getElementById('mdl').innerHTML = html;
    document.getElementById('mbg').classList.add('open');

    // Focus the first focusable element inside the modal
    var mdl = document.getElementById('mdl');
    var focusable = mdl.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusable.length) {
      focusable[0].focus();
    } else {
      mdl.setAttribute('tabindex', '-1');
      mdl.focus();
    }

    // Set up focus trap
    _focusTrapHandler = function(e) {
      if (e.key !== 'Tab') return;
      var modal = document.getElementById('mdl');
      var focusableEls = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (!focusableEls.length) return;
      var firstEl = focusableEls[0];
      var lastEl = focusableEls[focusableEls.length - 1];
      if (e.shiftKey) {
        if (document.activeElement === firstEl) {
          e.preventDefault();
          lastEl.focus();
        }
      } else {
        if (document.activeElement === lastEl) {
          e.preventDefault();
          firstEl.focus();
        }
      }
    };
    document.addEventListener('keydown', _focusTrapHandler);
  }
  function closeModal() {
    document.getElementById('mbg').classList.remove('open');

    // Remove focus trap
    if (_focusTrapHandler) {
      document.removeEventListener('keydown', _focusTrapHandler);
      _focusTrapHandler = null;
    }

    // Restore focus to the element that opened the modal
    if (_previouslyFocusedEl && typeof _previouslyFocusedEl.focus === 'function') {
      _previouslyFocusedEl.focus();
      _previouslyFocusedEl = null;
    }
  }

  function showTooltip(html, anchorEl) {
    const tt = document.getElementById('ttp');
    tt.innerHTML = html;
    const r = anchorEl.getBoundingClientRect();
    tt.style.left = Math.min(r.right + 8, window.innerWidth - 310) + 'px';
    tt.style.top = Math.min(r.top, window.innerHeight - 200) + 'px';
    tt.classList.add('show');
  }
  function hideTooltip() { document.getElementById('ttp').classList.remove('show'); }

  function showContextMenu(x, y, items) {
    const cm = document.getElementById('ctxMenu');
    let h = '';
    items.forEach(item => {
      if(item === 'sep') { h += '<div class="ctx-sep"></div>'; return; }
      h += `<div class="ctx-item${item.danger?' danger':''}" data-act="${U.escHtml(item.id)}">${item.icon||''} ${U.escHtml(item.label)}</div>`;
    });
    cm.innerHTML = h;
    cm.style.left = Math.min(x, window.innerWidth - 200) + 'px';
    cm.style.top = Math.min(y, window.innerHeight - 300) + 'px';
    cm.classList.add('show');

    // Bind clicks
    cm.querySelectorAll('.ctx-item').forEach(el => {
      el.addEventListener('click', () => {
        const act = el.dataset.act;
        const item = items.find(i => i.id === act);
        if(item && item.action) item.action();
        hideContextMenu();
      });
    });

    // Close on outside click
    setTimeout(() => {
      document.addEventListener('click', _ctxClose, {once:true});
      document.addEventListener('contextmenu', _ctxClose, {once:true});
    }, 10);
  }
  function _ctxClose() { hideContextMenu(); }
  function hideContextMenu() { document.getElementById('ctxMenu').classList.remove('show'); }

  function updateStatusBar() {
    const P = App.Store.get();
    document.getElementById('stProj').textContent = 'Proje: ' + P.meta.title;
    document.getElementById('stEps').textContent = P.episodes.length + ' bÃ¶lÃ¼m';
    document.getElementById('stScenes').textContent = P.scenes.length + ' sahne';
    document.getElementById('stEvents').textContent = P.events.length + ' olay';
    const totalDur = P.events.reduce((s,e) => s + (e.dur||0), 0);
    document.getElementById('stDur').textContent = App.Utils.s2t(totalDur);
    const warns = App.Analysis ? App.Analysis.getWarnings().length : 0;
    const wEl = document.getElementById('stWarn');
    wEl.textContent = warns ? 'âš  ' + warns + ' uyarÄ±' : '';
    const bdg = document.getElementById('wBdg');
    bdg.textContent = warns; bdg.style.display = warns ? '' : 'none';
    const sel = App.Interaction ? App.Interaction.getSelection() : [];
    document.getElementById('stSel').textContent = sel.length ? sel.length + ' seÃ§ili' : '';
  }

  return { toast, openModal, closeModal, showTooltip, hideTooltip, showContextMenu, hideContextMenu, updateStatusBar };
})();


// â”€â”€ mention.js â”€â”€
// â•â•â• MENTION HELPER â•â•â•
// Shared mention popup logic â€” eliminates duplication across Screenplay, Modal, and Edit Panel
App.Mention = (function(){
  const U = App.Utils;
  const S = App.Store;

  function createInstance(opts) {
    // opts: { getInputEl, getPopupEl, buildItemHtml, onInsert }
    let state = null;

    function handleInput() {
      const el = opts.getInputEl();
      if(!el) return;
      const sel = window.getSelection();
      if(!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      if(range.startContainer.nodeType !== Node.TEXT_NODE) { close(); return; }
      const textBefore = range.startContainer.textContent.substring(0, range.startOffset);
      const atIdx = textBefore.lastIndexOf('@');
      if(atIdx === -1) { close(); return; }
      const query = textBefore.substring(atIdx + 1);
      if(query.includes(' ') && query.trim().includes(' ')) { close(); return; }

      const P = S.get();
      const q = query.toLowerCase();
      const matches = P.characters.filter(c => c.name.toLowerCase().includes(q));
      const popup = opts.getPopupEl();
      if(!popup) return;

      if(!matches.length) {
        popup.innerHTML = '<div class="mp-empty">Karakter bulunamadÄ±</div>';
        popup.classList.add('open');
        state = { query, textNode: range.startContainer, atIdx, popupEl: popup, matches: [], activeIdx: 0 };
        _positionPopup(popup, range);
        return;
      }

      let html = '';
      matches.forEach((c, i) => {
        html += opts.buildItemHtml(c, i);
      });
      popup.innerHTML = html;
      popup.classList.add('open');
      state = { query, textNode: range.startContainer, atIdx, popupEl: popup, matches, activeIdx: 0 };
      _positionPopup(popup, range);
    }

    function _positionPopup(popup, range) {
      const rect = range.getBoundingClientRect();
      const wrapRect = popup.parentElement.getBoundingClientRect();
      popup.style.left = Math.max(0, rect.left - wrapRect.left) + 'px';
      popup.style.top = (rect.bottom - wrapRect.top + 4) + 'px';
    }

    function close() {
      if(state && state.popupEl) state.popupEl.classList.remove('open');
      state = null;
    }

    function handleKeydown(e) {
      if(!state || !state.matches.length) {
        if(state && e.key === 'Escape') { close(); e.preventDefault(); }
        return;
      }
      const items = state.popupEl.querySelectorAll('.mp-item');
      if(e.key === 'ArrowDown') {
        e.preventDefault();
        state.activeIdx = Math.min(state.activeIdx + 1, items.length - 1);
        items.forEach((it, i) => it.classList.toggle('active', i === state.activeIdx));
        items[state.activeIdx].scrollIntoView({block:'nearest'});
      } else if(e.key === 'ArrowUp') {
        e.preventDefault();
        state.activeIdx = Math.max(state.activeIdx - 1, 0);
        items.forEach((it, i) => it.classList.toggle('active', i === state.activeIdx));
        items[state.activeIdx].scrollIntoView({block:'nearest'});
      } else if(e.key === 'Enter' || e.key === 'Tab') {
        e.preventDefault();
        const active = items[state.activeIdx];
        if(active) insertMention(active.dataset.cid);
      } else if(e.key === 'Escape') {
        e.preventDefault(); close();
      }
    }

    function insertMention(charId) {
      if(!state) return;
      const P = S.get();
      const c = P.characters.find(x => x.id === charId);
      if(!c) return;
      const { textNode, atIdx } = state;
      const beforeAt = textNode.textContent.substring(0, atIdx);
      const afterQuery = textNode.textContent.substring(atIdx + 1 + state.query.length);

      const mention = document.createElement('span');
      mention.className = 'mention';
      mention.contentEditable = 'false';
      mention.dataset.charId = charId;
      mention.style.borderBottom = '2px solid ' + (U.sanitizeColor(c.color) || 'var(--cyan)');
      mention.textContent = '@' + c.name;

      const parent = textNode.parentNode;
      const beforeNode = document.createTextNode(beforeAt);
      const afterNode = document.createTextNode('\u00A0' + afterQuery);
      parent.insertBefore(beforeNode, textNode);
      parent.insertBefore(mention, textNode);
      parent.insertBefore(afterNode, textNode);
      parent.removeChild(textNode);

      const sel = window.getSelection();
      const r = document.createRange();
      r.setStart(afterNode, 1);
      r.collapse(true);
      sel.removeAllRanges();
      sel.addRange(r);

      close();
      if(opts.onInsert) opts.onInsert(charId, c);
    }

    return { handleInput, handleKeydown, insertMention, close, getState: () => state };
  }

  return { createInstance };
})();


// â”€â”€ auth.js â”€â”€
// â•â•â• AUTH MODULE â•â•â•
App.Auth = (function(){
  function switchTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.getElementById('authLoginForm').style.display = tab === 'login' ? '' : 'none';
    document.getElementById('authRegisterForm').style.display = tab === 'register' ? '' : 'none';
  }

  function showLoginScreen() {
    document.getElementById('authScreen').style.display = 'block';
    document.getElementById('projectsScreen').style.display = 'none';
    document.getElementById('appRoot').style.display = 'none';
    document.getElementById('loadMsg').style.display = 'none';
    // Her zaman login sekmesine sÄ±fÄ±rla
    switchTab('login');
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('registerError').style.display = 'none';
  }

  function doRegister() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value;
    const errEl = document.getElementById('registerError');
    errEl.style.display = 'none';
    if(!name) { errEl.textContent = 'Ad gerekli'; errEl.style.display = 'block'; return; }
    if(!email) { errEl.textContent = 'E-posta gerekli'; errEl.style.display = 'block'; return; }
    if(pass.length < 6) { errEl.textContent = 'Parola en az 6 karakter olmalÄ±'; errEl.style.display = 'block'; return; }

    firebase.auth().createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        return cred.user.updateProfile({ displayName: name }).then(() => {
          firebase.database().ref('users/' + cred.user.uid + '/profile').set({
            displayName: name, email: email, createdAt: firebase.database.ServerValue.TIMESTAMP
          });
        });
      })
      .catch(err => {
        errEl.textContent = _translateError(err.code);
        errEl.style.display = 'block';
      });
  }

  function doLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';
    if(!email || !pass) { errEl.textContent = 'E-posta ve parola gerekli'; errEl.style.display = 'block'; return; }

    firebase.auth().signInWithEmailAndPassword(email, pass)
      .catch(err => {
        errEl.textContent = _translateError(err.code);
        errEl.style.display = 'block';
      });
  }

  function logout() {
    if(App.Sync && App.Sync.isInRoom()) App.Sync.leaveRoom();
    firebase.auth().signOut();
  }

  function getCurrentUser() { return firebase.auth().currentUser; }

  function openProfileModal() {
    const user = firebase.auth().currentUser;
    if(!user) return;
    const name = user.displayName || '';
    const email = user.email || '';
    const created = user.metadata && user.metadata.creationTime ? new Date(user.metadata.creationTime).toLocaleDateString('tr-TR', {day:'numeric',month:'long',year:'numeric'}) : '-';
    const avatar = (name || email || '?').charAt(0).toUpperCase();

    App.UI.openModal(`<div class="mh"><span>Profil DÃ¼zenle</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>
      <div class="mb" style="padding:20px;">
        <div style="text-align:center;margin-bottom:20px;">
          <div style="width:56px;height:56px;border-radius:50%;background:var(--blue);color:#fff;font-size:22px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;">${avatar}</div>
        </div>
        <div class="fg" style="margin-bottom:12px;">
          <label style="font-size:11px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px;">Ad</label>
          <input type="text" id="profileName" value="${App.Utils.escHtml(name)}" placeholder="AdÄ±nÄ±z" style="width:100%;padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:13px;outline:none;" />
        </div>
        <div class="fg" style="margin-bottom:12px;">
          <label style="font-size:11px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px;">E-posta</label>
          <div style="padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg);color:var(--tx3);font-size:13px;">${App.Utils.escHtml(email)}</div>
        </div>
        <div class="fg" style="margin-bottom:16px;">
          <label style="font-size:11px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px;">KayÄ±t Tarihi</label>
          <div style="padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg);color:var(--tx3);font-size:13px;">${created}</div>
        </div>
        <div style="border-top:1px solid var(--brd);padding-top:14px;margin-top:4px;">
          <label style="font-size:11px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:8px;">Åifre DeÄŸiÅŸtir</label>
          <div class="fg" style="margin-bottom:8px;">
            <input type="password" id="profileCurrentPass" placeholder="Mevcut ÅŸifre" style="width:100%;padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:13px;outline:none;" />
          </div>
          <div class="fg" style="margin-bottom:8px;">
            <input type="password" id="profileNewPass" placeholder="Yeni ÅŸifre (min 6 karakter)" style="width:100%;padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:13px;outline:none;" />
          </div>
          <div class="fg" style="margin-bottom:4px;">
            <input type="password" id="profileNewPass2" placeholder="Yeni ÅŸifre (tekrar)" style="width:100%;padding:8px 10px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-family:inherit;font-size:13px;outline:none;" />
          </div>
          <div id="profilePassError" style="color:var(--red);font-size:11px;min-height:16px;margin-top:4px;"></div>
          <button class="btn btn-s" onclick="App.Auth.changePassword()" style="margin-top:4px;">Åifreyi GÃ¼ncelle</button>
        </div>
      </div>
      <div class="mf"><button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button><button class="btn btn-p" onclick="App.Auth.saveProfile(document.getElementById('profileName').value)">Kaydet</button></div>`);
  }

  function saveProfile(newName) {
    newName = (newName || '').trim();
    if(!newName) { App.UI.toast('Ad boÅŸ olamaz'); return; }
    const user = firebase.auth().currentUser;
    if(!user) return;
    const oldName = user.displayName || '';
    if(newName === oldName) { App.UI.closeModal(); return; }

    // 1. Firebase Auth profilini gÃ¼ncelle
    user.updateProfile({ displayName: newName }).then(() => {
      // 2. users/$uid/profile gÃ¼ncelle
      firebase.database().ref('users/' + user.uid + '/profile/displayName').set(newName);

      // 3. AÃ§Ä±k projedeki members kaydÄ±nÄ± gÃ¼ncelle
      if(App.Projects && App.Projects.getCurrentId) {
        const pid = App.Projects.getCurrentId();
        if(pid) {
          firebase.database().ref('projects/' + pid + '/members/' + user.uid + '/displayName').set(newName);
        }
      }

      // 4. Topbar'Ä± gÃ¼ncelle
      var avatarEl = document.getElementById('userAvatar');
      var nameEl = document.getElementById('userDisplayName');
      if(avatarEl) avatarEl.textContent = newName.charAt(0).toUpperCase();
      if(nameEl) nameEl.textContent = newName;

      // 5. GÃ¼nlÃ¼ÄŸe kaydet
      if(App.Changelog) App.Changelog.addEntry({type:'updateProfile', targetName: newName});

      App.UI.closeModal();
      App.UI.toast('Profil gÃ¼ncellendi');
    }).catch(err => {
      App.UI.toast('Hata: ' + err.message);
    });
  }

  function changePassword() {
    const user = firebase.auth().currentUser;
    if(!user) return;
    const errEl = document.getElementById('profilePassError');
    const current = (document.getElementById('profileCurrentPass').value || '').trim();
    const newPass = (document.getElementById('profileNewPass').value || '').trim();
    const newPass2 = (document.getElementById('profileNewPass2').value || '').trim();

    errEl.textContent = '';
    if(!current) { errEl.textContent = 'Mevcut ÅŸifreyi girin'; return; }
    if(!newPass) { errEl.textContent = 'Yeni ÅŸifreyi girin'; return; }
    if(newPass.length < 6) { errEl.textContent = 'Yeni ÅŸifre en az 6 karakter olmalÄ±'; return; }
    if(newPass !== newPass2) { errEl.textContent = 'Yeni ÅŸifreler eÅŸleÅŸmiyor'; return; }
    if(current === newPass) { errEl.textContent = 'Yeni ÅŸifre eskisiyle aynÄ± olamaz'; return; }

    const credential = firebase.auth.EmailAuthProvider.credential(user.email, current);
    user.reauthenticateWithCredential(credential).then(() => {
      return user.updatePassword(newPass);
    }).then(() => {
      document.getElementById('profileCurrentPass').value = '';
      document.getElementById('profileNewPass').value = '';
      document.getElementById('profileNewPass2').value = '';
      errEl.style.color = 'var(--green)';
      errEl.textContent = 'Åifre baÅŸarÄ±yla deÄŸiÅŸtirildi!';
      App.UI.toast('Åifre gÃ¼ncellendi');
    }).catch(err => {
      errEl.style.color = 'var(--red)';
      errEl.textContent = _translateError(err.code);
    });
  }

  function _translateError(code) {
    const map = {
      'auth/email-already-in-use': 'Bu e-posta zaten kayÄ±tlÄ±',
      'auth/invalid-email': 'GeÃ§ersiz e-posta adresi',
      'auth/weak-password': 'Parola Ã§ok zayÄ±f (min 6 karakter)',
      'auth/user-not-found': 'KullanÄ±cÄ± bulunamadÄ±',
      'auth/wrong-password': 'YanlÄ±ÅŸ parola',
      'auth/too-many-requests': 'Ã‡ok fazla deneme, lÃ¼tfen bekleyin',
      'auth/invalid-credential': 'GeÃ§ersiz kimlik bilgileri',
      'auth/wrong-password': 'Mevcut ÅŸifre yanlÄ±ÅŸ',
      'auth/requires-recent-login': 'LÃ¼tfen Ã§Ä±kÄ±ÅŸ yapÄ±p tekrar giriÅŸ yapÄ±n'
    };
    return map[code] || ('Hata: ' + code);
  }

  return { switchTab, showLoginScreen, doRegister, doLogin, logout, getCurrentUser, openProfileModal, saveProfile, changePassword };
})();


// â”€â”€ autosave.js â”€â”€
// â•â•â• AUTOSAVE MODULE â•â•â•
App.AutoSave = (function(){
  let _timer = null;
  function save() {
    if(_timer) clearTimeout(_timer);
    _showSyncing();
    _timer = setTimeout(_doSave, 500);
  }
  function _doSave() {
    _timer = null;
    if(App.Projects && App.Projects.getCurrentId() && App.Projects.canEdit()) {
      App.Projects.save();
    }
    _showSynced();
  }
  function _showSyncing() {
    var el = document.getElementById('syncStatusText');
    if(el) el.textContent = 'Kaydediliyor...';
    var st = document.getElementById('stSyncStatus');
    if(st) { st.textContent = 'Kaydediliyor...'; st.style.color = 'var(--yellow)'; }
  }
  function _showSynced() {
    var el = document.getElementById('syncStatusText');
    if(el) el.textContent = 'Kaydedildi';
    var st = document.getElementById('stSyncStatus');
    if(st) { st.textContent = 'Kaydedildi'; st.style.color = 'var(--green)'; }
    // Clear "Kaydedildi" after 3 seconds
    setTimeout(function() {
      var el2 = document.getElementById('syncStatusText');
      if(el2 && el2.textContent === 'Kaydedildi') el2.textContent = '';
      var st2 = document.getElementById('stSyncStatus');
      if(st2 && st2.textContent === 'Kaydedildi') st2.textContent = '';
    }, 3000);
  }
  function clear() { if(_timer) clearTimeout(_timer); _timer = null; }
  return { save, clear };
})();


// â”€â”€ projects.js â”€â”€
// â•â•â• PROJECTS MODULE (Firebase RTDB) â•â•â•
App.Projects = (function(){
  const S = App.Store;
  const U = App.Utils;
  let _currentId = null;
  let _myRole = null;
  let _membersCache = {};
  let _userProjectsRef = null;
  let _projectDataListeners = [];
  let _remoteChangeInProgress = false;
  let _heartbeatInterval = null;

  // â”€â”€ Firebase'den proje listesi yÃ¼kle â”€â”€
  function loadFromFirebase() {
    const user = App.Auth.getCurrentUser();
    if(!user) return;
    const uid = user.uid;
    if(_userProjectsRef) _userProjectsRef.off();
    _userProjectsRef = firebase.database().ref('userProjects/' + uid);
    _userProjectsRef.on('value', snap => {
      renderList(snap.val() || {});
    });
    showProjectsScreen();
  }

  function getCurrentId() { return _currentId; }

  // â”€â”€ Proje oluÅŸtur (tek atomik multi-path update) â”€â”€
  function create() {
    const user = App.Auth.getCurrentUser();
    const uid = user.uid;
    const projectId = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const now = firebase.database.ServerValue.TIMESTAMP;
    const displayName = user.displayName || user.email.split('@')[0];

    const emptyData = {
      categories: { operasyon:{label:'Operasyon',color:'#ef4444'}, karakter:{label:'Karakter',color:'#3b82f6'}, organizasyon:{label:'Organizasyon',color:'#10b981'}, sistem:{label:'Sistem',color:'#f59e0b'}, flashback:{label:'Flashback',color:'#a855f7'}, ihanet:{label:'Ä°hanet',color:'#f97316'} },
      characters: {}, episodes: {}, scenes: {}, events: {}, connections: {}, characterRelationships: {}, reviewComments: {}
    };

    const updates = {};
    updates['projects/' + projectId + '/owner'] = uid;
    updates['projects/' + projectId + '/members/' + uid] = { role:'owner', email:user.email, displayName:displayName, addedAt:now };
    updates['projects/' + projectId + '/meta'] = { title:'Yeni Proje', author:displayName, settings:{ episodeDuration:2700, pixelsPerSecond:0.5, snapGrid:10 }, createdAt:now, updatedAt:now };
    updates['projects/' + projectId + '/data'] = emptyData;
    updates['userProjects/' + uid + '/' + projectId] = { role:'owner', title:'Yeni Proje', updatedAt:now };

    firebase.database().ref().update(updates)
      .then(() => open(projectId))
      .catch(err => App.UI.toast('Proje oluÅŸturma hatasÄ±: ' + err.message));
  }

  // â”€â”€ Proje aÃ§ â”€â”€
  function open(projectId) {
    _currentId = projectId;
    const ref = firebase.database().ref('projects/' + projectId);

    Promise.all([
      ref.child('meta').once('value'),
      ref.child('data').once('value'),
      ref.child('members').once('value')
    ]).then(([metaSnap, dataSnap, membersSnap]) => {
      const meta = metaSnap.val() || { title:'Ä°simsiz', author:'', settings:{ episodeDuration:2700, pixelsPerSecond:0.5, snapGrid:10 } };
      const data = dataSnap.val() || {};
      _membersCache = membersSnap.val() || {};

      const uid = App.Auth.getCurrentUser().uid;
      _myRole = _membersCache[uid] ? _membersCache[uid].role : null;

      const P = {
        meta: meta,
        categories: data.categories || {},
        characters: _keyedToArray(data.characters),
        episodes: _keyedToArray(data.episodes).sort((a,b) => a.order - b.order),
        scenes: _keyedToArray(data.scenes),
        events: _keyedToArray(data.events),
        connections: _keyedToArray(data.connections),
        characterRelationships: _keyedToArray(data.characterRelationships),
        reviewComments: _keyedToArray(data.reviewComments)
      };
      S.set(P);
      _syncIdCounter();
      _initEditor();
      showEditor();
      _applyPermissions();
      _setupProjectListeners(projectId);
      _setupPresence(projectId);
    }).catch(err => {
      App.UI.toast('Proje aÃ§Ä±lamadÄ±: ' + err.message);
    });
  }

  // â”€â”€ Proje kaydet (debounced, Store change'de Ã§aÄŸrÄ±lÄ±r â€” sadece dirty koleksiyonlarÄ± yazar) â”€â”€
  function save() {
    if(!_currentId || !canEdit()) return;
    const P = S.get();
    const dirty = S.getDirty();
    if(!dirty.size) return;
    S.clearDirty();
    const ref = firebase.database().ref('projects/' + _currentId);
    const dataUpdate = {};
    if(dirty.has('categories')) dataUpdate.categories = P.categories;
    if(dirty.has('characters')) dataUpdate.characters = _arrayToKeyed(P.characters);
    if(dirty.has('episodes')) dataUpdate.episodes = _arrayToKeyed(P.episodes);
    if(dirty.has('scenes')) dataUpdate.scenes = _arrayToKeyed(P.scenes);
    if(dirty.has('events')) dataUpdate.events = _arrayToKeyed(P.events);
    if(dirty.has('connections')) dataUpdate.connections = _arrayToKeyed(P.connections);
    if(dirty.has('characterRelationships')) dataUpdate.characterRelationships = _arrayToKeyed(P.characterRelationships);
    if(dirty.has('reviewComments')) dataUpdate.reviewComments = _arrayToKeyed(P.reviewComments);
    if(Object.keys(dataUpdate).length) {
      ref.child('data').update(dataUpdate);
    }
    ref.child('meta').update({ title: P.meta.title, author: P.meta.author, settings: P.meta.settings, updatedAt: firebase.database.ServerValue.TIMESTAMP });
    const uid = App.Auth.getCurrentUser().uid;
    firebase.database().ref('userProjects/' + uid + '/' + _currentId).update({ title: P.meta.title, updatedAt: firebase.database.ServerValue.TIMESTAMP });
  }

  // â”€â”€ Real-time listeners â”€â”€
  function _setupProjectListeners(projectId) {
    _teardownProjectListeners();
    const ref = firebase.database().ref('projects/' + projectId + '/data');
    ['categories','characters','episodes','scenes','events','connections','characterRelationships','reviewComments'].forEach(col => {
      const colRef = ref.child(col);
      const fn = colRef.on('value', snap => {
        if(_remoteChangeInProgress) return;
        _remoteChangeInProgress = true;
        const P = S.get();
        if(col === 'categories') {
          P.categories = snap.val() || {};
        } else {
          P[col] = _keyedToArray(snap.val());
          if(col === 'episodes') P.episodes.sort((a,b) => a.order - b.order);
        }
        S.emit('change', {type:'remote_' + col});
        App.refresh();
        _remoteChangeInProgress = false;
      });
      _projectDataListeners.push({ ref: colRef, fn });
    });
    const metaRef = firebase.database().ref('projects/' + projectId + '/meta');
    const metaFn = metaRef.on('value', snap => {
      if(_remoteChangeInProgress) return;
      _remoteChangeInProgress = true;
      const P = S.get();
      P.meta = snap.val() || P.meta;
      S.emit('change', {type:'remoteMeta'});
      document.getElementById('projTitle').textContent = P.meta.title;
      _remoteChangeInProgress = false;
    });
    _projectDataListeners.push({ ref: metaRef, fn: metaFn });
    const membersRef = firebase.database().ref('projects/' + projectId + '/members');
    const membersFn = membersRef.on('value', snap => {
      _membersCache = snap.val() || {};
    });
    _projectDataListeners.push({ ref: membersRef, fn: membersFn });
    // Changelog & Notes remote listeners
    var dataRef = firebase.database().ref('projects/' + projectId + '/data');
    if(App.Changelog && App.Changelog.setupRemoteListener) App.Changelog.setupRemoteListener(dataRef);
    if(App.Notes && App.Notes.setupRemoteListener) App.Notes.setupRemoteListener(dataRef);
  }

  function _teardownProjectListeners() {
    if(App.Changelog && App.Changelog.teardownRemoteListener) App.Changelog.teardownRemoteListener();
    if(App.Notes && App.Notes.teardownRemoteListener) App.Notes.teardownRemoteListener();
    _projectDataListeners.forEach(l => { if(l.fn) l.ref.off('value', l.fn); else l.ref.off(); });
    _projectDataListeners = [];
  }

  // â”€â”€ Presence â”€â”€
  function _setupPresence(projectId) {
    const user = App.Auth.getCurrentUser();
    const presRef = firebase.database().ref('projects/' + projectId + '/presence/' + user.uid);
    const colors = ['#3b82f6','#ef4444','#10b981','#f59e0b','#a855f7','#ec4899','#06b6d4','#f97316'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    presRef.set({ name: user.displayName || user.email.split('@')[0], color, lastSeen: firebase.database.ServerValue.TIMESTAMP });
    presRef.onDisconnect().remove();
    if(_heartbeatInterval) clearInterval(_heartbeatInterval);
    _heartbeatInterval = setInterval(() => {
      presRef.child('lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
    }, 60000);
    const presenceRef = firebase.database().ref('projects/' + projectId + '/presence');
    const presFn = presenceRef.on('value', snap => {
      _renderPresenceBar(snap.val() || {});
    });
    _projectDataListeners.push({ ref: presenceRef, fn: presFn });
  }

  // â”€â”€ Yetki kontrolleri â”€â”€
  function getMyRole() { return _myRole; }
  function canEdit() { return _myRole === 'owner' || _myRole === 'editor'; }
  function canManage() { return _myRole === 'owner'; }

  function _applyPermissions() {
    document.body.classList.toggle('readonly-mode', !canEdit());
    const shareBtn = document.getElementById('shareBtn');
    if(shareBtn) shareBtn.style.display = canManage() ? '' : 'none';
  }

  // â”€â”€ Proje sil â”€â”€
  function deleteProject(projectId) {
    if(!confirm('Bu proje kalÄ±cÄ± olarak silinecek. Devam?')) return;
    firebase.database().ref('projects/' + projectId + '/members').once('value').then(snap => {
      const members = snap.val() || {};
      const updates = {};
      Object.keys(members).forEach(memberUid => {
        updates['userProjects/' + memberUid + '/' + projectId] = null;
      });
      updates['projects/' + projectId] = null;
      return firebase.database().ref().update(updates);
    }).then(() => {
      if(_currentId === projectId) { _currentId = null; _myRole = null; }
      App.UI.toast('Proje silindi');
    }).catch(err => App.UI.toast('Silme hatasÄ±: ' + err.message));
  }

  // â”€â”€ Davet sistemi â”€â”€
  function openShareModal() {
    if(!_currentId || !canManage()) return;
    let membersHtml = '';
    Object.keys(_membersCache).forEach(uid => {
      const m = _membersCache[uid];
      const isMe = uid === App.Auth.getCurrentUser().uid;
      const roleLabel = { owner:'Sahip', editor:'EditÃ¶r', viewer:'Ä°zleyici' }[m.role] || m.role;
      const removeBtn = (!isMe && canManage()) ? '<button class="btn btn-s" style="color:var(--red);" onclick="App.Projects.removeMember(\'' + uid + '\')">KaldÄ±r</button>' : '';
      membersHtml += '<div class="member-row"><span class="member-email">' + U.escHtml(m.email || m.displayName || 'Bilinmiyor') + (isMe ? ' (sen)' : '') + '</span><span class="member-role">' + roleLabel + '</span>' + removeBtn + '</div>';
    });

    App.UI.openModal(
      '<div style="padding:24px;max-width:480px;">' +
        '<h2 style="margin-bottom:16px;">Projeyi PaylaÅŸ</h2>' +
        '<div class="fg" style="margin-bottom:8px;"><label style="font-size:11px;color:var(--tx3);">E-posta adresi</label><input type="email" id="inviteEmail" placeholder="ornek@email.com" style="width:100%;padding:8px 12px;border:1px solid var(--brd);border-radius:var(--radius);background:var(--bg3);color:var(--tx);font-size:13px;" /></div>' +
        '<div class="fg" style="margin-bottom:12px;display:flex;gap:8px;"><select id="inviteRole" style="flex:1;padding:8px;border:1px solid var(--brd);border-radius:var(--radius);background:var(--bg3);color:var(--tx);font-size:12px;"><option value="editor">EditÃ¶r</option><option value="viewer">Ä°zleyici</option></select><button class="btn btn-p" onclick="App.Projects.sendInvite()">Davet GÃ¶nder</button></div>' +
        '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--brd);"><div style="font-size:12px;color:var(--tx2);margin-bottom:8px;">Ãœyeler</div>' + membersHtml + '</div>' +
        '<div style="margin-top:16px;"><button class="btn" onclick="App.UI.closeModal()" style="width:100%;">Kapat</button></div>' +
      '</div>'
    );
  }

  function sendInvite() {
    const email = (document.getElementById('inviteEmail').value || '').trim().toLowerCase();
    const role = document.getElementById('inviteRole').value;
    if(!email || !email.includes('@')) { App.UI.toast('GeÃ§erli e-posta girin'); return; }

    const alreadyMember = Object.values(_membersCache).some(m => m.email === email);
    if(alreadyMember) { App.UI.toast('Bu kullanÄ±cÄ± zaten Ã¼ye'); return; }

    const user = App.Auth.getCurrentUser();
    const invId = 'inv_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const sanitizedEmail = email.replace(/\./g, ',');

    const updates = {};
    updates['invitations/' + invId] = {
      projectId: _currentId,
      projectTitle: S.get().meta.title,
      invitedEmail: email,
      invitedBy: user.uid,
      invitedByName: user.displayName || user.email,
      role: role,
      status: 'pending',
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    updates['emailIndex/' + sanitizedEmail + '/' + invId] = true;

    firebase.database().ref().update(updates).then(() => {
      App.UI.toast(email + ' adresine davet gÃ¶nderildi');
      document.getElementById('inviteEmail').value = '';
    }).catch(err => App.UI.toast('Davet hatasÄ±: ' + err.message));
  }

  function removeMember(uid) {
    if(!_currentId || !canManage()) return;
    if(!confirm('Bu Ã¼yeyi projeden kaldÄ±rmak istediÄŸinize emin misiniz?')) return;
    const updates = {};
    updates['projects/' + _currentId + '/members/' + uid] = null;
    updates['userProjects/' + uid + '/' + _currentId] = null;
    updates['projects/' + _currentId + '/presence/' + uid] = null;
    firebase.database().ref().update(updates).then(() => {
      App.UI.toast('Ãœye kaldÄ±rÄ±ldÄ±');
      openShareModal();
    });
  }

  // â”€â”€ Davet kontrolÃ¼ (giriÅŸ yapÄ±nca Ã§aÄŸrÄ±lÄ±r) â”€â”€
  function checkPendingInvitations() {
    const user = App.Auth.getCurrentUser();
    if(!user || !user.email) return Promise.resolve();
    const sanitizedEmail = user.email.toLowerCase().replace(/\./g, ',');
    const uid = user.uid;

    return firebase.database().ref('emailIndex/' + sanitizedEmail).once('value').then(snap => {
      const invIds = snap.val();
      if(!invIds) return;

      const promises = Object.keys(invIds).map(invId => {
        return firebase.database().ref('invitations/' + invId).once('value').then(invSnap => {
          const inv = invSnap.val();
          if(!inv || inv.status !== 'pending') return;
          const updates = {};
          updates['invitations/' + invId + '/status'] = 'accepted';
          updates['projects/' + inv.projectId + '/members/' + uid] = {
            role: inv.role, email: user.email,
            displayName: user.displayName || user.email.split('@')[0],
            addedAt: firebase.database.ServerValue.TIMESTAMP
          };
          updates['userProjects/' + uid + '/' + inv.projectId] = {
            role: inv.role, title: inv.projectTitle,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
          };
          updates['emailIndex/' + sanitizedEmail + '/' + invId] = null;
          return firebase.database().ref().update(updates).then(() => {
            App.UI.toast(inv.invitedByName + ' sizi "' + inv.projectTitle + '" projesine davet etti');
          });
        });
      });
      return Promise.all(promises);
    });
  }

  // â”€â”€ Import (JSON dosyasÄ±ndan Firebase'e â€” tek atomik multi-path update) â”€â”€
  function importToProject(data) {
    const user = App.Auth.getCurrentUser();
    const uid = user.uid;
    const projectId = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const now = firebase.database.ServerValue.TIMESTAMP;
    const displayName = user.displayName || user.email.split('@')[0];
    const title = (data.meta && data.meta.title) || 'Ä°Ã§e AktarÄ±lmÄ±ÅŸ Proje';

    const fbData = {
      categories: data.categories || {},
      characters: _arrayToKeyed(data.characters || []),
      episodes: _arrayToKeyed(data.episodes || []),
      scenes: _arrayToKeyed(data.scenes || []),
      events: _arrayToKeyed(data.events || []),
      connections: _arrayToKeyed(data.connections || []),
      characterRelationships: _arrayToKeyed(data.characterRelationships || []),
      reviewComments: _arrayToKeyed(data.reviewComments || [])
    };

    const updates = {};
    updates['projects/' + projectId + '/owner'] = uid;
    updates['projects/' + projectId + '/members/' + uid] = { role:'owner', email:user.email, displayName:displayName, addedAt:now };
    updates['projects/' + projectId + '/meta'] = { title: title, author: (data.meta && data.meta.author) || displayName, settings: (data.meta && data.meta.settings) || { episodeDuration:2700, pixelsPerSecond:0.5, snapGrid:10 }, createdAt:now, updatedAt:now };
    updates['projects/' + projectId + '/data'] = fbData;
    updates['userProjects/' + uid + '/' + projectId] = { role:'owner', title: title, updatedAt:now };

    firebase.database().ref().update(updates)
      .then(() => open(projectId))
      .catch(err => App.UI.toast('Ä°Ã§e aktarma hatasÄ±: ' + err.message));
  }

  function loadDemoAsProject() {
    const demo = getDemoProject();
    U.setIdCounter(300);
    importToProject(demo);
  }

  function handleImport(e) {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if(d.meta && d.episodes) {
          importToProject(d);
        } else if(d.events && d.events[0] && ('ep' in d.events[0]) && ('t' in d.events[0])) {
          App.IO.migrateOldFormat(d);
          importToProject(S.get());
        } else {
          App.UI.toast('TanÄ±nmayan dosya formatÄ±');
        }
      } catch(err) { App.UI.toast('GeÃ§ersiz dosya: ' + err.message); }
    };
    r.readAsText(f);
    e.target.value = '';
  }

  // â”€â”€ YardÄ±mcÄ± fonksiyonlar â”€â”€
  function _arrayToKeyed(arr) {
    const obj = {};
    if(!arr || !Array.isArray(arr)) return obj;
    arr.forEach(item => { if(item && item.id) obj[item.id] = U.deepClone(item); });
    return obj;
  }
  function _keyedToArray(obj) {
    if(!obj || typeof obj !== 'object') return [];
    return Object.keys(obj).map(key => { const item = obj[key]; if(item && typeof item === 'object') { return { ...item, id: key }; } return null; }).filter(Boolean);
  }
  function _syncIdCounter() {
    const P = S.get();
    let maxNum = 0;
    const extractNum = id => { const m = (id||'').match(/(\d+)$/); return m ? parseInt(m[1]) : 0; };
    P.events.forEach(e => { maxNum = Math.max(maxNum, extractNum(e.id)); });
    P.scenes.forEach(s => { maxNum = Math.max(maxNum, extractNum(s.id)); });
    P.episodes.forEach(e => { maxNum = Math.max(maxNum, extractNum(e.id)); });
    P.characters.forEach(c => { maxNum = Math.max(maxNum, extractNum(c.id)); });
    P.connections.forEach(c => { maxNum = Math.max(maxNum, extractNum(c.id)); });
    (P.characterRelationships||[]).forEach(r => { maxNum = Math.max(maxNum, extractNum(r.id)); });
    (P.reviewComments||[]).forEach(r => { maxNum = Math.max(maxNum, extractNum(r.id)); });
    U.setIdCounter(maxNum + 1);
  }

  function _renderPresenceBar(presenceData) {
    const bar = document.getElementById('presenceBar');
    if(!bar) return;
    const user = App.Auth.getCurrentUser();
    if(!user) return;
    const uid = user.uid;
    let html = '';
    Object.keys(presenceData).forEach(pUid => {
      const u = presenceData[pUid];
      if(!u || !u.name) return;
      const initial = u.name.charAt(0).toUpperCase();
      const isMe = pUid === uid;
      html += '<div class="presence-avatar" style="background:' + U.sanitizeColor(u.color||'#666') + ';' + (isMe?'box-shadow:0 0 0 2px var(--cyan);':'') + '" title="' + U.escHtml(u.name) + (isMe?' (sen)':'') + '"><span>' + initial + '</span></div>';
    });
    bar.innerHTML = html;
    const stSync = document.getElementById('stSync');
    if(stSync) { stSync.textContent = Object.keys(presenceData).length + ' kullanÄ±cÄ±'; stSync.style.display = ''; }
  }

  // â”€â”€ Ekranlar â”€â”€
  function _initEditor() {
    App.Timeline.initFilter();
    App.Timeline.buildToolbar();
    App.Timeline.render();
    App.Screenplay.render();
    App.UI.updateStatusBar();
    App.setViewMode('split');
    document.getElementById('projTitle').textContent = S.get().meta.title;
    const user = App.Auth.getCurrentUser();
    const userInfo = document.getElementById('userInfo');
    if(userInfo) {
      userInfo.style.display = 'flex';
      document.getElementById('userAvatar').textContent = (user.displayName || user.email || '?').charAt(0).toUpperCase();
      document.getElementById('userDisplayName').textContent = user.displayName || user.email.split('@')[0];
    }
    document.getElementById('logoutBtn').style.display = '';
    if(canManage()) document.getElementById('shareBtn').style.display = '';
  }

  function showProjectsScreen() {
    U.$('authScreen').style.display = 'none';
    U.$('appRoot').style.display = 'none';
    U.$('projectsScreen').style.display = 'block';
    document.getElementById('loadMsg').style.display = 'none';
    _showUserInfoOnProjectsScreen();
  }

  function _showUserInfoOnProjectsScreen() {
    const user = App.Auth.getCurrentUser();
    if(!user) return;
    const header = document.querySelector('#projectsScreen .ps-header');
    const existing = document.getElementById('psUserBar');
    if(existing) existing.remove();
    const bar = document.createElement('div');
    bar.id = 'psUserBar';
    bar.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:8px 12px;background:var(--bg3);border-radius:var(--radius);border:1px solid var(--brd);';
    bar.innerHTML = '<div class="user-avatar" style="cursor:pointer;" onclick="App.Auth.openProfileModal()" title="Profili dÃ¼zenle">' + (user.displayName||user.email||'?').charAt(0).toUpperCase() + '</div><span style="flex:1;font-size:13px;color:var(--tx);cursor:pointer;" onclick="App.Auth.openProfileModal()" title="Profili dÃ¼zenle">' + U.escHtml(user.displayName || user.email) + '</span><button class="btn btn-s" onclick="App.Auth.logout()">Ã‡Ä±kÄ±ÅŸ</button>';
    header.after(bar);
  }

  function showEditor() {
    U.$('authScreen').style.display = 'none';
    U.$('projectsScreen').style.display = 'none';
    U.$('appRoot').style.display = 'flex';
  }

  function goBack() {
    _teardownProjectListeners();
    if(_heartbeatInterval) { clearInterval(_heartbeatInterval); _heartbeatInterval = null; }
    const user = App.Auth.getCurrentUser();
    if(_currentId && user) {
      firebase.database().ref('projects/' + _currentId + '/presence/' + user.uid).remove();
    }
    _currentId = null;
    _myRole = null;
    document.body.classList.remove('readonly-mode');
    if(user) loadFromFirebase();
  }

  function renderList(userProjects) {
    const el = document.getElementById('psList');
    const entries = Object.keys(userProjects).map(pid => ({ id: pid, ...userProjects[pid] }));
    if(!entries.length) {
      el.innerHTML = '<div class="ps-empty">HenÃ¼z proje yok. Yeni proje oluÅŸturun.</div>';
      return;
    }
    entries.sort((a,b) => ((b.updatedAt||0) - (a.updatedAt||0)));
    el.innerHTML = entries.map(p => {
      const roleLabel = { owner:'Sahip', editor:'EditÃ¶r', viewer:'Ä°zleyici' }[p.role] || '';
      const roleClass = p.role || 'viewer';
      const deleteBtn = p.role === 'owner' ? '<button class="btn btn-s btn-d" onclick="event.stopPropagation();App.Projects.deleteProject(\'' + p.id + '\')">Sil</button>' : '';
      return '<div class="ps-card" ondblclick="App.Projects.open(\'' + p.id + '\')">' +
        '<div style="display:flex;align-items:center;gap:8px;"><div class="ps-card-title" style="flex:1;">' + U.escHtml(p.title || 'Ä°simsiz Proje') + '</div><span class="ps-card-role ' + roleClass + '">' + roleLabel + '</span></div>' +
        '<div class="ps-card-actions" style="margin-top:8px;">' +
          '<button class="btn btn-s btn-p" onclick="event.stopPropagation();App.Projects.open(\'' + p.id + '\')">AÃ§</button>' +
          deleteBtn +
        '</div>' +
      '</div>';
    }).join('');
  }

  return {
    loadFromFirebase, create, open, save, deleteProject,
    importToProject, loadDemoAsProject, handleImport,
    openShareModal, sendInvite, removeMember, checkPendingInvitations,
    showProjectsScreen, showEditor, goBack, getCurrentId, renderList,
    getMyRole, canEdit, canManage
  };
})();


// â”€â”€ timeline.js â”€â”€
// â•â•â• TIMELINE MODULE â•â•â•
App.Timeline = (function(){
  const U = App.Utils;
  const S = App.Store;
  let zoomLvl = 1;
  let flt = { ep:'all', ch:'all', cats:new Set() };

  function initFilter() {
    const cats = S.getCategories();
    flt.cats = new Set(Object.keys(cats));
  }

  function buildToolbar() {
    const P = S.get();
    // Episodes
    const es = document.getElementById('fEp');
    es.innerHTML = '<option value="all">TÃ¼mÃ¼</option>';
    P.episodes.forEach(ep => {
      const o = document.createElement('option');
      o.value = ep.id; o.textContent = U.epLbl(ep.number);
      es.appendChild(o);
    });
    // Characters
    const cs = document.getElementById('fCh');
    cs.innerHTML = '<option value="all">TÃ¼mÃ¼</option>';
    P.characters.forEach(ch => {
      const o = document.createElement('option');
      o.value = ch.id; o.textContent = ch.name;
      cs.appendChild(o);
    });
    // Category pills
    const cp = document.getElementById('catP'); cp.innerHTML = '';
    Object.entries(P.categories).forEach(([k,v]) => {
      const p = document.createElement('div');
      p.className = 'pill' + (flt.cats.has(k)?'':' off');
      p.dataset.cat = k;
      p.style.borderColor = U.sanitizeColor(v.color); p.style.color = U.sanitizeColor(v.color);
      p.textContent = v.label;
      p.onclick = () => { p.classList.toggle('off'); if(flt.cats.has(k)) flt.cats.delete(k); else flt.cats.add(k); doFilter(); };
      cp.appendChild(p);
    });
  }

  function render() {
    const P = S.get();
    const cont = U.$('tlC');
    cont.innerHTML = '';
    const PPS = S.getPPS();
    const EPDUR = S.getEPDUR();
    const EPPX = S.getEPPX();
    const LW = 180, HDRH = 60, RW = 60;

    if(!P.episodes.length) {
      cont.innerHTML = '<div style="padding:40px;text-align:center;color:var(--tx3);">Timeline boÅŸ. Senaryo panelinden bÃ¶lÃ¼m ekleyin veya Demo Proje yÃ¼kleyin.</div>';
      applyZoom();
      return;
    }

    // Lane calc for each episode
    P.episodes.forEach(ep => {
      const rowEvs = P.events.filter(e => e.episodeId === ep.id).sort((a,b) => a.s - b.s);
      const lanes = [];
      rowEvs.forEach(ev => {
        let lane = 0;
        for(; lane < lanes.length; lane++) { if(ev.s >= lanes[lane]) break; }
        if(lane >= lanes.length) lanes.push(0);
        lanes[lane] = ev.s + ev.dur;
        ev._lane = lane;
      });
      rowEvs.forEach(ev => ev._laneCount = Math.max(lanes.length, 1));
    });

    // Ruler (vertical, left column)
    const maxMin = Math.ceil(EPDUR / 60);
    const ruler = document.createElement('div');
    ruler.className = 'ruler'; ruler.style.height = (EPPX + HDRH) + 'px';
    // Spacer to align with episode headers
    const spacer = document.createElement('div');
    spacer.style.height = HDRH + 'px'; spacer.style.flexShrink = '0';
    ruler.appendChild(spacer);
    for(let m = 0; m <= maxMin; m++) {
      const tk = document.createElement('div');
      tk.className = 'rtick' + (m%5===0?' major':' minor');
      tk.style.top = (HDRH + U.s2px(m*60, PPS)) + 'px';
      if(m%5===0) tk.innerHTML = `<span style="position:absolute;top:2px;right:4px">${m}dk</span>`;
      ruler.appendChild(tk);
    }
    // Snap guide
    const sg = document.createElement('div');
    sg.className = 'snap-guide'; sg.id = 'snapGuide';
    ruler.appendChild(sg);
    cont.appendChild(ruler);

    // Columns (episodes as vertical columns)
    let cumX = RW;
    P.episodes.forEach(ep => {
      const colEvs = P.events.filter(e => e.episodeId === ep.id);
      const laneCount = colEvs.length > 0 ? Math.max(...colEvs.map(e => (e._lane||0))) + 1 : 1;
      const colW = Math.max(laneCount * (LW + 6) + 16, LW + 16);

      const col = document.createElement('div');
      col.className = 'ep-row'; col.style.width = colW + 'px';

      const hdr = document.createElement('div');
      hdr.className = 'ep-hdr'; hdr.style.width = colW + 'px';
      const epDurTotal = colEvs.reduce((s,e) => Math.max(s, e.s+e.dur), 0);
      hdr.innerHTML = `<div class="num">${ep.number==='fb'?'FB':ep.number}</div><div class="sub">${U.escHtml(ep.title||((ep.number==='fb')?'Flashback':'BÃ¶lÃ¼m'))}</div><div class="dur">${U.s2t(EPDUR)}</div>`;
      col.appendChild(hdr);

      const body = document.createElement('div');
      body.className = 'ep-body'; body.dataset.ep = ep.id; body.style.width = colW + 'px'; body.style.height = EPPX + 'px';

      // Gridlines (horizontal)
      for(let m = 0; m <= maxMin; m++) {
        const gl = document.createElement('div');
        gl.className = 'gl' + (m%5===0?' ma':' mi');
        gl.style.top = U.s2px(m*60, PPS) + 'px';
        body.appendChild(gl);
      }

      // Event blocks
      colEvs.forEach(ev => {
        const cat = P.categories[ev.category] || {color:'#888'};
        const bl = document.createElement('div');
        bl.className = 'evb'; bl.dataset.id = ev.id; bl.dataset.c = ev.category;
        bl.style.top = U.s2px(ev.s, PPS) + 'px';
        bl.style.height = Math.max(U.s2px(ev.dur, PPS), 20) + 'px';
        bl.style.left = (8 + (ev._lane||0) * (LW + 6)) + 'px';
        bl.style.width = LW + 'px';
        // Dynamic category colors
        const c = cat.color;
        const sc_ = U.sanitizeColor(c);
        bl.style.background = sc_ + '1a'; bl.style.borderColor = sc_ + '4d'; bl.style.color = sc_;
        const hasScene = ev.sceneId ? '<span class="scene-link">ğŸ“</span>' : '';
        bl.innerHTML = `<div class="rh l"></div><span class="etxt">${U.escHtml(ev.title)}</span>${hasScene}<div class="rh r"></div>`;

        bl.addEventListener('mouseenter', () => {
          if(App.Interaction && App.Interaction.isDragging()) return;
          hlRel(ev.id);
          const chNames = (ev.characters||[]).map(cid => { const ch = P.characters.find(c=>c.id===cid); return ch?ch.name:cid; });
          App.UI.showTooltip(`<div class="tt">${U.escHtml(ev.title)}</div><div class="td">${U.escHtml(ev.description||'')}</div>
            <div class="tm">${U.epLbl(P.episodes.find(e=>e.id===ev.episodeId)?.number||'?')} | ${U.s2t(ev.s)}â€“${U.s2t(ev.s+ev.dur)} (${Math.round(ev.dur/60)}dk)</div>
            ${chNames.length?'<div class="tm">'+chNames.join(', ')+'</div>':''}`, bl);
        });
        bl.addEventListener('mouseleave', () => {
          if(App.Interaction && App.Interaction.isDragging()) return;
          clrHL(); App.UI.hideTooltip();
        });
        bl.addEventListener('contextmenu', (e) => { e.preventDefault(); App.Interaction.showEventContext(e, ev.id); });

        body.appendChild(bl);
      });

      col.appendChild(body);
      cont.appendChild(col);
      cumX += colW;
    });

    cont.style.width = cumX + 'px';
    cont.style.height = (HDRH + EPPX + 40) + 'px';
    applyZoom();
    doFilter();
  }

  function hlRel(id) {
    const cns = App.Store.get().connections;
    const rel = new Set([id]);
    cns.forEach(c => { if(c.from===id) rel.add(c.to); if(c.to===id) rel.add(c.from); });
    document.querySelectorAll('.evb').forEach(el => {
      if(rel.has(el.dataset.id)) el.classList.add('hl'); else el.classList.add('dim');
    });
  }
  function clrHL() {
    document.querySelectorAll('.evb').forEach(el => el.classList.remove('hl','dim','warn-hl','impact-1','impact-2','impact-3'));
  }

  function applyZoom() {
    const c = U.$('tlC');
    c.style.transform = `scale(${zoomLvl})`; c.style.transformOrigin = '0 0';
    document.getElementById('zLvl').textContent = Math.round(zoomLvl*100) + '%';
  }
  function zoomIn() { zoomLvl = Math.min(3, zoomLvl + 0.15); applyZoom(); }
  function zoomOut() { zoomLvl = Math.max(0.25, zoomLvl - 0.15); applyZoom(); }
  function zoomReset() { zoomLvl = 1; applyZoom(); }
  function getZoom() { return zoomLvl; }
  function setZoom(z) { zoomLvl = z; applyZoom(); }

  function doFilter() {
    flt.ep = document.getElementById('fEp').value;
    flt.ch = document.getElementById('fCh').value;
    const P = App.Store.get();
    document.querySelectorAll('.evb').forEach(el => {
      const ev = P.events.find(e => e.id === el.dataset.id);
      if(!ev) { el.style.display = 'none'; return; }
      let v = true;
      if(flt.ep !== 'all' && ev.episodeId !== flt.ep) v = false;
      if(flt.ch !== 'all' && !(ev.characters||[]).includes(flt.ch)) v = false;
      if(!flt.cats.has(ev.category)) v = false;
      el.style.display = v ? '' : 'none';
    });
    document.querySelectorAll('.ep-row').forEach(row => {
      if(flt.ep === 'all') { row.style.display = ''; return; }
      const body = row.querySelector('.ep-body');
      if(!body) return;
      row.style.display = body.dataset.ep === flt.ep ? '' : 'none';
    });
  }

  function scrollToEvent(id) {
    const el = document.querySelector(`[data-id="${id}"]`);
    if(el) el.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
  }

  return { render, buildToolbar, initFilter, applyZoom, zoomIn, zoomOut, zoomReset, getZoom, setZoom, doFilter, hlRel, clrHL, scrollToEvent };
})();


// â”€â”€ screenplay.js â”€â”€
// â•â•â• SCREENPLAY MODULE â•â•â•
App.Screenplay = (function(){
  const U = App.Utils;
  const S = App.Store;
  let openEps = new Set();
  let activeSceneId = null;

  function render() {
    const P = S.get();
    const cont = U.$('spEpisodes');
    if(!P.episodes.length) {
      cont.innerHTML = '<div style="padding:20px;text-align:center;color:var(--tx4);font-size:12px;line-height:1.6;">HenÃ¼z bÃ¶lÃ¼m yok.<br>YukarÄ±dan <b>+ BÃ¶lÃ¼m</b> ekleyin veya<br><b>Demo Proje</b> yÃ¼kleyin.</div>';
      return;
    }
    let h = '';
    P.episodes.forEach(ep => {
      const scenes = S.getScenes(ep.id);
      const isOpen = openEps.has(ep.id);
      const sceneCount = scenes.length;
      const totalDur = P.events.filter(e=>e.episodeId===ep.id).reduce((s,e)=>s+e.dur,0);
      h += `<div class="ep-tree">
        <div class="ep-tree-hdr" onclick="App.Screenplay.toggleEp('${ep.id}')">
          <span class="arrow${isOpen?' open':''}">â–¶</span>
          <div class="ep-info">
            <span class="ep-num">${ep.number==='fb'?'FB':'BÃ¶lÃ¼m '+ep.number}</span>
            <span class="ep-title">${U.escHtml(ep.title||'')}</span>
          </div>
          <span class="ep-meta">${sceneCount} sahne Â· ${U.s2t(totalDur)}</span>
        </div>
        <div class="ep-tree-body${isOpen?' open':''}">`;
      scenes.forEach((sc, idx) => {
        const isActive = sc.id === activeSceneId;
        const catObj = P.categories[sc.category]||{color:'#888',label:'?'};
        const charNames = (sc.characters||[]).map(cid=>{const c=P.characters.find(x=>x.id===cid);return c?c.name[0]:'?';});
        h += `<div class="scene-card${isActive?' active expanded':''}" data-sid="${sc.id}">
          <div class="scene-card-hdr" onclick="App.Screenplay.selectScene('${sc.id}')">
            <span class="scene-card-title">${idx+1}. ${U.escHtml(sc.title||'AdsÄ±z Sahne')}</span>
            <div class="scene-card-badges">
              ${sc.location?'<span class="scene-card-badge">'+U.escHtml(sc.location)+'</span>':''}
              ${sc.timeOfDay?'<span class="scene-card-badge">'+U.escHtml(sc.timeOfDay)+'</span>':''}
              <span class="scene-card-badge" style="color:${U.sanitizeColor(catObj.color)}">${U.escHtml(catObj.label)}</span>
            </div>
          </div>
          <div class="scene-card-chars" onclick="App.Screenplay.selectScene('${sc.id}')">${charNames.map(n=>'<div class="scene-card-char">'+n+'</div>').join('')}</div>
          <div class="scene-card-body">
            ${renderSceneEditor(sc)}
          </div>
        </div>`;
      });
      h += `<button class="add-scene-btn" onclick="event.stopPropagation();App.Screenplay.addScene('${ep.id}')">+ Sahne Ekle</button>`;
      h += '</div></div>';
    });
    cont.innerHTML = h;
  }

  function renderSceneEditor(sc) {
    const P = S.get();
    const content = sc.content || [];
    let h = '<div class="scene-editor">';
    // Scene metadata fields
    const catOpts = Object.entries(P.categories).map(([k,v]) => `<option value="${k}"${k===sc.category?' selected':''}>${U.escHtml(v.label)}</option>`).join('');
    h += `<div class="scene-meta-row">
      <div class="scene-meta-field">
        <label>BaÅŸlÄ±k</label>
        <input type="text" value="${U.escHtml(sc.title||'')}" onchange="App.Screenplay.saveSceneMeta('${sc.id}','title',this.value)" onclick="event.stopPropagation()" />
      </div>
      <div class="scene-meta-field" style="flex:0 0 110px">
        <label>Kategori</label>
        <select onchange="App.Screenplay.saveSceneMeta('${sc.id}','category',this.value)" onclick="event.stopPropagation()">${catOpts}</select>
      </div>
    </div>
    <div class="scene-meta-row">
      <div class="scene-meta-field">
        <label>Mekan</label>
        <select onchange="App.Screenplay.saveSceneMeta('${sc.id}','location',this.value)" onclick="event.stopPropagation()">
          <option value=""${!sc.location?' selected':''}>â€”</option>
          <option value="Ä°Ã‡"${'Ä°Ã‡'===sc.location?' selected':''}>Ä°Ã‡</option>
          <option value="DIÅ"${'DIÅ'===sc.location?' selected':''}>DIÅ</option>
          <option value="Ä°Ã‡/DIÅ"${'Ä°Ã‡/DIÅ'===sc.location?' selected':''}>Ä°Ã‡/DIÅ</option>
        </select>
      </div>
      <div class="scene-meta-field">
        <label>Zaman</label>
        <select onchange="App.Screenplay.saveSceneMeta('${sc.id}','timeOfDay',this.value)" onclick="event.stopPropagation()">
          <option value=""${!sc.timeOfDay?' selected':''}>â€”</option>
          <option value="GÃœN"${'GÃœN'===sc.timeOfDay?' selected':''}>GÃœN</option>
          <option value="GECE"${'GECE'===sc.timeOfDay?' selected':''}>GECE</option>
          <option value="AKÅAM"${'AKÅAM'===sc.timeOfDay?' selected':''}>AKÅAM</option>
          <option value="ÅAFAK"${'ÅAFAK'===sc.timeOfDay?' selected':''}>ÅAFAK</option>
        </select>
      </div>
    </div>`;
    // Character tags
    const scChars = (sc.characters||[]).map(cid => P.characters.find(c=>c.id===cid)).filter(Boolean);
    if(scChars.length) {
      h += '<div class="scene-chars-row">';
      scChars.forEach(c => {
        h += `<span class="scene-char-tag"><span class="mp-dot" style="background:${U.sanitizeColor(c.color)||'var(--tx3)'}"></span>${U.escHtml(c.name)}<span class="remove-char" onclick="event.stopPropagation();App.Screenplay.removeSceneChar('${sc.id}','${c.id}')">âœ•</span></span>`;
      });
      h += '</div>';
    }
    // Full screenplay text area with @ mention
    const scText = sc.screenplay || '';
    h += `<div class="scene-screenplay-wrap">
      <div class="scene-screenplay-label">Senaryo Metni <span style="color:var(--tx4);font-weight:400;text-transform:none">â€” karakter eklemek iÃ§in <b style="color:var(--cyan)">@</b> yazÄ±n</span></div>
      <div class="scene-screenplay" contenteditable="true" data-sid="${sc.id}" data-placeholder="Sahne metnini buraya yazÄ±n... Karakter eklemek iÃ§in @ kullanÄ±n.">${formatScreenplayHTML(sc.id, scText)}</div>
      <div class="mention-popup" id="mp_${sc.id}"></div>
    </div>`;
    content.forEach((block, bi) => {
      if(block.type === 'action') {
        h += `<div class="scene-block"><div class="scene-block-action" contenteditable="true" data-sid="${sc.id}" data-bi="${bi}" onblur="App.Screenplay.saveBlock('${sc.id}',${bi},this.textContent)">${U.escHtml(block.text||'')}</div></div>`;
      } else if(block.type === 'dialogue') {
        const charSel = P.characters.map(c=>`<option value="${c.id}"${c.id===block.characterId?' selected':''}>${U.escHtml(c.name)}</option>`).join('');
        h += `<div class="scene-block"><div class="scene-block-dialogue">
          <div class="char-line"><select onchange="App.Screenplay.saveBlockChar('${sc.id}',${bi},this.value)">${charSel}</select></div>
          ${block.parenthetical?'<div class="paren">('+U.escHtml(block.parenthetical)+')</div>':''}
          <div class="dial-text" contenteditable="true" data-sid="${sc.id}" data-bi="${bi}" onblur="App.Screenplay.saveBlock('${sc.id}',${bi},this.textContent)">${U.escHtml(block.text||'')}</div>
        </div></div>`;
      } else if(block.type === 'transition') {
        h += `<div class="scene-block"><div class="scene-block-transition" contenteditable="true" onblur="App.Screenplay.saveBlock('${sc.id}',${bi},this.textContent)">${U.escHtml(block.text||'KESME')}</div></div>`;
      }
    });
    h += `<div class="scene-block-acts">
      <button class="btn btn-s" onclick="event.stopPropagation();App.Screenplay.addBlock('${sc.id}','action')">+ Aksiyon</button>
      <button class="btn btn-s" onclick="event.stopPropagation();App.Screenplay.addBlock('${sc.id}','dialogue')">+ Diyalog</button>
      <button class="btn btn-s" onclick="event.stopPropagation();App.Screenplay.addBlock('${sc.id}','transition')">+ GeÃ§iÅŸ</button>
      <div style="flex:1"></div>
      <button class="btn btn-s" style="color:var(--red)" onclick="event.stopPropagation();App.Screenplay.deleteScene('${sc.id}')">Sil</button>
    </div>`;
    h += `<div class="scene-block-acts" style="border-top:1px solid var(--brd);padding-top:6px;margin-top:4px;">
      <button class="btn btn-s" style="color:#a855f7" onclick="event.stopPropagation();App.Panels.togglePanel('ai');App.AI.setTab('write');App.AI.generateDialogue('${sc.id}')">âœ¦ Diyalog</button>
      <button class="btn btn-s" style="color:#a855f7" onclick="event.stopPropagation();App.Panels.togglePanel('ai');App.AI.setTab('write');App.AI.writeSceneDescription('${sc.id}')">âœ¦ Sahne</button>
      <button class="btn btn-s" style="color:#a855f7" onclick="event.stopPropagation();App.Panels.togglePanel('ai');App.AI.setTab('write');App.AI.continueScreenplay('${sc.id}')">âœ¦ Devam</button>
    </div>`;
    h += '</div>';
    return h;
  }

  function toggleEp(epId) {
    if(openEps.has(epId)) openEps.delete(epId); else openEps.add(epId);
    render();
  }

  function selectScene(scId) {
    activeSceneId = activeSceneId === scId ? null : scId;
    render();
    // Sync: highlight in timeline or scroll in screenplay editor
    if(App.ScreenplayEditor && App.ScreenplayEditor.isActive()) {
      App.ScreenplayEditor.scrollToScene(scId);
    } else {
      const sc = S.getScene(scId);
      if(sc) {
        const ev = S.get().events.find(e => e.sceneId === scId);
        if(ev) App.Timeline.scrollToEvent(ev.id);
      }
    }
  }

  function addEpisode() {
    const P = S.get();
    const maxNum = P.episodes.reduce((m,e) => typeof e.number==='number'?Math.max(m,e.number):m, 0);
    const newNum = maxNum + 1;
    const ep = { id: U.genId('ep'), number: newNum, title: '', duration: S.getEPDUR(), type:'normal', order: newNum };
    // Set open BEFORE triggering render
    openEps.add(ep.id);
    S.addEpisode(ep);
  }

  function addScene(epId) {
    const P = S.get();
    const existing = S.getScenes(epId);
    const order = existing.length ? Math.max(...existing.map(s=>s.order)) + 1 : 1;
    const sc = {
      id: U.genId('sc'), episodeId: epId, order, title: 'Yeni Sahne', location: '',
      timeOfDay: '', category: 'karakter', characters: [], timelineStart: 0, timelineDuration: 180,
      content: [{ type: 'action', text: '' }]
    };
    // Set active BEFORE triggering renders
    openEps.add(epId);
    activeSceneId = sc.id;
    // Now add to store (triggers render with correct activeSceneId)
    S.snapshot();
    P.scenes.push(sc);
    // Auto-create timeline event without double-render
    const epEvs = P.events.filter(e => e.episodeId === sc.episodeId);
    const lastEnd = epEvs.reduce((m,e) => Math.max(m, e.s + e.dur), 0);
    const dur = calcSceneDuration(sc);
    const s = Math.min(lastEnd + 10, S.getEPDUR() - dur);
    P.events.push({
      id: U.genId('ev'), title: sc.title, description: '', episodeId: sc.episodeId,
      sceneId: sc.id, category: sc.category, characters: sc.characters||[],
      s: Math.max(0, s), dur: dur
    });
    S.markDirty(['scenes','events']);
    S.emit('change', {type:'addScene',targetId:sc.id,targetName:sc.title||''});
    // Focus the first editable block after render
    setTimeout(() => {
      const el = document.querySelector(`[data-sid="${sc.id}"][contenteditable]`);
      if(el) el.focus();
    }, 50);
  }

  function deleteScene(scId) {
    if(!confirm('Bu sahne silinsin mi?')) return;
    S.removeScene(scId);
    if(activeSceneId === scId) activeSceneId = null;
  }

  function addBlock(scId, type) {
    const sc = S.getScene(scId);
    if(!sc) return;
    const block = { type };
    if(type === 'action') block.text = '';
    else if(type === 'dialogue') { block.characterId = ''; block.text = ''; block.parenthetical = ''; }
    else if(type === 'transition') block.text = 'KESME';
    S.snapshot();
    sc.content = sc.content || [];
    sc.content.push(block);
    const bi = sc.content.length - 1;
    updateTimelineDuration(sc);
    S.markDirty('scenes');
    S.emit('change', {type:'updateScene',targetId:scId,targetName:sc.title||''});
    // Focus the new block after render
    setTimeout(() => {
      const blocks = document.querySelectorAll(`[data-sid="${scId}"][contenteditable]`);
      const lastBlock = blocks[blocks.length - 1];
      if(lastBlock) lastBlock.focus();
      // For dialogue, focus the text area not the select
      if(type === 'dialogue') {
        const dialTexts = document.querySelectorAll(`.scene-card.active .dial-text[contenteditable]`);
        const last = dialTexts[dialTexts.length - 1];
        if(last) last.focus();
      }
    }, 50);
  }

  function saveBlock(scId, bi, text) {
    const sc = S.getScene(scId);
    if(!sc || !sc.content[bi]) return;
    if(sc.content[bi].text === text) return;
    S.snapshot();
    sc.content[bi].text = text;
    // Update timeline duration silently (no full re-render to preserve editing)
    updateTimelineDuration(sc);
    // Only update timeline + status, NOT screenplay panel (to preserve focus)
    App.Analysis.invalidateCache();
    App.Timeline.render();
    App.UI.updateStatusBar();
    // Real-time sync handled by App.AutoSave
  }

  function saveSceneMeta(scId, field, value) {
    const sc = S.getScene(scId);
    if(!sc) return;
    if(field === 'title') value = U.validateText(value, 'title');
    if(sc[field] === value) return;
    S.snapshot();
    sc[field] = value;
    // Sync to linked timeline event
    const P = S.get();
    const ev = P.events.find(e => e.sceneId === scId);
    if(ev) {
      if(field === 'title') ev.title = value;
      if(field === 'category') ev.category = value;
    }
    // Re-render timeline + status but NOT screenplay (preserve editing)
    App.Analysis.invalidateCache();
    App.Timeline.render();
    App.UI.updateStatusBar();
    // Update scene card header badges without losing focus
    const card = document.querySelector(`.scene-card[data-sid="${scId}"]`);
    if(card) {
      const catObj = P.categories[sc.category]||{color:'#888',label:'?'};
      const badges = card.querySelector('.scene-card-badges');
      if(badges) {
        badges.innerHTML = `${sc.location?'<span class="scene-card-badge">'+U.escHtml(sc.location)+'</span>':''}${sc.timeOfDay?'<span class="scene-card-badge">'+U.escHtml(sc.timeOfDay)+'</span>':''}<span class="scene-card-badge" style="color:${U.sanitizeColor(catObj.color)}">${U.escHtml(catObj.label)}</span>`;
      }
      if(field === 'title') {
        const titleEl = card.querySelector('.scene-card-title');
        if(titleEl) {
          const idx = titleEl.textContent.match(/^(\d+)\./);
          titleEl.textContent = (idx?idx[0]+' ':'')+value;
        }
      }
    }
    // Real-time sync handled by App.AutoSave
  }

  // â”€â”€ SCREENPLAY TEXT WITH @ MENTION â”€â”€
  let mentionState = null; // { scId, query, range, popupEl }

  function formatScreenplayHTML(scId, text) {
    if(!text) return '';
    const P = S.get();
    // Replace @CharName with mention spans
    return text.replace(/@\[([^\]]+)\]\(([^)]+)\)/g, (m, name, id) => {
      const c = P.characters.find(x => x.id === id);
      const color = c ? U.sanitizeColor(c.color) : 'var(--cyan)';
      return `<span class="mention" contenteditable="false" data-char-id="${id}" style="border-bottom:2px solid ${color}">@${U.escHtml(name)}</span>`;
    });
  }

  function getScreenplayText(el) {
    // Convert DOM back to plain text with mention markers
    let text = '';
    el.childNodes.forEach(node => {
      if(node.nodeType === Node.TEXT_NODE) {
        text += node.textContent;
      } else if(node.classList && node.classList.contains('mention')) {
        const cid = node.dataset.charId;
        const name = node.textContent.replace(/^@/, '');
        text += `@[${name}](${cid})`;
      } else if(node.tagName === 'BR') {
        text += '\n';
      } else if(node.tagName === 'DIV' || node.tagName === 'P') {
        if(text && !text.endsWith('\n')) text += '\n';
        text += node.textContent || '';
      } else {
        text += node.textContent || '';
      }
    });
    return text;
  }

  function saveScreenplay(scId, el) {
    const sc = S.getScene(scId);
    if(!sc) return;
    let newText = getScreenplayText(el);
    newText = U.validateText(newText, 'screenplay');
    if(sc.screenplay === newText) return;
    S.snapshot();
    sc.screenplay = newText;
    // Extract characters from mentions and sync
    const mentionIds = [];
    el.querySelectorAll('.mention[data-char-id]').forEach(m => {
      const cid = m.dataset.charId;
      if(cid && !mentionIds.includes(cid)) mentionIds.push(cid);
    });
    // Add any mentioned characters not already in scene
    let changed = false;
    sc.characters = sc.characters || [];
    mentionIds.forEach(cid => {
      if(!sc.characters.includes(cid)) { sc.characters.push(cid); changed = true; }
    });
    updateTimelineDuration(sc);
    App.Analysis.invalidateCache();
    App.Timeline.render();
    App.UI.updateStatusBar();
    if(changed) {
      // Update character tags without full re-render
      const P = S.get();
      const card = document.querySelector(`.scene-card[data-sid="${scId}"]`);
      if(card) {
        const charRow = card.querySelector('.scene-chars-row');
        const scChars = (sc.characters||[]).map(cid => P.characters.find(c=>c.id===cid)).filter(Boolean);
        const html = scChars.map(c => `<span class="scene-char-tag"><span class="mp-dot" style="background:${U.sanitizeColor(c.color)||'var(--tx3)'}"></span>${U.escHtml(c.name)}<span class="remove-char" onclick="event.stopPropagation();App.Screenplay.removeSceneChar('${scId}','${c.id}')">âœ•</span></span>`).join('');
        if(charRow) { charRow.innerHTML = html; }
        else {
          const editor = card.querySelector('.scene-editor');
          if(editor) {
            const row = document.createElement('div');
            row.className = 'scene-chars-row';
            row.innerHTML = html;
            editor.insertBefore(row, editor.querySelector('.scene-screenplay-wrap'));
          }
        }
      }
    }
    // Real-time sync handled by App.AutoSave
  }

  function removeSceneChar(scId, charId) {
    const sc = S.getScene(scId);
    if(!sc) return;
    S.snapshot();
    sc.characters = (sc.characters||[]).filter(c => c !== charId);
    // Also sync to timeline event
    const P = S.get();
    const ev = P.events.find(e => e.sceneId === scId);
    if(ev) ev.characters = sc.characters.slice();
    S.markDirty(['scenes','events']);
    S.emit('change', {type:'updateScene',targetId:scId,targetName:sc.title||''});
  }

  function handleMentionInput(e) {
    const el = e.target.closest('.scene-screenplay');
    if(!el) return;
    const scId = el.dataset.sid;
    const sel = window.getSelection();
    if(!sel.rangeCount) return;

    const range = sel.getRangeAt(0);
    // Get text before cursor in current text node
    if(range.startContainer.nodeType !== Node.TEXT_NODE) { closeMentionPopup(); return; }
    const textBefore = range.startContainer.textContent.substring(0, range.startOffset);
    const atIdx = textBefore.lastIndexOf('@');

    if(atIdx === -1) { closeMentionPopup(); return; }
    // Check no space between @ and cursor (allow Turkish characters)
    const query = textBefore.substring(atIdx + 1);
    if(query.includes(' ') && query.trim().includes(' ')) { closeMentionPopup(); return; }

    const P = S.get();
    const q = query.toLowerCase();
    const matches = P.characters.filter(c => c.name.toLowerCase().includes(q));

    const popup = document.getElementById('mp_' + scId);
    if(!popup) return;

    if(!matches.length) {
      popup.innerHTML = '<div class="mp-empty">Karakter bulunamadÄ±</div>';
      popup.classList.add('open');
      mentionState = { scId, query, textNode: range.startContainer, atIdx, popupEl: popup, matches: [], activeIdx: 0 };
      positionPopup(popup, range);
      return;
    }

    let html = '';
    matches.forEach((c, i) => {
      html += `<div class="mp-item${i===0?' active':''}" data-cid="${c.id}" data-name="${U.escHtml(c.name)}" onmousedown="event.preventDefault();App.Screenplay.insertMention('${scId}','${c.id}')"><span class="mp-dot" style="background:${U.sanitizeColor(c.color)||'var(--tx3)'}"></span>${U.escHtml(c.name)}</div>`;
    });
    popup.innerHTML = html;
    popup.classList.add('open');
    mentionState = { scId, query, textNode: range.startContainer, atIdx, popupEl: popup, matches, activeIdx: 0 };
    positionPopup(popup, range);
  }

  function positionPopup(popup, range) {
    const rect = range.getBoundingClientRect();
    const wrapRect = popup.parentElement.getBoundingClientRect();
    popup.style.left = Math.max(0, rect.left - wrapRect.left) + 'px';
    popup.style.top = (rect.bottom - wrapRect.top + 4) + 'px';
  }

  function closeMentionPopup() {
    if(mentionState && mentionState.popupEl) {
      mentionState.popupEl.classList.remove('open');
    }
    mentionState = null;
  }

  function handleMentionKeydown(e) {
    if(!mentionState || !mentionState.matches.length) {
      if(mentionState && e.key === 'Escape') { closeMentionPopup(); e.preventDefault(); }
      return;
    }
    const items = mentionState.popupEl.querySelectorAll('.mp-item');
    if(e.key === 'ArrowDown') {
      e.preventDefault();
      mentionState.activeIdx = Math.min(mentionState.activeIdx + 1, items.length - 1);
      items.forEach((it, i) => it.classList.toggle('active', i === mentionState.activeIdx));
      items[mentionState.activeIdx].scrollIntoView({block:'nearest'});
    } else if(e.key === 'ArrowUp') {
      e.preventDefault();
      mentionState.activeIdx = Math.max(mentionState.activeIdx - 1, 0);
      items.forEach((it, i) => it.classList.toggle('active', i === mentionState.activeIdx));
      items[mentionState.activeIdx].scrollIntoView({block:'nearest'});
    } else if(e.key === 'Enter' || e.key === 'Tab') {
      e.preventDefault();
      const active = items[mentionState.activeIdx];
      if(active) insertMention(mentionState.scId, active.dataset.cid);
    } else if(e.key === 'Escape') {
      e.preventDefault();
      closeMentionPopup();
    }
  }

  function insertMention(scId, charId) {
    if(!mentionState) return;
    const P = S.get();
    const c = P.characters.find(x => x.id === charId);
    if(!c) return;
    const { textNode, atIdx } = mentionState;
    const beforeAt = textNode.textContent.substring(0, atIdx);
    const afterQuery = textNode.textContent.substring(atIdx + 1 + mentionState.query.length);

    // Create mention span
    const mention = document.createElement('span');
    mention.className = 'mention';
    mention.contentEditable = 'false';
    mention.dataset.charId = charId;
    mention.style.borderBottom = '2px solid ' + (U.sanitizeColor(c.color) || 'var(--cyan)');
    mention.textContent = '@' + c.name;

    // Split text node and insert mention
    const parent = textNode.parentNode;
    const beforeNode = document.createTextNode(beforeAt);
    const afterNode = document.createTextNode('\u00A0' + afterQuery); // nbsp after mention

    parent.insertBefore(beforeNode, textNode);
    parent.insertBefore(mention, textNode);
    parent.insertBefore(afterNode, textNode);
    parent.removeChild(textNode);

    // Place cursor after mention
    const sel = window.getSelection();
    const r = document.createRange();
    r.setStart(afterNode, 1);
    r.collapse(true);
    sel.removeAllRanges();
    sel.addRange(r);

    closeMentionPopup();

    // Auto-add character to scene
    const sc = S.getScene(scId);
    if(sc) {
      sc.characters = sc.characters || [];
      if(!sc.characters.includes(charId)) {
        S.snapshot();
        sc.characters.push(charId);
        const ev = P.events.find(e => e.sceneId === scId);
        if(ev) ev.characters = sc.characters.slice();
        // Update character tags
        const card = document.querySelector(`.scene-card[data-sid="${scId}"]`);
        if(card) {
          const scChars = sc.characters.map(cid => P.characters.find(cc=>cc.id===cid)).filter(Boolean);
          const html = scChars.map(cc => `<span class="scene-char-tag"><span class="mp-dot" style="background:${U.sanitizeColor(cc.color)||'var(--tx3)'}"></span>${U.escHtml(cc.name)}<span class="remove-char" onclick="event.stopPropagation();App.Screenplay.removeSceneChar('${scId}','${cc.id}')">âœ•</span></span>`).join('');
          let charRow = card.querySelector('.scene-chars-row');
          if(!charRow) {
            charRow = document.createElement('div');
            charRow.className = 'scene-chars-row';
            const editor = card.querySelector('.scene-editor');
            if(editor) editor.insertBefore(charRow, editor.querySelector('.scene-screenplay-wrap'));
          }
          charRow.innerHTML = html;
        }
        App.Analysis.invalidateCache();
        App.Timeline.render();
        App.UI.updateStatusBar();
      }
    }
  }

  // Event delegation for screenplay areas
  function initMentionListeners() {
    const sp = U.$('spEpisodes');
    sp.addEventListener('input', e => {
      if(e.target.closest('.scene-screenplay')) {
        // Review mode interception
        if(App.Review && App.Review.isReviewMode()) {
          App.Review.interceptInput(e, e.target.closest('.scene-screenplay'));
        }
        handleMentionInput(e);
      }
    });
    sp.addEventListener('keydown', e => {
      if(e.target.closest('.scene-screenplay')) {
        // Review mode: intercept delete/backspace
        if((e.key === 'Backspace' || e.key === 'Delete') && App.Review && App.Review.isReviewMode()) {
          if(App.Review.interceptDelete(e, e.target.closest('.scene-screenplay'))) return;
        }
        handleMentionKeydown(e);
      }
    });
    sp.addEventListener('blur', e => {
      const el = e.target.closest('.scene-screenplay');
      if(el) {
        setTimeout(() => closeMentionPopup(), 150);
        saveScreenplay(el.dataset.sid, el);
      }
    }, true);
    sp.addEventListener('click', e => {
      // Close popup on click outside
      if(!e.target.closest('.mention-popup')) closeMentionPopup();
    });
  }

  function saveBlockChar(scId, bi, charId) {
    const sc = S.getScene(scId);
    if(!sc || !sc.content[bi]) return;
    S.snapshot();
    sc.content[bi].characterId = charId;
    if(charId && !(sc.characters||[]).includes(charId)) {
      sc.characters = sc.characters || [];
      sc.characters.push(charId);
    }
    // Silent update â€” don't re-render screenplay to preserve editing context
    App.Analysis.invalidateCache();
    App.Timeline.render();
    App.UI.updateStatusBar();
  }

  function autoCreateTimelineEvent(sc) {
    const P = S.get();
    const epEvs = P.events.filter(e => e.episodeId === sc.episodeId);
    const lastEnd = epEvs.reduce((m,e) => Math.max(m, e.s + e.dur), 0);
    const dur = calcSceneDuration(sc);
    const s = Math.min(lastEnd + 10, S.getEPDUR() - dur);
    const ev = {
      id: U.genId('ev'), title: sc.title, description: '', episodeId: sc.episodeId,
      sceneId: sc.id, category: sc.category, characters: sc.characters||[],
      s: Math.max(0, s), dur: dur
    };
    S.addEvent(ev);
  }

  function calcSceneDuration(sc) {
    const content = sc.content || [];
    let dur = 0;
    content.forEach(b => {
      if(b.type === 'action') dur += Math.max(30, (b.text||'').split(/\s+/).length * 1.5);
      else if(b.type === 'dialogue') dur += Math.max(20, (b.text||'').split(/\s+/).length / 2.5);
      else if(b.type === 'transition') dur += 5;
    });
    return U.clamp(Math.round(dur), 60, 600);
  }

  function updateTimelineDuration(sc) {
    const P = S.get();
    const ev = P.events.find(e => e.sceneId === sc.id);
    if(!ev) return;
    const newDur = calcSceneDuration(sc);
    if(Math.abs(ev.dur - newDur) > 10) {
      ev.dur = newDur;
      ev.title = sc.title;
      ev.category = sc.category;
      ev.characters = sc.characters || [];
    }
  }

  // Called when timeline event is double-clicked â€” open scene in screenplay
  function openSceneFromTimeline(evId) {
    const P = S.get();
    const ev = P.events.find(e => e.id === evId);
    if(!ev || !ev.sceneId) return;
    const sc = S.getScene(ev.sceneId);
    if(!sc) return;
    openEps.add(sc.episodeId);
    activeSceneId = sc.id;
    App.setViewMode('split');
    render();
    setTimeout(() => {
      const el = document.querySelector(`[data-sid="${sc.id}"]`);
      if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
    }, 100);
  }

  // Init mention listeners on DOM ready
  setTimeout(initMentionListeners, 100);

  function getActiveSceneId() { return activeSceneId; }

  return { render, toggleEp, selectScene, addEpisode, addScene, deleteScene, addBlock, saveBlock, saveBlockChar, saveSceneMeta, removeSceneChar, insertMention, openSceneFromTimeline, formatScreenplayHTML, getActiveSceneId };
})();


// â”€â”€ screenplay-editor.js â”€â”€
// â•â•â• SCREENPLAY EDITOR MODULE (Professional Celtx/Final Draft style) â•â•â•
App.ScreenplayEditor = (function(){
  const U = App.Utils;
  const S = App.Store;

  // â”€â”€ State â”€â”€
  let _elements = [];       // [{id, type, text, sceneId, episodeId, divider?, dividerType?}]
  let _activeElId = null;
  let _focusMode = false;
  let _mounted = false;
  let _syncTimer = null;
  let _autocompleteEl = null;
  let _autocompleteItems = [];
  let _autocompleteIndex = 0;

  const ELEMENT_TYPES = ['action','character','parenthetical','dialogue','transition'];
  const TYPE_LABELS = {'action':'Aksiyon','character':'Karakter','parenthetical':'Parantez Ä°Ã§i','dialogue':'Diyalog','transition':'GeÃ§iÅŸ'};
  const TYPE_PLACEHOLDERS = {'action':'Aksiyon aÃ§Ä±klamasÄ±...','character':'KARAKTER ADI','parenthetical':'yÃ¶nerge','dialogue':'Diyalog metni...','transition':'KESME:'};

  // Tab cycle: current type â†’ next type on Tab
  const TAB_NEXT = {'action':'character','character':'dialogue','parenthetical':'dialogue','dialogue':'character','transition':'action'};
  const TAB_PREV = {'action':'transition','character':'action','dialogue':'character','transition':'dialogue','parenthetical':'character'};
  // Enter on empty line: what to become
  const ENTER_EMPTY = {'action':'character','character':'action','dialogue':'action','parenthetical':'dialogue','transition':'action'};
  // Enter on non-empty: what the NEW line should be
  const ENTER_NEXT = {'action':'action','character':'dialogue','parenthetical':'dialogue','dialogue':'dialogue','transition':'action'};

  function isActive() { return _mounted; }
  function getActiveElement() { return _activeElId; }

  // â”€â”€ buildFromState: Convert project state â†’ flat element list â”€â”€
  function buildFromState() {
    _elements = [];
    const P = S.get();
    const episodes = [...P.episodes].sort((a,b) => a.order - b.order);
    let globalSceneNum = 0;

    episodes.forEach((ep, epIdx) => {
      // Episode divider
      _elements.push({
        id: 'epd_' + ep.id, divider: true, dividerType: 'episode',
        episodeId: ep.id, text: (ep.number === 'fb' ? 'FLASHBACK' : 'BÃ–LÃœM ' + ep.number) + (ep.title ? ' â€” ' + ep.title : '')
      });

      const scenes = S.getScenes(ep.id);
      scenes.forEach((sc, scIdx) => {
        globalSceneNum++;

        // Scene header (metadata bar with dropdowns)
        _elements.push({
          id: 'shdr_' + sc.id, divider: true, dividerType: 'scene-header',
          sceneId: sc.id, episodeId: ep.id,
          sceneNum: globalSceneNum,
          location: sc.location || 'Ä°Ã‡',
          timeOfDay: sc.timeOfDay || 'GÃœN',
          category: sc.category || 'karakter',
          title: sc.title || ''
        });

        // Content blocks
        const content = sc.content || [];
        content.forEach((block, bi) => {
          if (block.type === 'action') {
            _elements.push({
              id: 'el_' + sc.id + '_' + bi, type: 'action', text: block.text || '',
              sceneId: sc.id, episodeId: ep.id
            });
          } else if (block.type === 'dialogue') {
            // Character line
            const ch = block.characterId ? P.characters.find(c => c.id === block.characterId) : null;
            const charName = ch ? ch.name.toUpperCase() : '';
            _elements.push({
              id: 'ch_' + sc.id + '_' + bi, type: 'character', text: charName,
              sceneId: sc.id, episodeId: ep.id, characterId: block.characterId
            });
            // Parenthetical (if exists)
            if (block.parenthetical) {
              _elements.push({
                id: 'pr_' + sc.id + '_' + bi, type: 'parenthetical', text: block.parenthetical,
                sceneId: sc.id, episodeId: ep.id
              });
            }
            // Dialogue text
            _elements.push({
              id: 'dl_' + sc.id + '_' + bi, type: 'dialogue', text: block.text || '',
              sceneId: sc.id, episodeId: ep.id
            });
          } else if (block.type === 'transition') {
            _elements.push({
              id: 'tr_' + sc.id + '_' + bi, type: 'transition', text: block.text || 'KESME',
              sceneId: sc.id, episodeId: ep.id
            });
          }
        });

        // If scene has no content, add empty action
        if (!content.length) {
          _elements.push({
            id: 'el_' + sc.id + '_0', type: 'action', text: '',
            sceneId: sc.id, episodeId: ep.id
          });
        }

        // Block action buttons (add action/dialogue/transition)
        _elements.push({
          id: 'ba_' + sc.id, divider: true, dividerType: 'block-actions',
          sceneId: sc.id, episodeId: ep.id
        });
      });
    });
  }

  // â”€â”€ render: Build the editor DOM â”€â”€
  function render() {
    const tlC = U.$('tlC');
    if (!tlC) return;
    _mounted = true;

    // Build toolbar
    let html = '<div class="sp-editor-toolbar">';
    html += '<select id="spElTypeSelect" onchange="App.ScreenplayEditor.changeElementType(this.value)">';
    ELEMENT_TYPES.forEach(t => {
      html += '<option value="' + t + '">' + TYPE_LABELS[t] + '</option>';
    });
    html += '</select>';
    html += '<span class="sp-tb-sep"></span>';
    html += '<button onclick="App.ScreenplayEditor.addSceneInEditor()" title="Yeni sahne ekle">+ Sahne</button>';
    html += '<button onclick="App.ScreenplayEditor.addEpisodeInEditor()" title="Yeni bÃ¶lÃ¼m ekle">+ BÃ¶lÃ¼m</button>';
    html += '<span style="flex:1"></span>';
    html += '<button id="spFocusBtn" onclick="App.ScreenplayEditor.toggleFocusMode()" title="Odak Modu">â—‰ Odak</button>';
    html += '</div>';

    // Paper wrap
    html += '<div class="sp-editor-wrap">';
    html += '<div class="sp-editor-page' + (_focusMode ? ' focus-mode' : '') + '" id="spEditorPage">';

    const P = S.get();
    const catEntries = Object.entries(P.categories);
    _elements.forEach((el, idx) => {
      if (el.divider) {
        if (el.dividerType === 'episode') {
          html += '<div class="sp-episode-divider" data-epid="' + el.episodeId + '">' + U.escHtml(el.text) + '</div>';
        } else if (el.dividerType === 'scene-header') {
          html += '<div class="sp-scene-header" data-scid="' + el.sceneId + '" data-epid="' + el.episodeId + '">';
          html += '<span class="sp-scene-num">SAHNE ' + el.sceneNum + '</span>';
          // Category dropdown
          html += '<select onchange="App.ScreenplayEditor.saveSceneMeta(\'' + el.sceneId + '\',\'category\',this.value)">';
          catEntries.forEach(([k,v]) => {
            html += '<option value="' + k + '"' + (k === el.category ? ' selected' : '') + '>' + U.escHtml(v.label) + '</option>';
          });
          html += '</select>';
          // Location dropdown (Ä°Ã‡/DIÅ)
          html += '<select onchange="App.ScreenplayEditor.saveSceneMeta(\'' + el.sceneId + '\',\'location\',this.value)">';
          ['Ä°Ã‡','DIÅ','Ä°Ã‡/DIÅ'].forEach(loc => {
            html += '<option value="' + loc + '"' + (loc === el.location ? ' selected' : '') + '>' + loc + '</option>';
          });
          html += '</select>';
          // Title input (mekan)
          html += '<input placeholder="Mekan" value="' + U.escHtml(el.title) + '" onchange="App.ScreenplayEditor.saveSceneMeta(\'' + el.sceneId + '\',\'title\',this.value)" />';
          // Time of day dropdown
          html += '<select onchange="App.ScreenplayEditor.saveSceneMeta(\'' + el.sceneId + '\',\'timeOfDay\',this.value)">';
          ['GÃœN','GECE','AKÅAM','ÅAFAK','SÃœREKLI'].forEach(t => {
            html += '<option value="' + t + '"' + (t === el.timeOfDay ? ' selected' : '') + '>' + t + '</option>';
          });
          html += '</select>';
          // Add scene button
          html += '<button class="sp-add-scene-btn" onclick="App.ScreenplayEditor.addSceneInEditor(\'' + el.sceneId + '\',\'' + el.episodeId + '\')">+ Sahne</button>';
          html += '</div>';
        } else if (el.dividerType === 'block-actions') {
          html += '<div class="sp-block-actions" data-scid="' + el.sceneId + '">';
          html += '<button onclick="App.ScreenplayEditor.addBlock(\'' + el.sceneId + '\',\'action\')">+ Aksiyon</button>';
          html += '<button onclick="App.ScreenplayEditor.addBlock(\'' + el.sceneId + '\',\'dialogue\')">+ Diyalog</button>';
          html += '<button onclick="App.ScreenplayEditor.addBlock(\'' + el.sceneId + '\',\'transition\')">+ GeÃ§iÅŸ</button>';
          html += '</div>';
        }
        return;
      }
      html += '<div class="sp-el sp-' + el.type + '" contenteditable="true" data-id="' + el.id + '" data-type="' + el.type + '" data-placeholder="' + (TYPE_PLACEHOLDERS[el.type] || '') + '" data-scid="' + (el.sceneId || '') + '" data-epidid="' + (el.episodeId || '') + '">';
      html += U.escHtml(String(el.text || ''));
      html += '</div>';
    });

    // If no elements, show placeholder
    if (!_elements.length) {
      html += '<div style="text-align:center;color:#999;padding:40px;font-family:Inter,sans-serif;font-size:14px;">HenÃ¼z iÃ§erik yok. BÃ¶lÃ¼m ve sahne ekleyin.</div>';
    }

    html += '</div></div>'; // close page + wrap

    // Autocomplete dropdown
    html += '<div class="sp-autocomplete" id="spAutocomplete"></div>';

    tlC.innerHTML = html;

    // Attach delegated event listeners
    const page = document.getElementById('spEditorPage');
    if (page) {
      page.addEventListener('keydown', onKeyDown);
      page.addEventListener('input', onInput);
      page.addEventListener('focusin', onFocus);
      page.addEventListener('focusout', onBlur);
    }

    // Recalc page breaks
    setTimeout(recalcPageBreaks, 50);
  }

  // â”€â”€ Event: Focus â”€â”€
  function onFocus(e) {
    const el = e.target.closest('.sp-el');
    if (!el) return;
    _activeElId = el.dataset.id;

    // Update type dropdown
    const sel = document.getElementById('spElTypeSelect');
    if (sel) sel.value = el.dataset.type;

    // Show type badge OUTSIDE the contenteditable (as previous sibling)
    removeBadges();
    const badge = document.createElement('span');
    badge.className = 'sp-el-type-badge';
    badge.textContent = TYPE_LABELS[el.dataset.type] || el.dataset.type;
    el.parentNode.insertBefore(badge, el);

    // Highlight scene in left panel
    const scId = el.dataset.scid;
    if (scId) {
      document.querySelectorAll('.scene-card').forEach(c => c.classList.toggle('active', c.dataset.sid === scId));
    }
  }

  function onBlur() {
    removeBadges();
  }

  function removeBadges() {
    document.querySelectorAll('.sp-el-type-badge').forEach(b => b.remove());
  }

  // â”€â”€ Event: KeyDown â”€â”€
  function onKeyDown(e) {
    const el = e.target.closest('.sp-el');
    if (!el) return;
    const elId = el.dataset.id;
    const elType = el.dataset.type;
    const idx = _elements.findIndex(x => x.id === elId);
    if (idx < 0) return;

    // Autocomplete navigation
    const acDrop = document.getElementById('spAutocomplete');
    if (acDrop && acDrop.classList.contains('open')) {
      if (e.key === 'ArrowDown') { e.preventDefault(); navigateAutocomplete(1); return; }
      if (e.key === 'ArrowUp') { e.preventDefault(); navigateAutocomplete(-1); return; }
      if (e.key === 'Enter') { e.preventDefault(); applyAutocomplete(); return; }
      if (e.key === 'Escape') { e.preventDefault(); hideAutocomplete(); return; }
    }

    // Tab â†’ change element type
    if (e.key === 'Tab') {
      e.preventDefault();
      const next = e.shiftKey ? TAB_PREV[elType] : TAB_NEXT[elType];
      if (next) {
        changeElementTypeDom(el, idx, next);
      }
      return;
    }

    // Enter â†’ new element
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const text = el.textContent.trim();

      // Empty line: transform current element
      if (!text && ENTER_EMPTY[elType]) {
        changeElementTypeDom(el, idx, ENTER_EMPTY[elType]);
        return;
      }

      // Non-empty: create new element after current
      const newType = ENTER_NEXT[elType] || 'action';
      const newEl = {
        id: 'el_' + U.genId('sp'), type: newType, text: '',
        sceneId: _elements[idx].sceneId, episodeId: _elements[idx].episodeId
      };
      _elements.splice(idx + 1, 0, newEl);

      // Insert DOM element
      const newDiv = document.createElement('div');
      newDiv.className = 'sp-el sp-' + newType;
      newDiv.contentEditable = 'true';
      newDiv.dataset.id = newEl.id;
      newDiv.dataset.type = newType;
      newDiv.dataset.placeholder = TYPE_PLACEHOLDERS[newType] || '';
      newDiv.dataset.scid = newEl.sceneId || '';
      newDiv.dataset.epidid = newEl.episodeId || '';
      el.after(newDiv);
      newDiv.focus();

      scheduleSyncToState();
      return;
    }

    // Review mode: intercept delete/backspace
    if ((e.key === 'Backspace' || e.key === 'Delete') && App.Review && App.Review.isReviewMode()) {
      if (App.Review.interceptDelete(e, el)) return;
    }

    // Backspace on empty â†’ delete element, focus previous
    if (e.key === 'Backspace' && !el.textContent.trim()) {
      e.preventDefault();
      // Find previous editable element
      const prevEl = findPrevEditable(el);
      if (prevEl) {
        _elements.splice(idx, 1);
        el.remove();
        prevEl.focus();
        // Place cursor at end
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(prevEl);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
        scheduleSyncToState();
      }
      return;
    }

    // Escape â†’ close focus mode
    if (e.key === 'Escape') {
      if (_focusMode) toggleFocusMode();
      return;
    }
  }

  function findPrevEditable(el) {
    let prev = el.previousElementSibling;
    while (prev) {
      if (prev.classList.contains('sp-el') && prev.contentEditable === 'true') return prev;
      prev = prev.previousElementSibling;
    }
    return null;
  }

  // â”€â”€ Event: Input â”€â”€
  function onInput(e) {
    const el = e.target.closest('.sp-el');
    if (!el) return;
    // Review mode interception
    if (App.Review && App.Review.isReviewMode()) {
      App.Review.interceptInput(e, el);
    }
    const elId = el.dataset.id;
    const idx = _elements.findIndex(x => x.id === elId);
    if (idx < 0) return;

    // Update element text
    _elements[idx].text = el.textContent;

    // Character autocomplete
    if (el.dataset.type === 'character') {
      showAutocomplete(el);
    } else {
      hideAutocomplete();
    }

    scheduleSyncToState();
  }

  // â”€â”€ Debounced sync â”€â”€
  function scheduleSyncToState() {
    if (_syncTimer) clearTimeout(_syncTimer);
    _syncTimer = setTimeout(syncToState, 400);
  }

  // â”€â”€ changeElementType (from toolbar) â”€â”€
  function changeElementType(newType) {
    const page = document.getElementById('spEditorPage');
    if (!page) return;
    const focused = page.querySelector('.sp-el:focus');
    if (!focused) return;
    const idx = _elements.findIndex(x => x.id === focused.dataset.id);
    if (idx < 0) return;
    changeElementTypeDom(focused, idx, newType);
  }

  function changeElementTypeDom(el, idx, newType) {
    const oldType = _elements[idx].type;
    _elements[idx].type = newType;
    el.className = 'sp-el sp-' + newType;
    el.dataset.type = newType;
    el.dataset.placeholder = TYPE_PLACEHOLDERS[newType] || '';

    // Update toolbar dropdown
    const sel = document.getElementById('spElTypeSelect');
    if (sel) sel.value = newType;

    // Update badge (outside the contenteditable)
    removeBadges();
    const badge = document.createElement('span');
    badge.className = 'sp-el-type-badge';
    badge.textContent = TYPE_LABELS[newType] || newType;
    el.parentNode.insertBefore(badge, el);

    scheduleSyncToState();
  }

  // â”€â”€ Autocomplete (Character Names) â”€â”€
  function showAutocomplete(el) {
    const text = el.textContent.trim().toUpperCase();
    if (!text) { hideAutocomplete(); return; }

    const P = S.get();
    // Collect all character names from store + elements
    const storeChars = P.characters.map(c => c.name.toUpperCase());
    const elChars = _elements.filter(x => x.type === 'character' && x.text.trim())
      .map(x => x.text.trim().toUpperCase());
    const allChars = [...new Set([...storeChars, ...elChars])];
    const matches = allChars.filter(c => c.startsWith(text) && c !== text);

    if (!matches.length) { hideAutocomplete(); return; }

    _autocompleteItems = matches;
    _autocompleteIndex = 0;
    _autocompleteEl = el;

    const drop = document.getElementById('spAutocomplete');
    if (!drop) return;
    let h = '';
    matches.forEach((m, i) => {
      h += '<div class="sp-autocomplete-item' + (i === 0 ? ' active' : '') + '" data-idx="' + i + '" onmousedown="App.ScreenplayEditor._pickAutocomplete(' + i + ')">' + U.escHtml(m) + '</div>';
    });
    drop.innerHTML = h;

    // Position using fixed viewport coordinates
    const rect = el.getBoundingClientRect();
    drop.style.position = 'fixed';
    drop.style.left = rect.left + 'px';
    drop.style.top = (rect.bottom + 4) + 'px';
    drop.classList.add('open');
  }

  function hideAutocomplete() {
    const drop = document.getElementById('spAutocomplete');
    if (drop) { drop.classList.remove('open'); drop.innerHTML = ''; }
    _autocompleteItems = [];
    _autocompleteIndex = 0;
    _autocompleteEl = null;
  }

  function navigateAutocomplete(dir) {
    _autocompleteIndex = Math.max(0, Math.min(_autocompleteItems.length - 1, _autocompleteIndex + dir));
    const drop = document.getElementById('spAutocomplete');
    if (!drop) return;
    drop.querySelectorAll('.sp-autocomplete-item').forEach((item, i) => {
      item.classList.toggle('active', i === _autocompleteIndex);
    });
  }

  function applyAutocomplete() {
    if (!_autocompleteEl || !_autocompleteItems.length) return;
    const name = _autocompleteItems[_autocompleteIndex];
    _autocompleteEl.textContent = name;
    const idx = _elements.findIndex(x => x.id === _autocompleteEl.dataset.id);
    if (idx >= 0) _elements[idx].text = name;
    hideAutocomplete();

    // Move cursor to end
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(_autocompleteEl);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);

    scheduleSyncToState();
  }

  function _pickAutocomplete(idx) {
    _autocompleteIndex = idx;
    applyAutocomplete();
  }

  // â”€â”€ syncToState: Push editor content back to project state â”€â”€
  function syncToState() {
    const P = S.get();
    S.snapshot();

    // Group elements by sceneId (skip dividers)
    const sceneMap = {};
    _elements.forEach(el => {
      if (el.divider) return;
      if (!el.sceneId) return;
      if (!sceneMap[el.sceneId]) sceneMap[el.sceneId] = [];
      sceneMap[el.sceneId].push(el);
    });

    // Update each scene's content blocks
    // Note: scene metadata (location, timeOfDay, title, category) is now
    // updated directly by saveSceneMeta() from header dropdowns/inputs
    Object.keys(sceneMap).forEach(scId => {
      const sc = S.getScene(scId);
      if (!sc) return;

      const els = sceneMap[scId];
      const newContent = [];

      let i = 0;
      while (i < els.length) {
        const el = els[i];
        if (el.type === 'action') {
          newContent.push({ type: 'action', text: el.text || '' });
          i++;
        } else if (el.type === 'character') {
          const charName = el.text.trim().toUpperCase();
          const charObj = P.characters.find(c => c.name.toUpperCase() === charName);
          const block = { type: 'dialogue', characterId: charObj ? charObj.id : '', text: '' };

          i++;
          if (i < els.length && els[i].type === 'parenthetical') {
            block.parenthetical = els[i].text;
            i++;
          }
          if (i < els.length && els[i].type === 'dialogue') {
            block.text = els[i].text;
            i++;
          }
          newContent.push(block);
        } else if (el.type === 'transition') {
          newContent.push({ type: 'transition', text: el.text || '' });
          i++;
        } else if (el.type === 'parenthetical' || el.type === 'dialogue') {
          newContent.push({ type: 'action', text: el.text || '' });
          i++;
        } else {
          i++;
        }
      }

      sc.content = newContent;
    });

    S.markDirty('scenes');
    S.emit('change', {type: 'screenplay-editor'});
  }

  // â”€â”€ recalcPageBreaks â”€â”€
  function recalcPageBreaks() {
    const page = document.getElementById('spEditorPage');
    if (!page) return;

    // Remove existing page breaks
    page.querySelectorAll('.sp-page-break').forEach(pb => pb.remove());

    // Each "page" is ~55 lines or ~792px at 12pt
    const PAGE_HEIGHT = 792; // approx US Letter minus margins
    let accHeight = 0;
    let pageNum = 1;
    const children = Array.from(page.children);

    children.forEach((child, idx) => {
      accHeight += child.offsetHeight + 12; // margin estimate
      if (accHeight >= PAGE_HEIGHT) {
        // Don't break right after a scene header (widow protection)
        if (child.classList.contains('sp-scene-header') && idx > 0) {
          const pb = document.createElement('div');
          pb.className = 'sp-page-break';
          pb.dataset.page = 'Sayfa ' + (++pageNum);
          child.before(pb);
        } else {
          const pb = document.createElement('div');
          pb.className = 'sp-page-break';
          pb.dataset.page = 'Sayfa ' + (++pageNum);
          child.after(pb);
        }
        accHeight = 0;
      }
    });
  }

  // â”€â”€ addSceneInEditor (positional insertion) â”€â”€
  function addSceneInEditor(afterSceneId, episodeId, _skipSnapshot) {
    const P = S.get();

    // Determine episode from afterScene if not provided
    if (!episodeId && afterSceneId) {
      const asc = S.getScene(afterSceneId);
      if (asc) episodeId = asc.episodeId;
    }
    if (!episodeId) {
      if (P.episodes.length) episodeId = P.episodes[0].id;
      else return;
    }

    if (!_skipSnapshot) S.snapshot();

    const existing = S.getScenes(episodeId);
    let newOrder;

    if (afterSceneId) {
      const afterSc = S.getScene(afterSceneId);
      if (afterSc) {
        // Shift subsequent scenes' order up by 1
        existing.filter(s => s.order > afterSc.order).forEach(s => { s.order += 1; });
        newOrder = afterSc.order + 1;
      } else {
        newOrder = existing.length ? Math.max(...existing.map(s => s.order)) + 1 : 1;
      }
    } else {
      newOrder = existing.length ? Math.max(...existing.map(s => s.order)) + 1 : 1;
    }

    const sc = {
      id: U.genId('sc'), episodeId: episodeId, order: newOrder,
      title: '', location: 'Ä°Ã‡', timeOfDay: 'GÃœN',
      category: 'karakter', characters: [],
      content: [{ type: 'action', text: '' }]
    };
    P.scenes.push(sc);

    // Auto-create timeline event
    const epEvs = P.events.filter(e => e.episodeId === sc.episodeId);
    const lastEnd = epEvs.reduce((m, e) => Math.max(m, e.s + e.dur), 0);
    P.events.push({
      id: U.genId('ev'), title: sc.title || 'Yeni Sahne', description: '', episodeId: sc.episodeId,
      sceneId: sc.id, category: sc.category, characters: [],
      s: Math.max(0, Math.min(lastEnd + 10, S.getEPDUR() - 60)), dur: 60
    });

    S.markDirty(['scenes','events']);
    S.emit('change', {type: 'screenplay-editor'});
    buildFromState();
    render();
    setTimeout(() => scrollToScene(sc.id), 100);
  }

  // â”€â”€ addBlock: Add action/dialogue/transition to a scene â”€â”€
  function addBlock(sceneId, blockType) {
    const sc = S.getScene(sceneId);
    if (!sc) return;
    S.snapshot();

    if (!sc.content) sc.content = [];
    if (blockType === 'dialogue') {
      sc.content.push({ type: 'dialogue', characterId: '', text: '', parenthetical: '' });
    } else {
      sc.content.push({ type: blockType, text: '' });
    }

    S.emit('change', {type: 'screenplay-editor'});
    buildFromState();
    render();

    // Focus the new element â€” for dialogue, focus the character line (second-to-last)
    setTimeout(() => {
      const page = document.getElementById('spEditorPage');
      if (!page) return;
      const scEls = page.querySelectorAll('.sp-el[data-scid="' + sceneId + '"]');
      if (scEls.length) {
        if (blockType === 'dialogue' && scEls.length >= 2) {
          // Focus character line (before dialogue text)
          scEls[scEls.length - 2].focus();
        } else {
          scEls[scEls.length - 1].focus();
        }
      }
    }, 100);
  }

  // â”€â”€ saveSceneMeta: Update scene metadata from header dropdowns â”€â”€
  function saveSceneMeta(sceneId, field, value) {
    const sc = S.getScene(sceneId);
    if (!sc) return;
    S.snapshot();
    sc[field] = value;

    // Sync category to corresponding timeline events
    if (field === 'category') {
      const P = S.get();
      P.events.filter(e => e.sceneId === sceneId).forEach(e => { e.category = value; });
      S.markDirty(['scenes','events']);
    } else {
      S.markDirty('scenes');
    }

    S.emit('change', {type: 'screenplay-editor'});
    // Don't do full rebuild â€” just update left panel. Header is already showing the new value.
  }

  // â”€â”€ addEpisodeInEditor â”€â”€
  function addEpisodeInEditor() {
    const P = S.get();
    const maxNum = P.episodes.reduce((m, e) => typeof e.number === 'number' ? Math.max(m, e.number) : m, 0);
    const ep = { id: U.genId('ep'), number: maxNum + 1, title: '', duration: S.getEPDUR(), type: 'normal', order: maxNum + 1 };

    // Single snapshot for the whole operation (addSceneInEditor won't re-snapshot)
    S.snapshot();
    P.episodes.push(ep);
    P.episodes.sort((a, b) => a.order - b.order);

    // Don't emit yet â€” addSceneInEditor will emit and rebuild (skip snapshot â€” we already took one)
    S.markDirty('episodes');
    addSceneInEditor(null, ep.id, true);
  }

  // â”€â”€ scrollToScene â”€â”€
  function scrollToScene(scId) {
    const page = document.getElementById('spEditorPage');
    if (!page) return;
    // Find scene heading or scene divider
    const target = page.querySelector('[data-scid="' + scId + '"]') || page.querySelector('[data-id="sh_' + scId + '"]');
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Flash effect
      target.classList.add('sp-flash');
      setTimeout(() => target.classList.remove('sp-flash'), 700);
    }
  }

  // â”€â”€ toggleFocusMode â”€â”€
  function toggleFocusMode() {
    _focusMode = !_focusMode;
    const page = document.getElementById('spEditorPage');
    if (page) page.classList.toggle('focus-mode', _focusMode);
    const btn = document.getElementById('spFocusBtn');
    if (btn) btn.classList.toggle('active', _focusMode);
  }

  // â”€â”€ unmount: Clean up when leaving screenplay mode â”€â”€
  function unmount() {
    _mounted = false;
    _elements = [];
    _activeElId = null;
    hideAutocomplete();
    if (_syncTimer) { clearTimeout(_syncTimer); _syncTimer = null; }
    document.body.classList.remove('screenplay-editor-active');
    const tlC = U.$('tlC');
    if (tlC) tlC.innerHTML = '';
  }

  return {
    render, buildFromState, syncToState, scrollToScene,
    addSceneInEditor, addEpisodeInEditor, toggleFocusMode,
    getActiveElement, changeElementType, isActive, unmount,
    addBlock, saveSceneMeta,
    _pickAutocomplete // for inline onclick
  };
})();


// â”€â”€ interaction.js â”€â”€
// â•â•â• INTERACTION MODULE â•â•â•
App.Interaction = (function(){
  const U = App.Utils;
  const S = App.Store;
  let drag = null;
  let pan = null;
  let selection = new Set();
  let snapGrid = 10;

  function getSelection() { return [...selection]; }
  function isDragging() { return !!drag; }
  function setSnap(v) { snapGrid = v; S.setSnap(v); }

  function setup() {
    const area = document.getElementById('tlA');

    // Wheel zoom
    area.addEventListener('wheel', e => {
      if(App.ScreenplayEditor && App.ScreenplayEditor.isActive()) return;
      if(e.ctrlKey || e.metaKey) {
        e.preventDefault();
        const d = e.deltaY > 0 ? -0.1 : 0.1;
        App.Timeline.setZoom(U.clamp(App.Timeline.getZoom() + d, 0.25, 3));
      }
    }, {passive:false});

    // Unified pointer handler (mouse + touch)
    function onPointerDown(clientX, clientY, target, isTouch) {
      const bl = target.closest('.evb');
      if(bl) {
        const ev = S.getEvent(bl.dataset.id);
        if(!ev) return;
        if(!selection.has(ev.id)) { selection.clear(); selection.add(ev.id); updateSelectionVisual(); }

        let mode = 'move';
        if(target.classList.contains('rh')) mode = target.classList.contains('l') ? 'rl' : 'rr';

        if(mode === 'move' && !isTouch) {
          const ghost = bl.cloneNode(true);
          ghost.classList.add('ghost');
          ghost.style.pointerEvents = 'none';
          bl.parentNode.appendChild(ghost);
          bl.classList.add('drag');
        }

        S.snapshot();
        const origLeft = parseInt(bl.style.left) || 0;
        const parentBody = bl.closest('.ep-body');
        const parentRect = parentBody ? parentBody.getBoundingClientRect() : null;
        drag = { id:ev.id, mode, sx:clientX, sy:clientY, os:ev.s, od:ev.dur, el:bl, origEp:ev.episodeId, origLeft, parentBody, parentRect, isTouch };
        App.UI.hideTooltip();
        return true;
      }
      return false;
    }

    // Mouse down
    area.addEventListener('mousedown', e => {
      if(App.ScreenplayEditor && App.ScreenplayEditor.isActive()) return;
      if(e.button !== 0) return;
      if(e.target.closest('.evb')) {
        e.preventDefault();
        // Multi-selection
        if(e.ctrlKey || e.metaKey) {
          const bl = e.target.closest('.evb');
          const evId = bl?.dataset.id;
          if(evId) { if(selection.has(evId)) selection.delete(evId); else selection.add(evId); updateSelectionVisual(); }
          return;
        }
        onPointerDown(e.clientX, e.clientY, e.target, false);
      } else {
        // Pan
        if(!e.target.closest('.ep-hdr')) {
          e.preventDefault();
          pan = { sx:e.clientX, sy:e.clientY, scrollX:area.scrollLeft, scrollY:area.scrollTop };
          area.classList.add('panning');
        }
      }
    });

    // Touch start
    let touchTimer = null;
    let touchStarted = false;
    area.addEventListener('touchstart', e => {
      if(App.ScreenplayEditor && App.ScreenplayEditor.isActive()) return;
      const t = e.touches[0];
      const bl = e.target.closest('.evb');
      if(bl) {
        // Long press for drag (short tap = select)
        touchStarted = false;
        touchTimer = setTimeout(() => {
          touchStarted = true;
          if(onPointerDown(t.clientX, t.clientY, e.target, true)) {
            bl.classList.add('drag');
          }
        }, 300);
        // Immediately select on tap
        const ev = S.getEvent(bl.dataset.id);
        if(ev) { selection.clear(); selection.add(ev.id); updateSelectionVisual(); }
      }
    }, {passive:true});

    // Touch move
    area.addEventListener('touchmove', e => {
      if(!touchStarted) { clearTimeout(touchTimer); return; }
      if(drag) {
        e.preventDefault();
        const t = e.touches[0];
        handlePointerMove(t.clientX, t.clientY, false);
      }
    }, {passive:false});

    // Touch end
    area.addEventListener('touchend', e => {
      clearTimeout(touchTimer);
      if(drag && touchStarted) {
        const t = e.changedTouches[0];
        handlePointerUp(t.clientX, t.clientY, false);
      } else if(!touchStarted && selection.size === 1) {
        // Short tap â€” open edit panel
        const selId = [...selection][0];
        if(selId) App.Panels.openEditEvent(selId);
      }
      touchStarted = false;
    }, {passive:true});

    // Mouse move
    function handlePointerMove(clientX, clientY, shiftKey) {
      if(!drag) return;
      const zoom = App.Timeline.getZoom();
      const ev = S.getEvent(drag.id);
      if(!ev) return;
      const dpx = (clientY - drag.sy) / zoom;
      const ds = U.px2s(dpx, S.getPPS());
      const EPDUR = S.getEPDUR();

      if(drag.mode === 'move') {
        let newS = drag.os + ds;
        newS = U.snap(newS, snapGrid);
        newS = U.clamp(newS, 0, EPDUR - ev.dur);
        ev.s = newS;

        const sg = document.getElementById('snapGuide');
        if(sg && snapGrid > 0) {
          sg.style.top = U.s2px(newS, S.getPPS()) + 'px';
          sg.classList.add('show');
        }

        if(!drag.isTouch) {
          const dropBody = findDropEp(clientX);
          document.querySelectorAll('.ep-body').forEach(b => b.classList.remove('drop-target'));
          if(dropBody && dropBody.dataset.ep !== drag.origEp) {
            dropBody.classList.add('drop-target');
            if(drag.el.parentNode !== dropBody) { dropBody.appendChild(drag.el); drag.el.style.left = '8px'; }
          } else if(dropBody && dropBody.dataset.ep === drag.origEp && drag.parentBody) {
            if(drag.el.parentNode !== drag.parentBody) { drag.parentBody.appendChild(drag.el); drag.el.style.left = drag.origLeft + 'px'; }
          }
        }

        drag.el.classList.remove('collision');
        const checkEpId = ev.episodeId;
        const others = S.getEvents(checkEpId).filter(o => o.id !== ev.id);
        const hasCollision = others.some(o => ev.s < o.s + o.dur && ev.s + ev.dur > o.s);
        if(hasCollision && !shiftKey) drag.el.classList.add('collision');

      } else if(drag.mode === 'rr') {
        let newDur = drag.od + ds;
        newDur = U.snap(newDur, snapGrid);
        ev.dur = U.clamp(newDur, 60, EPDUR - ev.s);
      } else if(drag.mode === 'rl') {
        let newS = U.snap(drag.os + ds, snapGrid);
        const diff = newS - drag.os;
        const newDur = drag.od - diff;
        if(newDur >= 60 && newS >= 0) { ev.s = newS; ev.dur = newDur; }
      }
      drag.el.style.top = U.s2px(ev.s, S.getPPS()) + 'px';
      drag.el.style.height = Math.max(U.s2px(ev.dur, S.getPPS()), 20) + 'px';
    }

    function handlePointerUp(clientX, clientY, shiftKey) {
      if(!drag) return;
      const ev = S.getEvent(drag.id);
      const didMove = Math.abs(clientX - drag.sx) > 3 || Math.abs(clientY - drag.sy) > 3;
      if(ev && drag.mode === 'move' && !drag.isTouch) {
        const dropBody = findDropEp(clientX);
        if(dropBody && dropBody.dataset.ep !== drag.origEp) {
          ev.episodeId = dropBody.dataset.ep;
          const sc = ev.sceneId ? S.getScene(ev.sceneId) : null;
          if(sc) sc.episodeId = ev.episodeId;
          resolveCollisions(ev.episodeId, ev.id);
          App.UI.toast('"' + ev.title + '" â†’ ' + (App.Utils.epLbl(S.get().episodes.find(ep=>ep.id===ev.episodeId)?.number||'?')));
        }
        if(!shiftKey) resolveCollisions(ev.episodeId, ev.id);
      }
      const ghosts = document.querySelectorAll('.evb.ghost');
      ghosts.forEach(g => g.remove());
      drag.el.classList.remove('drag','collision');
      document.querySelectorAll('.ep-body').forEach(b => b.classList.remove('drop-target'));
      const sg = document.getElementById('snapGuide');
      if(sg) sg.classList.remove('show');
      drag = null;
      if(didMove) {
        App.refresh();
      } else {
        setTimeout(() => App.refresh(), 300);
      }
    }

    window.addEventListener('mousemove', e => {
      if(drag) handlePointerMove(e.clientX, e.clientY, e.shiftKey);
      if(pan) {
        area.scrollLeft = pan.scrollX - (e.clientX - pan.sx);
        area.scrollTop = pan.scrollY - (e.clientY - pan.sy);
      }
    });

    window.addEventListener('mouseup', e => {
      if(drag) handlePointerUp(e.clientX, e.clientY, e.shiftKey);
      if(pan) { pan = null; area.classList.remove('panning'); }
    });

    // Double-click via event delegation (survives DOM re-renders)
    area.addEventListener('dblclick', e => {
      const bl = e.target.closest('.evb');
      if(bl && bl.dataset.id) {
        e.stopPropagation();
        App.Panels.openEditEvent(bl.dataset.id);
      }
    });

    // Right-click on empty space
    area.addEventListener('contextmenu', e => {
      if(!e.target.closest('.evb') && e.target.closest('.ep-body')) {
        e.preventDefault();
        const body = e.target.closest('.ep-body');
        const epId = body.dataset.ep;
        App.UI.showContextMenu(e.clientX, e.clientY, [
          { id:'add', icon:'+', label:'Buraya Olay Ekle', action:() => App.Panels.openAddEvent(epId) },
          { id:'paste', icon:'ğŸ“‹', label:'YapÄ±ÅŸtÄ±r', action:() => App.UI.toast('Panoya olay yok') }
        ]);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
      if(e.key === 'Escape') { App.Panels.closeAll(); selection.clear(); updateSelectionVisual(); }
      if(e.key === 'Delete' || e.key === 'Backspace') {
        if(selection.size) {
          if(confirm(selection.size + ' olay silinsin mi?')) {
            S.batch(() => { selection.forEach(id => { S.get().events = S.get().events.filter(e=>e.id!==id); S.get().connections = S.get().connections.filter(c=>c.from!==id&&c.to!==id); }); });
            selection.clear();
            App.refresh();
            App.UI.toast('Silindi');
          }
        }
      }
      if((e.ctrlKey||e.metaKey) && e.key === 'z') { e.preventDefault(); S.undo(); }
      if((e.ctrlKey||e.metaKey) && e.key === 'y') { e.preventDefault(); S.redo(); }
      if((e.ctrlKey||e.metaKey) && e.key === 's') { e.preventDefault(); App.Projects.save(); App.UI.toast('Kaydedildi'); }
      if((e.ctrlKey||e.metaKey) && e.key === 'n') { e.preventDefault(); App.Panels.openAddEvent(); }
    });

    // SP resize handle
    const spResize = document.getElementById('spResize');
    let spDrag = null;
    spResize.addEventListener('mousedown', e => {
      e.preventDefault();
      spDrag = { sx: e.clientX, sw: U.$('spPanel').offsetWidth };
      spResize.classList.add('active');
    });
    window.addEventListener('mousemove', e => {
      if(spDrag) {
        const newW = U.clamp(spDrag.sw + (e.clientX - spDrag.sx), 250, 600);
        U.$('spPanel').style.width = newW + 'px';
      }
    });
    window.addEventListener('mouseup', () => {
      if(spDrag) { spDrag = null; spResize.classList.remove('active'); }
    });
  }

  function findDropEp(clientX) {
    let best = null, bestDist = 999999;
    document.querySelectorAll('.ep-body').forEach(b => {
      const r = b.getBoundingClientRect();
      if(clientX >= r.left && clientX <= r.right) { best = b; bestDist = 0; }
      else { const d = Math.abs(clientX - (r.left+r.width/2)); if(d < bestDist) { bestDist = d; best = b; } }
    });
    return best;
  }

  function resolveCollisions(epId, myId) {
    const me = S.getEvent(myId);
    if(!me) return;
    const others = S.getEvents(epId).filter(e => e.id !== myId).sort((a,b) => a.s - b.s);
    others.forEach(o => {
      if(me.s < o.s + o.dur && me.s + me.dur > o.s) {
        o.s = me.s + me.dur + 10;
        if(o.s + o.dur > S.getEPDUR()) o.s = S.getEPDUR() - o.dur;
      }
    });
  }

  function updateSelectionVisual() {
    document.querySelectorAll('.evb').forEach(el => {
      el.classList.toggle('selected', selection.has(el.dataset.id));
    });
    App.UI.updateStatusBar();
    // If analysis panel is open with impact tab, refresh it
    if(App.Panels && App.Panels.isImpactActive()) {
      App.Panels.renderPanel();
    }
  }

  function showEventContext(e, evId) {
    const P = S.get();
    const ev = S.getEvent(evId);
    if(!ev) return;
    const items = [
      { id:'edit', icon:'âœï¸', label:'DÃ¼zenle', action:() => App.Panels.openEditEvent(evId) },
      { id:'scene', icon:'ğŸ“', label:'Senaryoda GÃ¶r', action:() => App.Screenplay.openSceneFromTimeline(evId) },
      'sep',
      { id:'copy', icon:'ğŸ“‹', label:'Kopyala', action:() => { copyEvent(evId); App.UI.toast('KopyalandÄ±'); } },
      { id:'link', icon:'ğŸ”—', label:'BaÄŸlantÄ± Ekle', action:() => App.Panels.openAddConnection(evId) },
      'sep',
      { id:'del', icon:'ğŸ—‘', label:'Sil', danger:true, action:() => { if(confirm('"'+ev.title+'" silinsin mi?')){ S.removeEvent(evId); App.refresh(); App.UI.toast('Silindi'); } } }
    ];
    App.UI.showContextMenu(e.clientX, e.clientY, items);
  }

  let clipboard = null;
  function copyEvent(id) {
    const ev = S.getEvent(id);
    if(ev) clipboard = U.deepClone(ev);
  }

  return { setup, getSelection, isDragging, setSnap, showEventContext, updateSelectionVisual };
})();

// â”€â”€ panels.js â”€â”€
// â•â•â• PANELS MODULE â•â•â•
App.Panels = (function(){
  const U = App.Utils;
  const S = App.Store;
  let currentPanel = null; // 'edit','warn','analysis'
  let editId = null;
  let analysisTab = 'warn';
  let activeWarnIdx = -1;

  function togglePanel(name) {
    if(currentPanel === name) { closeAll(); return; }
    currentPanel = name;
    renderPanel();
  }

  function closeAll() {
    currentPanel = null; editId = null; activeWarnIdx = -1;
    if(App.Notes) App.Notes.setPanelOpen(false);
    U.$('rPanel').classList.remove('open');
    App.Timeline.clrHL();
  }

  function renderPanel() {
    const rp = U.$('rPanel');
    rp.classList.add('open');
    if(currentPanel === 'edit') renderEditPanel();
    else if(currentPanel === 'warn') renderWarnPanel();
    else if(currentPanel === 'analysis') renderAnalysisPanel();
    else if(currentPanel === 'changelog') App.Changelog.renderPanel();
    else if(currentPanel === 'notes') { App.Notes.setPanelOpen(true); App.Notes.renderPanel(); }
    else if(currentPanel === 'ai') { if(App.AI) App.AI.renderPanel(); }
    else if(currentPanel === 'review') { if(App.Review) App.Review.renderReviewPanel(); }
    else if(currentPanel === 'relmap') { /* keep existing relmap panel content */ }
    else { rp.classList.remove('open'); }
  }

  // â”€â”€ EDIT PANEL â”€â”€
  function openEditEvent(id) {
    editId = id; currentPanel = 'edit';
    renderPanel();
  }

  function renderEditPanel() {
    const P = S.get();
    const ev = S.getEvent(editId);
    if(!ev) { closeAll(); return; }
    const rp = U.$('rPanel');
    const cns = S.getConnections(editId);
    const tl = { neden:'Neden-SonuÃ§', karakter:'Karakter', kronoloji:'Kronoloji' };
    rp.innerHTML = `<div class="rpanel-hdr"><h3>Olay DÃ¼zenle</h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>
      <div class="rpanel-body" style="padding:14px;">
        <div class="fg"><label>BaÅŸlÄ±k</label><input id="dT" value="${U.escHtml(ev.title)}"></div>
        <div class="fg"><label>Ã–zet</label><textarea id="dD">${U.escHtml(ev.description||'')}</textarea></div>
        <div class="fg"><label>Senaryo Metni <span style="color:var(--tx4);text-transform:none;font-weight:400">â€” karakter iÃ§in <b style="color:var(--cyan)">@</b></span></label>
          <div class="scene-screenplay-wrap">
            <div class="scene-screenplay" id="dScreenplay" contenteditable="true" data-placeholder="Sahne metnini yazÄ±n..." style="min-height:120px;max-height:250px;"></div>
            <div class="mention-popup" id="dMentionPopup"></div>
          </div>
        </div>
        <div class="fg"><label>BÃ¶lÃ¼m</label><select id="dEp">${P.episodes.map(ep=>`<option value="${ep.id}"${ev.episodeId===ep.id?' selected':''}>${U.epLbl(ep.number)}</option>`).join('')}</select></div>
        <div class="fg"><label>Kategori</label><select id="dC">${Object.entries(P.categories).map(([k,v])=>`<option value="${k}"${ev.category===k?' selected':''}>${U.escHtml(v.label)}</option>`).join('')}</select></div>
        <div class="fg"><label>BaÅŸlangÄ±Ã§ (sn)</label><input type="number" id="dS" value="${Math.round(ev.s)}" min="0" max="${S.getEPDUR()}"></div>
        <div class="fg"><label>SÃ¼re (sn)</label><input type="number" id="dDur" value="${Math.round(ev.dur)}" min="60"></div>
        <div class="fg"><label>Karakterler</label><div class="chw">${P.characters.map(c=>`<label class="chcb"><input type="checkbox" value="${c.id}"${(ev.characters||[]).includes(c.id)?' checked':''}>${U.escHtml(c.name)}</label>`).join('')}</div></div>
        <div class="epc"><label style="font-size:10px;color:var(--tx3);text-transform:uppercase;font-weight:500">BaÄŸlantÄ±lar (${cns.length})</label>
          ${cns.map(c=>{const o=c.from===editId?S.getEvent(c.to):S.getEvent(c.from);return `<div class="eci"><span>${c.from===editId?'â†’':'â†'} ${o?U.escHtml(o.title):'?'} (${tl[c.type]||c.type})</span><button class="btn btn-s" style="color:var(--red)" onclick="App.Panels.rmCn('${c.from}','${c.to}','${c.type}')">âœ•</button></div>`;}).join('')}
          <button class="btn btn-s" style="margin-top:6px" onclick="App.Panels.openAddConnection('${editId}')">+ BaÄŸlantÄ±</button>
        </div>
      </div>
      <div class="epf">
        <button class="btn" style="color:var(--red)" onclick="App.Panels.delEvent('${editId}')">Sil</button>
        <div style="flex:1"></div>
        <button class="btn" onclick="App.Panels.closeAll()">Ä°ptal</button>
        <button class="btn btn-p" onclick="App.Panels.saveEvent('${editId}')">Kaydet</button>
      </div>`;
    setTimeout(() => {
      const el = document.getElementById('dScreenplay');
      if(!el) return;
      // Load existing screenplay if event has a scene
      if(ev.sceneId) {
        const sc = S.getScene(ev.sceneId);
        if(sc && sc.screenplay) {
          el.innerHTML = App.Screenplay.formatScreenplayHTML(ev.sceneId, sc.screenplay);
        }
      }
      el.addEventListener('input', () => _editMention.handleInput());
      el.addEventListener('keydown', (e) => _editMention.handleKeydown(e));
    }, 50);
  }

  function saveEvent(id) {
    const ev = S.getEvent(id); if(!ev) return;
    S.snapshot();
    ev.title = U.validateText(document.getElementById('dT').value.trim(), 'title') || ev.title;
    ev.description = U.validateText(document.getElementById('dD').value.trim(), 'description');
    ev.episodeId = document.getElementById('dEp').value;
    ev.category = document.getElementById('dC').value;
    ev.s = Math.max(0, parseInt(document.getElementById('dS').value) || 0);
    ev.dur = Math.max(60, parseInt(document.getElementById('dDur').value) || 120);
    ev.characters = [];
    document.querySelectorAll('#rPanel .chcb input:checked').forEach(cb => ev.characters.push(cb.value));
    // Save screenplay text
    const { text: screenplay, chars: mentionChars } = getEditScreenplayText();
    mentionChars.forEach(cid => { if(!ev.characters.includes(cid)) ev.characters.push(cid); });
    if(ev.sceneId) {
      const sc = S.getScene(ev.sceneId);
      if(sc) sc.screenplay = screenplay;
    } else if(screenplay.trim()) {
      // Create new scene for this event
      const P = S.get();
      const existing = P.scenes.filter(s => s.episodeId === ev.episodeId);
      const order = existing.length ? Math.max(...existing.map(s=>s.order)) + 1 : 1;
      const scId = U.genId('sc');
      P.scenes.push({
        id: scId, episodeId: ev.episodeId, order, title: ev.title, location: '', timeOfDay: '',
        category: ev.category, characters: ev.characters,
        content: [{ type: 'action', text: screenplay.replace(/@\[[^\]]+\]\([^)]+\)/g, m => '@' + m.match(/@\[([^\]]+)\]/)[1]) }],
        screenplay: screenplay
      });
      ev.sceneId = scId;
    }
    S.markDirty(['events','scenes']);
    S.emit('change', {type:'updateEvent',targetId:ev.id,targetName:ev.title||''});
    closeAll();
    App.UI.toast('"' + ev.title + '" gÃ¼ncellendi');
  }

  function delEvent(id) {
    const ev = S.getEvent(id);
    if(!ev || !confirm('"' + ev.title + '" silinsin mi?')) return;
    S.removeEvent(id);
    closeAll();
    App.UI.toast('Silindi');
  }

  function rmCn(f,t,tp) { S.removeConnection(f,t,tp); if(editId) renderPanel(); App.UI.toast('BaÄŸlantÄ± kaldÄ±rÄ±ldÄ±'); }

  function openAddConnection(fromId) {
    const P = S.get();
    const others = P.events.filter(e => e.id !== fromId);
    App.UI.openModal(`<div class="mh"><span>BaÄŸlantÄ± Ekle</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>
      <div class="mb">
        <div class="fg"><label>Hedef</label><select id="cTo">${others.map(e=>`<option value="${e.id}">${U.epLbl(P.episodes.find(ep=>ep.id===e.episodeId)?.number||'?')}: ${U.escHtml(e.title)}</option>`).join('')}</select></div>
        <div class="fg"><label>TÃ¼r</label><select id="cTp"><option value="neden">Neden-SonuÃ§</option><option value="karakter">Karakter</option><option value="kronoloji">Kronoloji</option></select></div>
      </div>
      <div class="mf"><button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button><button class="btn btn-p" onclick="App.Panels.doAddConnection('${fromId}')">Ekle</button></div>`);
  }

  function doAddConnection(fromId) {
    const to = document.getElementById('cTo').value;
    const type = document.getElementById('cTp').value;
    S.addConnection({ id: U.genId('cn'), from: fromId, to, type, description:'', strength:1 });
    App.UI.closeModal();
    if(editId) renderPanel();
    App.UI.toast('BaÄŸlantÄ± eklendi');
  }

  // â”€â”€ ADD EVENT â”€â”€
  // Use shared mention helper for modal and edit panel
  const _modalMention = App.Mention.createInstance({
    getInputEl: () => document.getElementById('nScreenplay'),
    getPopupEl: () => document.getElementById('nMentionPopup'),
    buildItemHtml: (c, i) => `<div class="mp-item${i===0?' active':''}" data-cid="${c.id}" data-name="${U.escHtml(c.name)}" onmousedown="event.preventDefault();App.Panels.insertModalMention('${c.id}')"><span class="mp-dot" style="background:${U.sanitizeColor(c.color)||'var(--tx3)'}"></span>${U.escHtml(c.name)}</div>`,
    onInsert: (charId) => { const cb = document.querySelector('#mbg .chcb input[value="' + charId + '"]'); if(cb) cb.checked = true; }
  });

  function openAddEvent(epId) {
    const P = S.get();
    if(!P.episodes.length) { App.UI.toast('Ã–nce bir bÃ¶lÃ¼m ekleyin'); return; }
    const defaultEp = epId || P.episodes[0].id;
    App.UI.openModal(`<div class="mh"><span>Yeni Olay</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>
      <div class="mb">
        <div class="fg"><label>BaÅŸlÄ±k</label><input id="nT" placeholder="Olay baÅŸlÄ±ÄŸÄ±"></div>
        <div class="fg"><label>BÃ¶lÃ¼m</label><select id="nEp">${P.episodes.map(ep=>`<option value="${ep.id}"${ep.id===defaultEp?' selected':''}>${U.epLbl(ep.number)}</option>`).join('')}</select></div>
        <div class="fg"><label>Kategori</label><select id="nC">${Object.entries(P.categories).map(([k,v])=>`<option value="${k}">${U.escHtml(v.label)}</option>`).join('')}</select></div>
        <div style="display:flex;gap:8px"><div class="fg" style="flex:1"><label>BaÅŸlangÄ±Ã§ (dk)</label><input type="number" id="nS" value="0" min="0" max="${Math.floor(S.getEPDUR()/60)}"></div>
        <div class="fg" style="flex:1"><label>SÃ¼re (dk)</label><input type="number" id="nDur" value="3" min="1" max="${Math.floor(S.getEPDUR()/60)}"></div></div>
        <div class="fg"><label>Ã–zet</label><textarea id="nDesc" placeholder="KÄ±sa aÃ§Ä±klama..." rows="2" style="resize:vertical"></textarea></div>
        <div class="fg"><label>Senaryo Metni <span style="color:var(--tx4);text-transform:none;font-weight:400">â€” karakter eklemek iÃ§in <b style="color:var(--cyan)">@</b> yazÄ±n</span></label>
          <div class="scene-screenplay-wrap">
            <div class="scene-screenplay" id="nScreenplay" contenteditable="true" data-placeholder="Sahne metnini yazÄ±n... Karakter iÃ§in @ kullanÄ±n." style="min-height:150px;max-height:300px;"></div>
            <div class="mention-popup" id="nMentionPopup"></div>
          </div>
        </div>
      </div>
      <div class="mf"><button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button><button class="btn btn-p" onclick="App.Panels.doAddEvent()">Ekle</button></div>`);
    // Setup mention listeners for modal (uses shared App.Mention)
    setTimeout(() => {
      const el = document.getElementById('nScreenplay');
      if(!el) return;
      el.addEventListener('input', () => _modalMention.handleInput());
      el.addEventListener('keydown', (e) => _modalMention.handleKeydown(e));
    }, 50);
  }

  function insertModalMention(charId) { _modalMention.insertMention(charId); }

  function getModalScreenplayText() {
    const el = document.getElementById('nScreenplay');
    if(!el) return { text: '', chars: [] };
    let text = '';
    const chars = [];
    el.childNodes.forEach(node => {
      if(node.nodeType === Node.TEXT_NODE) {
        text += node.textContent;
      } else if(node.classList && node.classList.contains('mention')) {
        const cid = node.dataset.charId;
        const name = node.textContent.replace(/^@/, '');
        text += `@[${name}](${cid})`;
        if(cid && !chars.includes(cid)) chars.push(cid);
      } else if(node.tagName === 'BR') {
        text += '\n';
      } else if(node.tagName === 'DIV' || node.tagName === 'P') {
        if(text && !text.endsWith('\n')) text += '\n';
        text += node.textContent || '';
      } else {
        text += node.textContent || '';
      }
    });
    return { text, chars };
  }

  // â”€â”€ EDIT PANEL MENTION SUPPORT (uses shared App.Mention) â”€â”€
  const _editMention = App.Mention.createInstance({
    getInputEl: () => document.getElementById('dScreenplay'),
    getPopupEl: () => document.getElementById('dMentionPopup'),
    buildItemHtml: (c, i) => `<div class="mp-item${i===0?' active':''}" data-cid="${c.id}" data-name="${U.escHtml(c.name)}" onmousedown="event.preventDefault();App.Panels.insertEditMention('${c.id}')"><span class="mp-dot" style="background:${U.sanitizeColor(c.color)||'var(--tx3)'}"></span>${U.escHtml(c.name)}</div>`,
    onInsert: (charId) => { const cb = document.querySelector('#rPanel .chcb input[value="' + charId + '"]'); if(cb) cb.checked = true; }
  });

  function insertEditMention(charId) { _editMention.insertMention(charId); }

  function getEditScreenplayText() {
    const el = document.getElementById('dScreenplay');
    if(!el) return { text: '', chars: [] };
    let text = '';
    const chars = [];
    el.childNodes.forEach(node => {
      if(node.nodeType === Node.TEXT_NODE) {
        text += node.textContent;
      } else if(node.classList && node.classList.contains('mention')) {
        const cid = node.dataset.charId;
        const name = node.textContent.replace(/^@/, '');
        text += `@[${name}](${cid})`;
        if(cid && !chars.includes(cid)) chars.push(cid);
      } else if(node.tagName === 'BR') {
        text += '\n';
      } else if(node.tagName === 'DIV' || node.tagName === 'P') {
        if(text && !text.endsWith('\n')) text += '\n';
        text += node.textContent || '';
      } else {
        text += node.textContent || '';
      }
    });
    return { text, chars };
  }

  function doAddEvent() {
    let t = document.getElementById('nT').value.trim();
    if(!t) { App.UI.toast('BaÅŸlÄ±k gerekli!'); return; }
    t = U.validateText(t, 'title');
    const { text: screenplay, chars: mentionChars } = getModalScreenplayText();
    const ch = [];
    document.querySelectorAll('#mbg .chcb input:checked').forEach(cb => ch.push(cb.value));
    // Merge mention chars
    mentionChars.forEach(cid => { if(!ch.includes(cid)) ch.push(cid); });
    const ozet = U.validateText((document.getElementById('nDesc').value || '').trim(), 'description');
    const epId = document.getElementById('nEp').value;
    const cat = document.getElementById('nC').value;
    const sVal = (parseInt(document.getElementById('nS').value) || 0) * 60;
    const durVal = (parseInt(document.getElementById('nDur').value) || 3) * 60;
    // Plain text for description (strip mention markers)
    const desc = screenplay.replace(/@\[[^\]]+\]\([^)]+\)/g, m => '@' + m.match(/@\[([^\]]+)\]/)[1]);
    // Create scene + event
    const P = S.get();
    const existing = P.scenes.filter(s => s.episodeId === epId);
    const order = existing.length ? Math.max(...existing.map(s=>s.order)) + 1 : 1;
    const scId = U.genId('sc');
    const evId = U.genId('ev');
    S.snapshot();
    P.scenes.push({
      id: scId, episodeId: epId, order, title: t, location: '', timeOfDay: '',
      category: cat, characters: ch,
      content: [{ type: 'action', text: desc }],
      screenplay: screenplay
    });
    P.events.push({
      id: evId, title: t, description: ozet, episodeId: epId, category: cat,
      characters: ch, sceneId: scId, s: sVal, dur: durVal
    });
    S.markDirty(['events','scenes']);
    S.emit('change', {type:'addEvent',targetId:evId,targetName:t});
    App.UI.closeModal();
    App.UI.toast('"' + t + '" eklendi');
  }

  // â”€â”€ WARN PANEL â”€â”€
  function renderWarnPanel() {
    const warns = App.Analysis.getWarnings();
    const rp = U.$('rPanel');
    const icons = { overflow:'â±', dep:'â›“', overlap:'âŠ˜', gap:'â—Œ', charConflict:'ğŸ‘¤', orphan:'ğŸ”—', cycle:'ğŸ”„', empty:'ğŸ“', duration:'â±' };
    let h = `<div class="rpanel-hdr"><h3>âš  UyarÄ±lar <span class="badge">${warns.length}</span></h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div><div class="rpanel-body">`;
    if(!warns.length) h += '<div class="nw">âœ“ Sorun yok</div>';
    else warns.forEach((w,i) => {
      h += `<div class="wi${activeWarnIdx===i?' active':''}" data-widx="${i}" onclick="App.Panels.toggleWarnHL(${i})">
        <div class="wt">${icons[w.tp]||'âš '} ${U.escHtml(w.t)}</div><div class="wd">${U.escHtml(w.d)}</div>
        ${w.fix?`<div class="wf"><button class="btn btn-s" onclick="event.stopPropagation();App.Analysis.getWarnings()[${i}].fix()">Otomatik DÃ¼zelt</button></div>`:''}</div>`;
    });
    h += '</div>';
    rp.innerHTML = h;
  }

  function toggleWarnHL(idx) {
    if(activeWarnIdx === idx) { activeWarnIdx = -1; App.Timeline.clrHL(); renderPanel(); return; }
    activeWarnIdx = idx;
    App.Timeline.clrHL();
    const w = App.Analysis.getWarnings()[idx];
    if(!w) return;
    const ids = []; if(w.id) ids.push(w.id); if(w.id2) ids.push(w.id2);
    document.querySelectorAll('.evb').forEach(el => {
      if(ids.includes(el.dataset.id)) el.classList.add('warn-hl'); else el.classList.add('dim');
    });
    if(ids.length) App.Timeline.scrollToEvent(ids[0]);
    renderPanel();
  }

  // â”€â”€ ANALYSIS PANEL â”€â”€
  function renderAnalysisPanel() {
    const rp = U.$('rPanel');
    let h = `<div class="rpanel-hdr"><h3>â— Analiz</h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>`;
    h += `<div class="rtabs">
      <button class="rtab${analysisTab==='warn'?' active':''}" onclick="App.Panels.setAnalysisTab('warn')">UyarÄ±lar</button>
      <button class="rtab${analysisTab==='connections'?' active':''}" onclick="App.Panels.setAnalysisTab('connections')">BaÄŸlantÄ±lar</button>
      <button class="rtab${analysisTab==='tempo'?' active':''}" onclick="App.Panels.setAnalysisTab('tempo')">Tempo</button>
      <button class="rtab${analysisTab==='chars'?' active':''}" onclick="App.Panels.setAnalysisTab('chars')">Karakterler</button>
      <button class="rtab${analysisTab==='impact'?' active':''}" onclick="App.Panels.setAnalysisTab('impact')">Etki</button>
      <button class="rtab${analysisTab==='relations'?' active':''}" onclick="App.Panels.setAnalysisTab('relations')">Ä°liÅŸkiler</button>
    </div>`;
    h += '<div class="rpanel-body">';
    if(analysisTab === 'warn') h += renderWarnContent();
    else if(analysisTab === 'connections') h += App.Analysis.renderConnections();
    else if(analysisTab === 'tempo') h += App.Analysis.renderTempo();
    else if(analysisTab === 'chars') h += App.Analysis.renderCharacters();
    else if(analysisTab === 'impact') h += App.Analysis.renderImpact();
    else if(analysisTab === 'relations') h += _renderRelationsAnalysis();
    h += '</div>';
    rp.innerHTML = h;
  }

  function renderWarnContent() {
    const warns = App.Analysis.getWarnings();
    const icons = { overflow:'â±', dep:'â›“', overlap:'âŠ˜', gap:'â—Œ', charConflict:'ğŸ‘¤', orphan:'ğŸ”—', cycle:'ğŸ”„', empty:'ğŸ“', duration:'â±' };
    if(!warns.length) return '<div class="nw">âœ“ Sorun yok</div>';
    return warns.map((w,i) => `<div class="wi" onclick="App.Panels.toggleWarnHL(${i})">
      <div class="wt">${icons[w.tp]||'âš '} ${U.escHtml(w.t)}</div><div class="wd">${U.escHtml(w.d)}</div>
      ${w.fix?`<div class="wf"><button class="btn btn-s" onclick="event.stopPropagation();App.Analysis.getWarnings()[${i}].fix()">DÃ¼zelt</button></div>`:''}</div>`).join('');
  }

  function setAnalysisTab(tab) { analysisTab = tab; renderPanel(); }
  function isImpactActive() { return currentPanel === 'analysis' && analysisTab === 'impact'; }

  function _renderRelationsAnalysis() {
    const P = S.get();
    const chars = P.characters;
    const rels = P.characterRelationships || [];
    if(!rels.length) return '<div class="nw">HenÃ¼z karakter iliÅŸkisi yok.<br>Ä°liÅŸkiler gÃ¶rÃ¼nÃ¼mÃ¼nden ekleyin.</div>';
    let h = '<div style="padding:14px;">';
    // Summary
    h += '<div style="font-size:12px;color:var(--tx2);margin-bottom:12px;">' + rels.length + ' iliÅŸki, ' + chars.length + ' karakter</div>';
    // Type distribution
    const types = {};
    rels.forEach(r => { types[r.type || 'diÄŸer'] = (types[r.type || 'diÄŸer'] || 0) + 1; });
    h += '<div style="margin-bottom:12px;">';
    Object.entries(types).forEach(([t, c]) => {
      h += '<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px;">';
      h += '<span style="flex:1;color:var(--tx);">' + U.escHtml(t) + '</span>';
      h += '<span style="color:var(--tx3);">' + c + '</span>';
      h += '</div>';
    });
    h += '</div>';
    // Most connected characters
    const charCounts = {};
    rels.forEach(r => { charCounts[r.from] = (charCounts[r.from] || 0) + 1; charCounts[r.to] = (charCounts[r.to] || 0) + 1; });
    const sorted = Object.entries(charCounts).sort((a,b) => b[1] - a[1]);
    h += '<div style="font-size:10px;color:var(--tx3);text-transform:uppercase;font-weight:500;margin-bottom:6px;">En baÄŸlantÄ±lÄ± karakterler</div>';
    sorted.slice(0, 10).forEach(([cid, count]) => {
      const ch = chars.find(c => c.id === cid);
      h += '<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px;">';
      h += '<span style="flex:1;color:var(--tx);">' + U.escHtml(ch ? ch.name : cid) + '</span>';
      h += '<span style="color:var(--tx3);">' + count + ' iliÅŸki</span>';
      h += '</div>';
    });
    h += '</div>';
    return h;
  }

  // â”€â”€ SETTINGS â”€â”€
  function openSettings() {
    const P = S.get();
    let catsHtml = Object.entries(P.categories).map(([k,v]) =>
      `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
        <input type="color" value="${v.color}" style="width:28px;height:24px;border:none;background:none;cursor:pointer;" data-catk="${k}" class="cat-color-in">
        <input value="${U.escHtml(v.label)}" style="flex:1;padding:4px 6px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);border-radius:4px;font-size:12px;font-family:inherit;" data-catk="${k}" class="cat-label-in">
        <button class="btn btn-s" style="color:var(--red)" onclick="this.parentNode.remove()">âœ•</button>
      </div>`).join('');
    let charsHtml = P.characters.map(c =>
      `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;" data-chid="${c.id}">
        <input value="${U.escHtml(c.name)}" style="flex:1;padding:4px 6px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);border-radius:4px;font-size:12px;font-family:inherit;" class="char-name-in">
        <button class="btn btn-s" style="color:var(--red)" onclick="this.parentNode.remove()">âœ•</button>
      </div>`).join('');

    App.UI.openModal(`<div class="mh"><span>Proje AyarlarÄ±</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>
      <div class="mb">
        <div class="fg"><label>Proje AdÄ±</label><input id="sTitle" value="${U.escHtml(P.meta.title)}"></div>
        <div class="fg"><label>Yazar</label><input id="sAuthor" value="${U.escHtml(P.meta.author||'')}"></div>
        <div class="fg"><label>BÃ¶lÃ¼m SÃ¼resi (saniye)</label><input type="number" id="sEpDur" value="${P.meta.settings.episodeDuration}" min="300" max="7200"></div>
        <div class="fg"><label>Kategoriler</label>
          <div id="sCats">${catsHtml}</div>
          <button class="btn btn-s" style="margin-top:4px" onclick="document.getElementById('sCats').insertAdjacentHTML('beforeend','<div style=\\'display:flex;align-items:center;gap:6px;margin-bottom:4px;\\'><input type=\\'color\\' value=\\'#888888\\' style=\\'width:28px;height:24px;border:none;background:none;cursor:pointer;\\' class=\\'cat-color-in\\' data-catk=\\'new_'+Date.now()+'\\'><input placeholder=\\'Yeni Kategori\\' style=\\'flex:1;padding:4px 6px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);border-radius:4px;font-size:12px;font-family:inherit;\\' class=\\'cat-label-in\\' data-catk=\\'new_'+Date.now()+'\\'><button class=\\'btn btn-s\\' style=\\'color:var(--red)\\' onclick=\\'this.parentNode.remove()\\'>âœ•</button></div>')">+ Kategori</button>
        </div>
        <div class="fg"><label>Karakterler</label>
          <div id="sChars">${charsHtml}</div>
          <button class="btn btn-s" style="margin-top:4px" onclick="document.getElementById('sChars').insertAdjacentHTML('beforeend','<div style=\\'display:flex;align-items:center;gap:6px;margin-bottom:4px;\\' data-chid=\\'new_'+Date.now()+'\\'><input placeholder=\\'Yeni Karakter\\' style=\\'flex:1;padding:4px 6px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);border-radius:4px;font-size:12px;font-family:inherit;\\' class=\\'char-name-in\\'><button class=\\'btn btn-s\\' style=\\'color:var(--red)\\' onclick=\\'this.parentNode.remove()\\'>âœ•</button></div>')">+ Karakter</button>
        </div>
        <div class="ai-config-section">
          <h4 style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--purple);">âœ¦ AI YapÄ±landÄ±rmasÄ±</h4>
          <div class="fg"><label>AI SaÄŸlayÄ±cÄ±</label>
            <select id="sAIProvider" onchange="App.AI._onProviderChange(this.value)" style="padding:4px 8px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx2);font-size:12px;font-family:inherit;width:100%;">
              ${Object.entries(App.AI.PROVIDERS).map(([k,v])=>'<option value="'+k+'"'+(App.AI.getProvider()===k?' selected':'')+'>'+v.name+'</option>').join('')}
            </select>
          </div>
          <div class="fg"><label>Model</label>
            <select id="sAIModel" onchange="App.AI.setModel(this.value)" style="padding:4px 8px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx2);font-size:12px;font-family:inherit;width:100%;">
              ${App.AI.PROVIDERS[App.AI.getProvider()].models.map(m=>'<option value="'+m.id+'"'+(App.AI.getModel()===m.id?' selected':'')+'>'+m.label+'</option>').join('')}
            </select>
          </div>
          <div class="fg"><label>API AnahtarÄ±</label>
            <div style="display:flex;gap:4px;">
              <input type="password" id="sAIKey" placeholder="API anahtarÄ±nÄ±zÄ± girin" value="${App.AI.getKey()?'********':''}" style="flex:1;padding:4px 8px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx);font-size:12px;font-family:inherit;">
              <button class="btn btn-s" id="aiTestBtn" onclick="App.AI._testKey()">Test</button>
            </div>
            <div id="aiTestResult" style="font-size:11px;margin-top:4px;min-height:14px;"></div>
          </div>
          <div style="font-size:10px;color:var(--tx3);margin-top:4px;">ğŸ”’ AnahtarÄ±nÄ±z yalnÄ±zca tarayÄ±cÄ±nÄ±zda (localStorage) saklanÄ±r, hiÃ§bir sunucuya gÃ¶nderilmez.</div>
        </div>
      </div>
      <div class="mf"><button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button><button class="btn btn-p" onclick="App.Panels.saveSettings()">Kaydet</button></div>`);
  }

  function saveSettings() {
    const P = S.get();
    S.snapshot();
    P.meta.title = document.getElementById('sTitle').value.trim() || 'Yeni Proje';
    P.meta.author = document.getElementById('sAuthor').value.trim();
    P.meta.settings.episodeDuration = Math.max(300, parseInt(document.getElementById('sEpDur').value) || 2700);
    // Categories
    const newCats = {};
    document.querySelectorAll('#sCats > div').forEach(row => {
      const colorIn = row.querySelector('.cat-color-in');
      const labelIn = row.querySelector('.cat-label-in');
      if(colorIn && labelIn && labelIn.value.trim()) {
        const key = labelIn.value.trim().toLowerCase().replace(/[^a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9]/gi,'_');
        newCats[key] = { label: labelIn.value.trim(), color: colorIn.value };
      }
    });
    P.categories = newCats;
    // Characters
    const newChars = [];
    document.querySelectorAll('#sChars > div').forEach(row => {
      const nameIn = row.querySelector('.char-name-in');
      const existingId = row.dataset.chid;
      if(nameIn && nameIn.value.trim()) {
        const id = (existingId && !existingId.startsWith('new_')) ? existingId : U.genId('ch');
        newChars.push({ id, name: nameIn.value.trim(), color:'', notes:'' });
      }
    });
    P.characters = newChars;
    // AI Settings
    if(App.AI) {
      const provVal = document.getElementById('sAIProvider')?.value;
      const modelVal = document.getElementById('sAIModel')?.value;
      if(provVal) App.AI.setProvider(provVal);
      if(modelVal) App.AI.setModel(modelVal);
      const keyInp = document.getElementById('sAIKey');
      if(keyInp && keyInp.value && keyInp.value !== '********') App.AI.setKey(App.AI.getProvider(), keyInp.value.trim());
    }
    S.markDirty(['categories','characters']);
    S.emit('change', {type:'settings'});
    App.UI.closeModal();
    document.getElementById('projTitle').textContent = P.meta.title;
    App.UI.toast('Ayarlar kaydedildi');
  }

  function getCurrentPanel() { return currentPanel; }
  function setCurrentPanel(name) { currentPanel = name; }

  return { togglePanel, closeAll, openEditEvent, saveEvent, delEvent, rmCn, openAddConnection, doAddConnection, openAddEvent, doAddEvent, insertModalMention, insertEditMention, toggleWarnHL, setAnalysisTab, renderPanel, openSettings, saveSettings, renderWarnPanel, renderAnalysisPanel, isImpactActive, getCurrentPanel, setCurrentPanel };
})();

// â”€â”€ analysis.js â”€â”€
// â•â•â• ANALYSIS MODULE â•â•â•
App.Analysis = (function(){
  const U = App.Utils;
  const S = App.Store;
  let cachedWarnings = null;

  function invalidateCache() { cachedWarnings = null; }

  function getWarnings() {
    if(cachedWarnings) return cachedWarnings;
    const P = S.get();
    const warns = [];
    const EPDUR = S.getEPDUR();

    // Overflow
    P.events.forEach(ev => {
      if(ev.s + ev.dur > EPDUR + 5) {
        const ep = P.episodes.find(e=>e.id===ev.episodeId);
        warns.push({ tp:'overflow', id:ev.id, t:'SÃ¼re TaÅŸmasÄ±', d:`"${ev.title}" (${U.epLbl(ep?.number||'?')}) bÃ¶lÃ¼m sÃ¼resini aÅŸÄ±yor.`,
          fix:()=>{ S.snapshot(); ev.dur = EPDUR - ev.s; S.markDirty('events'); S.emit('change',{type:'fix',targetId:ev.id,targetName:ev.title||''}); App.UI.toast('DÃ¼zeltildi'); } });
      }
    });

    // Dependency errors
    const epOrder = {};
    P.episodes.forEach((ep,i) => epOrder[ep.id] = i);
    P.connections.filter(c=>c.type==='neden').forEach(cn => {
      const fe = S.getEvent(cn.from), te = S.getEvent(cn.to);
      if(!fe || !te) return;
      const fAbs = (epOrder[fe.episodeId]||0) * EPDUR + fe.s + fe.dur;
      const tAbs = (epOrder[te.episodeId]||0) * EPDUR + te.s;
      if(fAbs > tAbs + 30)
        warns.push({ tp:'dep', id:cn.from, id2:cn.to, t:'BaÄŸÄ±mlÄ±lÄ±k HatasÄ±', d:`"${fe.title}" â†’ "${te.title}": Neden, sonuÃ§tan sonra!`,
          fix:()=>{ S.snapshot(); const newAbs=fAbs+60; const eps=P.episodes; const newEpIdx=Math.min(Math.floor(newAbs/EPDUR),eps.length-1); te.episodeId=eps[newEpIdx].id; te.s=Math.min(newAbs%EPDUR,EPDUR-te.dur); S.markDirty('events'); S.emit('change',{type:'fix',targetId:te.id,targetName:te.title||''}); App.UI.toast('TaÅŸÄ±ndÄ±'); } });
    });

    // Overlaps
    P.episodes.forEach(ep => {
      const re = P.events.filter(e=>e.episodeId===ep.id).sort((a,b)=>a.s-b.s);
      for(let i=0;i<re.length;i++) for(let j=i+1;j<re.length;j++) {
        if(re[i]._lane===re[j]._lane && re[j].s < re[i].s+re[i].dur)
          warns.push({ tp:'overlap', id:re[i].id, id2:re[j].id, t:'Ã‡akÄ±ÅŸma', d:`"${re[i].title}" ile "${re[j].title}" Ã§akÄ±ÅŸÄ±yor.`,
            fix:()=>{ S.snapshot(); re[j].s=re[i].s+re[i].dur; S.markDirty('events'); S.emit('change',{type:'fix',targetId:re[j].id,targetName:re[j].title||''}); App.UI.toast('DÃ¼zeltildi'); } });
      }
    });

    // Gaps
    P.episodes.forEach(ep => {
      if(ep.number==='fb') return;
      const re = P.events.filter(e=>e.episodeId===ep.id).sort((a,b)=>a.s-b.s);
      if(!re.length) return;
      let cur = 0;
      re.forEach(ev => {
        if(ev.s - cur > 600)
          warns.push({ tp:'gap', id:ev.id, t:'BoÅŸluk', d:`${U.epLbl(ep.number)}: ${U.s2t(cur)}â€“${U.s2t(ev.s)} arasÄ± ${Math.round((ev.s-cur)/60)}dk boÅŸ.` });
        cur = Math.max(cur, ev.s + ev.dur);
      });
    });

    // Character conflict (same character in 2 places at same time, same episode)
    P.episodes.forEach(ep => {
      const evs = P.events.filter(e=>e.episodeId===ep.id);
      for(let i=0;i<evs.length;i++) for(let j=i+1;j<evs.length;j++) {
        if(evs[i].s < evs[j].s+evs[j].dur && evs[i].s+evs[i].dur > evs[j].s) {
          const shared = (evs[i].characters||[]).filter(c=>(evs[j].characters||[]).includes(c));
          shared.forEach(cid => {
            const ch = P.characters.find(c=>c.id===cid);
            warns.push({ tp:'charConflict', id:evs[i].id, id2:evs[j].id, t:'Karakter Ã‡akÄ±ÅŸmasÄ±', d:`${ch?ch.name:cid} aynÄ± anda "${evs[i].title}" ve "${evs[j].title}" sahnelerinde.` });
          });
        }
      }
    });

    // Orphan events
    P.events.forEach(ev => {
      const cns = P.connections.filter(c=>c.from===ev.id||c.to===ev.id);
      if(cns.length===0 && P.events.length > 5)
        warns.push({ tp:'orphan', id:ev.id, t:'Yetim Olay', d:`"${ev.title}" hiÃ§bir olaya baÄŸlÄ± deÄŸil.` });
    });

    // Cycle detection
    const cycles = detectCycles();
    cycles.forEach(cycle => {
      warns.push({ tp:'cycle', id:cycle[0], t:'DÃ¶ngÃ¼sel BaÄŸÄ±mlÄ±lÄ±k', d:`DÃ¶ngÃ¼: ${cycle.map(id=>{const e=S.getEvent(id);return e?e.title:id;}).join(' â†’ ')}` });
    });

    // Empty scenes
    P.scenes.forEach(sc => {
      if(!sc.content || sc.content.length === 0 || sc.content.every(b=>!b.text||!b.text.trim()))
        warns.push({ tp:'empty', id:null, t:'BoÅŸ Sahne', d:`"${sc.title}" sahnesinde iÃ§erik yok.` });
    });

    cachedWarnings = warns;
    return warns;
  }

  function detectCycles() {
    const P = S.get();
    const adj = {};
    P.connections.filter(c=>c.type==='neden').forEach(c => {
      if(!adj[c.from]) adj[c.from] = [];
      adj[c.from].push(c.to);
    });
    const visited = new Set(), stack = new Set(), cycles = [];
    function dfs(node, path) {
      if(stack.has(node)) { cycles.push([...path.slice(path.indexOf(node)), node]); return; }
      if(visited.has(node)) return;
      visited.add(node); stack.add(node); path.push(node);
      (adj[node]||[]).forEach(n => dfs(n, path));
      path.pop(); stack.delete(node);
    }
    Object.keys(adj).forEach(n => { if(!visited.has(n)) dfs(n, []); });
    return cycles;
  }

  // Critical path (longest chain via topo sort + DP)
  function getCriticalPath() {
    const P = S.get();
    const adj = {}, inDeg = {};
    P.events.forEach(e => { adj[e.id] = []; inDeg[e.id] = 0; });
    P.connections.filter(c=>c.type==='neden').forEach(c => {
      if(adj[c.from]) { adj[c.from].push(c.to); inDeg[c.to] = (inDeg[c.to]||0) + 1; }
    });
    // Topo sort (Kahn's)
    const q = Object.keys(inDeg).filter(k=>inDeg[k]===0);
    const order = [];
    while(q.length) {
      const n = q.shift(); order.push(n);
      (adj[n]||[]).forEach(m => { inDeg[m]--; if(inDeg[m]===0) q.push(m); });
    }
    // DP for longest path
    const dist = {}, prev = {};
    order.forEach(n => { dist[n] = 0; prev[n] = null; });
    order.forEach(n => {
      (adj[n]||[]).forEach(m => {
        const ev = S.getEvent(n);
        const w = ev ? ev.dur : 0;
        if(dist[n] + w > (dist[m]||0)) { dist[m] = dist[n] + w; prev[m] = n; }
      });
    });
    // Find end with max dist
    let maxNode = null, maxDist = 0;
    Object.entries(dist).forEach(([k,v]) => { if(v > maxDist) { maxDist = v; maxNode = k; } });
    // Trace back
    const path = [];
    let cur = maxNode;
    while(cur) { path.unshift(cur); cur = prev[cur]; }
    return { path, length: maxDist };
  }

  // BFS impact analysis
  function getImpact(evId) {
    const P = S.get();
    const adj = {};
    P.connections.filter(c=>c.type==='neden').forEach(c => {
      if(!adj[c.from]) adj[c.from] = [];
      adj[c.from].push(c.to);
    });
    const depths = {};
    const q = [evId];
    depths[evId] = 0;
    while(q.length) {
      const cur = q.shift();
      (adj[cur]||[]).forEach(n => {
        if(!(n in depths)) { depths[n] = depths[cur] + 1; q.push(n); }
      });
    }
    delete depths[evId];
    return depths; // id -> depth
  }

  // Character analysis
  function getCharacterData() {
    const P = S.get();
    const epOrder = {};
    P.episodes.forEach((ep,i) => epOrder[ep.id] = i);
    return P.characters.map(ch => {
      const evs = P.events.filter(e=>(e.characters||[]).includes(ch.id));
      const perEp = {};
      evs.forEach(e => { perEp[e.episodeId] = (perEp[e.episodeId]||0) + e.dur; });
      const totalDur = evs.reduce((s,e)=>s+e.dur,0);
      // Gap detection
      const epNums = [...new Set(evs.map(e=>epOrder[e.episodeId]))].sort((a,b)=>a-b);
      const gaps = [];
      for(let i=1;i<epNums.length;i++) {
        if(epNums[i]-epNums[i-1]>1) gaps.push({ from:epNums[i-1]+1, to:epNums[i]-1 });
      }
      return { char: ch, events: evs, perEp, totalDur, gaps };
    });
  }

  // Tempo analysis (events per minute per episode)
  function getTempoData() {
    const P = S.get();
    return P.episodes.map(ep => {
      const evs = P.events.filter(e=>e.episodeId===ep.id);
      const density = evs.length / (S.getEPDUR()/60);
      const totalDur = evs.reduce((s,e)=>s+e.dur,0);
      const coverage = totalDur / S.getEPDUR();
      return { ep, events: evs.length, density, coverage, totalDur };
    });
  }

  // Render functions for analysis tabs
  function renderConnections() {
    const cp = getCriticalPath();
    const P = S.get();
    if(!cp.path.length) return '<div class="nw">BaÄŸlantÄ± yok</div>';
    let h = '<div style="padding:14px;"><div style="font-size:12px;font-weight:600;margin-bottom:8px;">Kritik Yol (En Uzun Zincir)</div>';
    h += `<div style="font-size:11px;color:var(--tx3);margin-bottom:10px;">Toplam: ${U.s2t(cp.length)} Â· ${cp.path.length} olay</div>`;
    cp.path.forEach((id,i) => {
      const ev = S.getEvent(id);
      if(!ev) return;
      const cat = P.categories[ev.category]||{color:'#888'};
      h += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;cursor:pointer;" onclick="App.Timeline.scrollToEvent('${id}')">
        <div style="width:8px;height:8px;border-radius:50%;background:${U.sanitizeColor(cat.color)};flex-shrink:0;"></div>
        <span style="font-size:11px;">${U.escHtml(ev.title)}</span>
      </div>`;
      if(i < cp.path.length-1) h += '<div style="margin-left:3px;border-left:2px solid var(--brd);height:12px;"></div>';
    });
    h += '</div>';
    return h;
  }

  function renderTempo() {
    const data = getTempoData();
    if(!data.length) return '<div class="nw">BÃ¶lÃ¼m yok</div>';
    const maxDensity = Math.max(...data.map(d=>d.density), 0.1);
    let h = '<div style="padding:10px 0;">';
    data.forEach(d => {
      const pct = (d.density / maxDensity * 100).toFixed(0);
      const color = d.density > maxDensity*0.7 ? 'var(--red)' : d.density > maxDensity*0.4 ? 'var(--yellow)' : 'var(--green)';
      h += `<div class="tempo-row">
        <span style="min-width:36px;">${U.epLbl(d.ep.number)}</span>
        <div class="tempo-bar"><div class="tempo-fill" style="width:${pct}%;background:${color};"></div></div>
        <span style="min-width:50px;text-align:right;color:var(--tx3);">${d.events} olay</span>
      </div>`;
    });
    h += '</div>';
    return h;
  }

  function renderCharacters() {
    const data = getCharacterData();
    if(!data.length) return '<div class="nw">Karakter yok</div>';
    const maxDur = Math.max(...data.map(d=>d.totalDur), 1);
    let h = '';
    data.sort((a,b)=>b.totalDur-a.totalDur).forEach(d => {
      const pct = (d.totalDur / maxDur * 100).toFixed(0);
      h += `<div class="char-row">
        <div style="font-size:12px;font-weight:500;">${U.escHtml(d.char.name)}</div>
        <div style="font-size:10px;color:var(--tx3);">${d.events.length} sahne Â· ${U.s2t(d.totalDur)}</div>
        <div class="char-bar" style="width:${pct}%;background:var(--blue);"></div>
        ${d.gaps.length ? `<div style="font-size:10px;color:var(--orange);margin-top:2px;">âš  ${d.gaps.map(g=>`B${g.from+1}-B${g.to+1}`).join(', ')} bÃ¶lÃ¼mlerinde yok</div>` : ''}
      </div>`;
    });
    return h;
  }

  function renderImpact() {
    const sel = App.Interaction.getSelection();
    if(!sel.length) return '<div class="nw" style="line-height:1.6;">Bir olay seÃ§in ve etki analizini gÃ¶rÃ¼n.<br><br>Timeline\'da bir olaya tÄ±klayÄ±n.</div>';
    const evId = sel[0];
    const ev = S.getEvent(evId);
    if(!ev) return '<div class="nw">Olay bulunamadÄ±</div>';
    const impact = getImpact(evId);
    const impactCount = Object.keys(impact).length;
    if(!impactCount) return `<div class="impact-info"><b>${U.escHtml(ev.title)}</b><br><br>Bu olayÄ±n baÅŸka olaylara etkisi yok (neden-sonuÃ§ baÄŸlantÄ±sÄ± bulunmuyor).</div>`;

    let h = `<div class="impact-info"><b>${U.escHtml(ev.title)}</b><br>Bu olay deÄŸiÅŸirse <b>${impactCount} olay</b> etkilenir.</div>`;
    // Group by depth
    const byDepth = {};
    Object.entries(impact).forEach(([id,depth]) => {
      if(!byDepth[depth]) byDepth[depth] = [];
      byDepth[depth].push(id);
    });
    const depthColors = ['var(--red)','var(--orange)','var(--yellow)','var(--tx3)'];
    Object.keys(byDepth).sort((a,b)=>a-b).forEach(depth => {
      const color = depthColors[Math.min(depth-1, depthColors.length-1)];
      h += `<div style="padding:4px 14px;font-size:10px;color:${color};font-weight:600;margin-top:8px;">${depth}. Derece Etki</div>`;
      byDepth[depth].forEach(id => {
        const e = S.getEvent(id);
        h += `<div style="padding:4px 14px;font-size:11px;cursor:pointer;color:var(--tx2);" onclick="App.Timeline.scrollToEvent('${id}')">${e?U.escHtml(e.title):id}</div>`;
      });
    });

    // Highlight on timeline
    setTimeout(() => {
      App.Timeline.clrHL();
      document.querySelectorAll('.evb').forEach(el => {
        const d = impact[el.dataset.id];
        if(el.dataset.id === evId) el.classList.add('selected');
        else if(d === 1) el.classList.add('impact-1');
        else if(d === 2) el.classList.add('impact-2');
        else if(d >= 3) el.classList.add('impact-3');
        else el.classList.add('dim');
      });
    }, 50);

    return h;
  }

  return { getWarnings, invalidateCache, getCriticalPath, getImpact, getCharacterData, getTempoData, renderConnections, renderTempo, renderCharacters, renderImpact, detectCycles };
})();

// â”€â”€ relationship-map.js â”€â”€
// â•â•â• RELATIONSHIP MAP MODULE â•â•â•
App.RelationshipMap = (function(){
  const U = App.Utils;
  const S = App.Store;

  let _svg = null;
  let _container = null;
  let _viewBox = { x: 0, y: 0, w: 1200, h: 800 };
  let _zoom = 1;
  let _isPanning = false;
  let _panStart = { x: 0, y: 0 };
  let _dragNode = null;
  let _dragOffset = { x: 0, y: 0 };
  let _selectedNode = null;
  let _selectedEdge = null;
  let _mouseDownPos = null;
  let _mouseDownNodeId = null;
  let _isDragging = false;
  const DRAG_THRESHOLD = 5;
  let _mounted = false;

  const ROLE_SIZES = { primary: 40, secondary: 30, tertiary: 22 };
  const ROLE_COLORS = { primary: 'var(--blue)', secondary: 'var(--green)', tertiary: 'var(--tx3)' };
  const REL_COLORS = {
    mentor: '#3b82f6', aile: '#10b981', dost: '#06b6d4', dusman: '#ef4444',
    sevgili: '#ec4899', rakip: '#f97316', is: '#f59e0b', gizli: '#a855f7'
  };
  const EDGE_CURVE = 0.06;

  function render() {
    _container = document.getElementById('tlC');
    if(!_container) return;
    _mounted = true;
    _container.style.overflow = 'hidden';
    _container.style.position = 'relative';
    _container.style.cursor = 'grab';

    const P = S.get();
    const chars = P.characters;
    const rels = P.characterRelationships || [];

    // Toolbar
    let html = '<div class="rm-toolbar">';
    html += '<button class="btn btn-s" onclick="App.RelationshipMap.openAddRelationship()">+ Ä°liÅŸki</button>';
    html += '<button class="btn btn-s" onclick="App.RelationshipMap.autoLayout()">Otomatik YerleÅŸim</button>';
    html += '<button class="btn btn-s" onclick="App.RelationshipMap.exportPNG()">PNG Ä°ndir</button>';
    html += '<button class="btn btn-s" onclick="App.RelationshipMap.zoomIn()">+</button>';
    html += '<button class="btn btn-s" onclick="App.RelationshipMap.zoomOut()">-</button>';
    html += '<button class="btn btn-s" onclick="App.RelationshipMap.zoomReset()">SÄ±ÄŸdÄ±r</button>';
    html += '</div>';

    // SVG
    html += '<svg id="rmSvg" width="100%" height="100%" style="position:absolute;top:40px;left:0;right:0;bottom:0;">';
    html += '<defs>';
    // Node shadow filter
    html += '<filter id="nodeShadow" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.35)"/></filter>';
    // Node shine gradient (3D highlight)
    html += '<radialGradient id="nodeShine" cx="35%" cy="30%" r="65%"><stop offset="0%" stop-color="white" stop-opacity="0.22"/><stop offset="100%" stop-color="white" stop-opacity="0"/></radialGradient>';
    // Per-color arrow markers (small open chevron style)
    var _usedColors = {};
    rels.forEach(function(rel) { var c = REL_COLORS[rel.type] || '#888888'; _usedColors[c] = true; });
    Object.keys(_usedColors).forEach(function(color) {
      var cid = 'arr_' + color.replace(/[^a-zA-Z0-9]/g, '');
      html += '<marker id="' + cid + '" viewBox="0 0 10 8" refX="9" refY="4" markerWidth="4" markerHeight="4" orient="auto"><path d="M1.5,1 L8,4 L1.5,7" fill="none" stroke="' + U.sanitizeColor(color) + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/></marker>';
      html += '<marker id="' + cid + 'b" viewBox="0 0 10 8" refX="1" refY="4" markerWidth="4" markerHeight="4" orient="auto"><path d="M8.5,1 L2,4 L8.5,7" fill="none" stroke="' + U.sanitizeColor(color) + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/></marker>';
    });
    html += '</defs>';
    html += '<g id="rmRoot">';

    // Assign default positions if missing
    const cx = _viewBox.w / 2, cy = _viewBox.h / 2;
    chars.forEach((ch, i) => {
      if(ch.relMapX == null || ch.relMapY == null) {
        const angle = (2 * Math.PI * i) / Math.max(chars.length, 1);
        const radius = Math.min(cx, cy) * 0.6;
        ch.relMapX = cx + Math.cos(angle) * radius;
        ch.relMapY = cy + Math.sin(angle) * radius;
      }
    });

    // Edges (curved bezier paths)
    rels.forEach(rel => {
      const from = chars.find(c => c.id === rel.from);
      const to = chars.find(c => c.id === rel.to);
      if(!from || !to) return;
      const color = REL_COLORS[rel.type] || '#888888';
      const sw = Math.max(0.8, 0.5 + (rel.strength || 1) * 0.4);
      const x1 = from.relMapX, y1 = from.relMapY, x2 = to.relMapX, y2 = to.relMapY;

      // Shorten to node edge
      const dx = x2 - x1, dy = y2 - y1;
      const dist = Math.sqrt(dx*dx + dy*dy) || 1;
      const rFrom = ROLE_SIZES[from.role || 'secondary'] || 30;
      const rTo = ROLE_SIZES[to.role || 'secondary'] || 30;
      const nx1 = x1 + (dx/dist) * (rFrom + 6);
      const ny1 = y1 + (dy/dist) * (rFrom + 6);
      const nx2 = x2 - (dx/dist) * (rTo + 6);
      const ny2 = y2 - (dy/dist) * (rTo + 6);

      // Bezier control point (subtle curve)
      const mx = (nx1 + nx2) / 2, my = (ny1 + ny2) / 2;
      const perpX = -(ny2 - ny1) / dist, perpY = (nx2 - nx1) / dist;
      const cpx = mx + perpX * dist * EDGE_CURVE;
      const cpy = my + perpY * dist * EDGE_CURVE;
      const pathD = 'M' + nx1 + ',' + ny1 + ' Q' + cpx + ',' + cpy + ' ' + nx2 + ',' + ny2;
      // Label at bezier midpoint (t=0.5)
      const lx = 0.25*nx1 + 0.5*cpx + 0.25*nx2;
      const ly = 0.25*ny1 + 0.5*cpy + 0.25*ny2;

      const cid = 'arr_' + color.replace(/[^a-zA-Z0-9]/g, '');
      const selected = _selectedEdge === rel.id;
      html += '<g class="rm-edge' + (selected ? ' selected' : '') + '" data-relid="' + rel.id + '">';
      // Clickable invisible fat path
      html += '<path d="' + pathD + '" stroke="transparent" stroke-width="14" fill="none" style="cursor:pointer"/>';
      // Visible curved path
      html += '<path d="' + pathD + '" stroke="' + U.sanitizeColor(color) + '" stroke-width="' + sw + '" fill="none" stroke-linecap="round" marker-end="url(#' + cid + ')"';
      if(rel.bidirectional) html += ' marker-start="url(#' + cid + 'b)"';
      html += ' stroke-opacity="' + (selected ? '0.9' : '0.4') + '"/>';
      // Label
      const label = rel.type || '';
      if(label) {
        html += '<text x="' + lx + '" y="' + (ly - 3) + '" text-anchor="middle" fill="' + U.sanitizeColor(color) + '" font-size="9" font-weight="500" font-family="Inter,sans-serif" pointer-events="none" opacity="0.8">' + U.escHtml(label) + '</text>';
      }
      if(rel.description) {
        html += '<text x="' + lx + '" y="' + (ly + 9) + '" text-anchor="middle" fill="var(--tx3)" font-size="7.5" font-family="Inter,sans-serif" pointer-events="none" opacity="0.6">' + U.escHtml(rel.description.substring(0, 30)) + '</text>';
      }
      html += '</g>';
    });

    // Nodes
    chars.forEach(ch => {
      const r = ROLE_SIZES[ch.role || 'secondary'] || 30;
      const x = ch.relMapX, y = ch.relMapY;
      const selected = _selectedNode === ch.id;
      const color = U.sanitizeColor(ch.color) || '#3b82f6';
      const initials = getInitials(ch.name);

      html += '<g class="rm-node' + (selected ? ' selected' : '') + '" data-chid="' + ch.id + '" transform="translate(' + x + ',' + y + ')" style="cursor:grab">';
      // Selection glow (always present, toggled via _updateSelection)
      html += '<circle class="rm-glow" r="' + (r + 5) + '" fill="none" stroke="var(--cyan)" stroke-width="1.5" stroke-dasharray="4,3" style="opacity:' + (selected ? '1' : '0') + '"/>';
      // Main circle with drop shadow
      html += '<circle r="' + r + '" fill="' + color + '" filter="url(#nodeShadow)"/>';
      // Shine overlay (3D highlight)
      html += '<circle r="' + r + '" fill="url(#nodeShine)" pointer-events="none"/>';
      // Subtle border ring
      html += '<circle r="' + r + '" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.8"/>';
      // Initials
      html += '<text y="1" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="' + Math.max(10, r * 0.55) + '" font-weight="600" font-family="Inter,sans-serif" pointer-events="none">' + U.escHtml(initials) + '</text>';
      // Name label below
      html += '<text y="' + (r + 14) + '" text-anchor="middle" fill="var(--tx)" font-size="10.5" font-weight="500" font-family="Inter,sans-serif" pointer-events="none">' + U.escHtml(ch.name) + '</text>';
      // Role badge
      if(ch.role === 'primary') {
        html += '<text y="' + (r + 25) + '" text-anchor="middle" fill="var(--tx3)" font-size="7.5" font-family="Inter,sans-serif" pointer-events="none" opacity="0.7">Ana Karakter</text>';
      }
      html += '</g>';
    });

    html += '</g></svg>';
    _container.innerHTML = html;

    _svg = document.getElementById('rmSvg');
    if(_svg) {
      _svg.setAttribute('viewBox', _viewBox.x + ' ' + _viewBox.y + ' ' + (_viewBox.w / _zoom) + ' ' + (_viewBox.h / _zoom));
      _attachEvents();
    }
  }

  function getInitials(name) {
    if(!name) return '?';
    const parts = name.split(/\s+/);
    if(parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
    return name.substring(0, 2).toUpperCase();
  }

  function _attachEvents() {
    if(!_svg) return;

    _svg.addEventListener('mousedown', function(e) {
      const node = e.target.closest('.rm-node');
      const edge = e.target.closest('.rm-edge');

      if(node) {
        e.preventDefault();
        e.stopPropagation();
        const chId = node.dataset.chid;
        _mouseDownNodeId = chId;
        _mouseDownPos = { x: e.clientX, y: e.clientY };
        _isDragging = false;
        // Prepare drag offset but don't start drag yet
        const ch = S.getCharacters().find(c => c.id === chId);
        if(!ch) return;
        const pt = _svgPoint(e);
        _dragOffset.x = pt.x - ch.relMapX;
        _dragOffset.y = pt.y - ch.relMapY;
        _svg.style.cursor = 'grabbing';
        return;
      }

      if(edge) {
        e.preventDefault();
        e.stopPropagation();
        const relId = edge.dataset.relid;
        _selectedEdge = relId;
        _selectedNode = null;
        _mouseDownNodeId = null;
        _showEdgeDetails(relId);
        _updateSelection();
        return;
      }

      // Pan start (only on background)
      _isPanning = true;
      _panStart.x = e.clientX;
      _panStart.y = e.clientY;
      _svg.style.cursor = 'grabbing';
    });

    _svg.addEventListener('mousemove', function(e) {
      // Check drag threshold for node drag
      if(_mouseDownNodeId && !_isDragging && !_dragNode) {
        const dx = e.clientX - _mouseDownPos.x;
        const dy = e.clientY - _mouseDownPos.y;
        if(Math.sqrt(dx*dx + dy*dy) > DRAG_THRESHOLD) {
          _isDragging = true;
          _dragNode = _mouseDownNodeId;
          _selectedNode = _mouseDownNodeId;
          _selectedEdge = null;
          _updateSelection();
        }
        return;
      }

      if(_dragNode) {
        const ch = S.getCharacters().find(c => c.id === _dragNode);
        if(!ch) return;
        const pt = _svgPoint(e);
        ch.relMapX = pt.x - _dragOffset.x;
        ch.relMapY = pt.y - _dragOffset.y;
        _updateNodeDOM(ch);
        _updateEdgeDOM();
        return;
      }

      if(_isPanning) {
        const dx = (e.clientX - _panStart.x) / _zoom;
        const dy = (e.clientY - _panStart.y) / _zoom;
        _viewBox.x -= dx;
        _viewBox.y -= dy;
        _panStart.x = e.clientX;
        _panStart.y = e.clientY;
        if(_svg) _svg.setAttribute('viewBox', _viewBox.x + ' ' + _viewBox.y + ' ' + (_viewBox.w / _zoom) + ' ' + (_viewBox.h / _zoom));
      }
    });

    _svg.addEventListener('mouseup', function(e) {
      if(_mouseDownNodeId && !_isDragging) {
        // Click (not drag) â€” show details in panel
        const chId = _mouseDownNodeId;
        _selectedNode = chId;
        _selectedEdge = null;
        _showNodeDetails(chId);
        _updateSelection();
        _mouseDownNodeId = null;
        _mouseDownPos = null;
        _svg.style.cursor = 'grab';
        return;
      }

      if(_dragNode) {
        S.markDirty('characters');
        S.emit('change', { type: 'relMapDrag' });
        _dragNode = null;
        _isDragging = false;
        _mouseDownNodeId = null;
        _mouseDownPos = null;
      }
      _isPanning = false;
      _svg.style.cursor = 'grab';
    });

    _svg.addEventListener('mouseleave', function() {
      if(_dragNode) {
        S.markDirty('characters');
        S.emit('change', { type: 'relMapDrag' });
        _dragNode = null;
        _isDragging = false;
      }
      _mouseDownNodeId = null;
      _mouseDownPos = null;
      _isPanning = false;
    });

    // Zoom
    _svg.addEventListener('wheel', function(e) {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      _zoom = Math.max(0.2, Math.min(5, _zoom * delta));
      _svg.setAttribute('viewBox', _viewBox.x + ' ' + _viewBox.y + ' ' + (_viewBox.w / _zoom) + ' ' + (_viewBox.h / _zoom));
    });
  }

  // Update selection visuals without full re-render
  function _updateSelection() {
    if(!_svg) return;
    _svg.querySelectorAll('.rm-node').forEach(function(n) {
      var isSel = n.dataset.chid === _selectedNode;
      n.classList.toggle('selected', isSel);
      var glow = n.querySelector('.rm-glow');
      if(glow) glow.style.opacity = isSel ? '1' : '0';
    });
    _svg.querySelectorAll('.rm-edge').forEach(function(el) {
      var isSel = el.dataset.relid === _selectedEdge;
      el.classList.toggle('selected', isSel);
      var paths = el.querySelectorAll('path');
      if(paths[1]) paths[1].setAttribute('stroke-opacity', isSel ? '0.9' : '0.4');
    });
  }

  // Update a single node's position in the DOM without full re-render
  function _updateNodeDOM(ch) {
    if(!_svg) return;
    var nodeEl = _svg.querySelector('.rm-node[data-chid="' + ch.id + '"]');
    if(nodeEl) nodeEl.setAttribute('transform', 'translate(' + ch.relMapX + ',' + ch.relMapY + ')');
  }

  // Update all edge positions in the DOM without full re-render
  function _updateEdgeDOM() {
    if(!_svg) return;
    var P = S.get();
    var chars = P.characters;
    var rels = P.characterRelationships || [];
    rels.forEach(function(rel) {
      var from = chars.find(function(c) { return c.id === rel.from; });
      var to = chars.find(function(c) { return c.id === rel.to; });
      if(!from || !to) return;
      var edgeEl = _svg.querySelector('.rm-edge[data-relid="' + rel.id + '"]');
      if(!edgeEl) return;
      var x1 = from.relMapX, y1 = from.relMapY, x2 = to.relMapX, y2 = to.relMapY;
      var dx = x2 - x1, dy = y2 - y1;
      var dist = Math.sqrt(dx*dx + dy*dy) || 1;
      var rFrom = ROLE_SIZES[from.role || 'secondary'] || 30;
      var rTo = ROLE_SIZES[to.role || 'secondary'] || 30;
      var nx1 = x1 + (dx/dist) * (rFrom + 6);
      var ny1 = y1 + (dy/dist) * (rFrom + 6);
      var nx2 = x2 - (dx/dist) * (rTo + 6);
      var ny2 = y2 - (dy/dist) * (rTo + 6);
      var mx = (nx1 + nx2) / 2, my = (ny1 + ny2) / 2;
      var perpX = -(ny2 - ny1) / dist, perpY = (nx2 - nx1) / dist;
      var cpx = mx + perpX * dist * EDGE_CURVE;
      var cpy = my + perpY * dist * EDGE_CURVE;
      var pathD = 'M' + nx1 + ',' + ny1 + ' Q' + cpx + ',' + cpy + ' ' + nx2 + ',' + ny2;
      var lx = 0.25*nx1 + 0.5*cpx + 0.25*nx2;
      var ly = 0.25*ny1 + 0.5*cpy + 0.25*ny2;
      var paths = edgeEl.querySelectorAll('path');
      paths.forEach(function(p) { p.setAttribute('d', pathD); });
      var texts = edgeEl.querySelectorAll('text');
      if(texts[0]) { texts[0].setAttribute('x', lx); texts[0].setAttribute('y', ly - 3); }
      if(texts[1]) { texts[1].setAttribute('x', lx); texts[1].setAttribute('y', ly + 9); }
    });
  }

  function _svgPoint(e) {
    if(!_svg) return { x: 0, y: 0 };
    const rect = _svg.getBoundingClientRect();
    const vbW = _viewBox.w / _zoom, vbH = _viewBox.h / _zoom;
    return {
      x: _viewBox.x + ((e.clientX - rect.left) / rect.width) * vbW,
      y: _viewBox.y + ((e.clientY - rect.top) / rect.height) * vbH
    };
  }

  function _showNodeDetails(chId) {
    const P = S.get();
    const ch = P.characters.find(c => c.id === chId);
    if(!ch) return;
    const rels = (P.characterRelationships || []).filter(r => r.from === chId || r.to === chId);
    const rp = document.getElementById('rPanel');
    if(!rp) return;

    let h = '<div class="rpanel-hdr"><h3>Karakter DetayÄ±</h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>';
    h += '<div class="rpanel-body" style="padding:14px;">';
    h += '<div style="text-align:center;margin-bottom:16px;">';
    h += '<div style="width:60px;height:60px;border-radius:50%;background:' + U.sanitizeColor(ch.color || '#3b82f6') + ';display:inline-flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:#fff;">' + getInitials(ch.name) + '</div>';
    h += '<div style="font-size:15px;font-weight:600;margin-top:8px;">' + U.escHtml(ch.name) + '</div>';
    h += '<div style="font-size:11px;color:var(--tx3);">' + _roleLabelTr(ch.role || 'secondary') + '</div>';
    h += '</div>';

    // Role selector
    h += '<div class="fg"><label>Rol</label><select onchange="App.RelationshipMap.setCharRole(\'' + ch.id + '\',this.value)">';
    ['primary','secondary','tertiary'].forEach(r => {
      h += '<option value="' + r + '"' + (ch.role === r ? ' selected' : '') + '>' + _roleLabelTr(r) + '</option>';
    });
    h += '</select></div>';

    // Relations list
    h += '<div style="font-size:11px;color:var(--tx3);text-transform:uppercase;margin-bottom:6px;font-weight:500;">Ä°liÅŸkiler (' + rels.length + ')</div>';
    rels.forEach(r => {
      const other = r.from === chId ? P.characters.find(c => c.id === r.to) : P.characters.find(c => c.id === r.from);
      const direction = r.from === chId ? 'â†’' : 'â†';
      const color = REL_COLORS[r.type] || 'var(--tx3)';
      h += '<div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid var(--brd);font-size:12px;">';
      h += '<span style="color:' + U.sanitizeColor(color) + ';font-weight:600;">' + direction + '</span>';
      h += '<span style="flex:1;">' + U.escHtml(other ? other.name : '?') + '</span>';
      h += '<span style="font-size:10px;color:' + U.sanitizeColor(color) + ';background:rgba(255,255,255,.05);padding:2px 6px;border-radius:8px;">' + U.escHtml(r.type || '?') + '</span>';
      h += '<button class="btn btn-s" style="color:var(--red);padding:2px 6px;" onclick="App.RelationshipMap.removeRelationship(\'' + r.id + '\')">âœ•</button>';
      h += '</div>';
    });
    h += '<button class="btn btn-s" style="margin-top:8px;width:100%;" onclick="App.RelationshipMap.openAddRelationship(\'' + ch.id + '\')">+ Ä°liÅŸki Ekle</button>';
    h += '</div>';

    rp.innerHTML = h;
    rp.classList.add('open');
    if(App.Panels.setCurrentPanel) App.Panels.setCurrentPanel('relmap');
  }

  function _showEdgeDetails(relId) {
    const P = S.get();
    const rel = (P.characterRelationships || []).find(r => r.id === relId);
    if(!rel) return;
    const from = P.characters.find(c => c.id === rel.from);
    const to = P.characters.find(c => c.id === rel.to);
    const rp = document.getElementById('rPanel');
    if(!rp) return;

    let h = '<div class="rpanel-hdr"><h3>Ä°liÅŸki DetayÄ±</h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>';
    h += '<div class="rpanel-body" style="padding:14px;">';
    h += '<div style="text-align:center;margin-bottom:12px;">';
    h += '<span style="font-weight:600;">' + U.escHtml(from ? from.name : '?') + '</span>';
    h += ' <span style="color:var(--tx3);">' + (rel.bidirectional ? 'âŸ·' : 'â†’') + '</span> ';
    h += '<span style="font-weight:600;">' + U.escHtml(to ? to.name : '?') + '</span>';
    h += '</div>';
    h += '<div class="fg"><label>Tip</label><input id="rmRelType" value="' + U.escHtml(rel.type || '') + '" placeholder="mentor, dost, dÃ¼ÅŸman..." /></div>';
    h += '<div class="fg"><label>AÃ§Ä±klama</label><textarea id="rmRelDesc" rows="2">' + U.escHtml(rel.description || '') + '</textarea></div>';
    h += '<div class="fg"><label>GÃ¼Ã§ (1-5)</label><input type="range" id="rmRelStr" min="1" max="5" value="' + (rel.strength || 3) + '" /></div>';
    h += '<div class="fg"><label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="rmRelBi"' + (rel.bidirectional ? ' checked' : '') + ' style="width:auto;" /> Ã‡ift yÃ¶nlÃ¼</label></div>';
    h += '<div style="display:flex;gap:6px;margin-top:12px;">';
    h += '<button class="btn btn-d" onclick="App.RelationshipMap.removeRelationship(\'' + rel.id + '\')">Sil</button>';
    h += '<div style="flex:1"></div>';
    h += '<button class="btn btn-p" onclick="App.RelationshipMap.saveEdgeDetails(\'' + rel.id + '\')">Kaydet</button>';
    h += '</div></div>';

    rp.innerHTML = h;
    rp.classList.add('open');
    if(App.Panels.setCurrentPanel) App.Panels.setCurrentPanel('relmap');
  }

  function saveEdgeDetails(relId) {
    const type = (document.getElementById('rmRelType') || {}).value || '';
    const desc = (document.getElementById('rmRelDesc') || {}).value || '';
    const str = parseInt((document.getElementById('rmRelStr') || {}).value) || 3;
    const bi = (document.getElementById('rmRelBi') || {}).checked || false;
    S.updateCharacterRelationship(relId, { type, description: desc, strength: str, bidirectional: bi });
    render();
    App.UI.toast('Ä°liÅŸki gÃ¼ncellendi');
  }

  function setCharRole(chId, role) {
    S.updateCharacter(chId, { role });
    render();
    _showNodeDetails(chId);
  }

  function removeRelationship(relId) {
    S.removeCharacterRelationship(relId);
    _selectedEdge = null;
    _selectedNode = null;
    App.Panels.closeAll();
    render();
    App.UI.toast('Ä°liÅŸki silindi');
  }

  function openAddRelationship(fromCharId) {
    const P = S.get();
    const chars = P.characters;
    if(chars.length < 2) { App.UI.toast('En az 2 karakter gerekli'); return; }

    const fromOpts = chars.map(c => '<option value="' + c.id + '"' + (c.id === fromCharId ? ' selected' : '') + '>' + U.escHtml(c.name) + '</option>').join('');
    const toOpts = chars.map(c => '<option value="' + c.id + '">' + U.escHtml(c.name) + '</option>').join('');
    const typeOpts = ['mentor','aile','dost','dusman','sevgili','rakip','is','gizli'].map(t => '<option value="' + t + '">' + t + '</option>').join('');

    App.UI.openModal(
      '<div class="mh"><span>Yeni Ä°liÅŸki</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>' +
      '<div class="mb">' +
      '<div class="fg"><label>Kimden</label><select id="rmNewFrom">' + fromOpts + '</select></div>' +
      '<div class="fg"><label>Kime</label><select id="rmNewTo">' + toOpts + '</select></div>' +
      '<div class="fg"><label>Tip</label><select id="rmNewType">' + typeOpts + '<option value="">DiÄŸer...</option></select></div>' +
      '<div class="fg"><label>AÃ§Ä±klama</label><textarea id="rmNewDesc" rows="2" placeholder="KÄ±sa aÃ§Ä±klama..."></textarea></div>' +
      '<div class="fg"><label>GÃ¼Ã§ (1-5)</label><input type="range" id="rmNewStr" min="1" max="5" value="3" /></div>' +
      '<div class="fg"><label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="rmNewBi" style="width:auto;" /> Ã‡ift yÃ¶nlÃ¼</label></div>' +
      '</div>' +
      '<div class="mf"><button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button><button class="btn btn-p" onclick="App.RelationshipMap.doAddRelationship()">Ekle</button></div>'
    );
  }

  function doAddRelationship() {
    const from = (document.getElementById('rmNewFrom') || {}).value;
    const to = (document.getElementById('rmNewTo') || {}).value;
    if(!from || !to || from === to) { App.UI.toast('FarklÄ± iki karakter seÃ§in'); return; }
    const type = (document.getElementById('rmNewType') || {}).value || 'dost';
    const desc = (document.getElementById('rmNewDesc') || {}).value || '';
    const str = parseInt((document.getElementById('rmNewStr') || {}).value) || 3;
    const bi = (document.getElementById('rmNewBi') || {}).checked || false;

    S.addCharacterRelationship({
      id: U.genId('cr'), from, to, type, description: desc, strength: str, bidirectional: bi
    });
    App.UI.closeModal();
    render();
    App.UI.toast('Ä°liÅŸki eklendi');
  }

  function openEditRelationship(relId) {
    _selectedEdge = relId;
    _selectedNode = null;
    _showEdgeDetails(relId);
    render();
  }

  // Force-directed auto layout
  function autoLayout() {
    const P = S.get();
    const chars = P.characters;
    const rels = P.characterRelationships || [];
    if(!chars.length) return;

    const W = _viewBox.w, H = _viewBox.h;
    const cx = W / 2, cy = H / 2;
    const k = Math.sqrt((W * H) / Math.max(chars.length, 1)) * 0.5;

    // Initialize positions in circle
    chars.forEach((ch, i) => {
      const angle = (2 * Math.PI * i) / chars.length;
      ch.relMapX = cx + Math.cos(angle) * k;
      ch.relMapY = cy + Math.sin(angle) * k;
    });

    // Iterate force simulation
    for(let iter = 0; iter < 100; iter++) {
      const forces = {};
      chars.forEach(ch => { forces[ch.id] = { fx: 0, fy: 0 }; });

      // Repulsive forces between all nodes
      for(let i = 0; i < chars.length; i++) {
        for(let j = i + 1; j < chars.length; j++) {
          const a = chars[i], b = chars[j];
          let dx = b.relMapX - a.relMapX;
          let dy = b.relMapY - a.relMapY;
          const dist = Math.sqrt(dx*dx + dy*dy) || 1;
          const force = (k * k) / dist;
          const fx = (dx / dist) * force;
          const fy = (dy / dist) * force;
          forces[a.id].fx -= fx;
          forces[a.id].fy -= fy;
          forces[b.id].fx += fx;
          forces[b.id].fy += fy;
        }
      }

      // Attractive forces along edges
      rels.forEach(rel => {
        const a = chars.find(c => c.id === rel.from);
        const b = chars.find(c => c.id === rel.to);
        if(!a || !b) return;
        let dx = b.relMapX - a.relMapX;
        let dy = b.relMapY - a.relMapY;
        const dist = Math.sqrt(dx*dx + dy*dy) || 1;
        const force = dist / k;
        const fx = (dx / dist) * force;
        const fy = (dy / dist) * force;
        forces[a.id].fx += fx;
        forces[a.id].fy += fy;
        forces[b.id].fx -= fx;
        forces[b.id].fy -= fy;
      });

      // Center gravity
      chars.forEach(ch => {
        const dx = cx - ch.relMapX;
        const dy = cy - ch.relMapY;
        forces[ch.id].fx += dx * 0.01;
        forces[ch.id].fy += dy * 0.01;
      });

      // Apply with cooling
      const temp = Math.max(1, 50 - iter * 0.5);
      chars.forEach(ch => {
        const f = forces[ch.id];
        const fLen = Math.sqrt(f.fx*f.fx + f.fy*f.fy) || 1;
        const move = Math.min(fLen, temp);
        ch.relMapX += (f.fx / fLen) * move;
        ch.relMapY += (f.fy / fLen) * move;
        // Keep in bounds
        ch.relMapX = Math.max(60, Math.min(W - 60, ch.relMapX));
        ch.relMapY = Math.max(60, Math.min(H - 60, ch.relMapY));
      });
    }

    S.markDirty('characters');
    S.emit('change', { type: 'relMapAutoLayout' });
    render();
    App.UI.toast('Otomatik yerleÅŸim uygulandÄ±');
  }

  // Pan & Zoom
  function zoomIn() { _zoom = Math.min(5, _zoom * 1.2); _updateViewBox(); }
  function zoomOut() { _zoom = Math.max(0.2, _zoom / 1.2); _updateViewBox(); }
  function zoomReset() { _zoom = 1; _viewBox.x = 0; _viewBox.y = 0; _updateViewBox(); }
  function _updateViewBox() {
    if(_svg) _svg.setAttribute('viewBox', _viewBox.x + ' ' + _viewBox.y + ' ' + (_viewBox.w / _zoom) + ' ' + (_viewBox.h / _zoom));
  }

  // Export PNG
  function exportPNG() {
    if(!_svg) { App.UI.toast('Harita yok'); return; }
    const svgData = new XMLSerializer().serializeToString(_svg);
    const canvas = document.createElement('canvas');
    canvas.width = 1920; canvas.height = 1080;
    const ctx = canvas.getContext('2d');

    // Background
    ctx.fillStyle = '#08080c';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const img = new Image();
    const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(svgBlob);
    img.onload = function() {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      canvas.toBlob(function(blob) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'iliski-haritasi.png';
        a.click();
        App.UI.toast('PNG indirildi');
      });
    };
    img.onerror = function() {
      URL.revokeObjectURL(url);
      App.UI.toast('PNG oluÅŸturulamadÄ±');
    };
    img.src = url;
  }

  function _roleLabelTr(role) {
    return { primary: 'Ana Karakter', secondary: 'Yan Karakter', tertiary: 'FigÃ¼ran' }[role] || 'Yan Karakter';
  }

  function unmount() {
    _mounted = false;
    _selectedNode = null;
    _selectedEdge = null;
    _dragNode = null;
    _isPanning = false;
  }

  return {
    render, unmount, autoLayout, exportPNG,
    openAddRelationship, doAddRelationship, openEditRelationship,
    saveEdgeDetails, setCharRole, removeRelationship,
    zoomIn, zoomOut, zoomReset
  };
})();


// â”€â”€ changelog.js â”€â”€
// â•â•â• CHANGELOG MODULE â•â•â•
App.Changelog = (function(){
  const U = App.Utils;
  const KEY = 'scenario_changelog';
  const MAX_LOCAL = 500;
  const MAX_REMOTE = 200;
  const SKIP = new Set(['undo','redo','set']);
  let _entries = [];
  let _remoteRef = null;
  let _remoteListener = null;

  const ACTION_LABELS = {
    addEvent:'Olay eklendi', updateEvent:'Olay gÃ¼ncellendi', removeEvent:'Olay silindi',
    addScene:'Sahne eklendi', updateScene:'Sahne gÃ¼ncellendi', removeScene:'Sahne silindi',
    addEp:'BÃ¶lÃ¼m eklendi', updateEp:'BÃ¶lÃ¼m gÃ¼ncellendi', removeEp:'BÃ¶lÃ¼m silindi',
    addCn:'BaÄŸlantÄ± eklendi', removeCn:'BaÄŸlantÄ± silindi',
    addChar:'Karakter eklendi', removeChar:'Karakter silindi',
    addCat:'Kategori eklendi', removeCat:'Kategori silindi',
    batch:'Toplu gÃ¼ncelleme', settings:'Ayarlar deÄŸiÅŸtirildi',
    docx:'DOCX dÄ±ÅŸa aktarÄ±ldÄ±', fix:'DÃ¼zeltme uygulandÄ±',
    addNote:'Not eklendi', updateNote:'Not dÃ¼zenlendi', removeNote:'Not silindi',
    updateProfile:'Profil gÃ¼ncellendi'
  };

  function init() {
    if(!_remoteRef) {
      try {
        const raw = localStorage.getItem(KEY);
        if(raw) _entries = JSON.parse(raw);
      } catch(e) { _entries = []; }
    }
  }

  function addEntry(data) {
    if(!data || !data.type) return;
    const actionType = data.type;
    if(SKIP.has(actionType) || actionType.startsWith('remote')) return;
    const userName = (App.Auth && App.Auth.getCurrentUser()) ? (App.Auth.getCurrentUser().displayName || App.Auth.getCurrentUser().email || 'KullanÄ±cÄ±') : 'KullanÄ±cÄ±';
    const label = ACTION_LABELS[actionType] || actionType;
    const targetName = data.targetName || '';
    const desc = targetName ? label + ': "' + targetName + '"' : label;
    const entry = {
      id: U.genId('cl'),
      ts: Date.now(),
      userName: userName,
      action: actionType,
      targetId: data.targetId || null,
      targetName: targetName,
      desc: desc
    };

    if(_remoteRef) {
      _remoteRef.push(entry);
    } else {
      _entries.push(entry);
      if(_entries.length > MAX_LOCAL) _entries = _entries.slice(-MAX_LOCAL);
      try { localStorage.setItem(KEY, JSON.stringify(_entries)); } catch(e) {}
    }
  }

  function setupRemoteListener(roomRef) {
    _remoteRef = roomRef.child('changelog');
    _entries = [];
    _remoteListener = _remoteRef.limitToLast(MAX_REMOTE).on('value', snap => {
      _entries = [];
      snap.forEach(ch => { _entries.push(ch.val()); });
      // Re-render if panel is open
      if(U.$('rPanel').classList.contains('open')) {
        const hdr = U.$('rPanel').querySelector('.rpanel-hdr h3');
        if(hdr && hdr.textContent.includes('GÃ¼nlÃ¼k')) renderPanel();
      }
    });
  }

  function teardownRemoteListener() {
    if(_remoteRef && _remoteListener) {
      _remoteRef.off('value', _remoteListener);
    }
    _remoteRef = null;
    _remoteListener = null;
    // Load local entries
    init();
  }

  function _navigate(targetId) {
    if(!targetId) return;
    const ev = App.Store.getEvent(targetId);
    if(ev) {
      App.Timeline.scrollToEvent(targetId);
      App.Panels.openEditEvent(targetId);
      return;
    }
    const sc = App.Store.getScene(targetId);
    if(sc) {
      const linked = App.Store.get().events.find(e => e.sceneId === targetId);
      if(linked) { App.Timeline.scrollToEvent(linked.id); App.Panels.openEditEvent(linked.id); }
    }
  }

  function renderPanel() {
    const rp = U.$('rPanel');
    const sorted = _entries.slice().reverse();
    let h = '<div class="rpanel-hdr"><h3>ğŸ“‹ DeÄŸiÅŸiklik GÃ¼nlÃ¼ÄŸÃ¼</h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>';
    h += '<div class="rpanel-body" style="overflow-y:auto;flex:1;">';
    if(sorted.length === 0) {
      h += '<div style="padding:20px;text-align:center;color:var(--tx3);font-size:12px;">HenÃ¼z deÄŸiÅŸiklik yok</div>';
    } else {
      sorted.forEach(e => {
        const d = new Date(e.ts);
        const time = d.toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'});
        const date = d.toLocaleDateString('tr-TR', {day:'numeric',month:'short'});
        const clickable = e.targetId && !e.action.startsWith('remove');
        const cursor = clickable ? 'cursor:pointer;' : '';
        const onclick = clickable ? ' onclick="App.Changelog.navigate(\'' + e.targetId + '\')"' : '';
        h += '<div class="cl-entry" style="' + cursor + '"' + onclick + '>';
        h += '<div class="cl-hdr"><span class="cl-user">' + U.escHtml(e.userName) + '</span><span class="cl-time">' + date + ' ' + time + '</span></div>';
        h += '<div class="cl-desc">' + U.escHtml(e.desc) + '</div>';
        if(clickable) h += '<div style="font-size:10px;color:var(--blue);margin-top:2px;">Olaya git â†’</div>';
        h += '</div>';
      });
    }
    h += '</div>';
    rp.innerHTML = h;
  }

  return { init, addEntry, setupRemoteListener, teardownRemoteListener, renderPanel, navigate: _navigate };
})();

// â”€â”€ notes.js â”€â”€
// â•â•â• NOTES MODULE â•â•â•
App.Notes = (function(){
  const U = App.Utils;
  const KEY = 'scenario_notes';
  const MAX_LOCAL = 100;
  let _notes = [];
  let _remoteRef = null;
  let _remoteListener = null;
  let _panelOpen = false;
  let _editingId = null;

  function init() {
    if(!_remoteRef) {
      try {
        const raw = localStorage.getItem(KEY);
        if(raw) _notes = JSON.parse(raw);
      } catch(e) { _notes = []; }
    }
  }

  function setPanelOpen(v) { _panelOpen = v; if(!v) _editingId = null; }

  function _getUserName() {
    return (App.Auth && App.Auth.getCurrentUser()) ? (App.Auth.getCurrentUser().displayName || App.Auth.getCurrentUser().email || 'KullanÄ±cÄ±') : 'KullanÄ±cÄ±';
  }
  function _getUserColor() {
    return '#3b82f6';
  }

  function addNote(text) {
    text = (text || '').trim();
    if(!text) return;
    const note = {
      id: U.genId('note'),
      author: _getUserName(),
      authorColor: _getUserColor(),
      text: text,
      ts: Date.now(),
      edited: false
    };
    if(_remoteRef) {
      _remoteRef.child(note.id).set(note);
    } else {
      _notes.push(note);
      if(_notes.length > MAX_LOCAL) _notes = _notes.slice(-MAX_LOCAL);
      _saveLocal();
    }
    if(App.Changelog) App.Changelog.addEntry({type:'addNote', targetName: text.substring(0, 40)});
    if(_panelOpen) renderPanel();
  }

  function updateNote(id, newText) {
    newText = (newText || '').trim();
    if(!newText) return;
    if(_remoteRef) {
      _remoteRef.child(id).update({ text: newText, edited: true });
    } else {
      const n = _notes.find(n => n.id === id);
      if(n) { n.text = newText; n.edited = true; _saveLocal(); }
    }
    if(App.Changelog) App.Changelog.addEntry({type:'updateNote', targetName: newText.substring(0, 40)});
    _editingId = null;
    if(_panelOpen) renderPanel();
  }

  function removeNote(id) {
    var _removedText = '';
    var _n = _notes.find(n => n.id === id);
    if(_n) _removedText = _n.text || '';
    if(_remoteRef) {
      _remoteRef.child(id).remove();
    } else {
      _notes = _notes.filter(n => n.id !== id);
      _saveLocal();
    }
    if(App.Changelog) App.Changelog.addEntry({type:'removeNote', targetName: _removedText.substring(0, 40)});
    if(_panelOpen) renderPanel();
  }

  function _saveLocal() {
    try { localStorage.setItem(KEY, JSON.stringify(_notes)); } catch(e) {}
  }

  function setupRemoteListener(roomRef) {
    _remoteRef = roomRef.child('notes');
    _notes = [];
    _remoteListener = _remoteRef.on('value', snap => {
      _notes = [];
      snap.forEach(ch => { _notes.push(ch.val()); });
      if(_panelOpen) renderPanel();
    });
  }

  function teardownRemoteListener() {
    if(_remoteRef && _remoteListener) {
      _remoteRef.off('value', _remoteListener);
    }
    _remoteRef = null;
    _remoteListener = null;
    init();
  }

  function renderPanel() {
    const rp = U.$('rPanel');
    const myName = _getUserName();
    const sorted = _notes.slice().reverse();

    let h = '<div class="rpanel-hdr"><h3>ğŸ“Œ Notlar</h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>';
    // Compose area
    h += '<div class="notes-compose">';
    h += '<textarea id="noteInput" placeholder="Not yaz..." onkeydown="if(event.ctrlKey&&event.key===\'Enter\'){App.Notes.addNote(this.value);this.value=\'\';event.preventDefault();}"></textarea>';
    h += '<div class="notes-compose-bar"><button class="btn btn-p btn-s" onclick="var ta=document.getElementById(\'noteInput\');App.Notes.addNote(ta.value);ta.value=\'\';">Ekle</button></div>';
    h += '</div>';
    // Notes list
    h += '<div class="rpanel-body" style="overflow-y:auto;flex:1;">';
    if(sorted.length === 0) {
      h += '<div style="padding:20px;text-align:center;color:var(--tx3);font-size:12px;">HenÃ¼z not yok</div>';
    } else {
      sorted.forEach(n => {
        const d = new Date(n.ts);
        const time = d.toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'});
        const date = d.toLocaleDateString('tr-TR', {day:'numeric',month:'short'});
        const isMine = n.author === myName;
        h += '<div class="note-item" data-note-id="' + n.id + '">';
        h += '<div class="note-hdr">';
        h += '<span class="note-author" style="color:' + U.sanitizeColor(n.authorColor || 'var(--tx)') + '">' + U.escHtml(n.author) + '</span>';
        h += '<span class="note-time">' + date + ' ' + time + (n.edited ? ' (dÃ¼zenlendi)' : '') + '</span>';
        if(isMine) {
          h += '<div class="note-actions">';
          h += '<button class="btn btn-s" onclick="App.Notes.startEdit(\'' + n.id + '\')">âœ</button>';
          h += '<button class="btn btn-s btn-d" onclick="App.Notes.removeNote(\'' + n.id + '\')">âœ•</button>';
          h += '</div>';
        }
        h += '</div>';
        if(_editingId === n.id) {
          h += '<textarea id="noteEdit_' + n.id + '" class="notes-compose" style="width:100%;min-height:50px;padding:6px;border-radius:var(--radius);border:1px solid var(--blue);background:var(--bg);color:var(--tx);font-family:inherit;font-size:12px;resize:vertical;outline:none;">' + U.escHtml(n.text) + '</textarea>';
          h += '<div style="display:flex;gap:4px;margin-top:4px;justify-content:flex-end;">';
          h += '<button class="btn btn-s" onclick="App.Notes._cancelEdit()">Ä°ptal</button>';
          h += '<button class="btn btn-s btn-p" onclick="App.Notes.updateNote(\'' + n.id + '\',document.getElementById(\'noteEdit_' + n.id + '\').value)">Kaydet</button>';
          h += '</div>';
        } else {
          h += '<div class="note-text">' + U.escHtml(n.text) + '</div>';
        }
        h += '</div>';
      });
    }
    h += '</div>';
    rp.innerHTML = h;
  }

  function startEdit(id) {
    _editingId = id;
    renderPanel();
  }

  function _cancelEdit() {
    _editingId = null;
    renderPanel();
  }

  return { init, setPanelOpen, addNote, updateNote, removeNote, setupRemoteListener, teardownRemoteListener, renderPanel, startEdit, _cancelEdit };
})();

// â”€â”€ ai.js â”€â”€
// â•â•â• AI ASSISTANT MODULE â•â•â•
App.AI = (function(){
  const U = App.Utils;
  const S = App.Store;

  // â”€â”€ Provider Configuration â”€â”€
  const PROVIDERS = {
    gemini: {
      name: 'Google Gemini (Ãœcretsiz)',
      endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/{MODEL}:streamGenerateContent?alt=sse',
      models: [
        {id:'gemini-2.5-flash',label:'Gemini 2.5 Flash'},
        {id:'gemini-2.5-pro',label:'Gemini 2.5 Pro'},
        {id:'gemini-3-flash-preview',label:'Gemini 3 Flash (Preview)'},
        {id:'gemini-3-pro-preview',label:'Gemini 3 Pro (Preview)'}
      ],
      defaultModel: 'gemini-2.5-flash',
      headers(key){return{'Content-Type':'application/json'};},
      buildBody(messages, model, maxOut){
        const sys = messages.find(m=>m.role==='system');
        const parts = messages.filter(m=>m.role!=='system').map(m=>({role:m.role==='assistant'?'model':'user',parts:[{text:m.content}]}));
        const body = {contents:parts,generationConfig:{maxOutputTokens:maxOut||2048}};
        if(sys) body.systemInstruction = {parts:[{text:sys.content}]};
        return JSON.stringify(body);
      },
      parseStream: _parseGeminiStream
    },
    anthropic: {
      name: 'Anthropic (Claude)',
      endpoint: 'https://api.anthropic.com/v1/messages',
      models: [
        {id:'claude-sonnet-4-6',label:'Claude Sonnet 4.6'},
        {id:'claude-opus-4-6',label:'Claude Opus 4.6'},
        {id:'claude-sonnet-4-5-20250929',label:'Claude Sonnet 4.5'},
        {id:'claude-haiku-4-5-20251001',label:'Claude Haiku 4.5'}
      ],
      defaultModel: 'claude-sonnet-4-6',
      headers(key){return{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'};},
      buildBody(messages, model, maxOut){
        const sys = messages.find(m=>m.role==='system');
        const msgs = messages.filter(m=>m.role!=='system');
        return JSON.stringify({model,max_tokens:maxOut||2048,stream:true,system:sys?sys.content:'',messages:msgs});
      },
      parseStream: _parseAnthropicStream
    },
    openai: {
      name: 'OpenAI (GPT)',
      endpoint: 'https://api.openai.com/v1/chat/completions',
      models: [
        {id:'gpt-5.2',label:'GPT-5.2'},
        {id:'gpt-4.1',label:'GPT-4.1'},
        {id:'gpt-4.1-mini',label:'GPT-4.1 Mini'},
        {id:'gpt-4.1-nano',label:'GPT-4.1 Nano'},
        {id:'o3',label:'o3 (Reasoning)'},
        {id:'o4-mini',label:'o4-mini (Reasoning)'}
      ],
      defaultModel: 'gpt-4.1',
      headers(key){return{'Content-Type':'application/json','Authorization':'Bearer '+key};},
      buildBody(messages, model, maxOut){
        return JSON.stringify({model,max_tokens:maxOut||2048,stream:true,messages});
      },
      parseStream: _parseOpenAIStream
    }
  };

  // â”€â”€ State â”€â”€
  let _provider = localStorage.getItem('ai_provider') || 'gemini';
  if(!PROVIDERS[_provider]) { _provider = 'gemini'; localStorage.setItem('ai_provider', _provider); }
  let _model = localStorage.getItem('ai_model') || PROVIDERS[_provider].defaultModel;
  if(!PROVIDERS[_provider].models.find(m => m.id === _model)) { _model = PROVIDERS[_provider].defaultModel; localStorage.setItem('ai_model', _model); }
  let _activeRequest = null;
  let _aiTab = 'write';
  let _lastResponse = '';
  let _streaming = false;
  let _history = [];
  let _requestTimes = [];

  // â”€â”€ API Key Management â”€â”€
  function getKey(prov) { return localStorage.getItem('ai_key_'+(prov||_provider)) || ''; }
  function setKey(prov, key) { localStorage.setItem('ai_key_'+(prov||_provider), key); }
  function getProvider() { return _provider; }
  function setProvider(p) { if(PROVIDERS[p]) { _provider = p; localStorage.setItem('ai_provider', p); if(!PROVIDERS[p].models.find(m=>m.id===_model)) { _model = PROVIDERS[p].defaultModel; localStorage.setItem('ai_model', _model); } } }
  function getModel() { return _model; }
  function setModel(m) { _model = m; localStorage.setItem('ai_model', m); }
  function isConfigured() { return !!getKey(); }

  // â”€â”€ Stream Parsers â”€â”€
  async function _parseAnthropicStream(reader, onChunk) {
    const decoder = new TextDecoder();
    let buf = '';
    while(true) {
      const {done, value} = await reader.read();
      if(done) break;
      buf += decoder.decode(value, {stream:true});
      const lines = buf.split('\n');
      buf = lines.pop() || '';
      for(const line of lines) {
        if(!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if(data === '[DONE]') return;
        try {
          const j = JSON.parse(data);
          if(j.type === 'content_block_delta' && j.delta && j.delta.text) onChunk(j.delta.text);
        } catch(e){}
      }
    }
  }

  async function _parseOpenAIStream(reader, onChunk) {
    const decoder = new TextDecoder();
    let buf = '';
    while(true) {
      const {done, value} = await reader.read();
      if(done) break;
      buf += decoder.decode(value, {stream:true});
      const lines = buf.split('\n');
      buf = lines.pop() || '';
      for(const line of lines) {
        if(!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if(data === '[DONE]') return;
        try {
          const j = JSON.parse(data);
          if(j.choices && j.choices[0] && j.choices[0].delta && j.choices[0].delta.content) onChunk(j.choices[0].delta.content);
        } catch(e){}
      }
    }
  }

  async function _parseGeminiStream(reader, onChunk) {
    const decoder = new TextDecoder();
    let buf = '';
    while(true) {
      const {done, value} = await reader.read();
      if(done) break;
      buf += decoder.decode(value, {stream:true});
      const lines = buf.split('\n');
      buf = lines.pop() || '';
      for(const line of lines) {
        if(!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if(!data) continue;
        try {
          const j = JSON.parse(data);
          if(j.candidates && j.candidates[0] && j.candidates[0].content && j.candidates[0].content.parts) {
            j.candidates[0].content.parts.forEach(p => { if(p.text) onChunk(p.text); });
          }
        } catch(e){}
      }
    }
  }

  // â”€â”€ Rate Limiting â”€â”€
  function _checkRateLimit() {
    const now = Date.now();
    _requestTimes = _requestTimes.filter(t => now - t < 60000);
    if(_requestTimes.length >= 10) return false;
    _requestTimes.push(now);
    return true;
  }

  // â”€â”€ Core Request â”€â”€
  async function streamRequest(messages, onChunk, onDone, onError, maxOut) {
    if(!isConfigured()) { onError('API anahtarÄ± yapÄ±landÄ±rÄ±lmamÄ±ÅŸ. Proje AyarlarÄ±\'ndan API anahtarÄ±nÄ±zÄ± girin.'); return; }
    if(!_checkRateLimit()) { onError('Ã‡ok fazla istek gÃ¶nderildi. LÃ¼tfen bir dakika bekleyin.'); return; }
    if(_streaming) { onError('Zaten bir istek devam ediyor.'); return; }

    const prov = PROVIDERS[_provider];
    const key = getKey();
    let endpoint = prov.endpoint;
    if(_provider === 'gemini') endpoint = endpoint.replace('{MODEL}', _model) + '&key=' + key;

    const headers = prov.headers(key);
    const body = prov.buildBody(messages, _model, maxOut);

    _activeRequest = new AbortController();
    _streaming = true;
    let fullText = '';

    try {
      const resp = await fetch(endpoint, { method:'POST', headers, body, signal:_activeRequest.signal });
      if(!resp.ok) {
        let detail = '';
        try { const errBody = await resp.json(); detail = errBody.error?.message || errBody.error?.type || JSON.stringify(errBody.error || errBody); } catch(e) { try { detail = await resp.text(); } catch(e2){} }
        const errMap = {400:'GeÃ§ersiz istek',401:'GeÃ§ersiz API anahtarÄ±',403:'EriÅŸim reddedildi',429:'Ä°stek limiti aÅŸÄ±ldÄ±. LÃ¼tfen bekleyin',500:'Sunucu hatasÄ±'};
        const base = errMap[resp.status] || `HTTP ${resp.status}`;
        const msg = detail ? `${base}: ${detail}` : `${base}.`;
        _streaming = false;
        onError(msg);
        return;
      }
      const reader = resp.body.getReader();
      await prov.parseStream(reader, (chunk) => {
        fullText += chunk;
        onChunk(chunk, fullText);
      });
      _streaming = false;
      _lastResponse = fullText;
      onDone(fullText);
    } catch(e) {
      _streaming = false;
      if(e.name === 'AbortError') { onDone(fullText || '(Ä°ptal edildi)'); return; }
      onError('BaÄŸlantÄ± hatasÄ±: ' + e.message);
    }
  }

  function cancelRequest() {
    if(_activeRequest) { _activeRequest.abort(); _activeRequest = null; }
    _streaming = false;
  }

  // â”€â”€ Context Building â”€â”€
  function buildProjectContext(opts) {
    const P = S.get();
    const o = opts || {};
    let ctx = `## Proje: ${P.meta.title}\nYazar: ${P.meta.author||'BelirtilmemiÅŸ'}\n`;

    if(P.characters && P.characters.length) {
      ctx += '\n### Karakterler:\n';
      P.characters.forEach(c => { ctx += `- ${c.name}${c.notes?' ('+c.notes+')':''}\n`; });
    }

    if(P.categories) {
      ctx += '\n### Kategoriler:\n';
      Object.values(P.categories).forEach(c => { ctx += `- ${c.label}\n`; });
    }

    if(P.episodes && P.episodes.length) {
      ctx += '\n### BÃ¶lÃ¼mler:\n';
      P.episodes.forEach(ep => {
        ctx += `\n#### BÃ¶lÃ¼m ${ep.number}${ep.title?' - '+ep.title:''}\n`;
        const scenes = S.getScenes(ep.id);
        scenes.forEach(sc => {
          ctx += `- Sahne: ${sc.title||'Ä°simsiz'}`;
          if(sc.location) ctx += ` | Mekan: ${sc.location}`;
          if(sc.timeOfDay) ctx += ` | Zaman: ${sc.timeOfDay}`;
          if(sc.characters && sc.characters.length) {
            const charNames = sc.characters.map(cid => { const ch = P.characters.find(c=>c.id===cid); return ch?ch.name:cid; });
            ctx += ` | Karakterler: ${charNames.join(', ')}`;
          }
          if(!o.brief && sc.screenplay) ctx += `\n  Senaryo: ${sc.screenplay.substring(0, 200)}${sc.screenplay.length>200?'...':''}`;
          ctx += '\n';
        });
      });
    }

    if(!o.brief && P.connections && P.connections.length) {
      ctx += '\n### BaÄŸlantÄ±lar:\n';
      P.connections.slice(0, 20).forEach(cn => {
        ctx += `- ${cn.type||'baÄŸlantÄ±'}: ${cn.label||''}\n`;
      });
    }

    // Budget: truncate if too long (~8000 chars max for context)
    if(ctx.length > 8000) ctx = ctx.substring(0, 8000) + '\n...(kÄ±saltÄ±ldÄ±)';
    return ctx;
  }

  function buildSceneContext(sceneId) {
    const P = S.get();
    const sc = S.getScene(sceneId);
    if(!sc) return '';
    let ctx = `## Sahne: ${sc.title||'Ä°simsiz'}\n`;
    if(sc.location) ctx += `Mekan: ${sc.location}\n`;
    if(sc.timeOfDay) ctx += `Zaman: ${sc.timeOfDay}\n`;
    if(sc.characters && sc.characters.length) {
      const charNames = sc.characters.map(cid => { const ch = P.characters.find(c=>c.id===cid); return ch?ch.name:cid; });
      ctx += `Karakterler: ${charNames.join(', ')}\n`;
    }
    if(sc.screenplay) ctx += `\n### Mevcut Senaryo Metni:\n${sc.screenplay}\n`;
    if(sc.content && sc.content.length) {
      ctx += '\n### Ä°Ã§erik BloklarÄ±:\n';
      sc.content.forEach(b => {
        if(b.type === 'dialogue') {
          const ch = P.characters.find(c=>c.id===b.character);
          ctx += `[DÄ°YALOG] ${ch?ch.name:'?'}: ${b.text||''}\n`;
        } else if(b.type === 'action') {
          ctx += `[AKSÄ°YON] ${b.text||''}\n`;
        } else if(b.type === 'transition') {
          ctx += `[GEÃ‡Ä°Å] ${b.text||''}\n`;
        }
      });
    }
    return ctx;
  }

  function buildEpisodeContext(episodeId) {
    const P = S.get();
    const ep = P.episodes.find(e => e.id === episodeId);
    if(!ep) return '';
    let ctx = `## BÃ¶lÃ¼m ${ep.number}${ep.title?' - '+ep.title:''}\n`;
    const scenes = S.getScenes(episodeId);
    scenes.forEach(sc => {
      ctx += `\n### Sahne: ${sc.title||'Ä°simsiz'}`;
      if(sc.location) ctx += ` (${sc.location})`;
      ctx += '\n';
      if(sc.screenplay) ctx += sc.screenplay + '\n';
      if(sc.content && sc.content.length) {
        sc.content.forEach(b => {
          if(b.type === 'dialogue') {
            const ch = P.characters.find(c=>c.id===b.character);
            ctx += `${ch?ch.name:'?'}: ${b.text||''}\n`;
          } else if(b.type === 'action') {
            ctx += `(${b.text||''})\n`;
          }
        });
      }
    });
    if(ctx.length > 10000) ctx = ctx.substring(0, 10000) + '\n...(kÄ±saltÄ±ldÄ±)';
    return ctx;
  }

  // â”€â”€ System Prompt â”€â”€
  const SYSTEM_PROMPT = `Sen deneyimli bir TÃ¼rk TV dizisi senaryo yazarÄ±sÄ±n. GÃ¶revin, kullanÄ±cÄ±nÄ±n senaryo projesine yardÄ±mcÄ± olmaktÄ±r.

Kurallar:
- Her zaman TÃ¼rkÃ§e yaz.
- Diyaloglarda doÄŸal, konuÅŸma diline yakÄ±n TÃ¼rkÃ§e kullan.
- Sahne aÃ§Ä±klamalarÄ±nÄ± sinematik ve gÃ¶rsel olarak zengin yaz.
- Karakter tutarlÄ±lÄ±ÄŸÄ±na dikkat et.
- Senaryo formatÄ±na uy: bÃ¼yÃ¼k harfle karakter adlarÄ±, parantez iÃ§inde yÃ¶nerge, sahne baÅŸlÄ±klarÄ±.
- KÄ±sa ve etkili cÃ¼mleler kur.
- Gereksiz tekrarlardan kaÃ§Ä±n.`;

  // â”€â”€ Feature Functions â”€â”€
  function generateDialogue(sceneId) {
    const scCtx = buildSceneContext(sceneId);
    const projCtx = buildProjectContext({brief:true});
    if(!scCtx) { App.UI.toast('Sahne bulunamadÄ±','error'); return; }
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\n${scCtx}\n\nBu sahne iÃ§in karakterler arasÄ± doÄŸal, dramatik ve hikayeyi ilerletecek diyaloglar yaz. Sahnedeki tÃ¼m karakterleri dahil et. Senaryo formatÄ±nda yaz (KARAKTER ADI bÃ¼yÃ¼k harfle, altÄ±nda diyalog).`}
    ];
    _runFeature(messages, sceneId);
  }

  function writeSceneDescription(sceneId) {
    const scCtx = buildSceneContext(sceneId);
    const projCtx = buildProjectContext({brief:true});
    if(!scCtx) { App.UI.toast('Sahne bulunamadÄ±','error'); return; }
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\n${scCtx}\n\nBu sahne iÃ§in detaylÄ±, sinematik bir sahne aÃ§Ä±klamasÄ± yaz. Mekan tasvirini, atmosferi, Ä±ÅŸÄ±ÄŸÄ±, sesleri ve karakterlerin fiziksel konumlarÄ±nÄ± betimle. YÃ¶netmene gÃ¶rsel rehber olacak ÅŸekilde yaz.`}
    ];
    _runFeature(messages, sceneId);
  }

  function continueScreenplay(sceneId) {
    const scCtx = buildSceneContext(sceneId);
    const projCtx = buildProjectContext({brief:true});
    if(!scCtx) { App.UI.toast('Sahne bulunamadÄ±','error'); return; }
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\n${scCtx}\n\nMevcut senaryo metninin devamÄ±nÄ± yaz. Hikayenin akÄ±ÅŸÄ±nÄ± ve karakterlerin durumunu dikkate alarak doÄŸal bir ÅŸekilde devam ettir. Senaryo formatÄ±nda yaz.`}
    ];
    _runFeature(messages, sceneId);
  }

  function analyzeConsistency() {
    const projCtx = buildProjectContext();
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\nBu projenin tutarlÄ±lÄ±k analizini yap. Åu baÅŸlÄ±klar altÄ±nda incele:\n1. **Karakter TutarlÄ±lÄ±ÄŸÄ±**: Karakterlerin davranÄ±ÅŸ ve konuÅŸma tutarlÄ±lÄ±ÄŸÄ±\n2. **Hikaye TutarlÄ±lÄ±ÄŸÄ±**: Olay Ã¶rgÃ¼sÃ¼nde Ã§eliÅŸkiler\n3. **Kronoloji**: Zaman Ã§izelgesinde hatalar\n4. **AÃ§Ä±k Noktalar**: Ã‡Ã¶zÃ¼lmemiÅŸ hikaye hatlarÄ±\n\nHer sorun iÃ§in somut Ã¶neriler sun.`}
    ];
    _runFeature(messages, null);
  }

  function suggestCharacterDevelopment(charId) {
    const P = S.get();
    const ch = P.characters.find(c => c.id === charId);
    if(!ch) { App.UI.toast('Karakter bulunamadÄ±','error'); return; }
    const projCtx = buildProjectContext();
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\nKarakter: ${ch.name}\n${ch.notes?'Notlar: '+ch.notes:''}\n\nBu karakter iÃ§in geliÅŸim Ã¶nerileri sun:\n1. **Karakter ArkÄ±**: Nereden nereye gidebilir?\n2. **Ä°Ã§ Ã‡atÄ±ÅŸma**: Hangi iÃ§ Ã§atÄ±ÅŸmalar eklenebilir?\n3. **Ä°liÅŸkiler**: DiÄŸer karakterlerle iliÅŸkileri nasÄ±l derinleÅŸtirilebilir?\n4. **Sahneler**: Bu karakterin geliÅŸimi iÃ§in hangi sahneler eklenebilir?`}
    ];
    _runFeature(messages, null);
  }

  function analyzeTempoSuggestions() {
    const projCtx = buildProjectContext();
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\nBu projenin tempo ve ritim analizini yap:\n1. **Genel Tempo**: Hikaye hÄ±zÄ± uygun mu?\n2. **Sahne UzunluklarÄ±**: Dengeli mi?\n3. **Gerilim EÄŸrisi**: YÃ¼kseliÅŸ-dÃ¼ÅŸÃ¼ÅŸ dengeliyor mu?\n4. **BÃ¶lÃ¼m Sonu KancalarÄ±**: Cliffhanger'lar etkili mi?\n5. **Ã–neriler**: Tempo iyileÅŸtirme Ã¶nerileri`}
    ];
    _runFeature(messages, null);
  }

  function summarizeEpisode(episodeId) {
    const epCtx = buildEpisodeContext(episodeId);
    if(!epCtx) { App.UI.toast('BÃ¶lÃ¼m bulunamadÄ±','error'); return; }
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${epCtx}\n\nBu bÃ¶lÃ¼mÃ¼n detaylÄ± Ã¶zetini yaz:\n1. **Genel Ã–zet** (2-3 paragraf)\n2. **Ana Olaylar** (madde madde)\n3. **Karakter GeliÅŸimleri** (bu bÃ¶lÃ¼mde neler deÄŸiÅŸti)\n4. **Sonraki BÃ¶lÃ¼m Ä°Ã§in Ä°puÃ§larÄ±**`}
    ];
    _runFeature(messages, null);
  }

  function summarizeCharacterArc(charId) {
    const P = S.get();
    const ch = P.characters.find(c => c.id === charId);
    if(!ch) { App.UI.toast('Karakter bulunamadÄ±','error'); return; }
    const projCtx = buildProjectContext();
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\nKarakter: ${ch.name}\n\nBu karakterin tÃ¼m proje boyunca arkÄ±nÄ± Ã¶zetle:\n1. **BaÅŸlangÄ±Ã§ NoktasÄ±**: Karakter ilk nasÄ±l tanÄ±tÄ±lÄ±yor?\n2. **DÃ¶nÃ¼m NoktalarÄ±**: Ã–nemli deÄŸiÅŸim anlarÄ±\n3. **Ä°liÅŸki HaritasÄ±**: DiÄŸer karakterlerle etkileÅŸimleri\n4. **Mevcut Durum**: Karakter ÅŸu an nerede?`}
    ];
    _runFeature(messages, null);
  }

  function generateProjectOverview() {
    const projCtx = buildProjectContext();
    const messages = [
      {role:'system', content:SYSTEM_PROMPT},
      {role:'user', content:`${projCtx}\n\nBu proje iÃ§in profesyonel bir pitch document / genel bakÄ±ÅŸ belgesi oluÅŸtur:\n1. **Logline** (tek cÃ¼mle)\n2. **Ã–zet** (1 paragraf)\n3. **Tema ve Ton**\n4. **Ana Karakterler** (kÄ±sa tanÄ±tÄ±m)\n5. **Hikaye YapÄ±sÄ±**\n6. **Hedef Kitle**\n7. **Benzersiz SatÄ±ÅŸ NoktasÄ±**`}
    ];
    _runFeature(messages, null);
  }

  // â”€â”€ Internal: Run Feature â”€â”€
  function _runFeature(messages, targetSceneId) {
    showStreamingResponse();
    let full = '';
    streamRequest(messages,
      (chunk, fullText) => { full = fullText; updateStreamDisplay(chunk, fullText); },
      (finalText) => { showCompletedResponse(finalText, targetSceneId); },
      (err) => { _showError(err); }
    );
  }

  // â”€â”€ Chat â”€â”€
  function sendChat(text) {
    if(!text || !text.trim()) return;
    _history.push({role:'user', content:text.trim()});
    const projCtx = buildProjectContext({brief:true});
    const messages = [
      {role:'system', content:SYSTEM_PROMPT + '\n\nProje baÄŸlamÄ±:\n' + projCtx},
      ..._history
    ];
    // Keep history manageable
    if(_history.length > 20) _history.splice(0, _history.length - 16);
    showStreamingResponse();
    let full = '';
    streamRequest(messages,
      (chunk, fullText) => { full = fullText; updateStreamDisplay(chunk, fullText); },
      (finalText) => { _history.push({role:'assistant', content:finalText}); showCompletedResponse(finalText, null); },
      (err) => { _showError(err); }
    );
  }

  // â”€â”€ Streaming UI â”€â”€
  function showStreamingResponse() {
    const container = document.getElementById('aiResponseArea');
    if(!container) return;
    container.innerHTML = '<div class="ai-response-stream" id="aiStreamBox"><span class="ai-spinner"></span> YanÄ±t bekleniyor...</div>' +
      '<div style="margin-top:6px;text-align:right"><button class="btn btn-s" style="color:var(--red)" onclick="App.AI.cancelRequest();App.AI.renderPanel()">âœ• Ä°ptal</button></div>';
  }

  function updateStreamDisplay(chunk, fullText) {
    const box = document.getElementById('aiStreamBox');
    if(!box) return;
    box.textContent = fullText;
    box.scrollTop = box.scrollHeight;
  }

  function showCompletedResponse(fullText, targetSceneId) {
    const container = document.getElementById('aiResponseArea');
    if(!container) return;
    let html = '<div class="ai-response-stream" id="aiStreamBox">' + U.escHtml(fullText) + '</div>';
    html += '<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">';
    html += '<button class="btn btn-s" onclick="App.AI._copyToClipboard()">ğŸ“‹ Kopyala</button>';
    if(targetSceneId) {
      html += `<button class="btn btn-s" style="color:var(--green)" onclick="App.AI._applyToScene('${targetSceneId}')">+ Senaryoya Ekle</button>`;
      html += `<button class="btn btn-s" style="color:var(--orange)" onclick="App.AI._replaceScene('${targetSceneId}')">â†» DeÄŸiÅŸtir</button>`;
    }
    html += '</div>';
    container.innerHTML = html;
  }

  function _showError(msg) {
    const container = document.getElementById('aiResponseArea');
    if(!container) return;
    container.innerHTML = '<div style="padding:10px;color:var(--red);font-size:12px;">âš  ' + U.escHtml(msg) + '</div>';
  }

  // â”€â”€ Apply Results â”€â”€
  function _applyToScene(sceneId) {
    const sc = S.getScene(sceneId);
    if(!sc || !_lastResponse) return;
    S.snapshot();
    sc.screenplay = (sc.screenplay || '') + '\n\n' + _lastResponse;
    S.markDirty('scenes');
    S.emit('change', {type:'screenplay', sceneId});
    App.UI.toast('Senaryoya eklendi');
  }

  function _replaceScene(sceneId) {
    const sc = S.getScene(sceneId);
    if(!sc || !_lastResponse) return;
    if(!confirm('Mevcut senaryo metni AI yanÄ±tÄ±yla deÄŸiÅŸtirilecek. Emin misiniz?')) return;
    S.snapshot();
    sc.screenplay = _lastResponse;
    S.markDirty('scenes');
    S.emit('change', {type:'screenplay', sceneId});
    App.UI.toast('Senaryo metni deÄŸiÅŸtirildi');
  }

  function _copyToClipboard() {
    if(!_lastResponse) return;
    navigator.clipboard.writeText(_lastResponse).then(() => App.UI.toast('Panoya kopyalandÄ±'));
  }

  // â”€â”€ Key Validation â”€â”€
  async function validateKey(prov, key) {
    const p = PROVIDERS[prov || _provider];
    if(!p || !key) return {ok:false, msg:'Anahtar boÅŸ.'};
    try {
      let endpoint = p.endpoint;
      let headers = p.headers(key);
      let body;
      if(prov === 'gemini' || _provider === 'gemini') {
        endpoint = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
        const resp = await fetch(endpoint);
        if(resp.ok) return {ok:true, msg:'Anahtar geÃ§erli!'};
        return {ok:false, msg:'GeÃ§ersiz anahtar.'};
      } else if(prov === 'openai' || _provider === 'openai') {
        const resp = await fetch('https://api.openai.com/v1/models', {headers});
        if(resp.ok) return {ok:true, msg:'Anahtar geÃ§erli!'};
        return {ok:false, msg:'GeÃ§ersiz anahtar.'};
      } else {
        body = JSON.stringify({model:PROVIDERS.anthropic.defaultModel,max_tokens:1,messages:[{role:'user',content:'test'}]});
        const resp = await fetch(endpoint, {method:'POST', headers, body});
        if(resp.ok || resp.status === 200) return {ok:true, msg:'Anahtar geÃ§erli!'};
        if(resp.status === 401) return {ok:false, msg:'GeÃ§ersiz anahtar.'};
        if(resp.status === 400) return {ok:false, msg:'GeÃ§ersiz istek. Anahtar formatÄ±nÄ± kontrol edin.'};
        if(resp.status === 403) return {ok:false, msg:'EriÅŸim reddedildi.'};
        return {ok:true, msg:'BaÄŸlantÄ± kuruldu.'};
      }
    } catch(e) {
      return {ok:false, msg:'BaÄŸlantÄ± hatasÄ±: '+e.message};
    }
  }

  async function _testKey() {
    const inp = document.getElementById('sAIKey');
    const btn = document.getElementById('aiTestBtn');
    const res = document.getElementById('aiTestResult');
    if(!inp || !btn) return;
    let key = inp.value.trim();
    if(!key) { if(res) res.textContent = 'Anahtar girin.'; return; }
    if(key === '********') { key = getKey(); if(!key) { if(res) res.textContent = 'Ã–nce yeni anahtar girin.'; return; } }
    btn.disabled = true;
    btn.textContent = 'Test ediliyor...';
    const result = await validateKey(_provider, key);
    btn.disabled = false;
    btn.textContent = 'Test';
    if(res) {
      res.textContent = result.msg;
      res.style.color = result.ok ? 'var(--green)' : 'var(--red)';
    }
  }

  // â”€â”€ Panel Render â”€â”€
  function renderPanel() {
    const rp = U.$('rPanel');
    if(!rp) return;
    const P = S.get();

    let h = '<div style="padding:10px 14px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center;">';
    h += '<h3 style="font-size:13px;font-weight:600;">âœ¦ AI Asistan</h3>';
    h += '<button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>';

    if(!isConfigured()) {
      h += '<div style="padding:14px;"><div style="padding:12px;background:var(--bg3);border:1px solid var(--brd);border-radius:var(--radius);font-size:12px;color:var(--tx2);">';
      h += '<p style="margin-bottom:8px;">AI Ã¶zelliklerini kullanmak iÃ§in Proje AyarlarÄ±\'ndan API anahtarÄ±nÄ±zÄ± yapÄ±landÄ±rÄ±n.</p>';
      h += '<button class="btn btn-s btn-p" onclick="App.Panels.openSettings()">âš™ AyarlarÄ± AÃ§</button>';
      h += '</div></div>';
      rp.innerHTML = h;
      return;
    }

    // Tab bar
    h += '<div style="padding:8px 14px 0;">';
    h += '<div class="ai-tab-bar">';
    ['write','analysis','summary','chat'].forEach(tab => {
      const labels = {write:'YazÄ±m',analysis:'Analiz',summary:'Ã–zet',chat:'Sohbet'};
      h += `<button class="ai-tab${_aiTab===tab?' active':''}" onclick="App.AI.setTab('${tab}')">${labels[tab]}</button>`;
    });
    h += '</div></div>';

    // Provider & Model selector
    h += '<div style="padding:4px 14px;display:flex;gap:6px;align-items:center;">';
    h += '<select style="flex:1;padding:3px 6px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx2);font-size:11px;font-family:inherit;" onchange="App.AI.setProvider(this.value);App.AI.renderPanel();">';
    Object.entries(PROVIDERS).forEach(([k,v]) => {
      h += `<option value="${k}"${_provider===k?' selected':''}>${v.name}</option>`;
    });
    h += '</select>';
    h += '<select style="flex:1;padding:3px 6px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--tx2);font-size:11px;font-family:inherit;" onchange="App.AI.setModel(this.value);">';
    PROVIDERS[_provider].models.forEach(m => {
      h += `<option value="${m.id}"${_model===m.id?' selected':''}>${m.label}</option>`;
    });
    h += '</select>';
    h += '</div>';

    h += '<div style="padding:8px 14px;overflow-y:auto;flex:1;">';

    if(_aiTab === 'write') {
      h += _renderWriteTab(P);
    } else if(_aiTab === 'analysis') {
      h += _renderAnalysisTab(P);
    } else if(_aiTab === 'summary') {
      h += _renderSummaryTab(P);
    } else if(_aiTab === 'chat') {
      h += _renderChatTab(P);
    }

    h += '<div id="aiResponseArea"></div>';
    h += '</div>';
    rp.innerHTML = h;
  }

  function _renderWriteTab(P) {
    let h = '';
    const activeId = App.Screenplay && App.Screenplay.getActiveSceneId ? App.Screenplay.getActiveSceneId() : null;
    if(activeId) {
      const sc = S.getScene(activeId);
      if(sc) {
        h += `<div style="font-size:11px;color:var(--tx3);margin-bottom:8px;">Aktif Sahne: <strong style="color:var(--tx)">${U.escHtml(sc.title||'Ä°simsiz')}</strong></div>`;
      }
      h += `<button class="ai-feature-btn" onclick="App.AI.generateDialogue('${activeId}')" ${_streaming?'disabled':''}><span style="color:var(--purple)">âœ¦</span> Diyalog OluÅŸtur</button>`;
      h += `<button class="ai-feature-btn" onclick="App.AI.writeSceneDescription('${activeId}')" ${_streaming?'disabled':''}><span style="color:var(--purple)">âœ¦</span> Sahne AÃ§Ä±klamasÄ± Yaz</button>`;
      h += `<button class="ai-feature-btn" onclick="App.AI.continueScreenplay('${activeId}')" ${_streaming?'disabled':''}><span style="color:var(--purple)">âœ¦</span> Devam Ettir</button>`;
    } else {
      h += '<div style="font-size:12px;color:var(--tx3);padding:20px 0;text-align:center;">YazÄ±m Ã¶zelliklerini kullanmak iÃ§in sol panelden bir sahne seÃ§in.</div>';
    }
    return h;
  }

  function _renderAnalysisTab(P) {
    let h = '';
    h += `<button class="ai-feature-btn" onclick="App.AI.analyzeConsistency()" ${_streaming?'disabled':''}><span style="color:var(--purple)">âœ¦</span> TutarlÄ±lÄ±k Analizi</button>`;
    h += `<button class="ai-feature-btn" onclick="App.AI.analyzeTempoSuggestions()" ${_streaming?'disabled':''}><span style="color:var(--purple)">âœ¦</span> Tempo & Ritim Analizi</button>`;

    if(P.characters && P.characters.length) {
      h += '<div style="margin-top:10px;"><label style="font-size:11px;color:var(--tx3);display:block;margin-bottom:4px;">Karakter GeliÅŸim Ã–nerisi:</label>';
      h += '<div style="display:flex;gap:4px;flex-wrap:wrap;">';
      P.characters.forEach(ch => {
        h += `<button class="btn btn-s" onclick="App.AI.suggestCharacterDevelopment('${ch.id}')" ${_streaming?'disabled':''}>${U.escHtml(ch.name)}</button>`;
      });
      h += '</div></div>';
    }
    return h;
  }

  function _renderSummaryTab(P) {
    let h = '';
    if(P.episodes && P.episodes.length) {
      h += '<label style="font-size:11px;color:var(--tx3);display:block;margin-bottom:4px;">BÃ¶lÃ¼m Ã–zeti:</label>';
      h += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px;">';
      P.episodes.forEach(ep => {
        h += `<button class="btn btn-s" onclick="App.AI.summarizeEpisode('${ep.id}')" ${_streaming?'disabled':''}>BÃ¶lÃ¼m ${ep.number}</button>`;
      });
      h += '</div>';
    }

    if(P.characters && P.characters.length) {
      h += '<label style="font-size:11px;color:var(--tx3);display:block;margin-bottom:4px;">Karakter ArkÄ± Ã–zeti:</label>';
      h += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px;">';
      P.characters.forEach(ch => {
        h += `<button class="btn btn-s" onclick="App.AI.summarizeCharacterArc('${ch.id}')" ${_streaming?'disabled':''}>${U.escHtml(ch.name)}</button>`;
      });
      h += '</div>';
    }

    h += `<button class="ai-feature-btn" onclick="App.AI.generateProjectOverview()" ${_streaming?'disabled':''}><span style="color:var(--purple)">âœ¦</span> Proje Genel BakÄ±ÅŸ (Pitch)</button>`;
    return h;
  }

  function _renderChatTab(P) {
    let h = '';
    // Message history display
    if(_history.length) {
      h += '<div style="max-height:250px;overflow-y:auto;margin-bottom:8px;" id="aiChatHistory">';
      _history.forEach(msg => {
        h += `<div class="ai-msg ${msg.role}">`;
        if(msg.role === 'user') h += '<strong>Siz:</strong> ';
        h += U.escHtml(msg.content).substring(0, 500);
        if(msg.content.length > 500) h += '...';
        h += '</div>';
      });
      h += '</div>';
    }
    h += '<textarea id="aiChatInput" placeholder="Projeniz hakkÄ±nda soru sorun..." style="width:100%;min-height:60px;padding:8px;border-radius:var(--radius);border:1px solid var(--brd);background:var(--bg);color:var(--tx);font-family:inherit;font-size:12px;resize:vertical;outline:none;"></textarea>';
    h += '<div style="display:flex;justify-content:space-between;margin-top:6px;">';
    h += '<button class="btn btn-s" onclick="App.AI.clearHistory();App.AI.renderPanel();" style="color:var(--tx3)">Temizle</button>';
    h += `<button class="btn btn-s btn-p" onclick="App.AI.sendChat(document.getElementById('aiChatInput').value);document.getElementById('aiChatInput').value='';" ${_streaming?'disabled':''}>GÃ¶nder</button>`;
    h += '</div>';
    return h;
  }

  function clearHistory() { _history.length = 0; }

  function setTab(tab) {
    _aiTab = tab;
    renderPanel();
  }

  function _onProviderChange(val) {
    setProvider(val);
    const modelSel = document.getElementById('sAIModel');
    if(modelSel) {
      modelSel.innerHTML = '';
      PROVIDERS[_provider].models.forEach(m => {
        modelSel.innerHTML += `<option value="${m.id}"${m.id===_model?' selected':''}>${m.label}</option>`;
      });
    }
    // Update key field
    const keyInp = document.getElementById('sAIKey');
    if(keyInp) {
      const k = getKey();
      keyInp.value = k ? '********' : '';
    }
    const res = document.getElementById('aiTestResult');
    if(res) res.textContent = '';
  }

  return {
    PROVIDERS, isConfigured, getProvider, setProvider, getModel, setModel,
    getKey, setKey, validateKey, renderPanel, setTab, cancelRequest,
    generateDialogue, writeSceneDescription, continueScreenplay,
    analyzeConsistency, suggestCharacterDevelopment, analyzeTempoSuggestions,
    summarizeEpisode, summarizeCharacterArc, generateProjectOverview,
    sendChat, clearHistory,
    _onProviderChange, _testKey, _applyToScene, _replaceScene, _copyToClipboard
  };
})();


// â”€â”€ io.js â”€â”€
// â•â•â• IO MODULE â•â•â•
App.IO = (function(){
  const U = App.Utils;
  const S = App.Store;

  function exportJSON() {
    const P = S.get();
    const data = { ...P, meta: { ...P.meta, exportVersion: '2.1', date: new Date().toISOString() } };
    const b = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = (P.meta.title||'proje').replace(/\s+/g,'_') + '_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    App.UI.toast('JSON aktarÄ±ldÄ±');
  }

  function importJSON(e) {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if(d.events && d.events[0] && ('ep' in d.events[0]) && ('t' in d.events[0])) {
          migrateOldFormat(d);
          App.Projects.importToProject(S.get());
        } else if(d.meta && d.episodes) {
          App.Projects.importToProject(d);
        } else {
          App.UI.toast('TanÄ±nmayan dosya formatÄ±');
          return;
        }
      } catch(err) { App.UI.toast('GeÃ§ersiz dosya: ' + err.message); }
    };
    r.readAsText(f);
    e.target.value = '';
  }

  function migrateOldFormat(d) {
    // Migrate from v7 flat format to new hierarchical format
    const oldEvs = d.events || [];
    const oldCns = d.connections || [];
    const CATS = {operasyon:{label:'Operasyon',color:'#ef4444'},karakter:{label:'Karakter',color:'#3b82f6'},organizasyon:{label:'Organizasyon',color:'#10b981'},sistem:{label:'Sistem',color:'#f59e0b'},flashback:{label:'Flashback',color:'#a855f7'},ihanet:{label:'Ä°hanet',color:'#f97316'}};
    // Collect unique episodes
    const epNums = [...new Set(oldEvs.map(e=>e.ep))].sort((a,b)=>{if(a==='fb')return 1;if(b==='fb')return -1;return a-b;});
    const episodes = epNums.map((n,i) => ({ id:'ep_'+n, number:n, title:n==='fb'?'Flashback':'', duration:2700, type:'normal', order:i }));
    const epIdMap = {}; epNums.forEach(n => epIdMap[n] = 'ep_'+n);
    // Collect characters
    const charSet = new Set();
    oldEvs.forEach(e => (e.ch||[]).forEach(c => charSet.add(c)));
    const characters = [...charSet].map(name => ({ id:'ch_'+name.replace(/[^a-zA-ZÃ§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄÄ°Ã–ÅÃœ0-9]/g,'_'), name, color:'', notes:'' }));
    const charIdMap = {}; characters.forEach(c => charIdMap[c.name] = c.id);
    // Migrate events
    const events = oldEvs.map(e => ({
      id: e.id, title: e.t, description: e.d, episodeId: epIdMap[e.ep],
      sceneId: null, category: e.c, characters: (e.ch||[]).map(n=>charIdMap[n]||n),
      s: e.s, dur: e.dur
    }));
    // Migrate connections
    const connections = oldCns.map(c => ({
      id: U.genId('cn'), from: c.f, to: c.t, type: c.tp, description:'', strength:1
    }));
    const scenes = generateScenesFromEvents(events, episodes);
    S.set({
      meta: { title: d.meta?.title || 'Ä°Ã§e AktarÄ±lmÄ±ÅŸ Proje', author:'', settings:{ episodeDuration:2700, pixelsPerSecond:0.5, snapGrid:10 } },
      categories: CATS, characters, episodes, scenes, events, connections
    });
    // Set ID counter high enough
    U.setIdCounter(300);
  }

  function loadDemo() {
    App.Projects.loadDemoAsProject();
  }

  function handleDocx(e) {
    const f = e.target.files[0]; if(!f) return;
    App.UI.toast('DOCX ayrÄ±ÅŸtÄ±rÄ±lÄ±yor...');
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const data = new Uint8Array(evt.target.result);
        parseDocxSimple(data);
      } catch(err) { App.UI.toast('DOCX hatasÄ±: ' + err.message); }
    };
    reader.readAsArrayBuffer(f);
    e.target.value = '';
  }

  function parseDocxSimple(data) {
    // Minimal ZIP + XML parser for DOCX
    const view = new DataView(data.buffer);
    let eocd = -1;
    for(let i=data.length-22;i>=0;i--) { if(view.getUint32(i,true)===0x06054b50){eocd=i;break;} }
    if(eocd<0){App.UI.toast('GeÃ§ersiz DOCX');return;}
    const cdOff=view.getUint32(eocd+16,true), cdCnt=view.getUint16(eocd+10,true);
    let pos=cdOff;
    const entries=[];
    for(let f=0;f<cdCnt;f++){
      if(view.getUint32(pos,true)!==0x02014b50)break;
      const method=view.getUint16(pos+10,true),cSize=view.getUint32(pos+20,true),uSize=view.getUint32(pos+24,true);
      const nLen=view.getUint16(pos+28,true),eLen=view.getUint16(pos+30,true),cLen=view.getUint16(pos+32,true);
      const lOff=view.getUint32(pos+42,true);
      const name=new TextDecoder().decode(data.slice(pos+46,pos+46+nLen));
      entries.push({name,method,cSize,uSize,lOff});
      pos+=46+nLen+eLen+cLen;
    }
    // Find document.xml (stored, not compressed for simplicity)
    let docEntry = entries.find(e=>e.name.includes('word/document')&&e.name.includes('.xml'));
    if(!docEntry){App.UI.toast('document.xml bulunamadÄ±');return;}
    const lhNLen=view.getUint16(docEntry.lOff+26,true), lhELen=view.getUint16(docEntry.lOff+28,true);
    const dStart=docEntry.lOff+30+lhNLen+lhELen;
    let xmlData;
    if(docEntry.method===0) xmlData=data.slice(dStart,dStart+docEntry.uSize);
    else if(docEntry.method===8 && typeof DecompressionStream!=='undefined') {
      // Async decompress
      const compressed=data.slice(dStart,dStart+docEntry.cSize);
      const ds=new DecompressionStream('deflate-raw');
      const writer=ds.writable.getWriter();
      const reader=ds.readable.getReader();
      writer.write(compressed);writer.close();
      const chunks=[];
      (function read(){reader.read().then(r=>{if(r.value)chunks.push(r.value);if(r.done){let t=0;chunks.forEach(c=>t+=c.length);const out=new Uint8Array(t);let o=0;chunks.forEach(c=>{out.set(c,o);o+=c.length;});processDocxXml(out);}else read();});})();
      return;
    } else { App.UI.toast('SÄ±kÄ±ÅŸtÄ±rma desteklenmiyor'); return; }
    processDocxXml(xmlData);
  }

  function processDocxXml(xmlData) {
    const P = S.get();
    const xmlStr = new TextDecoder('utf-8').decode(xmlData);
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlStr, 'application/xml');
    const ns = 'http://schemas.openxmlformats.org/wordprocessingml/2006/main';
    const paras = doc.getElementsByTagNameNS(ns,'p');
    const lines = [];
    for(let i=0;i<paras.length;i++){
      const texts=paras[i].getElementsByTagNameNS(ns,'t');
      let line='';for(let j=0;j<texts.length;j++)line+=texts[j].textContent;
      let isBold=paras[i].getElementsByTagNameNS(ns,'b').length>0;
      const runs=paras[i].getElementsByTagNameNS(ns,'r');
      for(let r=0;r<runs.length;r++){if(runs[r].getElementsByTagNameNS(ns,'rPr').length>0&&runs[r].querySelector('b'))isBold=true;}
      let pStyle='';const pPrs=paras[i].getElementsByTagNameNS(ns,'pStyle');
      if(pPrs.length>0)pStyle=pPrs[0].getAttribute('w:val')||'';
      if(line.trim())lines.push({text:line.trim(),bold:isBold,style:pStyle});
    }
    // Scene detection
    const scenes=[];let curScene=null;let curEp=P.episodes[0]?.id||null;
    const charNames=P.characters.map(c=>c.name.toLowerCase());
    lines.forEach(line=>{
      const t=line.text, upper=t.toUpperCase();
      const epMatch=t.match(/(?:BÃ–LÃœM|BÃ¶lÃ¼m)\s*(\d+)/i);
      if(epMatch){const n=parseInt(epMatch[1]);const ep=P.episodes.find(e=>e.number===n);if(ep)curEp=ep.id;}
      let isScene=(upper.match(/^\[?\s*SAHNE\s*\d+/)||(line.bold&&t.length<100&&t.length>2)||line.style?.match(/heading/i));
      if(isScene){
        if(curScene&&curScene.content.length)scenes.push(curScene);
        curScene={id:U.genId('sc'),episodeId:curEp,order:scenes.length+1,title:t.replace(/[\[\]]/g,'').trim().substring(0,60)||'Sahne '+(scenes.length+1),
          location:'',timeOfDay:'',category:'karakter',characters:[],content:[]};
      } else if(curScene){
        const isChar=charNames.some((cn,idx)=>upper===P.characters[idx].name.toUpperCase());
        if(isChar) curScene.content.push({type:'dialogue',characterId:P.characters[charNames.findIndex(cn=>upper===P.characters[charNames.indexOf(cn)].name.toUpperCase())]?.id||'',text:'',parenthetical:''});
        else curScene.content.push({type:'action',text:t});
      }
    });
    if(curScene&&curScene.content.length)scenes.push(curScene);
    if(!scenes.length){App.UI.toast('Sahne bulunamadÄ±');return;}
    // Add scenes and auto-create events
    S.snapshot();
    const perEpTime={};
    scenes.forEach(sc=>{
      P.scenes.push(sc);
      const ep=sc.episodeId;if(!perEpTime[ep])perEpTime[ep]=0;
      const textLen=sc.content.reduce((s,b)=>s+(b.text||'').length,0);
      const dur=U.clamp(Math.round(textLen/40)*30,120,600);
      const s=perEpTime[ep];
      if(s>=S.getEPDUR())return;
      const ev={id:U.genId('ev'),title:sc.title,description:'',episodeId:ep,sceneId:sc.id,category:sc.category,characters:sc.characters||[],s:s,dur:Math.min(dur,S.getEPDUR()-s)};
      P.events.push(ev);
      perEpTime[ep]=s+dur+10;
    });
    S.markAllDirty();
    S.emit('change',{type:'docx'});
    App.refresh();
    App.UI.toast(scenes.length+' sahne ayrÄ±ÅŸtÄ±rÄ±ldÄ±');
  }

  return { exportJSON, importJSON, loadDemo, handleDocx, migrateOldFormat };
})();


// â”€â”€ export.js â”€â”€
// â•â•â• EXPORT MODULE (PDF / FDX / Fountain) â•â•â•
App.Export = (function(){
  const U = App.Utils;
  const S = App.Store;

  let _jsPDFLoaded = false;
  let _exportPrefs = null;

  function _loadPrefs() {
    if(_exportPrefs) return _exportPrefs;
    try { _exportPrefs = JSON.parse(localStorage.getItem('exportPrefs') || '{}'); } catch(e) { _exportPrefs = {}; }
    return _exportPrefs;
  }
  function _savePrefs(p) { _exportPrefs = p; try { localStorage.setItem('exportPrefs', JSON.stringify(p)); } catch(e) {} }

  // â”€â”€ Modal â”€â”€
  function openExportModal() {
    const P = S.get();
    const prefs = _loadPrefs();
    const format = prefs.format || 'pdf';
    const scope = prefs.scope || 'full';
    const pageSize = prefs.pageSize || 'a4';

    let episodeOpts = '<option value="all">Tam Proje</option>';
    P.episodes.forEach(ep => {
      episodeOpts += '<option value="' + ep.id + '">' + U.escHtml(ep.number === 'fb' ? 'Flashback' : 'BÃ¶lÃ¼m ' + ep.number + (ep.title ? ' â€” ' + ep.title : '')) + '</option>';
    });

    App.UI.openModal(
      '<div class="mh"><span>DÄ±ÅŸa Aktar</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>' +
      '<div class="mb">' +
      // Format tabs
      '<div class="export-tabs" style="display:flex;gap:2px;background:var(--bg);border-radius:var(--radius);padding:2px;border:1px solid var(--brd);margin-bottom:16px;">' +
      '<button class="export-tab' + (format === 'pdf' ? ' active' : '') + '" data-fmt="pdf" onclick="App.Export._setFormat(\'pdf\')">PDF</button>' +
      '<button class="export-tab' + (format === 'fdx' ? ' active' : '') + '" data-fmt="fdx" onclick="App.Export._setFormat(\'fdx\')">FDX (Final Draft)</button>' +
      '<button class="export-tab' + (format === 'fountain' ? ' active' : '') + '" data-fmt="fountain" onclick="App.Export._setFormat(\'fountain\')">Fountain</button>' +
      '</div>' +
      // Scope
      '<div class="fg"><label>Kapsam</label><select id="expScope">' + episodeOpts + '</select></div>' +
      // PDF options
      '<div id="expPDFOpts"' + (format !== 'pdf' ? ' style="display:none"' : '') + '>' +
      '<div class="fg"><label>Sayfa Boyutu</label><select id="expPageSize"><option value="a4"' + (pageSize === 'a4' ? ' selected' : '') + '>A4</option><option value="letter"' + (pageSize === 'letter' ? ' selected' : '') + '>US Letter</option></select></div>' +
      '<div class="fg"><label>Filigran (opsiyonel)</label><input id="expWatermark" placeholder="Filigran metni (Ã¶rn. TASLAK)" value="' + U.escHtml(prefs.watermark || '') + '" /></div>' +
      '<div class="fg"><label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="expSceneNums" style="width:auto;"' + (prefs.sceneNums !== false ? ' checked' : '') + ' /> Sahne numaralarÄ±</label></div>' +
      '<div class="fg"><label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="expTitlePage" style="width:auto;"' + (prefs.titlePage !== false ? ' checked' : '') + ' /> BaÅŸlÄ±k sayfasÄ±</label></div>' +
      '</div>' +
      // Preview
      '<div id="expPreview" style="border:1px solid var(--brd);border-radius:var(--radius);padding:12px;max-height:200px;overflow-y:auto;font-family:\'Courier New\',monospace;font-size:10px;background:var(--bg);color:var(--tx2);margin-top:12px;"></div>' +
      '</div>' +
      '<div class="mf">' +
      '<button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button>' +
      '<button class="btn" onclick="App.Export._preview()">Ã–nizleme</button>' +
      '<button class="btn btn-p" onclick="App.Export.doExport()">DÄ±ÅŸa Aktar</button>' +
      '</div>'
    );

    setTimeout(() => _preview(), 100);
  }

  function _setFormat(fmt) {
    document.querySelectorAll('.export-tab').forEach(t => t.classList.toggle('active', t.dataset.fmt === fmt));
    const pdfOpts = document.getElementById('expPDFOpts');
    if(pdfOpts) pdfOpts.style.display = fmt === 'pdf' ? '' : 'none';
    const prefs = _loadPrefs();
    prefs.format = fmt;
    _savePrefs(prefs);
    _preview();
  }

  function _getActiveFormat() {
    const active = document.querySelector('.export-tab.active');
    return active ? active.dataset.fmt : 'pdf';
  }

  function _preview() {
    const previewEl = document.getElementById('expPreview');
    if(!previewEl) return;
    const fmt = _getActiveFormat();
    const scope = (document.getElementById('expScope') || {}).value || 'all';
    const blocks = _buildScreenplayBlocks(scope);

    if(fmt === 'fountain') {
      previewEl.innerHTML = '<pre style="white-space:pre-wrap;margin:0;">' + U.escHtml(_generateFountain(blocks).substring(0, 2000)) + '...</pre>';
    } else if(fmt === 'fdx') {
      previewEl.innerHTML = '<pre style="white-space:pre-wrap;margin:0;">' + U.escHtml(_generateFDX(blocks).substring(0, 2000)) + '...</pre>';
    } else {
      // Simple text preview for PDF
      let text = '';
      blocks.forEach(b => {
        if(b.type === 'episode-header') text += '\nâ•â•â• ' + b.text + ' â•â•â•\n\n';
        else if(b.type === 'scene-heading') text += b.text + '\n';
        else if(b.type === 'character') text += '        ' + b.text + '\n';
        else if(b.type === 'dialogue') text += '    ' + b.text + '\n';
        else if(b.type === 'parenthetical') text += '      ' + b.text + '\n';
        else if(b.type === 'transition') text += '                    ' + b.text + '\n';
        else text += b.text + '\n';
      });
      previewEl.innerHTML = '<pre style="white-space:pre-wrap;margin:0;">' + U.escHtml(text.substring(0, 2000)) + (text.length > 2000 ? '...' : '') + '</pre>';
    }
  }

  // â”€â”€ Build screenplay blocks from project data â”€â”€
  function _buildScreenplayBlocks(scope) {
    const P = S.get();
    const blocks = [];
    const episodes = scope === 'all' ? [...P.episodes].sort((a,b) => a.order - b.order) : P.episodes.filter(e => e.id === scope);

    let globalSceneNum = 0;
    episodes.forEach(ep => {
      blocks.push({ type: 'episode-header', text: (ep.number === 'fb' ? 'FLASHBACK' : 'BÃ–LÃœM ' + ep.number) + (ep.title ? ' â€” ' + ep.title : '') });

      const scenes = S.getScenes(ep.id);
      scenes.forEach(sc => {
        globalSceneNum++;
        // Scene heading
        const loc = sc.location || 'Ä°Ã‡';
        const tod = sc.timeOfDay || 'GÃœN';
        const heading = loc + '. ' + (sc.title || 'SAHNE ' + globalSceneNum) + ' â€” ' + tod;
        blocks.push({ type: 'scene-heading', text: heading, sceneNum: globalSceneNum, sceneId: sc.id });

        const content = sc.content || [];
        content.forEach(block => {
          if(block.type === 'action') {
            blocks.push({ type: 'action', text: _stripMentions(block.text || '') });
          } else if(block.type === 'dialogue') {
            const ch = block.characterId ? P.characters.find(c => c.id === block.characterId) : null;
            blocks.push({ type: 'character', text: (ch ? ch.name : 'BÄ°LÄ°NMEYEN').toUpperCase() });
            if(block.parenthetical) blocks.push({ type: 'parenthetical', text: '(' + block.parenthetical + ')' });
            blocks.push({ type: 'dialogue', text: _stripMentions(block.text || '') });
          } else if(block.type === 'transition') {
            blocks.push({ type: 'transition', text: (block.text || 'KESME:').toUpperCase() });
          }
        });

        // If scene has screenplay text but no content blocks
        if(!content.length && sc.screenplay) {
          blocks.push({ type: 'action', text: _stripMentions(sc.screenplay) });
        }
      });
    });
    return blocks;
  }

  function _stripMentions(text) {
    return (text || '').replace(/@\[([^\]]+)\]\([^)]+\)/g, '$1');
  }

  // â”€â”€ Export dispatch â”€â”€
  function doExport() {
    const fmt = _getActiveFormat();
    const scope = (document.getElementById('expScope') || {}).value || 'all';
    const prefs = _loadPrefs();
    prefs.format = fmt;
    prefs.scope = scope;
    if(fmt === 'pdf') {
      prefs.pageSize = (document.getElementById('expPageSize') || {}).value || 'a4';
      prefs.watermark = (document.getElementById('expWatermark') || {}).value || '';
      prefs.sceneNums = (document.getElementById('expSceneNums') || {}).checked !== false;
      prefs.titlePage = (document.getElementById('expTitlePage') || {}).checked !== false;
    }
    _savePrefs(prefs);

    if(fmt === 'pdf') exportPDF(prefs);
    else if(fmt === 'fdx') exportFDX(scope);
    else if(fmt === 'fountain') exportFountain(scope);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PDF EXPORT (jsPDF)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function exportPDF(opts) {
    _ensureJsPDF(function() {
      const blocks = _buildScreenplayBlocks(opts.scope || 'all');
      const P = S.get();
      const isLetter = opts.pageSize === 'letter';
      const pageW = isLetter ? 215.9 : 210;
      const pageH = isLetter ? 279.4 : 297;
      const marginLeft = 38; // 1.5 inch
      const marginRight = 25; // 1 inch
      const marginTop = 25;
      const marginBottom = 25;
      const usableW = pageW - marginLeft - marginRight;
      const lineH = 4.2; // ~12pt Courier

      var doc = new jspdf.jsPDF({ unit: 'mm', format: isLetter ? 'letter' : 'a4' });
      doc.setFont('courier', 'normal');
      var pageNum = 1;
      var y = marginTop;

      function newPage() {
        // Footer
        doc.setFontSize(9);
        doc.setTextColor(150);
        doc.text(String(pageNum), pageW - marginRight, pageH - 10, { align: 'right' });
        doc.addPage();
        pageNum++;
        y = marginTop;
        // Watermark
        if(opts.watermark) _addWatermark(doc, opts.watermark, pageW, pageH);
      }

      function checkPage(lines) {
        if(y + lines * lineH > pageH - marginBottom) newPage();
      }

      // Title page
      if(opts.titlePage) {
        var titleY = pageH * 0.35;
        doc.setFontSize(24);
        doc.setTextColor(0);
        doc.text(P.meta.title || 'Senaryo', pageW / 2, titleY, { align: 'center' });
        doc.setFontSize(14);
        doc.setTextColor(80);
        if(P.meta.author) doc.text('Yazan: ' + P.meta.author, pageW / 2, titleY + 14, { align: 'center' });
        doc.setFontSize(10);
        doc.text(new Date().toLocaleDateString('tr-TR'), pageW / 2, titleY + 28, { align: 'center' });
        if(opts.watermark) _addWatermark(doc, opts.watermark, pageW, pageH);
        newPage();
      }

      // Watermark on first content page
      if(opts.watermark) _addWatermark(doc, opts.watermark, pageW, pageH);

      blocks.forEach(function(block) {
        doc.setFont('courier', 'normal');
        doc.setTextColor(0);

        if(block.type === 'episode-header') {
          checkPage(3);
          y += lineH * 2;
          doc.setFontSize(14);
          doc.setFont('courier', 'bold');
          doc.text(block.text, marginLeft, y);
          y += lineH * 2;
          doc.setFontSize(12);
          return;
        }

        if(block.type === 'scene-heading') {
          checkPage(3);
          y += lineH;
          doc.setFontSize(12);
          doc.setFont('courier', 'bold');
          var headText = block.text;
          if(opts.sceneNums && block.sceneNum) {
            doc.setFont('courier', 'normal');
            doc.setTextColor(120);
            doc.text(String(block.sceneNum), marginLeft - 12, y);
            doc.setTextColor(0);
            doc.setFont('courier', 'bold');
            doc.text(String(block.sceneNum), pageW - marginRight + 4, y);
          }
          doc.setTextColor(0);
          var headLines = doc.splitTextToSize(headText, usableW);
          headLines.forEach(function(line) {
            checkPage(1);
            doc.text(line, marginLeft, y);
            y += lineH;
          });
          y += lineH * 0.5;
          return;
        }

        doc.setFontSize(12);
        doc.setFont('courier', 'normal');

        if(block.type === 'action') {
          var actionLines = doc.splitTextToSize(block.text, usableW);
          actionLines.forEach(function(line) {
            checkPage(1);
            doc.text(line, marginLeft, y);
            y += lineH;
          });
          y += lineH * 0.3;
          return;
        }

        if(block.type === 'character') {
          checkPage(2);
          y += lineH * 0.3;
          doc.text(block.text, marginLeft + usableW * 0.37, y);
          y += lineH;
          return;
        }

        if(block.type === 'parenthetical') {
          checkPage(1);
          var parenLines = doc.splitTextToSize(block.text, usableW * 0.38);
          parenLines.forEach(function(line) {
            checkPage(1);
            doc.text(line, marginLeft + usableW * 0.31, y);
            y += lineH;
          });
          return;
        }

        if(block.type === 'dialogue') {
          var dialLines = doc.splitTextToSize(block.text, usableW * 0.50);
          dialLines.forEach(function(line) {
            checkPage(1);
            doc.text(line, marginLeft + usableW * 0.25, y);
            y += lineH;
          });
          y += lineH * 0.3;
          return;
        }

        if(block.type === 'transition') {
          checkPage(2);
          y += lineH * 0.3;
          doc.text(block.text, pageW - marginRight, y, { align: 'right' });
          y += lineH * 1.3;
          return;
        }
      });

      // Last page footer
      doc.setFontSize(9);
      doc.setTextColor(150);
      doc.text(String(pageNum), pageW - marginRight, pageH - 10, { align: 'right' });

      // Download
      var filename = (P.meta.title || 'senaryo').replace(/\s+/g, '_') + '.pdf';
      doc.save(filename);
      App.UI.closeModal();
      App.UI.toast('PDF indirildi');
    });
  }

  function _addWatermark(doc, text, pageW, pageH) {
    doc.saveGraphicsState();
    doc.setFontSize(50);
    doc.setTextColor(200, 200, 200);
    doc.setGState(new doc.GState({ opacity: 0.15 }));
    var cx = pageW / 2, cy = pageH / 2;
    // Diagonal watermark
    doc.text(text, cx, cy, { align: 'center', angle: 45 });
    doc.restoreGraphicsState();
  }

  function _ensureJsPDF(callback) {
    if(_jsPDFLoaded && typeof jspdf !== 'undefined') { callback(); return; }
    var script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js';
    script.crossOrigin = 'anonymous';
    script.onload = function() {
      _jsPDFLoaded = true;
      callback();
    };
    script.onerror = function() {
      App.UI.toast('jsPDF yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
    };
    document.head.appendChild(script);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FDX EXPORT (Final Draft XML)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function exportFDX(scope) {
    const blocks = _buildScreenplayBlocks(scope || 'all');
    const xml = _generateFDX(blocks);
    const P = S.get();
    var blob = new Blob([xml], { type: 'application/xml' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (P.meta.title || 'senaryo').replace(/\s+/g, '_') + '.fdx';
    a.click();
    App.UI.closeModal();
    App.UI.toast('FDX indirildi');
  }

  function _generateFDX(blocks) {
    var xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
    xml += '<FinalDraft DocumentType="Script" Template="No" Version="5">\n';
    xml += '  <Content>\n';

    blocks.forEach(function(block) {
      var fdxType = 'Action';
      if(block.type === 'scene-heading') fdxType = 'Scene Heading';
      else if(block.type === 'character') fdxType = 'Character';
      else if(block.type === 'dialogue') fdxType = 'Dialogue';
      else if(block.type === 'parenthetical') fdxType = 'Parenthetical';
      else if(block.type === 'transition') fdxType = 'Transition';
      else if(block.type === 'episode-header') fdxType = 'Action';
      else fdxType = 'Action';

      xml += '    <Paragraph Type="' + fdxType + '">\n';
      xml += '      <Text>' + _escapeXml(block.text || '') + '</Text>\n';
      xml += '    </Paragraph>\n';
    });

    xml += '  </Content>\n';
    xml += '</FinalDraft>\n';
    return xml;
  }

  function _escapeXml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FOUNTAIN EXPORT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function exportFountain(scope) {
    const blocks = _buildScreenplayBlocks(scope || 'all');
    const text = _generateFountain(blocks);
    const P = S.get();
    var blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (P.meta.title || 'senaryo').replace(/\s+/g, '_') + '.fountain';
    a.click();
    App.UI.closeModal();
    App.UI.toast('Fountain indirildi');
  }

  function _generateFountain(blocks) {
    const P = S.get();
    var text = '';

    // Title page metadata
    text += 'Title: ' + (P.meta.title || 'Senaryo') + '\n';
    if(P.meta.author) text += 'Credit: Yazan\nAuthor: ' + P.meta.author + '\n';
    text += 'Date: ' + new Date().toLocaleDateString('tr-TR') + '\n';
    text += '\n===\n\n';

    blocks.forEach(function(block) {
      if(block.type === 'episode-header') {
        text += '\n# ' + block.text + '\n\n';
      } else if(block.type === 'scene-heading') {
        // Fountain scene headings start with INT./EXT. or Turkish Ä°Ã‡./DIÅ.
        var heading = block.text;
        if(!heading.match(/^(Ä°Ã‡|DIÅ|INT|EXT)\./i)) {
          heading = 'Ä°Ã‡. ' + heading;
        }
        text += '\n.' + heading + '\n\n';
      } else if(block.type === 'action') {
        text += block.text + '\n\n';
      } else if(block.type === 'character') {
        text += '@' + block.text + '\n';
      } else if(block.type === 'parenthetical') {
        text += block.text + '\n';
      } else if(block.type === 'dialogue') {
        text += block.text + '\n\n';
      } else if(block.type === 'transition') {
        text += '> ' + block.text + '\n\n';
      }
    });
    return text;
  }

  return {
    openExportModal, doExport,
    exportPDF, exportFDX, exportFountain,
    _setFormat, _preview
  };
})();


// â”€â”€ review.js â”€â”€
// â•â•â• REVIEW + TRACK CHANGES MODULE â•â•â•
App.Review = (function(){
  const U = App.Utils;
  const S = App.Store;

  let _reviewMode = false;
  let _userId = null;
  let _userName = '';
  let _userColor = '#3b82f6';
  const USER_COLORS = ['#3b82f6','#ef4444','#10b981','#f59e0b','#a855f7','#ec4899','#06b6d4','#f97316'];

  function _initUser() {
    if(_userId) return;
    var user = App.Auth ? App.Auth.getCurrentUser() : null;
    if(user) {
      _userId = user.uid;
      _userName = user.displayName || user.email.split('@')[0];
      var hash = 0;
      for(var i = 0; i < _userId.length; i++) hash = ((hash << 5) - hash) + _userId.charCodeAt(i);
      _userColor = USER_COLORS[Math.abs(hash) % USER_COLORS.length];
    } else {
      _userId = 'local_' + Date.now();
      _userName = 'KullanÄ±cÄ±';
      _userColor = '#3b82f6';
    }
  }

  // â”€â”€ Toggle review mode â”€â”€
  function toggleReviewMode() {
    _initUser();
    _reviewMode = !_reviewMode;
    var btn = document.getElementById('reviewToggleBtn');
    if(btn) {
      btn.classList.toggle('btn-p', _reviewMode);
      btn.textContent = _reviewMode ? 'Ä°nceleme âœ“' : 'Ä°nceleme';
    }
    document.body.classList.toggle('review-mode-active', _reviewMode);
    if(_reviewMode) {
      App.UI.toast('Ä°nceleme modu aÃ§Ä±ldÄ±');
    } else {
      App.UI.toast('Ä°nceleme modu kapatÄ±ldÄ±');
    }
  }

  function isReviewMode() { return _reviewMode; }
  function getUserColor() { _initUser(); return _userColor; }
  function getUserId() { _initUser(); return _userId; }
  function getUserName() { _initUser(); return _userName; }

  // â”€â”€ Track Changes: Intercept input in contenteditable â”€â”€
  function interceptInput(event, editableEl) {
    if(!_reviewMode || !editableEl) return false;
    _initUser();

    // Get the current scene id
    var scId = editableEl.dataset.sid || editableEl.dataset.scid;
    if(!scId) return false;

    // Get insertion data
    var data = event.data || '';
    if(!data && event.inputType !== 'insertParagraph') return false;

    // Wrap inserted text in track-add span
    var sel = window.getSelection();
    if(!sel.rangeCount) return false;

    var range = sel.getRangeAt(0);
    range.deleteContents();

    var span = document.createElement('span');
    span.className = 'track-add';
    span.dataset.user = _userId;
    span.dataset.userName = _userName;
    span.dataset.ts = String(Date.now());
    span.style.borderBottom = '2px solid ' + U.sanitizeColor(_userColor);
    span.style.backgroundColor = 'rgba(' + _hexToRgb(_userColor) + ',0.1)';
    span.textContent = data || '\n';
    span.contentEditable = 'true';

    range.insertNode(span);

    // Move cursor after span
    var newRange = document.createRange();
    newRange.setStartAfter(span);
    newRange.collapse(true);
    sel.removeAllRanges();
    sel.addRange(newRange);

    // Record track change
    _addTrackChange(scId, 'add', data, span);

    event.preventDefault();
    return true;
  }

  function interceptDelete(event, editableEl) {
    if(!_reviewMode || !editableEl) return false;
    _initUser();

    var scId = editableEl.dataset.sid || editableEl.dataset.scid;
    if(!scId) return false;

    var sel = window.getSelection();
    if(!sel.rangeCount) return false;
    var range = sel.getRangeAt(0);

    // If there's a selection, wrap it in track-del
    if(!range.collapsed) {
      var fragment = range.extractContents();
      var span = document.createElement('span');
      span.className = 'track-del';
      span.dataset.user = _userId;
      span.dataset.userName = _userName;
      span.dataset.ts = String(Date.now());
      span.style.textDecoration = 'line-through';
      span.style.color = 'var(--red)';
      span.style.opacity = '0.7';
      span.contentEditable = 'false';
      span.appendChild(fragment);
      range.insertNode(span);

      _addTrackChange(scId, 'delete', span.textContent, span);
      event.preventDefault();
      return true;
    }

    // Single char delete (backspace/delete)
    var isBackspace = event.key === 'Backspace';
    var node = range.startContainer;
    var offset = range.startOffset;

    if(node.nodeType === Node.TEXT_NODE && node.textContent.length > 0) {
      var charIdx = isBackspace ? offset - 1 : offset;
      if(charIdx < 0 || charIdx >= node.textContent.length) return false;

      var deletedChar = node.textContent[charIdx];

      // Already in a track-del span? Skip
      if(node.parentElement && node.parentElement.classList.contains('track-del')) return false;

      // Already in a track-add span? Actually delete it
      if(node.parentElement && node.parentElement.classList.contains('track-add')) return false;

      // Create strikethrough span
      var before = node.textContent.substring(0, charIdx);
      var after = node.textContent.substring(charIdx + 1);

      var delSpan = document.createElement('span');
      delSpan.className = 'track-del';
      delSpan.dataset.user = _userId;
      delSpan.dataset.userName = _userName;
      delSpan.dataset.ts = String(Date.now());
      delSpan.style.textDecoration = 'line-through';
      delSpan.style.color = 'var(--red)';
      delSpan.style.opacity = '0.7';
      delSpan.contentEditable = 'false';
      delSpan.textContent = deletedChar;

      var parent = node.parentNode;
      var beforeNode = document.createTextNode(before);
      var afterNode = document.createTextNode(after);

      parent.insertBefore(beforeNode, node);
      parent.insertBefore(delSpan, node);
      parent.insertBefore(afterNode, node);
      parent.removeChild(node);

      // Place cursor after del span (at start of afterNode)
      var newRange = document.createRange();
      newRange.setStart(afterNode, 0);
      newRange.collapse(true);
      sel.removeAllRanges();
      sel.addRange(newRange);

      _addTrackChange(scId, 'delete', deletedChar, delSpan);
      event.preventDefault();
      return true;
    }

    return false;
  }

  function _addTrackChange(scId, type, text, spanEl) {
    var sc = S.getScene(scId);
    if(!sc) return;
    if(!sc.trackChanges) sc.trackChanges = [];
    sc.trackChanges.push({
      id: U.genId('tc'),
      type: type,
      userId: _userId,
      userName: _userName,
      userColor: _userColor,
      offset: 0, // simplified
      length: text.length,
      text: text,
      timestamp: Date.now(),
      accepted: null
    });
    S.markDirty('scenes');
  }

  // â”€â”€ Accept / Reject changes â”€â”€
  function acceptChange(changeId, sceneId) {
    var sc = S.getScene(sceneId);
    if(!sc || !sc.trackChanges) return;
    var tc = sc.trackChanges.find(function(c) { return c.id === changeId; });
    if(!tc) return;
    tc.accepted = true;

    // In DOM: if add, make permanent (remove span wrapper); if delete, remove the span entirely
    _applyDomChange(changeId, 'accept');
    S.markDirty('scenes');
    S.emit('change', { type: 'reviewAccept' });
    App.UI.toast('DeÄŸiÅŸiklik kabul edildi');
  }

  function rejectChange(changeId, sceneId) {
    var sc = S.getScene(sceneId);
    if(!sc || !sc.trackChanges) return;
    var tc = sc.trackChanges.find(function(c) { return c.id === changeId; });
    if(!tc) return;
    tc.accepted = false;

    // In DOM: if add, remove the text; if delete, restore the text
    _applyDomChange(changeId, 'reject');
    S.markDirty('scenes');
    S.emit('change', { type: 'reviewReject' });
    App.UI.toast('DeÄŸiÅŸiklik reddedildi');
  }

  function acceptAll(sceneId) {
    var sc = S.getScene(sceneId);
    if(!sc || !sc.trackChanges) return;
    sc.trackChanges.forEach(function(tc) {
      if(tc.accepted === null) {
        tc.accepted = true;
        _applyDomChange(tc.id, 'accept');
      }
    });
    S.markDirty('scenes');
    S.emit('change', { type: 'reviewAcceptAll' });
    App.UI.toast('TÃ¼m deÄŸiÅŸiklikler kabul edildi');
  }

  function rejectAll(sceneId) {
    var sc = S.getScene(sceneId);
    if(!sc || !sc.trackChanges) return;
    sc.trackChanges.forEach(function(tc) {
      if(tc.accepted === null) {
        tc.accepted = false;
        _applyDomChange(tc.id, 'reject');
      }
    });
    S.markDirty('scenes');
    S.emit('change', { type: 'reviewRejectAll' });
    App.UI.toast('TÃ¼m deÄŸiÅŸiklikler reddedildi');
  }

  function _applyDomChange(changeId, action) {
    // Find spans with this change id and apply
    document.querySelectorAll('[data-tc-id="' + changeId + '"]').forEach(function(span) {
      if(action === 'accept') {
        if(span.classList.contains('track-add')) {
          // Keep text, unwrap span
          var text = document.createTextNode(span.textContent);
          span.parentNode.replaceChild(text, span);
        } else if(span.classList.contains('track-del')) {
          // Remove the deleted text
          span.parentNode.removeChild(span);
        }
      } else { // reject
        if(span.classList.contains('track-add')) {
          // Remove the added text
          span.parentNode.removeChild(span);
        } else if(span.classList.contains('track-del')) {
          // Restore: unwrap the strikethrough
          var text = document.createTextNode(span.textContent);
          span.parentNode.replaceChild(text, span);
        }
      }
    });
  }

  // â”€â”€ Render track markers in screenplay text â”€â”€
  function renderTrackMarkers(sceneId, htmlText) {
    if(!htmlText) return htmlText;
    // Parse marker syntax: {+uid:ts|text+} and {-uid:ts|text-}
    htmlText = htmlText.replace(/\{\+([^:]+):(\d+)\|([^+]*)\+\}/g, function(m, uid, ts, text) {
      var color = _getColorForUser(uid);
      return '<span class="track-add" data-user="' + U.escHtml(uid) + '" data-ts="' + ts + '" style="border-bottom:2px solid ' + U.sanitizeColor(color) + ';background:rgba(' + _hexToRgb(color) + ',0.1)">' + U.escHtml(text) + '</span>';
    });
    htmlText = htmlText.replace(/\{-([^:]+):(\d+)\|([^-]*)-\}/g, function(m, uid, ts, text) {
      return '<span class="track-del" data-user="' + U.escHtml(uid) + '" data-ts="' + ts + '" style="text-decoration:line-through;color:var(--red);opacity:.7">' + U.escHtml(text) + '</span>';
    });
    return htmlText;
  }

  function stripMarkers(text) {
    if(!text) return text;
    // Remove add markers, keep text
    text = text.replace(/\{\+[^:]+:\d+\|([^+]*)\+\}/g, '$1');
    // Remove delete markers entirely (text was deleted)
    text = text.replace(/\{-[^:]+:\d+\|[^-]*-\}/g, '');
    return text;
  }

  // â”€â”€ Comments â”€â”€
  function addComment(sceneId, start, end, text) {
    _initUser();
    S.addReviewComment({
      id: U.genId('rc'),
      sceneId: sceneId,
      userId: _userId,
      userName: _userName,
      userColor: _userColor,
      text: text,
      markerStart: start || 0,
      markerEnd: end || 0,
      createdAt: Date.now(),
      resolved: false,
      replies: []
    });
    App.UI.toast('Yorum eklendi');
  }

  function openAddCommentModal(sceneId) {
    _initUser();
    App.UI.openModal(
      '<div class="mh"><span>Yorum Ekle</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>' +
      '<div class="mb">' +
      '<div class="fg"><label>Yorum</label><textarea id="rcText" rows="3" placeholder="Yorumunuzu yazÄ±n..."></textarea></div>' +
      '</div>' +
      '<div class="mf">' +
      '<button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button>' +
      '<button class="btn btn-p" onclick="App.Review.doAddComment(\'' + sceneId + '\')">Ekle</button>' +
      '</div>'
    );
  }

  function doAddComment(sceneId) {
    var text = (document.getElementById('rcText') || {}).value || '';
    if(!text.trim()) { App.UI.toast('Yorum metni gerekli'); return; }
    addComment(sceneId, 0, 0, text.trim());
    App.UI.closeModal();
  }

  function resolveComment(commentId) {
    S.updateReviewComment(commentId, { resolved: true });
    App.UI.toast('Yorum Ã§Ã¶zÃ¼ldÃ¼');
    if(document.getElementById('rPanel').classList.contains('open')) renderReviewPanel();
  }

  function unresolveComment(commentId) {
    S.updateReviewComment(commentId, { resolved: false });
    if(document.getElementById('rPanel').classList.contains('open')) renderReviewPanel();
  }

  function deleteComment(commentId) {
    S.removeReviewComment(commentId);
    App.UI.toast('Yorum silindi');
    if(document.getElementById('rPanel').classList.contains('open')) renderReviewPanel();
  }

  function addReply(commentId, text) {
    _initUser();
    var comment = (S.get().reviewComments || []).find(function(c) { return c.id === commentId; });
    if(!comment) return;
    if(!comment.replies) comment.replies = [];
    comment.replies.push({
      userId: _userId,
      userName: _userName,
      userColor: _userColor,
      text: text,
      createdAt: Date.now()
    });
    S.markDirty('reviewComments');
    S.emit('change', { type: 'reviewReply' });
    App.UI.toast('YanÄ±t eklendi');
  }

  function openReplyModal(commentId) {
    App.UI.openModal(
      '<div class="mh"><span>YanÄ±tla</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>' +
      '<div class="mb">' +
      '<div class="fg"><label>YanÄ±t</label><textarea id="rcReplyText" rows="2" placeholder="YanÄ±tÄ±nÄ±z..."></textarea></div>' +
      '</div>' +
      '<div class="mf">' +
      '<button class="btn" onclick="App.UI.closeModal()">Ä°ptal</button>' +
      '<button class="btn btn-p" onclick="App.Review.doReply(\'' + commentId + '\')">GÃ¶nder</button>' +
      '</div>'
    );
  }

  function doReply(commentId) {
    var text = (document.getElementById('rcReplyText') || {}).value || '';
    if(!text.trim()) { App.UI.toast('YanÄ±t gerekli'); return; }
    addReply(commentId, text.trim());
    App.UI.closeModal();
    renderReviewPanel();
  }

  // â”€â”€ Review Panel â”€â”€
  function renderReviewPanel() {
    var rp = document.getElementById('rPanel');
    if(!rp) return;
    rp.classList.add('open');

    var P = S.get();
    var comments = P.reviewComments || [];
    var scenes = P.scenes || [];

    // Collect track changes from all scenes
    var allChanges = [];
    scenes.forEach(function(sc) {
      (sc.trackChanges || []).forEach(function(tc) {
        if(tc.accepted === null) allChanges.push({ change: tc, sceneId: sc.id, sceneName: sc.title || 'AdsÄ±z' });
      });
    });

    var unresolvedComments = comments.filter(function(c) { return !c.resolved; });
    var resolvedComments = comments.filter(function(c) { return c.resolved; });

    var h = '<div class="rpanel-hdr"><h3>Ä°nceleme</h3><button class="close-btn" onclick="App.Panels.closeAll()">âœ•</button></div>';
    h += '<div class="rtabs">';
    h += '<button class="rtab active" onclick="App.Review._setTab(\'changes\',this)">DeÄŸiÅŸiklikler (' + allChanges.length + ')</button>';
    h += '<button class="rtab" onclick="App.Review._setTab(\'comments\',this)">Yorumlar (' + unresolvedComments.length + ')</button>';
    h += '<button class="rtab" onclick="App.Review._setTab(\'resolved\',this)">Ã‡Ã¶zÃ¼lmÃ¼ÅŸ (' + resolvedComments.length + ')</button>';
    h += '</div>';

    h += '<div class="rpanel-body">';

    // Changes tab (default)
    h += '<div id="rvTabChanges">';
    if(!allChanges.length) {
      h += '<div class="nw">Bekleyen deÄŸiÅŸiklik yok</div>';
    } else {
      // Stats
      var adds = allChanges.filter(function(c) { return c.change.type === 'add'; }).length;
      var dels = allChanges.filter(function(c) { return c.change.type === 'delete'; }).length;
      h += '<div style="padding:10px 14px;font-size:11px;color:var(--tx3);border-bottom:1px solid var(--brd);">';
      h += '<span style="color:var(--green);">+' + adds + ' ekleme</span> Â· <span style="color:var(--red);">-' + dels + ' silme</span>';
      h += '</div>';

      allChanges.forEach(function(item) {
        var tc = item.change;
        var color = U.sanitizeColor(tc.userColor || '#666');
        var icon = tc.type === 'add' ? '+' : '-';
        var iconColor = tc.type === 'add' ? 'var(--green)' : 'var(--red)';
        h += '<div class="review-panel-entry" style="padding:8px 14px;border-bottom:1px solid var(--brd);">';
        h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">';
        h += '<span style="font-weight:700;color:' + iconColor + ';font-size:14px;">' + icon + '</span>';
        h += '<span style="font-size:11px;font-weight:600;color:' + color + ';">' + U.escHtml(tc.userName || '?') + '</span>';
        h += '<span style="font-size:10px;color:var(--tx3);flex:1;">' + U.escHtml(item.sceneName) + '</span>';
        h += '<span style="font-size:9px;color:var(--tx4);">' + _timeAgo(tc.timestamp) + '</span>';
        h += '</div>';
        h += '<div style="font-size:12px;color:var(--tx2);padding:4px 8px;background:var(--bg);border-radius:4px;margin-bottom:6px;' + (tc.type === 'delete' ? 'text-decoration:line-through;color:var(--red);' : '') + '">';
        h += U.escHtml((tc.text || '').substring(0, 100));
        h += '</div>';
        h += '<div style="display:flex;gap:4px;">';
        h += '<button class="btn btn-s" style="color:var(--green);" onclick="App.Review.acceptChange(\'' + tc.id + '\',\'' + item.sceneId + '\')">Kabul</button>';
        h += '<button class="btn btn-s" style="color:var(--red);" onclick="App.Review.rejectChange(\'' + tc.id + '\',\'' + item.sceneId + '\')">Reddet</button>';
        h += '</div></div>';
      });

      // Bulk actions
      h += '<div style="padding:10px 14px;display:flex;gap:6px;">';
      h += '<button class="btn btn-s" style="color:var(--green);" onclick="App.Review._acceptAllScenes()">TÃ¼mÃ¼nÃ¼ Kabul</button>';
      h += '<button class="btn btn-s" style="color:var(--red);" onclick="App.Review._rejectAllScenes()">TÃ¼mÃ¼nÃ¼ Reddet</button>';
      h += '</div>';
    }
    h += '</div>';

    // Comments tab (hidden by default)
    h += '<div id="rvTabComments" style="display:none;">';
    if(!unresolvedComments.length) {
      h += '<div class="nw">AÃ§Ä±k yorum yok</div>';
    } else {
      unresolvedComments.forEach(function(c) {
        h += _renderComment(c, false);
      });
    }
    h += '</div>';

    // Resolved tab (hidden by default)
    h += '<div id="rvTabResolved" style="display:none;">';
    if(!resolvedComments.length) {
      h += '<div class="nw">Ã‡Ã¶zÃ¼lmÃ¼ÅŸ yorum yok</div>';
    } else {
      resolvedComments.forEach(function(c) {
        h += _renderComment(c, true);
      });
    }
    h += '</div>';

    h += '</div>';
    rp.innerHTML = h;
  }

  function _renderComment(c, isResolved) {
    var color = U.sanitizeColor(c.userColor || '#666');
    var h = '<div class="review-panel-entry" style="padding:10px 14px;border-bottom:1px solid var(--brd);' + (isResolved ? 'opacity:.6;' : '') + '">';
    h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">';
    h += '<div style="width:22px;height:22px;border-radius:50%;background:' + color + ';display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;">' + (c.userName || '?').charAt(0).toUpperCase() + '</div>';
    h += '<span style="font-size:11px;font-weight:600;">' + U.escHtml(c.userName || '?') + '</span>';
    h += '<span style="font-size:9px;color:var(--tx4);flex:1;">' + _timeAgo(c.createdAt) + '</span>';
    if(isResolved) {
      h += '<button class="btn btn-s" onclick="App.Review.unresolveComment(\'' + c.id + '\')">Yeniden AÃ§</button>';
    }
    h += '</div>';
    h += '<div style="font-size:12px;color:var(--tx);padding:6px 0;line-height:1.5;">' + U.escHtml(c.text) + '</div>';

    // Replies
    if(c.replies && c.replies.length) {
      c.replies.forEach(function(r) {
        h += '<div style="margin-left:16px;padding:6px 0;border-top:1px solid var(--brd);">';
        h += '<div style="display:flex;align-items:center;gap:4px;margin-bottom:2px;">';
        h += '<span style="font-size:10px;font-weight:600;color:' + U.sanitizeColor(r.userColor || '#666') + ';">' + U.escHtml(r.userName || '?') + '</span>';
        h += '<span style="font-size:9px;color:var(--tx4);">' + _timeAgo(r.createdAt) + '</span>';
        h += '</div>';
        h += '<div style="font-size:11px;color:var(--tx2);">' + U.escHtml(r.text) + '</div>';
        h += '</div>';
      });
    }

    if(!isResolved) {
      h += '<div style="display:flex;gap:4px;margin-top:6px;">';
      h += '<button class="btn btn-s" onclick="App.Review.openReplyModal(\'' + c.id + '\')">YanÄ±tla</button>';
      h += '<button class="btn btn-s" style="color:var(--green);" onclick="App.Review.resolveComment(\'' + c.id + '\')">Ã‡Ã¶zÃ¼ldÃ¼</button>';
      h += '<button class="btn btn-s" style="color:var(--red);" onclick="App.Review.deleteComment(\'' + c.id + '\')">Sil</button>';
      h += '</div>';
    }
    h += '</div>';
    return h;
  }

  function _setTab(tab, btn) {
    // Toggle tab content
    var tabs = ['changes','comments','resolved'];
    tabs.forEach(function(t) {
      var el = document.getElementById('rvTab' + t.charAt(0).toUpperCase() + t.slice(1));
      if(el) el.style.display = t === tab ? '' : 'none';
    });
    // Toggle active class
    var tabBar = btn ? btn.parentElement : null;
    if(tabBar) {
      tabBar.querySelectorAll('.rtab').forEach(function(t) { t.classList.remove('active'); });
      if(btn) btn.classList.add('active');
    }
  }

  function _acceptAllScenes() {
    var P = S.get();
    P.scenes.forEach(function(sc) {
      if(sc.trackChanges && sc.trackChanges.length) {
        sc.trackChanges.forEach(function(tc) {
          if(tc.accepted === null) tc.accepted = true;
        });
      }
    });
    S.markDirty('scenes');
    S.emit('change', { type: 'reviewAcceptAll' });
    renderReviewPanel();
    App.UI.toast('TÃ¼m deÄŸiÅŸiklikler kabul edildi');
  }

  function _rejectAllScenes() {
    var P = S.get();
    P.scenes.forEach(function(sc) {
      if(sc.trackChanges && sc.trackChanges.length) {
        sc.trackChanges.forEach(function(tc) {
          if(tc.accepted === null) tc.accepted = false;
        });
      }
    });
    S.markDirty('scenes');
    S.emit('change', { type: 'reviewRejectAll' });
    renderReviewPanel();
    App.UI.toast('TÃ¼m deÄŸiÅŸiklikler reddedildi');
  }

  // â”€â”€ User color assignment modal â”€â”€
  function openUserColorModal() {
    _initUser();
    var colorsHtml = USER_COLORS.map(function(c) {
      var selected = c === _userColor;
      return '<div style="width:32px;height:32px;border-radius:50%;background:' + c + ';cursor:pointer;border:3px solid ' + (selected ? 'var(--tx)' : 'transparent') + ';" onclick="App.Review._setUserColor(\'' + c + '\')"></div>';
    }).join('');

    App.UI.openModal(
      '<div class="mh"><span>Ä°nceleme Rengi</span><button class="close-btn" onclick="App.UI.closeModal()">âœ•</button></div>' +
      '<div class="mb">' +
      '<div class="fg"><label>KullanÄ±cÄ±: ' + U.escHtml(_userName) + '</label></div>' +
      '<div style="display:flex;gap:8px;flex-wrap:wrap;padding:8px 0;">' + colorsHtml + '</div>' +
      '</div>' +
      '<div class="mf"><button class="btn btn-p" onclick="App.UI.closeModal()">Tamam</button></div>'
    );
  }

  function _setUserColor(color) {
    _userColor = color;
    App.UI.closeModal();
    App.UI.toast('Ä°nceleme rengi gÃ¼ncellendi');
  }

  // â”€â”€ Change statistics â”€â”€
  function getChangeStats() {
    var P = S.get();
    var stats = { total: 0, adds: 0, deletes: 0, pending: 0, accepted: 0, rejected: 0 };
    (P.scenes || []).forEach(function(sc) {
      (sc.trackChanges || []).forEach(function(tc) {
        stats.total++;
        if(tc.type === 'add') stats.adds++;
        else stats.deletes++;
        if(tc.accepted === null) stats.pending++;
        else if(tc.accepted) stats.accepted++;
        else stats.rejected++;
      });
    });
    return stats;
  }

  // â”€â”€ Helpers â”€â”€
  function _hexToRgb(hex) {
    if(!hex || hex.charAt(0) !== '#') return '59,130,246';
    var r = parseInt(hex.slice(1,3), 16) || 0;
    var g = parseInt(hex.slice(3,5), 16) || 0;
    var b = parseInt(hex.slice(5,7), 16) || 0;
    return r + ',' + g + ',' + b;
  }

  function _getColorForUser(uid) {
    var P = S.get();
    var meta = P.meta || {};
    if(meta.reviewUsers && meta.reviewUsers[uid]) return meta.reviewUsers[uid].color;
    if(uid === _userId) return _userColor;
    var hash = 0;
    for(var i = 0; i < uid.length; i++) hash = ((hash << 5) - hash) + uid.charCodeAt(i);
    return USER_COLORS[Math.abs(hash) % USER_COLORS.length];
  }

  function _timeAgo(ts) {
    if(!ts) return '';
    var diff = Date.now() - ts;
    var mins = Math.floor(diff / 60000);
    if(mins < 1) return 'ÅŸimdi';
    if(mins < 60) return mins + ' dk Ã¶nce';
    var hours = Math.floor(mins / 60);
    if(hours < 24) return hours + ' sa Ã¶nce';
    var days = Math.floor(hours / 24);
    return days + ' gÃ¼n Ã¶nce';
  }

  return {
    toggleReviewMode, isReviewMode,
    getUserColor, getUserId, getUserName,
    interceptInput, interceptDelete,
    renderTrackMarkers, stripMarkers,
    acceptChange, rejectChange, acceptAll, rejectAll,
    addComment, openAddCommentModal, doAddComment,
    resolveComment, unresolveComment, deleteComment,
    addReply, openReplyModal, doReply,
    renderReviewPanel, openUserColorModal,
    getChangeStats,
    _setTab, _setUserColor, _acceptAllScenes, _rejectAllScenes
  };
})();


// â”€â”€ sync.js â”€â”€
// â•â•â• SYNC MODULE (Minimal â€” real-time sync is now in App.Projects) â•â•â•
App.Sync = (function(){
  function init() {}
  function handleStoreChange(data) {
    if(data && data.type && data.type.startsWith('remote')) return;
  }
  function isInRoom() { return !!App.Projects.getCurrentId(); }
  function leaveRoom() { App.Projects.goBack(); }
  return { init, handleStoreChange, isInRoom, leaveRoom };
})();


// â”€â”€ app.js â”€â”€
// â•â•â• DEMO PROJECT DATA (SAKAL) â•â•â•
function getDemoProject() {
  const U = App.Utils;
  const CHARS = ['Sakal','AkÄ±n','AyÃ§a','Hatice','Ã‡aÄŸatay','Ayaz','BegÃ¼m','Mehmet','Aren','Tomris/Lakas','Asaf','Menderes','DoÄŸan Albay','Tutak','Sangal','Tekin','Oktay Anar'];
  const characters = CHARS.map(name => ({id:'ch_'+name.replace(/[^a-zA-ZÃ§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄÄ°Ã–ÅÃœ0-9]/g,'_'), name, color:'', notes:''}));
  const charId = name => 'ch_'+name.replace(/[^a-zA-ZÃ§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄÄ°Ã–ÅÃœ0-9]/g,'_');
  const episodes = [
    {id:'ep1',number:1,title:'Uyanma',duration:2700,type:'normal',order:1},
    {id:'ep2',number:2,title:'Masal',duration:2700,type:'normal',order:2},
    {id:'ep3',number:3,title:'Sistemin YÃ¼zÃ¼',duration:2700,type:'normal',order:3},
    {id:'ep4',number:4,title:'Ä°lk Darbe',duration:2700,type:'normal',order:4},
    {id:'ep5',number:5,title:'Sangal Operasyonu',duration:2700,type:'normal',order:5},
    {id:'ep6',number:6,title:'Tekin Holding',duration:2700,type:'normal',order:6},
    {id:'ep7',number:7,title:'SÄ±nav ve Ã‡atlaklar',duration:2700,type:'normal',order:7},
    {id:'ep8',number:8,title:'KayÄ±p',duration:2700,type:'normal',order:8},
    {id:'ep9',number:9,title:'Yeniden DoÄŸuÅŸ',duration:2700,type:'normal',order:9},
    {id:'ep10',number:10,title:'Lakas (Final)',duration:2700,type:'normal',order:10},
    {id:'epfb',number:'fb',title:'Flashback',duration:2700,type:'flashback',order:11}
  ];
  const epMap = {1:'ep1',2:'ep2',3:'ep3',4:'ep4',5:'ep5',6:'ep6',7:'ep7',8:'ep8',9:'ep9',10:'ep10','fb':'epfb'};
  const raw = [
    {id:'e1',t:'Flashforward: Ä°zbe Bina',d:'Kaos, silah sesleri, patlama.',ep:1,c:'sistem',ch:[],s:0,dur:120},
    {id:'e2',t:'AkÄ±n: Sabah Rutini',d:'Alarm, tÄ±raÅŸ, modern kÃ¶lelik temasÄ±.',ep:1,c:'karakter',ch:['AkÄ±n'],s:120,dur:150},
    {id:'e3',t:'AkÄ±n: Trafik ve Plaza',d:'Trafikte sÄ±kÄ±ÅŸma, plazaya giriÅŸ.',ep:1,c:'karakter',ch:['AkÄ±n'],s:270,dur:90},
    {id:'e4',t:'Kafede BegÃ¼m ile TanÄ±ÅŸma',d:'Masada Demir Ã–kÃ§e kitabÄ±.',ep:1,c:'karakter',ch:['AkÄ±n','BegÃ¼m','Ayaz'],s:360,dur:120},
    {id:'e5',t:'AkÄ±n: Counter Strike â†’ MÃ¼dÃ¼r',d:'Ofiste oyun, mÃ¼dÃ¼rle gerilim.',ep:1,c:'karakter',ch:['AkÄ±n'],s:480,dur:120},
    {id:'e6',t:'Koridor Operasyonu',d:'Ayaz gece baskÄ±nÄ±, USB verileri.',ep:1,c:'operasyon',ch:['Ayaz','Sakal'],s:600,dur:180},
    {id:'e7',t:'Ã‡aÄŸatay: GTA â†’ Pizza',d:'GTA 5, Mehmet kurye gelir.',ep:1,c:'karakter',ch:['Ã‡aÄŸatay','Mehmet'],s:780,dur:120},
    {id:'e8',t:'AyÃ§a: Otel Sahnesi',d:'Barda KÃ¼Ã§Ã¼k Prens bÄ±rakma.',ep:1,c:'karakter',ch:['AyÃ§a','Ayaz'],s:900,dur:150},
    {id:'e9',t:'Hatice: Acil Servis + Taciz',d:'Vardiya bitiÅŸi, Mehmet kurtarma.',ep:1,c:'karakter',ch:['Hatice','Mehmet'],s:1050,dur:120},
    {id:'e10',t:'Hatice: Gecekondu Evi',d:'KitaplÄ±k, Meryem fotoÄŸrafÄ±.',ep:1,c:'karakter',ch:['Hatice'],s:1170,dur:60},
    {id:'e11',t:'Sahaf TanÄ±tÄ±mÄ± + Zihgir',d:'FSM tablosu ve hikayesi.',ep:1,c:'organizasyon',ch:['Sakal','Mehmet','Ayaz'],s:1230,dur:120},
    {id:'e12',t:'Haticeâ€“AyÃ§a Hastane SÃ¼reci',d:'BakÄ±m, anne boÅŸluÄŸu.',ep:1,c:'karakter',ch:['Hatice','AyÃ§a','Sakal'],s:1350,dur:90},
    {id:'e13',t:'Sakal: Aren\'i TV\'den Ä°zleme',d:'Randevu teyidi.',ep:1,c:'karakter',ch:['Sakal','Aren'],s:1440,dur:60},
    {id:'e14',t:'Sakalâ€“Aren Terapi SeansÄ±',d:'Kum saati hediyesi.',ep:1,c:'karakter',ch:['Sakal','Aren'],s:1500,dur:120},
    {id:'e15',t:'Parti: Odalar ve YÃ¼zleÅŸme',d:'NumaralÄ± bileklikler.',ep:1,c:'organizasyon',ch:['Sakal','AkÄ±n','AyÃ§a','Hatice','Ã‡aÄŸatay','BegÃ¼m','Ayaz','Mehmet'],s:1620,dur:240},
    {id:'e16',t:'Parti: Sakal TanÄ±ÅŸma + Damga',d:'FotoÄŸraf, damga.',ep:1,c:'organizasyon',ch:['Sakal','AkÄ±n','AyÃ§a','Hatice','Ã‡aÄŸatay'],s:1860,dur:120},
    {id:'e17',t:'Parti SonrasÄ±: Gece Sahneleri',d:'Herkes kendi evinde.',ep:1,c:'karakter',ch:['Ayaz','AyÃ§a','Ã‡aÄŸatay','AkÄ±n','Hatice'],s:1980,dur:120},
    {id:'e18',t:'Haticeâ€“AyÃ§a: Damga KeÅŸfi',d:'Sahaf adresini bulma.',ep:1,c:'organizasyon',ch:['Hatice','AyÃ§a'],s:2100,dur:90},
    {id:'e19',t:'Masal: MasalcÄ± KÄ±z (BegÃ¼m)',d:'BegÃ¼m sesiyle masal baÅŸlar.',ep:2,c:'organizasyon',ch:['BegÃ¼m'],s:0,dur:120},
    {id:'e20',t:'BegÃ¼m Yolda + Metro',d:'YÄ±lmaz Holding reklamlarÄ±.',ep:2,c:'karakter',ch:['BegÃ¼m'],s:120,dur:90},
    {id:'e21',t:'Masal: TÃ¼ccar (Tutak)',d:'Masalda TÃ¼ccar.',ep:2,c:'organizasyon',ch:['Tutak'],s:210,dur:90},
    {id:'e22',t:'Tutak: GÃ¼nlÃ¼k Hayat',d:'LÃ¼ks malikane ama yalnÄ±z.',ep:2,c:'sistem',ch:['Tutak'],s:300,dur:180},
    {id:'e23',t:'BegÃ¼mâ€“AkÄ±n Kafede',d:'Parti konuÅŸmasÄ±.',ep:2,c:'karakter',ch:['BegÃ¼m','AkÄ±n'],s:480,dur:150},
    {id:'e24',t:'Masal: Saat (AkÄ±n)',d:'AltÄ±n gÃ¶vde, Ã§elik mekanizma.',ep:2,c:'organizasyon',ch:['AkÄ±n'],s:630,dur:60},
    {id:'e25',t:'AkÄ±n Ofiste: Tekin Holding',d:'Kurumsal baskÄ±.',ep:2,c:'karakter',ch:['AkÄ±n','Tekin'],s:690,dur:120},
    {id:'e26',t:'Masal: Ã–rÃ¼mcek (Ã‡aÄŸatay)',d:'KaranlÄ±k kÃ¶ÅŸede aÄŸ.',ep:2,c:'organizasyon',ch:['Ã‡aÄŸatay'],s:810,dur:60},
    {id:'e27',t:'Sakal Ã‡aÄŸatay Evine Gelir',d:'Burada harcanÄ±yorsun.',ep:2,c:'organizasyon',ch:['Sakal','Ã‡aÄŸatay'],s:870,dur:150},
    {id:'e28',t:'Hatice: Meryem FotoÄŸrafÄ±',d:'Derin sessizlik.',ep:2,c:'karakter',ch:['Hatice'],s:1020,dur:60},
    {id:'e29',t:'Masal: AteÅŸ KuÅŸu (AyÃ§a)',d:'Masalda AyÃ§a.',ep:2,c:'organizasyon',ch:['AyÃ§a'],s:1080,dur:60},
    {id:'e30',t:'Masal Finali: Kelebek Etkisi',d:'Kaos teorisi metaforu.',ep:2,c:'organizasyon',ch:['BegÃ¼m'],s:1140,dur:120},
    {id:'e31',t:'e-Demokrasi: Oylama',d:'AlgÄ± operasyonu.',ep:3,c:'sistem',ch:['AkÄ±n'],s:0,dur:180},
    {id:'e32',t:'Asaf: Hastane AÃ§Ä±lÄ±ÅŸÄ±',d:'HayÄ±rsever imajÄ±.',ep:3,c:'sistem',ch:['Asaf'],s:180,dur:180},
    {id:'e33',t:'Sakalâ€“Tekin Holding Ziyareti',d:'AkÄ±n Sakal\'Ä± gÃ¶rÃ¼r.',ep:3,c:'organizasyon',ch:['Sakal','AkÄ±n','Tekin'],s:360,dur:150},
    {id:'e34',t:'BegÃ¼mâ€“Sakalâ€“AkÄ±n: Starbucks',d:'YÄ±lmaz\'Ä± mÄ± Ã¶ldÃ¼receksin?',ep:3,c:'organizasyon',ch:['Sakal','AkÄ±n','BegÃ¼m'],s:510,dur:120},
    {id:'e35',t:'Sahafta Ä°lk ToplantÄ±',d:'GÃ¶rev daÄŸÄ±lÄ±mÄ±.',ep:3,c:'organizasyon',ch:['Sakal','AkÄ±n','AyÃ§a','Hatice','Ayaz','BegÃ¼m','Mehmet'],s:630,dur:240},
    {id:'e36',t:'Åirket Kurma Teklifi',d:'Platform geliÅŸtirme gÃ¶revi.',ep:3,c:'organizasyon',ch:['Sakal','Ã‡aÄŸatay'],s:870,dur:150},
    {id:'e37',t:'Menderes: Balistik Rapor',d:'Mermi kovanlarÄ±.',ep:3,c:'sistem',ch:['Menderes'],s:1020,dur:120},
    {id:'e38',t:'Asaf: SaÄŸlÄ±k AltyapÄ±sÄ±',d:'Stratejik deÄŸer.',ep:3,c:'sistem',ch:['Asaf'],s:1140,dur:120},
    {id:'e39',t:'Tutak BaskÄ±nÄ±: Gece Op.',d:'Mermi kovanlarÄ±na isim yazma.',ep:4,c:'operasyon',ch:['Ayaz','Sakal','Tutak'],s:0,dur:240},
    {id:'e40',t:'Tutak\'Ä±n Ã–lÃ¼mÃ¼',d:'Ä°lk oligark dÃ¼ÅŸer.',ep:4,c:'operasyon',ch:['Ayaz','Tutak'],s:240,dur:90},
    {id:'e41',t:'Sangal: Medya Ä°mparatorluÄŸu',d:'Gazete patronu.',ep:4,c:'sistem',ch:['Sangal'],s:330,dur:180},
    {id:'e42',t:'AyÃ§aâ€“Hatice Dostluk',d:'Veranda sohbetleri.',ep:4,c:'karakter',ch:['AyÃ§a','Hatice'],s:510,dur:120},
    {id:'e43',t:'AyÃ§a: Annesiyle Telefon',d:'SoÄŸuk cevaplar.',ep:4,c:'karakter',ch:['AyÃ§a'],s:630,dur:90},
    {id:'e44',t:'Ã‡aÄŸatay: Uygulama Beta',d:'Gizli iÅŸlev.',ep:4,c:'ihanet',ch:['Ã‡aÄŸatay','Sakal'],s:720,dur:150},
    {id:'e45',t:'Hatice: Ä°ÅŸ Yerinde AÅŸaÄŸÄ±lanma',d:'Sessiz Ã¶fke.',ep:4,c:'karakter',ch:['Hatice'],s:870,dur:90},
    {id:'e46',t:'Asaf: Ä°ÅŸ Zirvesi',d:'Ä°stikrar konuÅŸmasÄ±.',ep:4,c:'sistem',ch:['Asaf'],s:960,dur:120},
    {id:'e47',t:'e-Demokrasi: AlgÄ± Op.',d:'Sangal gazetesi yÃ¶nlendirmesi.',ep:4,c:'sistem',ch:['Sangal'],s:1080,dur:120},
    {id:'e48',t:'AyÃ§a: Sahte Kimlik',d:'Gazeteci AyÅŸe Duran.',ep:5,c:'operasyon',ch:['AyÃ§a'],s:0,dur:120},
    {id:'e49',t:'Sangal Operasyonu: Otel',d:'Ustura, Sakal\'Ä±n selamÄ±.',ep:5,c:'operasyon',ch:['AyÃ§a','Sangal'],s:120,dur:210},
    {id:'e50',t:'Hatice: Koridorda BakÄ±ÅŸma',d:'Sessiz dayanÄ±ÅŸma.',ep:5,c:'operasyon',ch:['Hatice','AyÃ§a'],s:330,dur:60},
    {id:'e51',t:'Sangal Ã–lÃ¼mÃ¼: Kalp Krizi',d:'DoÄŸal gÃ¶sterilir.',ep:5,c:'operasyon',ch:['Hatice','Sangal'],s:390,dur:90},
    {id:'e52',t:'AkÄ±nâ€“BegÃ¼m Pub\'da',d:'Haberlerde cinayetler.',ep:5,c:'karakter',ch:['AkÄ±n','BegÃ¼m'],s:480,dur:120},
    {id:'e53',t:'Uygulama YayÄ±nda',d:'KullanÄ±cÄ± artÄ±ÅŸÄ±.',ep:5,c:'ihanet',ch:['Ã‡aÄŸatay'],s:600,dur:150},
    {id:'e54',t:'Halkta KÄ±pÄ±rtÄ±',d:'Anonim paylaÅŸÄ±mlar.',ep:5,c:'sistem',ch:[],s:750,dur:150},
    {id:'e55',t:'AkÄ±n: Turntable + GÃ¶zaltÄ±',d:'Ã–zel harekat baskÄ±nÄ±.',ep:5,c:'operasyon',ch:['AkÄ±n'],s:900,dur:180},
    {id:'e56',t:'Gece Sahneleri',d:'Herkes evde.',ep:5,c:'karakter',ch:['Hatice','Ã‡aÄŸatay','Sakal'],s:1080,dur:120},
    {id:'e57',t:'Tekin Holding Hack: Plan',d:'GÃ¶rev daÄŸÄ±lÄ±mÄ±.',ep:6,c:'operasyon',ch:['Sakal','AkÄ±n','Ã‡aÄŸatay','Ayaz','BegÃ¼m','Mehmet'],s:0,dur:180},
    {id:'e58',t:'Tekin Holding Hack: Ä°cra',d:'Hesaplar boÅŸaltÄ±lÄ±r.',ep:6,c:'operasyon',ch:['AkÄ±n','Ã‡aÄŸatay','Ayaz','Tekin'],s:180,dur:240},
    {id:'e59',t:'Asaf: YardÄ±m Organizasyonu',d:'Sahada halkla iÃ§ iÃ§e.',ep:6,c:'sistem',ch:['Asaf'],s:420,dur:120},
    {id:'e60',t:'Organize Åube: Emniyet MÃ¼dÃ¼rÃ¼',d:'Gazeteci nasÄ±l Ã¶ÄŸrendi?',ep:6,c:'sistem',ch:['Menderes'],s:540,dur:150},
    {id:'e61',t:'Menderes: AraÅŸtÄ±rma',d:'Ä°puÃ§larÄ± birleÅŸiyor.',ep:6,c:'sistem',ch:['Menderes'],s:690,dur:120},
    {id:'e62',t:'Ã‡aÄŸatay: Ego KÄ±pÄ±rtÄ±sÄ±',d:'Teknik baÅŸarÄ±, tatmin.',ep:6,c:'ihanet',ch:['Ã‡aÄŸatay'],s:810,dur:120},
    {id:'e63',t:'BegÃ¼m: Tekin BaÄŸlantÄ±sÄ±',d:'Aile meselesi.',ep:6,c:'karakter',ch:['BegÃ¼m','Tekin'],s:930,dur:120},
    {id:'e64',t:'AkÄ±n SÄ±navÄ±: Sahte Sorgu',d:'Maskeli adam â€” Ayaz.',ep:7,c:'karakter',ch:['AkÄ±n','Sakal','Ayaz','BegÃ¼m'],s:0,dur:210},
    {id:'e65',t:'Sakalâ€“AkÄ±n: ADALET Vizyonu',d:'GerÃ§ek plan.',ep:7,c:'organizasyon',ch:['Sakal','AkÄ±n'],s:210,dur:180},
    {id:'e66',t:'Aren vs Oktay: TV TartÄ±ÅŸmasÄ±',d:'CanlÄ± yayÄ±n.',ep:7,c:'sistem',ch:['Aren','Oktay Anar'],s:390,dur:180},
    {id:'e67',t:'Asaf: Adalet+Ä°stikrar',d:'BasÄ±n aÃ§Ä±klamasÄ±.',ep:7,c:'sistem',ch:['Asaf'],s:570,dur:90},
    {id:'e68',t:'Ã‡aÄŸatay: Medya Ä°lgisi',d:'Ego ÅŸiÅŸiyor.',ep:7,c:'ihanet',ch:['Ã‡aÄŸatay'],s:660,dur:150},
    {id:'e69',t:'12 Ä°sim Serbest',d:'Halkta Ã¶fke.',ep:7,c:'sistem',ch:['Tekin','Asaf'],s:810,dur:150},
    {id:'e70',t:'Menderes: Kumanda FÄ±rlatma',d:'Neleri Ã¶rttÃ¼ÄŸÃ¼mÃ¼zÃ¼ bilsen.',ep:7,c:'karakter',ch:['Menderes'],s:960,dur:120},
    {id:'e71',t:'Sahaf BaskÄ±nÄ±: HazÄ±rlÄ±k',d:'Ä°mha saati 4dk.',ep:8,c:'operasyon',ch:['Ayaz','Sakal','BegÃ¼m','Hatice','Mehmet'],s:0,dur:180},
    {id:'e72',t:'Sahaf BaskÄ±nÄ±: Polis',d:'Mermiler kitaplarÄ± deliyor.',ep:8,c:'operasyon',ch:['Ayaz','Menderes'],s:180,dur:180},
    {id:'e73',t:'Ayaz\'Ä±n Son SavaÅŸÄ±',d:'BÄ±Ã§akla son direniÅŸ.',ep:8,c:'operasyon',ch:['Ayaz'],s:360,dur:180},
    {id:'e74',t:'Ayaz\'Ä±n Hayali: Oba',d:'YemyeÅŸil oba, aile.',ep:8,c:'karakter',ch:['Ayaz'],s:540,dur:120},
    {id:'e75',t:'Ayaz\'Ä±n Ã–lÃ¼mÃ¼ + Patlama',d:'Sahaf yerle bir.',ep:8,c:'operasyon',ch:['Ayaz'],s:660,dur:120},
    {id:'e76',t:'KaÃ§Ä±ÅŸ: Araba Sahnesi',d:'Zihgir savaÅŸ pozisyonu.',ep:8,c:'organizasyon',ch:['Sakal','Mehmet','BegÃ¼m','Hatice'],s:780,dur:120},
    {id:'e77',t:'Ã‡aÄŸatay: Gizli Ä°ÅŸlev KeÅŸfi',d:'Ã–fke ve gÃ¼vensizlik.',ep:8,c:'ihanet',ch:['Ã‡aÄŸatay'],s:900,dur:120},
    {id:'e78',t:'Ã‡aÄŸatay: Ä°hanet KararÄ±',d:'Devletle temas kararÄ±.',ep:8,c:'ihanet',ch:['Ã‡aÄŸatay'],s:1020,dur:120},
    {id:'e79',t:'Emniyet BasÄ±n AÃ§Ä±klamasÄ±',d:'Ã–rgÃ¼t lideri Ã¶lÃ¼.',ep:9,c:'sistem',ch:['Menderes'],s:0,dur:150},
    {id:'e80',t:'Sokakta Kaynayan Ã–fke',d:'Engeller, mÄ±rÄ±ldanmalar.',ep:9,c:'sistem',ch:[],s:150,dur:90},
    {id:'e81',t:'Ekip DaÄŸÄ±lmÄ±ÅŸ',d:'PatladÄ±k / DuramayÄ±z.',ep:9,c:'karakter',ch:['AkÄ±n','AyÃ§a','Hatice','BegÃ¼m'],s:240,dur:150},
    {id:'e82',t:'Aren: Kulis + Kum Saati',d:'Sakal logosu.',ep:9,c:'karakter',ch:['Aren','Sakal'],s:390,dur:90},
    {id:'e83',t:'Aren: CanlÄ± YayÄ±n',d:'Devletin yanlÄ±ÅŸlarÄ±.',ep:9,c:'karakter',ch:['Aren'],s:480,dur:150},
    {id:'e84',t:'Aren: GÃ¶zaltÄ±',d:'GÃ¶kyÃ¼zÃ¼ne bakÄ±ÅŸ, gÃ¼lÃ¼mseme.',ep:9,c:'sistem',ch:['Aren'],s:630,dur:120},
    {id:'e85',t:'Asaf: Kriz YÃ¶netimi',d:'Diyalog, bastÄ±rma deÄŸil.',ep:9,c:'sistem',ch:['Asaf'],s:750,dur:120},
    {id:'e86',t:'Hatice ve Meryem: Parkta',d:'GÃ¶z gÃ¶ze ama dokunmaz.',ep:9,c:'karakter',ch:['Hatice','Sakal','AyÃ§a'],s:870,dur:180},
    {id:'e87',t:'Ã‡aÄŸatay: TEDx HazÄ±rlÄ±k',d:'Bu iÅŸin beyni benim.',ep:9,c:'ihanet',ch:['Ã‡aÄŸatay'],s:1050,dur:120},
    {id:'e88',t:'Ã‡aÄŸatay: Devletle Temas',d:'DokunulmazlÄ±k talebi.',ep:9,c:'ihanet',ch:['Ã‡aÄŸatay'],s:1170,dur:120},
    {id:'e89',t:'e-Demokrasi KÄ±rÄ±lma',d:'SonuÃ§lar deÄŸiÅŸiyor.',ep:10,c:'sistem',ch:[],s:0,dur:120},
    {id:'e90',t:'Sakal: Pub\'da Kaybolma',d:'Chopper kulÃ¼bÃ¼.',ep:10,c:'organizasyon',ch:['Sakal','Menderes'],s:120,dur:150},
    {id:'e91',t:'Sakal: Sahaf EnkazÄ±',d:'Dorian Gray alÄ±r.',ep:10,c:'organizasyon',ch:['Sakal'],s:270,dur:90},
    {id:'e92',t:'Ã‡aÄŸatay: TEDx KonuÅŸmasÄ±',d:'Ego zirvesi.',ep:10,c:'ihanet',ch:['Ã‡aÄŸatay'],s:360,dur:180},
    {id:'e93',t:'Sakalâ€“AkÄ±n BuluÅŸmasÄ±',d:'Teknokrasi vizyonu.',ep:10,c:'organizasyon',ch:['Sakal','AkÄ±n'],s:540,dur:120},
    {id:'e94',t:'Depoda Ã‡atÄ±ÅŸma: Mehmet',d:'Mehmet vurulur.',ep:10,c:'operasyon',ch:['Sakal','Mehmet','Menderes'],s:660,dur:180},
    {id:'e95',t:'Aren: Randevu Teyidi',d:'Kum saatine bakÄ±ÅŸ.',ep:10,c:'karakter',ch:['Aren'],s:840,dur:60},
    {id:'e96',t:'Asaf: Ä°ki Telefon',d:'Mutlak hesap.',ep:10,c:'sistem',ch:['Asaf'],s:900,dur:150},
    {id:'e97',t:'Lakas Kafesi: Ã‡aÄŸatayâ€“Tomris',d:'TOMA\'lar, Dorian Gray.',ep:10,c:'organizasyon',ch:['Ã‡aÄŸatay','Tomris/Lakas'],s:1050,dur:150},
    {id:'e98',t:'Garson Sakal: BÃ¼yÃ¼k Ä°fÅŸa',d:'TÄ±raÅŸ olmuÅŸ, Ã¶nlÃ¼klÃ¼.',ep:10,c:'organizasyon',ch:['Sakal','Ã‡aÄŸatay','Tomris/Lakas'],s:1200,dur:120},
    {id:'e99',t:'Ã‡aÄŸatay\'Ä±n Sonu: Zehirlenme',d:'KÃ¶pÃ¼klerle masaya yÄ±ÄŸÄ±lÄ±r.',ep:10,c:'ihanet',ch:['Ã‡aÄŸatay','Sakal','Hatice','BegÃ¼m'],s:1320,dur:150},
    {id:'e100',t:'Sakal: Gizli Karargah',d:'Devasa kitaplÄ±k.',ep:10,c:'organizasyon',ch:['Sakal','BegÃ¼m'],s:1470,dur:120},
    {id:'e101',t:'Son YazÄ±: Lakas Ä°fÅŸasÄ±',d:'Tomris HanÄ±m.',ep:10,c:'organizasyon',ch:['Sakal','Tomris/Lakas'],s:1590,dur:120},
    {id:'e102',t:'Jenerik SonrasÄ±: Mektup',d:'DiÄŸer bÃ¶lgelerdeki olaylar.',ep:10,c:'organizasyon',ch:['Tomris/Lakas','DoÄŸan Albay'],s:1710,dur:120},
    {id:'e103',t:'FB: 1974 Filipinler Kafesi',d:'DoÄŸan ve Tomris tanÄ±ÅŸma.',ep:'fb',c:'flashback',ch:['DoÄŸan Albay','Tomris/Lakas'],s:0,dur:180},
    {id:'e104',t:'FB: 2008 Ayaz â€” Patlama',d:'PatlamÄ±ÅŸ araba.',ep:'fb',c:'flashback',ch:['Ayaz'],s:180,dur:180},
    {id:'e105',t:'FB: 2008 Ayaz â€” Valiye SaldÄ±rÄ±',d:'Kafa atma.',ep:'fb',c:'flashback',ch:['Ayaz'],s:360,dur:150},
    {id:'e106',t:'FB: 2011 DoÄŸan â€” Kozmik Oda',d:'Belgeler, tutuklanma.',ep:'fb',c:'flashback',ch:['DoÄŸan Albay'],s:510,dur:180},
    {id:'e107',t:'FB: Hatice â€” KocasÄ±nÄ± Ã–ldÃ¼rmesi',d:'Sessiz karar anÄ±.',ep:'fb',c:'flashback',ch:['Hatice'],s:690,dur:180},
    {id:'e108',t:'FB: 2016 DoÄŸan â€” Cezaevi',d:'Mektup, intihar.',ep:'fb',c:'flashback',ch:['DoÄŸan Albay','Ayaz'],s:870,dur:210}
  ];
  const events = raw.map(r => ({
    id:r.id, title:r.t, description:r.d, episodeId:epMap[r.ep], sceneId:null,
    category:r.c, characters:r.ch.map(charId), s:r.s, dur:r.dur
  }));
  const rawCns = [
    {f:'e6',t:'e58',tp:'neden'},{f:'e36',t:'e44',tp:'neden'},{f:'e44',t:'e53',tp:'neden'},
    {f:'e53',t:'e62',tp:'neden'},{f:'e62',t:'e68',tp:'neden'},{f:'e68',t:'e77',tp:'neden'},
    {f:'e77',t:'e78',tp:'neden'},{f:'e78',t:'e88',tp:'neden'},{f:'e88',t:'e99',tp:'neden'},
    {f:'e39',t:'e60',tp:'neden'},{f:'e60',t:'e72',tp:'neden'},{f:'e75',t:'e79',tp:'neden'},
    {f:'e41',t:'e49',tp:'neden'},{f:'e69',t:'e54',tp:'neden'},{f:'e14',t:'e83',tp:'neden'},
    {f:'e72',t:'e73',tp:'neden'},{f:'e73',t:'e75',tp:'neden'},
    {f:'e97',t:'e99',tp:'neden'},{f:'e99',t:'e101',tp:'neden'},
    {f:'e103',t:'e101',tp:'neden'},{f:'e108',t:'e101',tp:'neden'},
    {f:'e42',t:'e36',tp:'karakter'},{f:'e105',t:'e73',tp:'karakter'},{f:'e107',t:'e86',tp:'karakter'},
    {f:'e32',t:'e96',tp:'karakter'},{f:'e108',t:'e73',tp:'karakter'},
    {f:'e15',t:'e35',tp:'kronoloji'},{f:'e35',t:'e39',tp:'kronoloji'},{f:'e39',t:'e48',tp:'kronoloji'},
    {f:'e48',t:'e57',tp:'kronoloji'},{f:'e57',t:'e71',tp:'kronoloji'},{f:'e71',t:'e94',tp:'kronoloji'},
    {f:'e94',t:'e97',tp:'kronoloji'}
  ];
  const connections = rawCns.map((c,i) => ({id:'cn'+i, from:c.f, to:c.t, type:c.tp, description:'', strength:1}));
  return {
    meta: { title:'SAKAL', author:'', settings:{ episodeDuration:2700, pixelsPerSecond:0.5, snapGrid:10 } },
    categories: {operasyon:{label:'Operasyon',color:'#ef4444'},karakter:{label:'Karakter',color:'#3b82f6'},organizasyon:{label:'Organizasyon',color:'#10b981'},sistem:{label:'Sistem',color:'#f59e0b'},flashback:{label:'Flashback',color:'#a855f7'},ihanet:{label:'Ä°hanet',color:'#f97316'}},
    characters, episodes, scenes: generateScenesFromEvents(events, episodes), events, connections
  };
}

function generateScenesFromEvents(events, episodes) {
  const scenes = [];
  const epGroups = {};
  events.forEach(ev => {
    if(!epGroups[ev.episodeId]) epGroups[ev.episodeId] = [];
    epGroups[ev.episodeId].push(ev);
  });
  Object.keys(epGroups).forEach(epId => {
    const evs = epGroups[epId].sort((a,b) => a.s - b.s);
    evs.forEach((ev, idx) => {
      const sc = {
        id: 'sc_' + ev.id,
        episodeId: epId,
        order: idx + 1,
        title: ev.title,
        location: '',
        timeOfDay: '',
        category: ev.category || 'karakter',
        characters: ev.characters || [],
        content: [{ type: 'action', text: ev.description || '' }]
      };
      ev.sceneId = sc.id;
      scenes.push(sc);
    });
  });
  return scenes;
}

// â•â•â• VIEW MODE â•â•â•
App.isMobile = function() { return window.innerWidth <= 768; };
App._viewMode = 'split';
App.setViewMode = function(mode) {
  App._viewMode = mode;
  const sp = document.getElementById('spPanel');
  const tl = document.getElementById('tlA');
  document.querySelectorAll('.view-mode').forEach(b => b.classList.toggle('active', b.dataset.vm === mode));
  if(mode === 'screenplay') {
    sp.classList.add('open'); sp.style.display = '';
    tl.style.display = ''; // Keep visible â€” used as editor canvas
    document.body.classList.add('screenplay-editor-active');
    App.ScreenplayEditor.buildFromState();
    App.ScreenplayEditor.render();
  } else if(mode === 'timeline') {
    sp.classList.remove('open'); sp.style.display = 'none'; tl.style.display = '';
    if(App.ScreenplayEditor.isActive()) App.ScreenplayEditor.unmount();
    App.Timeline.render();
  } else if(mode === 'iliskiler') {
    sp.classList.remove('open'); sp.style.display = 'none'; tl.style.display = '';
    if(App.ScreenplayEditor.isActive()) App.ScreenplayEditor.unmount();
    document.body.classList.remove('screenplay-editor-active');
    App.RelationshipMap.render();
  } else { // split
    sp.classList.add('open'); sp.style.display = ''; tl.style.display = '';
    if(App.ScreenplayEditor.isActive()) App.ScreenplayEditor.unmount();
    App.Timeline.render();
  }
  // On mobile, adjust sp-panel max-height for split
  if(App.isMobile() && mode === 'split') {
    sp.style.maxHeight = '50vh';
  } else {
    sp.style.maxHeight = '';
  }
};

// â•â•â• REFRESH â•â•â•
App.refresh = function() {
  App._pendingRemoteRefresh = false;
  App.Analysis.invalidateCache();
  // KullanÄ±cÄ± bir input/textarea/contenteditable alanÄ±nda yazÄ±yorsa aÄŸÄ±r render'larÄ± atla
  var _ae = document.activeElement;
  var _isEditing = _ae && (_ae.tagName === 'TEXTAREA' || _ae.tagName === 'INPUT' || _ae.isContentEditable);
  if(_isEditing) {
    App.UI.updateStatusBar();
    document.getElementById('projTitle').textContent = App.Store.get().meta.title;
    return;
  }
  App.Timeline.initFilter();
  App.Timeline.buildToolbar();
  if(App._viewMode === 'iliskiler') {
    App.RelationshipMap.render();
  } else if(App.ScreenplayEditor.isActive()) {
    App.ScreenplayEditor.buildFromState();
    App.ScreenplayEditor.render();
  } else {
    App.Timeline.render();
  }
  App.Screenplay.render();
  App.UI.updateStatusBar();
  document.getElementById('projTitle').textContent = App.Store.get().meta.title;
  if(App.Interaction.updateSelectionVisual) App.Interaction.updateSelectionVisual();
};

// â•â•â• INIT â•â•â•
(function(){
  try {
    // Firebase init
    if(typeof firebase !== 'undefined') {
      if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    }

    // Store change listener
    App.Store.on('change', (data) => {
      App.Analysis.invalidateCache();
      const fromEditor = data && data.type === 'screenplay-editor';
      const isRemote = data && data.type && (data.type.startsWith('remote') || data.type === 'set');
      // KullanÄ±cÄ± bir input/textarea/contenteditable alanÄ±nda yazÄ±yorsa render'larÄ± atla
      var _ae = document.activeElement;
      var _isEditing = _ae && (_ae.tagName === 'TEXTAREA' || _ae.tagName === 'INPUT' || _ae.isContentEditable);
      // Remote deÄŸiÅŸikliklerde kullanÄ±cÄ± yazÄ±yorsa render'larÄ± kuyruÄŸa al
      if(isRemote && _isEditing) {
        App._pendingRemoteRefresh = true;
        App.UI.updateStatusBar();
        return;
      }
      if(App._viewMode === 'iliskiler') {
        if(!data || data.type !== 'relMapDrag') App.RelationshipMap.render();
      } else if(App.ScreenplayEditor.isActive()) {
        App.Screenplay.render();
        if(!fromEditor) {
          App.ScreenplayEditor.buildFromState();
          App.ScreenplayEditor.render();
        }
      } else {
        App.Timeline.render();
        App.Screenplay.render();
      }
      App.UI.updateStatusBar();
      if(App.Interaction.updateSelectionVisual) App.Interaction.updateSelectionVisual();
      if(document.getElementById('rPanel').classList.contains('open')) {
        if(!_isEditing && App.Panels.getCurrentPanel() !== 'relmap') {
          App.Panels.renderPanel();
        }
      }
      // AutoSave (Firebase'e yazma) â€” remote deÄŸiÅŸikliklerde tekrar yazmayÄ± engelle
      if(App.AutoSave && !isRemote) App.AutoSave.save();
      if(App.Changelog) App.Changelog.addEntry(data);
    });

    App.Interaction.setup();
    if(App.Changelog) App.Changelog.init();
    if(App.Notes) App.Notes.init();

    // focusout: kullanÄ±cÄ± yazmayÄ± bÄ±rakÄ±nca bekleyen remote deÄŸiÅŸiklikleri uygula
    document.addEventListener('focusout', function() {
      if(App._pendingRemoteRefresh) {
        App._pendingRemoteRefresh = false;
        setTimeout(function() { App.refresh(); }, 100);
      }
    }, true);

    // AUTH STATE OBSERVER â€” tÃ¼m akÄ±ÅŸÄ± kontrol eder
    firebase.auth().onAuthStateChanged(user => {
      document.getElementById('loadMsg').style.display = 'none';
      if(user && user.isAnonymous) {
        // Eski anonim oturumu kapat, email/password auth'a geÃ§iÅŸ
        firebase.auth().signOut();
        return;
      }
      if(user) {
        App.Projects.checkPendingInvitations()
          .catch(err => console.warn('[Auth] Davet kontrolÃ¼ atlandÄ±:', err.message))
          .then(() => {
            App.Projects.loadFromFirebase();
          });
      } else {
        App.Auth.showLoginScreen();
      }
    });
  } catch(e) {
    const d = document.createElement('div');
    d.style.cssText = 'color:#ef4444;background:#1a1a2e;padding:24px;margin:20px;border:2px solid #ef4444;border-radius:8px;font-size:14px;font-family:monospace;white-space:pre-wrap;z-index:99999;position:relative;';
    d.textContent = 'HATA: ' + e.message + '\nStack: ' + (e.stack||'yok');
    document.body.insertBefore(d, document.body.firstChild);
  }
})();

</script>
</body>
</html>
